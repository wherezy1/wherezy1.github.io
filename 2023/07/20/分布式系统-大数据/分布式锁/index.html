

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="where">
  <meta name="keywords" content="">
  
    <meta name="description" content="分布式锁在应用开发中，特别是web工程开发，通常都是并发编程，不是多进程就是多线程。这种场景下极易出现线程并发性安全问题，此时不得不使用锁来解决问题。在多线程高并发场景下，为了保证资源的线程安全问题，jdk为我们提供了synchronized关键字和ReentrantLock可重入锁，但是它们只能保证一个工程内的线程安全。在分布式集群、微服务、云原生横行的当下，如何保证不同进程、不同服务、不同机器">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式锁-尚">
<meta property="og:url" content="http://example.com/2023/07/20/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/index.html">
<meta property="og:site_name" content="where&#39;s blog">
<meta property="og:description" content="分布式锁在应用开发中，特别是web工程开发，通常都是并发编程，不是多进程就是多线程。这种场景下极易出现线程并发性安全问题，此时不得不使用锁来解决问题。在多线程高并发场景下，为了保证资源的线程安全问题，jdk为我们提供了synchronized关键字和ReentrantLock可重入锁，但是它们只能保证一个工程内的线程安全。在分布式集群、微服务、云原生横行的当下，如何保证不同进程、不同服务、不同机器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230721103600425.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400425343.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606393792456.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606395123427.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400144254.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400294689.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400340594.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606442946203.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443124589.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443172072.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443276322.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443541407.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220313204754310.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606445079298.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606448306438.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220313212150451.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606448616499.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606448189738.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606453095867.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606468851705.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606467613477.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606467848874.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606467953589.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220313215233371.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606469161544.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606487086837.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606487362848.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606487554822.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606489307266.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606491642613.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606491689743.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606491754596.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220428200109930.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220428200244567.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606626611922.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606736612201.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606702476465.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504102416597.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606707959639.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504102714512.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606711874388.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606712580214.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606712697401.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1600610957600.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1600612707202.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504095916188.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606747747780.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504101636357.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504100503780.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504100728343.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504100850162.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220501155501783.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1568176834908.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606958454966.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606961296212.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606962536746.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220622191952608.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220501175644704.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607046072239.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607048160051.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607048783043.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607051823582.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607051896117.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607052541669.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607069431523.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220711225708066.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606620944823.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606625971086.png">
<meta property="article:published_time" content="2023-07-19T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-12T01:06:53.110Z">
<meta property="article:author" content="where">
<meta property="article:tag" content="分布式系统">
<meta property="article:tag" content="JUC">
<meta property="article:tag" content="分布式锁">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230721103600425.png">
  
  
  
  <title>分布式锁-尚 - where&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="分布式锁-尚"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-20 00:00" pubdate>
          2023年7月20日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          61k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          508 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">分布式锁-尚</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><p>在应用开发中，特别是web工程开发，通常都是并发编程，不是多进程就是多线程。这种场景下极易出现线程并发性安全问题，此时不得不使用锁来解决问题。在多线程高并发场景下，为了保证资源的线程安全问题，jdk为我们提供了synchronized关键字和ReentrantLock可重入锁，但是它们只能保证一个工程内的线程安全。在分布式集群、微服务、云原生横行的当下，如何保证不同进程、不同服务、不同机器的线程安全问题，jdk并没有给我们提供既有的解决方案。此时，我们就必须借助于相关技术手动实现了。目前主流的实现有以下方式：</p>
<ol>
<li>基于mysql关系型实现</li>
<li>基于redis非关系型数据实现</li>
<li>基于zookeeper&#x2F;etcd实现</li>
</ol>
<p>本课程将会全面深入、全程手撸代码式的讲解这三种分布式锁的实现。并深入源码讲解第三方分布式锁框架。</p>
<p>基础知识储备及技术要求： </p>
<p>​	开发工具：idea + jdk1.8<br>​	工程构建工具：maven<br>​	相关框架基础：SpringBoot SpringMVC Spring Mybatis（mybatis-plus） SpringData-Redis<br>​	数据库：mysql（InnoDB引擎 事务 锁机制） redis<br>​	负载均衡工具：nginx<br>​	压力测试工具：jmeter<br>​	其他：zookeeper lua脚本语言 JUC(java.util.concurrent相关背景知识) 微服务相关背景知识</p>
<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p>并发100循环50次，即5000次请求。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230721103600425.png" srcset="/img/loading.gif" lazyload alt="image-20230721103600425"></p>
<h1 id="1-传统锁回顾"><a href="#1-传统锁回顾" class="headerlink" title="1. 传统锁回顾"></a>1. 传统锁回顾</h1><h2 id="1-1-从减库存聊起"><a href="#1-1-从减库存聊起" class="headerlink" title="1.1. 从减库存聊起"></a>1.1. 从减库存聊起</h2><p>多线程并发安全问题最典型的代表就是超卖现象</p>
<p>库存在并发量较大情况下很容易发生超卖现象，一旦发生超卖现象，就会出现多成交了订单而发不了货的情况。</p>
<p>场景：</p>
<p>​		商品S库存余量为5时，用户A和B同时来购买一个商品，此时查询库存数都为5，库存充足则开始减库存：</p>
<p>用户A：update db_stock set stock &#x3D; stock - 1 where id &#x3D; 1</p>
<p>用户B：update db_stock set stock &#x3D; stock - 1 where id &#x3D; 1</p>
<p>并发情况下，更新后的结果可能是4，而实际的最终库存量应该是3才对</p>
<h2 id="1-2-环境准备"><a href="#1-2-环境准备" class="headerlink" title="1.2. 环境准备"></a>1.2. 环境准备</h2><p>建表语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `db_stock` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT,<br>  `product_code` varchar(255) DEFAULT NULL COMMENT &#x27;商品编号&#x27;,<br>  `stock_code` varchar(255) DEFAULT NULL COMMENT &#x27;仓库编号&#x27;,<br>  `count` int(11) DEFAULT NULL COMMENT &#x27;库存量&#x27;,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure>

<p>表中数据如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400425343.png" srcset="/img/loading.gif" lazyload alt="1606400425343"></p>
<p>1001商品在001仓库有5000件库存。</p>
<p>创建分布式锁demo工程：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606393792456.png" srcset="/img/loading.gif" lazyload alt="1606393792456"></p>
<p>创建好之后：</p>
<p> <img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606395123427.png" srcset="/img/loading.gif" lazyload alt="1606395123427"></p>
<p>pom.xml如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.11.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>distributed-lock<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>distributed-lock<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>分布式锁demo工程<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.46<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>application.yml配置文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">6000</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://172.16.116.100:3306/test</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.116</span><span class="hljs-number">.100</span><br></code></pre></td></tr></table></figure>

<p>DistributedLockApplication启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.atguigu.distributedlock.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(DistributedLockApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Stock实体类：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Data</span><br><span class="hljs-variable">@TableName</span>(<span class="hljs-string">&quot;db_stock&quot;</span>)<br>public class Stock &#123;<br><br>    <span class="hljs-variable">@TableId</span><br>    private Long id;<br><br>    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">productCode</span>;<br><br>    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">stockCode</span>;<br><br>    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Integer</span> <span class="hljs-selector-tag">count</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>StockMapper接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StockMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Stock&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="1-3-简单实现减库存"><a href="#1-3-简单实现减库存" class="headerlink" title="1.3. 简单实现减库存"></a>1.3. 简单实现减库存</h2><p>接下来咱们代码实操一下。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400144254.png" srcset="/img/loading.gif" lazyload alt="1606400144254"></p>
<p>StockController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StockService stockService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;check/lock&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-built_in">this</span>.stockService.checkAndLock();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;验库存并锁库存成功！&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>StockService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StockMapper stockMapper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">// 先查询库存是否充足</span><br>        <span class="hljs-type">Stock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.stockMapper.selectById(<span class="hljs-number">1L</span>);<br><br>        <span class="hljs-comment">// 再减库存</span><br>        <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.getCount() &gt; <span class="hljs-number">0</span>)&#123;<br>            stock.setCount(stock.getCount() - <span class="hljs-number">1</span>);<br>            <span class="hljs-built_in">this</span>.stockMapper.updateById(stock);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400294689.png" srcset="/img/loading.gif" lazyload alt="1606400294689"></p>
<p>查看数据库：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606400340594.png" srcset="/img/loading.gif" lazyload alt="1606400340594"></p>
<p>在浏览器中一个一个访问时，每访问一次，库存量减1，没有任何问题。</p>
<h2 id="1-4-演示超卖现象"><a href="#1-4-演示超卖现象" class="headerlink" title="1.4. 演示超卖现象"></a>1.4. 演示超卖现象</h2><p>接下来咱们使用jmeter压力测试工具，高并发下压测一下，添加线程组：并发100循环50次，即5000次请求。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606442946203.png" srcset="/img/loading.gif" lazyload alt="1606442946203"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443124589.png" srcset="/img/loading.gif" lazyload alt="1606443124589"></p>
<p>给线程组添加HTTP Request请求：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443172072.png" srcset="/img/loading.gif" lazyload alt="1606443172072"></p>
<p>填写测试接口路径如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443276322.png" srcset="/img/loading.gif" lazyload alt="1606443276322"></p>
<p>再选择你想要的测试报表，例如这里选择聚合报告：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606443541407.png" srcset="/img/loading.gif" lazyload alt="1606443541407"></p>
<p>启动测试，查看压力测试报告：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220313204754310.png" srcset="/img/loading.gif" lazyload alt="image-20220313204754310"></p>
<ul>
<li>Label          取样器别名，如果勾选<strong>Include group name</strong> ，则会添加线程组的名称作为前缀</li>
<li># Samples      取样器运行次数</li>
<li>Average       请求（事务）的平均响应时间</li>
<li>Median        中位数</li>
<li>90% Line       90%用户响应时间</li>
<li>95% Line       90%用户响应时间</li>
<li>99% Line       90%用户响应时间</li>
<li>Min           最小响应时间</li>
<li>Max           最大响应时间</li>
<li>Error          错误率</li>
<li>Throughput     吞吐率</li>
<li>Received KB&#x2F;sec  每秒收到的千字节</li>
<li>Sent KB&#x2F;sec      每秒收到的千字节</li>
</ul>
<p>测试结果：请求总数5000次，平均请求时间37ms，中位数（50%）请求是在36ms内完成的，错误率0%，每秒钟平均吞吐量2568.1次。</p>
<p>查看mysql数据库剩余库存数：还有4870</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606445079298.png" srcset="/img/loading.gif" lazyload alt="1606445079298"></p>
<p>此时如果还有人来下单，就会出现超卖现象（别人购买成功，而无货可发）。</p>
<h2 id="1-5-jvm锁问题演示"><a href="#1-5-jvm锁问题演示" class="headerlink" title="1.5. jvm锁问题演示"></a>1.5. jvm锁问题演示</h2><h3 id="1-5-1-添加jvm锁"><a href="#1-5-1-添加jvm锁" class="headerlink" title="1.5.1. 添加jvm锁"></a>1.5.1. 添加jvm锁</h3><p>使用jvm锁（synchronized关键字或者ReetrantLock）试试：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606448306438.png" srcset="/img/loading.gif" lazyload alt="1606448306438"></p>
<p>重启tomcat服务，再次使用jmeter压力测试，效果如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220313212150451.png" srcset="/img/loading.gif" lazyload alt="image-20220313212150451"></p>
<p>查看mysql数据库：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606448616499.png" srcset="/img/loading.gif" lazyload alt="1606448616499"></p>
<p>并没有发生超卖现象，完美解决。</p>
<h3 id="1-5-2-原理"><a href="#1-5-2-原理" class="headerlink" title="1.5.2. 原理"></a>1.5.2. 原理</h3><p>添加synchronized关键字之后，StockService就具备了对象锁，由于添加了独占的排他锁，同一时刻只有一个请求能够获取到锁，并减库存。此时，所有请求只会one-by-one执行下去，也就不会发生超卖现象。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606448189738.png" srcset="/img/loading.gif" lazyload alt="1606448189738"></p>
<h2 id="1-6-多服务问题"><a href="#1-6-多服务问题" class="headerlink" title="1.6. 多服务问题"></a>1.6. 多服务问题</h2><p>使用jvm锁在单工程单服务情况下确实没有问题，但是在集群情况下会怎样？</p>
<p>接下启动多个服务并使用nginx负载均衡，结构如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606453095867.png" srcset="/img/loading.gif" lazyload alt="1606453095867"></p>
<p>启动三个服务（端口号分别8000 8100 8200），如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606468851705.png" srcset="/img/loading.gif" lazyload alt="1606468851705"></p>
<h3 id="1-6-1-安装配置nginx"><a href="#1-6-1-安装配置nginx" class="headerlink" title="1.6.1. 安装配置nginx"></a>1.6.1. 安装配置nginx</h3><p>基于安装nginx：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">拉取镜像</span><br>docker pull nginx:latest<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建nginx对应资源、日志及配置目录</span><br>mkdir -p /opt/nginx/logs /opt/nginx/conf /opt/nginx/html<br><span class="hljs-meta prompt_"># </span><span class="language-bash">先在conf目录下创建nginx.conf文件，配置内容参照下方</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">再运行容器</span><br>docker run -d -p 80:80 --name nginx -v /opt/nginx/html:/usr/share/nginx/html -v /opt/nginx/conf/nginx.conf:/etc/nginx/nginx.conf -v /opt/nginx/logs:/var/log/nginx nginx<br></code></pre></td></tr></table></figure>

<p>nginx.conf配置如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">user</span>  nginx;<br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><br><span class="hljs-attribute">error_log</span>  /var/log/nginx/<span class="hljs-literal">error</span>.log <span class="hljs-literal">warn</span>;<br><span class="hljs-attribute">pid</span>        /var/run/nginx.pid;<br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       /etc/nginx/mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br><br>    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] &quot;<span class="hljs-variable">$request</span>&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> &quot;<span class="hljs-variable">$http_referer</span>&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$http_user_agent</span>&quot; &quot;<span class="hljs-variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;<br><br>    <span class="hljs-attribute">access_log</span>  /var/log/nginx/access.log  main;<br><br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-comment">#gzip  on;</span><br><br>    <span class="hljs-comment">#include /etc/nginx/conf.d/*.conf;</span><br>	<br>	<span class="hljs-section">upstream</span> distributed &#123;<br>		<span class="hljs-attribute">server</span> <span class="hljs-number">172.16.116.1:8000</span>;<br>		<span class="hljs-attribute">server</span> <span class="hljs-number">172.16.116.1:8100</span>;<br>		<span class="hljs-attribute">server</span> <span class="hljs-number">172.16.116.1:8200</span>;<br>	&#125;<br>	<br>	<span class="hljs-section">server</span> &#123;<br>		<span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  <span class="hljs-number">172.16.116.100</span>;<br>		<span class="hljs-section">location</span> / &#123;<br>			<span class="hljs-attribute">proxy_pass</span> http://distributed;<br>		&#125;<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在浏览器中测试：172.16.116.100是我的nginx服务器地址</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606467613477.png" srcset="/img/loading.gif" lazyload alt="1606467613477"></p>
<p>经过测试，通过nginx访问服务一切正常。</p>
<h3 id="1-6-2-Jmeter压力测试"><a href="#1-6-2-Jmeter压力测试" class="headerlink" title="1.6.2. Jmeter压力测试"></a>1.6.2. Jmeter压力测试</h3><p>注意：先把数据库库存量还原到5000。</p>
<p>参照之前的测试用例，再创建一个新的测试组：参数给之前一样</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606467848874.png" srcset="/img/loading.gif" lazyload alt="1606467848874"></p>
<p>配置nginx的地址及 服务的访问路径如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606467953589.png" srcset="/img/loading.gif" lazyload alt="1606467953589"></p>
<p>测试结果：性能只是略有提升。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220313215233371.png" srcset="/img/loading.gif" lazyload alt="image-20220313215233371"></p>
<p>数据库库存剩余量如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606469161544.png" srcset="/img/loading.gif" lazyload alt="1606469161544"></p>
<p>又出现了并发问题，即出现了超卖现象。</p>
<h2 id="1-7-mysql锁演示"><a href="#1-7-mysql锁演示" class="headerlink" title="1.7. mysql锁演示"></a>1.7. mysql锁演示</h2><p>除了使用jvm锁之外，还可以使用数据锁：<strong>悲观锁</strong> 或者 <strong>乐观锁</strong></p>
<ol>
<li><p>一个sql：直接更新时判断，在更新中判断库存是否大于0 </p>
<p>update table set surplus &#x3D; (surplus - buyQuantity) where id &#x3D; 1 and (surplus - buyQuantity) &gt; 0 ;</p>
</li>
<li><p>悲观锁：在读取数据时锁住那几行，其他对这几行的更新需要等到悲观锁结束时才能继续 。</p>
<p>select … for update</p>
</li>
<li><p>乐观锁：读取数据时不锁，更新时检查是否数据已经被更新过，如果是则取消当前更新进行重试。</p>
<p>version 或者 时间戳（CAS思想）。</p>
</li>
</ol>
<h3 id="1-7-1-一个sql"><a href="#1-7-1-一个sql" class="headerlink" title="1.7.1. 一个sql"></a>1.7.1. 一个sql</h3><p>略。。</p>
<h3 id="1-7-2-悲观锁"><a href="#1-7-2-悲观锁" class="headerlink" title="1.7.2. 悲观锁"></a>1.7.2. 悲观锁</h3><p>在MySQL的InnoDB中，预设的Tansaction isolation level 为REPEATABLE READ（可重读）</p>
<p><strong>在SELECT 的读取锁定主要分为两种方式：</strong></p>
<ul>
<li>SELECT … LOCK IN SHARE MODE　（共享锁）</li>
<li>SELECT … FOR UPDATE                     （悲观锁）</li>
</ul>
<p>这两种方式在事务(Transaction) 进行当中SELECT 到同一个数据表时，都必须等待其它事务数据被提交(Commit)后才会执行。</p>
<p>而主要的不同在于LOCK IN SHARE MODE 在有一方事务要Update 同一个表单时很容易造成死锁。</p>
<p>简单的说，如果SELECT 后面若要UPDATE 同一个表单，最好使用SELECT … FOR UPDATE。</p>
<p><strong>代码实现</strong></p>
<p>改造StockService：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606487086837.png" srcset="/img/loading.gif" lazyload alt="1606487086837"></p>
<p>在StockeMapper中定义selectStockForUpdate方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StockMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Stock&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> Stock <span class="hljs-title function_">selectStockForUpdate</span><span class="hljs-params">(Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在StockMapper.xml中定义对应的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.atguigu.distributedlock.mapper.StockMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectStockForUpdate&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.atguigu.distributedlock.pojo.Stock&quot;</span>&gt;</span><br>        select * from db_stock where id = #&#123;id&#125; for update<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p><strong>压力测试</strong></p>
<p>注意：测试之前，需要把库存量改成5000。压测数据如下：比jvm性能高很多，比无锁要低将近1倍</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606487362848.png" srcset="/img/loading.gif" lazyload alt="1606487362848"></p>
<p>mysql数据库存：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606487554822.png" srcset="/img/loading.gif" lazyload alt="1606487554822"></p>
<h3 id="1-7-3-乐观锁"><a href="#1-7-3-乐观锁" class="headerlink" title="1.7.3. 乐观锁"></a>1.7.3. 乐观锁</h3><p>乐观锁（ Optimistic Locking ） 相对悲观锁而言，乐观锁假设认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则重试。那么我们如何实现乐观锁呢</p>
<p>使用数据版本（Version）记录机制实现，这是乐观锁最常用的实现 方式。一般是通过为数据库表增加一个数字类型的 “version” 字段来实现。当读取数据时，将version字段的值一同读出，数据每更新一次，对此version值加一。当我们提交更新的时候，判断数据库表对应记录 的当前版本信息与第一次取出来的version值进行比对，如果数据库表当前版本号与第一次取出来的version值相等，则予以更新。</p>
<p>给db_stock表添加version字段：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606489307266.png" srcset="/img/loading.gif" lazyload alt="1606489307266"></p>
<p>对应也需要给Stock实体类添加version属性。此处略。。。。</p>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span> &#123;<br><br>    <span class="hljs-comment">// 先查询库存是否充足</span><br>    <span class="hljs-type">Stock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.stockMapper.selectById(<span class="hljs-number">1L</span>);<br><br>    <span class="hljs-comment">// 再减库存</span><br>    <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.getCount() &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">// 获取版本号</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> stock.getVersion();<br><br>        stock.setCount(stock.getCount() - <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 每次更新 版本号 + 1</span><br>        stock.setVersion(stock.getVersion() + <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 更新之前先判断是否是之前查询的那个版本，如果不是重试</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.stockMapper.update(stock, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;Stock&gt;().eq(<span class="hljs-string">&quot;id&quot;</span>, stock.getId()).eq(<span class="hljs-string">&quot;version&quot;</span>, version)) == <span class="hljs-number">0</span>) &#123;<br>            checkAndLock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重启后使用jmeter压力测试工具结果如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606491642613.png" srcset="/img/loading.gif" lazyload alt="1606491642613"></p>
<p>修改测试参数如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606491689743.png" srcset="/img/loading.gif" lazyload alt="1606491689743"></p>
<p>测试结果如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606491754596.png" srcset="/img/loading.gif" lazyload alt="1606491754596"></p>
<p>说明乐观锁在并发量越大的情况下，性能越低（因为需要大量的重试）；并发量越小，性能越高。</p>
<h3 id="1-7-4-mysql锁总结"><a href="#1-7-4-mysql锁总结" class="headerlink" title="1.7.4. mysql锁总结"></a>1.7.4. mysql锁总结</h3><p>性能：一个sql &gt; 悲观锁 &gt; jvm锁 &gt; 乐观锁</p>
<p>如果追求极致性能、业务场景简单并且不需要记录数据前后变化的情况下。</p>
<p>​		优先选择：一个sql</p>
<p>如果写并发量较低（多读），争抢不是很激烈的情况下优先选择：乐观锁</p>
<p>如果写并发量较高，一般会经常冲突，此时选择乐观锁的话，会导致业务代码不间断的重试。</p>
<p>​		优先选择：mysql悲观锁</p>
<p>不推荐jvm本地锁。</p>
<h2 id="1-8-redis乐观锁"><a href="#1-8-redis乐观锁" class="headerlink" title="1.8. redis乐观锁"></a>1.8. redis乐观锁</h2><p>利用redis监听 + 事务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">watch stock<br>multi<br>set stock 5000<br>exec<br></code></pre></td></tr></table></figure>

<p>如果执行过程中stock的值没有被其他链接改变，则执行成功</p>
<p> <img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220428200109930.png" srcset="/img/loading.gif" lazyload alt="image-20220428200109930"></p>
<p>如果执行过程中stock的值被改变，则执行失败效果如下：</p>
<p> <img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220428200244567.png" srcset="/img/loading.gif" lazyload alt="image-20220428200244567"></p>
<p>具体代码实现，只需要改造对应的service方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">()</span> &#123;<br><br>    <span class="hljs-built_in">this</span>.redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionCallback</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(RedisOperations operations)</span> <span class="hljs-keyword">throws</span> DataAccessException &#123;<br>            operations.watch(<span class="hljs-string">&quot;stock&quot;</span>);<br>            <span class="hljs-comment">// 1. 查询库存信息</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> operations.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>);<br>            <span class="hljs-comment">// 2. 判断库存是否充足</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; (st = Integer.parseInt(stock.toString())) &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 3. 扣减库存</span><br>                operations.multi();<br>                operations.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, String.valueOf(--st));<br>                <span class="hljs-type">List</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> operations.exec();<br>                <span class="hljs-keyword">if</span> (exec == <span class="hljs-literal">null</span> || exec.size() == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">50</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                    deduct();<br>                &#125;<br>                <span class="hljs-keyword">return</span> exec;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="2-基于redis实现分布式锁"><a href="#2-基于redis实现分布式锁" class="headerlink" title="2. 基于redis实现分布式锁"></a>2. 基于redis实现分布式锁</h1><h2 id="2-1-基本实现"><a href="#2-1-基本实现" class="headerlink" title="2.1. 基本实现"></a>2.1. 基本实现</h2><p>借助于redis中的命令setnx(key, value)，key不存在就新增，存在就什么都不做。同时有多个客户端发送setnx命令，只有一个客户端可以成功，返回1（true）；其他的客户端返回0（false）。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606626611922.png" srcset="/img/loading.gif" lazyload alt="1606626611922"></p>
<ol>
<li>多个客户端同时获取锁（setnx）</li>
<li>获取成功，执行业务逻辑，执行完成释放锁（del）</li>
<li>其他客户端等待重试</li>
</ol>
<p>改造StockService方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StockMapper stockMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 加锁setnx</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-string">&quot;111&quot;</span>);<br>        <span class="hljs-comment">// 重试：递归调用</span><br>        <span class="hljs-keyword">if</span> (!lock)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">50</span>);<br>                <span class="hljs-built_in">this</span>.deduct();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 1. 查询库存信息</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>).toString();<br><br>                <span class="hljs-comment">// 2. 判断库存是否充足</span><br>                <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.length() != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-type">Integer</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> Integer.valueOf(stock);<br>                    <span class="hljs-keyword">if</span> (st &gt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-comment">// 3.扣减库存</span><br>                        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, String.valueOf(--st));<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// 解锁</span><br>                <span class="hljs-built_in">this</span>.redisTemplate.delete(<span class="hljs-string">&quot;lock&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中，加锁也可以使用循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 加锁，获取锁失败重试</span><br><span class="hljs-keyword">while</span> (!<span class="hljs-built_in">this</span>.redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-string">&quot;111&quot;</span>))&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">40</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 释放锁</span><br><span class="hljs-built_in">this</span>.redisTemplate.delete(<span class="hljs-string">&quot;lock&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>使用Jmeter压力测试如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606736612201.png" srcset="/img/loading.gif" lazyload alt="1606736612201"></p>
<p>S</p>
<h2 id="2-2-防死锁"><a href="#2-2-防死锁" class="headerlink" title="2.2. 防死锁"></a>2.2. 防死锁</h2><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606702476465.png" srcset="/img/loading.gif" lazyload alt="1606702476465"></p>
<p>问题：setnx刚刚获取到锁，当前服务器宕机，导致del释放锁无法执行，进而导致锁无法锁无法释放（死锁）</p>
<p>解决：给锁设置过期时间，自动释放锁。</p>
<p>设置过期时间两种方式：</p>
<ol>
<li>通过expire设置过期时间（缺乏原子性：如果在setnx和expire之间出现异常，锁也无法释放）</li>
<li>使用set指令设置过期时间：set key value ex 3 nx（既达到setnx的效果，又设置了过期时间）</li>
</ol>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504102416597.png" srcset="/img/loading.gif" lazyload alt="image-20220504102416597"></p>
<p>压力测试肯定也没有问题。</p>
<h2 id="2-3-防误删"><a href="#2-3-防误删" class="headerlink" title="2.3. 防误删"></a>2.3. 防误删</h2><p>问题：可能会释放其他服务器的锁。</p>
<p>场景：如果业务逻辑的执行时间是7s。执行流程如下</p>
<ol>
<li><p>index1业务逻辑没执行完，3秒后锁被自动释放。</p>
</li>
<li><p>index2获取到锁，执行业务逻辑，3秒后锁被自动释放。</p>
</li>
<li><p>index3获取到锁，执行业务逻辑</p>
</li>
<li><p>index1业务逻辑执行完成，开始调用del释放锁，这时释放的是index3的锁，导致index3的业务只执行1s就被别人释放。</p>
<p>最终等于没锁的情况。</p>
</li>
</ol>
<p>解决：setnx获取锁时，设置一个指定的唯一值（例如：uuid）；释放前获取这个值，判断是否自己的锁</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606707959639.png" srcset="/img/loading.gif" lazyload alt="1606707959639"></p>
<p>实现如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504102714512.png" srcset="/img/loading.gif" lazyload alt="image-20220504102714512"></p>
<p>问题：删除操作缺乏原子性。</p>
<p>场景：</p>
<ol>
<li>index1执行删除时，查询到的lock值确实和uuid相等</li>
<li>index1执行删除前，lock刚好过期时间已到，被redis自动释放</li>
<li>index2获取了lock</li>
<li>index1执行删除，此时会把index2的lock删除</li>
</ol>
<p>解决方案：没有一个命令可以同时做到判断 + 删除，所有只能通过其他方式实现（<strong>LUA脚本</strong>）</p>
<h2 id="2-4-redis中的lua脚本"><a href="#2-4-redis中的lua脚本" class="headerlink" title="2.4. redis中的lua脚本"></a>2.4. redis中的lua脚本</h2><h3 id="2-4-1-现实问题"><a href="#2-4-1-现实问题" class="headerlink" title="2.4.1. 现实问题"></a>2.4.1. 现实问题</h3><p>redis采用单线程架构，可以保证单个命令的原子性，但是无法保证一组命令在高并发场景下的原子性。例如：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606711874388.png" srcset="/img/loading.gif" lazyload alt="1606711874388"></p>
<p>在串行场景下：A和B的值肯定都是3</p>
<p>在并发场景下：A和B的值可能在0-6之间。</p>
<p>极限情况下1：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606712580214.png" srcset="/img/loading.gif" lazyload alt="1606712580214"></p>
<p>则A的结果是0，B的结果是3</p>
<p>极限情况下2：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606712697401.png" srcset="/img/loading.gif" lazyload alt="1606712697401"></p>
<p>则A和B的结果都是6</p>
<p>如果redis客户端通过lua脚本把3个命令一次性发送给redis服务器，那么这三个指令就不会被其他客户端指令打断。Redis 也保证脚本会以原子性(atomic)的方式执行： 当某个脚本正在运行的时候，不会有其他脚本或 Redis 命令被执行。 这和使用 MULTI&#x2F; EXEC 包围的事务很类似。 </p>
<p>但是MULTI&#x2F; EXEC方法来使用事务功能，将一组命令打包执行，无法进行业务逻辑的操作。这期间有某一条命令执行报错（例如给字符串自增），其他的命令还是会执行，并不会回滚。</p>
<h3 id="2-4-2-lua介绍"><a href="#2-4-2-lua介绍" class="headerlink" title="2.4.2. lua介绍"></a>2.4.2. lua介绍</h3><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<p><strong>设计目的</strong></p>
<p>​	其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<p><strong>Lua 特性</strong></p>
<ul>
<li><strong>轻量级</strong>：它用标准C语言编写并以源代码形式开放，编译后仅仅一百余K，可以很方便的嵌入别的程序里。</li>
<li><strong>可扩展</strong>：Lua提供了非常易于使用的扩展接口和机制：由宿主语言(通常是C或C++)提供这些功能，Lua可以使用它们，就像是本来就内置的功能一样。</li>
<li>其它特性：<ul>
<li>支持面向过程(procedure-oriented)编程和函数式编程(functional programming)；</li>
<li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li>
<li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li>
<li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等。</li>
</ul>
</li>
</ul>
<h3 id="2-4-3-lua基本语法"><a href="#2-4-3-lua基本语法" class="headerlink" title="2.4.3. lua基本语法"></a>2.4.3. lua基本语法</h3><p>对lua脚本感兴趣的同学，请移步到官方教程或者《菜鸟教程》。这里仅以redis中可能会用到的部分语法作介绍。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua">a = <span class="hljs-number">5</span>               <span class="hljs-comment">-- 全局变量</span><br><span class="hljs-keyword">local</span> b = <span class="hljs-number">5</span>         <span class="hljs-comment">-- 局部变量， redis只支持局部变量</span><br>a, b = <span class="hljs-number">10</span>, <span class="hljs-number">2</span>*x      <span class="hljs-comment">-- 等价于       a=10; b=2*x</span><br></code></pre></td></tr></table></figure>

<p>流程控制：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>( 布尔表达式 <span class="hljs-number">1</span>)<br><span class="hljs-keyword">then</span><br>   <span class="hljs-comment">--[ 在布尔表达式 1 为 true 时执行该语句块 --]</span><br><span class="hljs-keyword">elseif</span>( 布尔表达式 <span class="hljs-number">2</span>)<br><span class="hljs-keyword">then</span><br>   <span class="hljs-comment">--[ 在布尔表达式 2 为 true 时执行该语句块 --]</span><br><span class="hljs-keyword">else</span> <br>   <span class="hljs-comment">--[ 如果以上布尔表达式都不为 true 则执行该语句块 --]</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<h3 id="2-4-4-redis执行lua脚本-EVAL指令"><a href="#2-4-4-redis执行lua脚本-EVAL指令" class="headerlink" title="2.4.4. redis执行lua脚本 - EVAL指令"></a>2.4.4. redis执行lua脚本 - EVAL指令</h3><p>在redis中需要通过eval命令执行lua脚本。</p>
<p>格式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">EVAL script numkeys key <span class="hljs-selector-attr">[key ...]</span> arg <span class="hljs-selector-attr">[arg ...]</span><br>script：lua脚本字符串，这段Lua脚本不需要（也不应该）定义函数。<br>numkeys：lua脚本中KEYS数组的大小<br>key <span class="hljs-selector-attr">[key ...]</span>：KEYS数组中的元素<br>arg <span class="hljs-selector-attr">[arg ...]</span>：ARGV数组中的元素<br></code></pre></td></tr></table></figure>

<p>案例1：基本案例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">EVAL &quot;return 10&quot; 0<br></code></pre></td></tr></table></figure>

<p>输出：(integer) 10</p>
<p>案例2：动态传参</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">EVAL &quot;return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;&quot; 5 10 20 30 40 50 60 70 80 90<br><span class="hljs-meta prompt_"># </span><span class="language-bash">输出：10 20 60 70</span><br><br>EVAL &quot;if KEYS[1] &gt; ARGV[1] then return 1 else return 0 end&quot; 1 10 20<br><span class="hljs-meta prompt_"># </span><span class="language-bash">输出：0</span><br><br>EVAL &quot;if KEYS[1] &gt; ARGV[1] then return 1 else return 0 end&quot; 1 20 10<br><span class="hljs-meta prompt_"># </span><span class="language-bash">输出：1</span><br></code></pre></td></tr></table></figure>

<p>传入了两个参数10和20，KEYS的长度是1，所以KEYS中有一个元素10，剩余的一个20就是ARGV数组的元素。</p>
<p>redis.call()中的redis是redis中提供的lua脚本类库，仅在redis环境中可以使用该类库。</p>
<p>案例3：执行redis类库方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">set aaa 10  -- 设置一个aaa值为10<br>EVAL &quot;return redis.call(&#x27;get&#x27;, &#x27;aaa&#x27;)&quot; 0<br><span class="hljs-meta prompt_"># </span><span class="language-bash">通过<span class="hljs-built_in">return</span>把call方法返回给redis客户端，打印：<span class="hljs-string">&quot;10&quot;</span></span><br></code></pre></td></tr></table></figure>

<p>注意：<strong>脚本里使用的所有键都应该由 KEYS 数组来传递。</strong>但并不是强制性的，代价是这样写出的脚本不能被 Redis 集群所兼容。</p>
<p>案例4：给redis类库方法动态传参</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">EVAL &quot;return redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1])&quot; 1 bbb 20<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1600610957600.png" srcset="/img/loading.gif" lazyload alt="1600610957600"></p>
<p>学到这里基本可以应付redis分布式锁所需要的脚本知识了。</p>
<p>案例5：pcall函数的使用（了解）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">-- 当call() 在执行命令的过程中发生错误时，脚本会停止执行，并返回一个脚本错误，输出错误信息<br>EVAL &quot;return redis.call(&#x27;sets&#x27;, KEYS[1], ARGV[1]), redis.call(&#x27;set&#x27;, KEYS[2], ARGV[2])&quot; 2 bbb ccc 20 30<br>-- pcall函数不影响后续指令的执行<br>EVAL &quot;return redis.pcall(&#x27;sets&#x27;, KEYS[1], ARGV[1]), redis.pcall(&#x27;set&#x27;, KEYS[2], ARGV[2])&quot; 2 bbb ccc 20 30<br></code></pre></td></tr></table></figure>

<p><strong>注意：set方法写成了sets</strong>，肯定会报错。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1600612707202.png" srcset="/img/loading.gif" lazyload alt="1600612707202"></p>
<h2 id="2-5-使用lua保证删除原子性"><a href="#2-5-使用lua保证删除原子性" class="headerlink" title="2.5. 使用lua保证删除原子性"></a>2.5. 使用lua保证删除原子性</h2><p>删除LUA脚本：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">&#x27;del&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>    <span class="hljs-comment">// 加锁setnx</span><br>    <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">this</span>.redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, uuid, <span class="hljs-number">3</span>, TimeUnit.SECONDS)) &#123;<br>        <span class="hljs-comment">// 重试：循环</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// this.redisTemplate.expire(&quot;lock&quot;, 3, TimeUnit.SECONDS);</span><br>        <span class="hljs-comment">// 1. 查询库存信息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>).toString();<br><br>        <span class="hljs-comment">// 2. 判断库存是否充足</span><br>        <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.length() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> Integer.valueOf(stock);<br>            <span class="hljs-keyword">if</span> (st &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 3.扣减库存</span><br>                redisTemplate.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, String.valueOf(--st));<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// 先判断是否自己的锁，再解锁</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] &quot;</span> +<br>            <span class="hljs-string">&quot;then &quot;</span> +<br>            <span class="hljs-string">&quot;   return redis.call(&#x27;del&#x27;, KEYS[1]) &quot;</span> +<br>            <span class="hljs-string">&quot;else &quot;</span> +<br>            <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>            <span class="hljs-string">&quot;end&quot;</span>;<br>        <span class="hljs-built_in">this</span>.redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(<span class="hljs-string">&quot;lock&quot;</span>), uuid);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>压力测试，库存量也没有问题，截图略过。。。</p>
<h2 id="2-6-可重入锁"><a href="#2-6-可重入锁" class="headerlink" title="2.6. 可重入锁"></a>2.6. 可重入锁</h2><p>由于上述加锁命令使用了 SETNX ，一旦键存在就无法再设置成功，这就导致后续同一线程内继续加锁，将会加锁失败。当一个线程执行一段代码成功获取锁之后，继续执行时，又遇到加锁的子任务代码，可重入性就保证线程能继续执行，而不可重入就是需要等待锁释放之后，再次获取锁成功，才能继续往下执行。</p>
<p>用一段 Java 代码解释可重入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">a</span><span class="hljs-params">()</span> &#123;<br>    b();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">b</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// pass</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>假设 X 线程在 a 方法获取锁之后，继续执行 b 方法，如果此时<strong>不可重入</strong>，线程就必须等待锁释放，再次争抢锁。</p>
<p>锁明明是被 X 线程拥有，却还需要等待自己释放锁，然后再去抢锁，这看起来就很奇怪，我释放我自己~</p>
<p>可重入性就可以解决这个尴尬的问题，当线程拥有锁之后，往后再遇到加锁方法，直接将加锁次数加 1，然后再执行方法逻辑。退出加锁方法之后，加锁次数再减 1，当加锁次数为 0 时，锁才被真正的释放。</p>
<p>可以看到可重入锁最大特性就是计数，计算加锁的次数。所以当可重入锁需要在分布式环境实现时，我们也就需要统计加锁次数。</p>
<p>解决方案：redis + Hash</p>
<h3 id="2-6-1-加锁脚本"><a href="#2-6-1-加锁脚本" class="headerlink" title="2.6.1. 加锁脚本"></a>2.6.1. 加锁脚本</h3><p>Redis 提供了 Hash （哈希表）这种可以存储键值对数据结构。所以我们可以使用 Redis Hash 存储的锁的重入次数，然后利用 lua 脚本判断逻辑。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;exists&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> redis.call(<span class="hljs-string">&#x27;hexists&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]) == <span class="hljs-number">1</span>) <br><span class="hljs-keyword">then</span><br>    redis.call(<span class="hljs-string">&#x27;hincrby&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>);<br>    redis.call(<span class="hljs-string">&#x27;expire&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>假设值为：KEYS:[lock], ARGV[uuid, expire]</p>
<p>如果锁不存在或者这是自己的锁，就通过hincrby（不存在就新增并加1，存在就加1）获取锁或者锁次数加1。</p>
<h3 id="2-6-2-解锁脚本"><a href="#2-6-2-解锁脚本" class="headerlink" title="2.6.2. 解锁脚本"></a>2.6.2. 解锁脚本</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 判断 hash set 可重入 key 的值是否等于 0</span><br><span class="hljs-comment">-- 如果为 nil 代表 自己的锁已不存在，在尝试解其他线程的锁，解锁失败</span><br><span class="hljs-comment">-- 如果为 0 代表 可重入次数被减 1</span><br><span class="hljs-comment">-- 如果为 1 代表 该可重入 key 解锁成功</span><br><span class="hljs-keyword">if</span>(redis.call(<span class="hljs-string">&#x27;hexists&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span> <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>; <br><span class="hljs-keyword">elseif</span>(redis.call(<span class="hljs-string">&#x27;hincrby&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>], <span class="hljs-number">-1</span>) &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <br><span class="hljs-keyword">else</span> <br>    redis.call(<span class="hljs-string">&#x27;del&#x27;</span>, KEYS[<span class="hljs-number">1</span>]); <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <br><span class="hljs-keyword">end</span>;<br></code></pre></td></tr></table></figure>



<h3 id="2-6-3-代码实现"><a href="#2-6-3-代码实现" class="headerlink" title="2.6.3. 代码实现"></a>2.6.3. 代码实现</h3><p>由于加解锁代码量相对较多，这里可以封装成一个工具类：</p>
<p> <img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504095916188.png" srcset="/img/loading.gif" lazyload alt="image-20220504095916188"></p>
<p>DistributedLockClient工厂类具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockClient</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">private</span> String uuid;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedLockClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.uuid = UUID.randomUUID().toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> DistributedRedisLock <span class="hljs-title function_">getRedisLock</span><span class="hljs-params">(String lockName)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributedRedisLock</span>(redisTemplate, lockName, uuid);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DistributedRedisLock实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">private</span> String lockName;<br><br>    <span class="hljs-keyword">private</span> String uuid;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">expire</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedRedisLock</span><span class="hljs-params">(StringRedisTemplate redisTemplate, String lockName, String uuid)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;<br>        <span class="hljs-built_in">this</span>.lockName = lockName;<br>        <span class="hljs-built_in">this</span>.uuid = uuid;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.tryLock();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.tryLock(-<span class="hljs-number">1L</span>, TimeUnit.SECONDS);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (time != -<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-built_in">this</span>.expire = unit.toSeconds(time);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;exists&#x27;, KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 1 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[1], 1) &quot;</span> +<br>                <span class="hljs-string">&quot;   redis.call(&#x27;expire&#x27;, KEYS[1], ARGV[2]) &quot;</span> +<br>                <span class="hljs-string">&quot;   return 1 &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>        <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">this</span>.redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), getId(), String.valueOf(expire)))&#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解锁方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 0 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   return nil &quot;</span> +<br>                <span class="hljs-string">&quot;elseif redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[1], -1) == 0 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   return redis.call(&#x27;del&#x27;, KEYS[1]) &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName), getId());<br>        <span class="hljs-keyword">if</span> (flag == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">&quot;this lock doesn&#x27;t belong to you!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给线程拼接唯一标识</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> uuid + <span class="hljs-string">&quot;:&quot;</span> + Thread.currentThread().getId();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="2-6-4-使用及测试"><a href="#2-6-4-使用及测试" class="headerlink" title="2.6.4. 使用及测试"></a>2.6.4. 使用及测试</h3><p>在业务代码中使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DistributedRedisLock</span> <span class="hljs-variable">redisLock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.distributedLockClient.getRedisLock(<span class="hljs-string">&quot;lock&quot;</span>);<br>    redisLock.lock();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 1. 查询库存信息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>).toString();<br><br>        <span class="hljs-comment">// 2. 判断库存是否充足</span><br>        <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.length() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> Integer.valueOf(stock);<br>            <span class="hljs-keyword">if</span> (st &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 3.扣减库存</span><br>                redisTemplate.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, String.valueOf(--st));<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        redisLock.unlock();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606747747780.png" srcset="/img/loading.gif" lazyload alt="1606747747780"></p>
<p>测试可重入性：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504101636357.png" srcset="/img/loading.gif" lazyload alt="image-20220504101636357"></p>
<h2 id="2-7-自动续期"><a href="#2-7-自动续期" class="headerlink" title="2.7. 自动续期"></a>2.7. 自动续期</h2><p>lua脚本：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>(redis.call(<span class="hljs-string">&#x27;hexists&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span> <br>    redis.call(<span class="hljs-string">&#x27;expire&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]); <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <br><span class="hljs-keyword">else</span> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在RedisDistributeLock中添加renewExpire方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">private</span> String lockName;<br><br>    <span class="hljs-keyword">private</span> String uuid;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">expire</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedRedisLock</span><span class="hljs-params">(StringRedisTemplate redisTemplate, String lockName, String uuid)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;<br>        <span class="hljs-built_in">this</span>.lockName = lockName;<br>        <span class="hljs-built_in">this</span>.uuid = uuid + <span class="hljs-string">&quot;:&quot;</span> + Thread.currentThread().getId();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.tryLock();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.tryLock(-<span class="hljs-number">1L</span>, TimeUnit.SECONDS);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (time != -<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-built_in">this</span>.expire = unit.toSeconds(time);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;exists&#x27;, KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 1 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[1], 1) &quot;</span> +<br>                <span class="hljs-string">&quot;   redis.call(&#x27;expire&#x27;, KEYS[1], ARGV[2]) &quot;</span> +<br>                <span class="hljs-string">&quot;   return 1 &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>        <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">this</span>.redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuid, String.valueOf(expire)))&#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>        &#125;<br>        <span class="hljs-comment">// 加锁成功，返回之前，开启定时器自动续期</span><br>        <span class="hljs-built_in">this</span>.renewExpire();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解锁方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 0 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   return nil &quot;</span> +<br>                <span class="hljs-string">&quot;elseif redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[1], -1) == 0 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   return redis.call(&#x27;del&#x27;, KEYS[1]) &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName), uuid);<br>        <span class="hljs-keyword">if</span> (flag == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">&quot;this lock doesn&#x27;t belong to you!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// String getId()&#123;</span><br>    <span class="hljs-comment">//     return this.uuid + &quot;:&quot; + Thread.currentThread().getId();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renewExpire</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 1 &quot;</span> +<br>                <span class="hljs-string">&quot;then &quot;</span> +<br>                <span class="hljs-string">&quot;   return redis.call(&#x27;expire&#x27;, KEYS[1], ARGV[2]) &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>().schedule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">if</span> (redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuid, String.valueOf(expire))) &#123;<br>                    renewExpire();<br>                &#125;<br>            &#125;<br>        &#125;, <span class="hljs-built_in">this</span>.expire * <span class="hljs-number">1000</span> / <span class="hljs-number">3</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>在tryLock方法中使用：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504100503780.png" srcset="/img/loading.gif" lazyload alt="image-20220504100503780"></p>
<p>构造方法作如下修改：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504100728343.png" srcset="/img/loading.gif" lazyload alt="image-20220504100728343"></p>
<p>解锁方法作如下修改：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220504100850162.png" srcset="/img/loading.gif" lazyload alt="image-20220504100850162"></p>
<h2 id="2-8-手写分步式锁小结"><a href="#2-8-手写分步式锁小结" class="headerlink" title="2.8. 手写分步式锁小结"></a>2.8. 手写分步式锁小结</h2><p>特征：</p>
<ol>
<li><p>独占排他：setnx</p>
</li>
<li><p>防死锁：</p>
<p>redis客户端程序获取到锁之后，立马宕机。给锁添加过期时间</p>
<p>不可重入：可重入</p>
</li>
<li><p>防误删：</p>
<p>先判断是否自己的锁才能删除</p>
</li>
<li><p>原子性：</p>
<p>加锁和过期时间之间：set k v ex 3 nx</p>
<p>判断和释放锁之间：lua脚本</p>
</li>
<li><p>可重入性：hash（key field value） + lua脚本 </p>
</li>
<li><p>自动续期：Timer定时器 + lua脚本</p>
</li>
<li><p>在集群情况下，导致锁机制失效：</p>
<ol>
<li>客户端程序10010，从主中获取锁</li>
<li>从还没来得及同步数据，主挂了</li>
<li>于是从升级为主</li>
<li>客户端程序10086就从新主中获取到锁，导致锁机制失效</li>
</ol>
</li>
</ol>
<p>锁操作：</p>
<p>加锁：</p>
<ol>
<li><p>setnx：独占排他   死锁、不可重入、原子性</p>
</li>
<li><p>set k v ex 30 nx：独占排他、死锁 		不可重入 </p>
</li>
<li><p>hash + lua脚本：可重入锁</p>
<ol>
<li>判断锁是否被占用（exists），如果没有被占用则直接获取锁（hset&#x2F;hincrby）并设置过期时间（expire）</li>
<li>如果锁被占用，则判断是否当前线程占用的（hexists），如果是则重入（hincrby）并重置过期时间（expire）</li>
<li>否则获取锁失败，将来代码中重试</li>
</ol>
</li>
<li><p>Timer定时器 + lua脚本：实现锁的自动续期</p>
<p>判断锁是否自己的锁（hexists &#x3D;&#x3D; 1），如果是自己的锁则执行expire重置过期时间</p>
</li>
</ol>
<p>解锁 </p>
<ol>
<li>del：导致误删</li>
<li>先判断再删除同时保证原子性：lua脚本</li>
<li>hash + lua脚本：可重入<br>  1. 判断当前线程的锁是否存在，不存在则返回nil，将来抛出异常<ol start="2">
<li>存在则直接减1（hincrby -1），判断减1后的值是否为0，为0则释放锁（del），并返回1</li>
<li>不为0，则返回0</li>
</ol>
</li>
</ol>
<p>重试：递归 循环 </p>
<h2 id="2-9-红锁算法"><a href="#2-9-红锁算法" class="headerlink" title="2.9. 红锁算法"></a>2.9. 红锁算法</h2><p>redis集群状态下的问题：</p>
<ol>
<li>客户端A从master获取到锁</li>
<li>在master将锁同步到slave之前，master宕掉了。</li>
<li>slave节点被晋级为master节点</li>
<li>客户端B取得了同一个资源被客户端A已经获取到的另外一个锁。</li>
</ol>
<p><strong>安全失效</strong>！</p>
<p>解决集群下锁失效，参照redis官方网站针对redlock文档：<a target="_blank" rel="noopener" href="https://redis.io/topics/distlock">https://redis.io/topics/distlock</a></p>
<p>在算法的分布式版本中，我们假设有N个Redis服务器。这些节点是完全独立的，因此我们不使用复制或任何其他隐式协调系统。<strong>前几节已经描述了如何在单个实例中安全地获取和释放锁，在分布式锁算法中，将使用相同的方法在单个实例中获取和释放锁。</strong>将N设置为5是一个合理的值，因此需要在不同的计算机或虚拟机上运行5个Redis主服务器，确保它们以独立的方式发生故障。</p>
<p>为了获取锁，客户端执行以下操作：</p>
<ol>
<li>客户端以毫秒为单位获取当前时间的时间戳，作为<strong>起始时间</strong>。</li>
<li>客户端尝试在所有N个实例中顺序使用相同的键名、相同的随机值来获取锁定。每个实例尝试获取锁都需要时间，客户端应该设置一个远小于总锁定时间的超时时间。例如，如果自动释放时间为10秒，则<strong>尝试获取锁的超时时间</strong>可能在5到50毫秒之间。这样可以防止客户端长时间与处于故障状态的Redis节点进行通信：如果某个实例不可用，尽快尝试与下一个实例进行通信。</li>
<li>客户端获取当前时间 减去在步骤1中获得的<strong>起始时间</strong>，来计算<strong>获取锁所花费的时间</strong>。当且仅当客户端能够在大多数实例（至少3个）中获取锁时，并且获取锁所花费的总时间小于锁有效时间，则认为已获取锁。</li>
<li>如果获取了锁，则将锁有效时间减去 <strong>获取锁所花费的时间</strong>，如步骤3中所计算。</li>
<li>如果客户端由于某种原因（无法锁定N &#x2F; 2 + 1个实例或有效时间为负）而未能获得该锁，它将尝试解锁所有实例（即使没有锁定成功的实例）。</li>
</ol>
<p>每台计算机都有一个本地时钟，我们通常可以依靠不同的计算机来产生很小的时钟漂移。只有在拥有锁的客户端将在锁有效时间内（如步骤3中获得的）减去一段时间（仅几毫秒）的情况下终止工作，才能保证这一点。以补偿进程之间的时钟漂移</p>
<p>当客户端无法获取锁时，它应该在随机延迟后重试，以避免同时获取同一资源的多个客户端之间不同步（这可能会导致脑裂的情况：没人胜）。同样，客户端在大多数Redis实例中尝试获取锁的速度越快，出现裂脑情况（以及需要重试）的窗口就越小，因此理想情况下，客户端应尝试将SET命令发送到N个实例同时使用多路复用。</p>
<p>值得强调的是，对于未能获得大多数锁的客户端，尽快释放（部分）获得的锁有多么重要，这样就不必等待锁定期满才能再次获得锁（但是，如果发生了网络分区，并且客户端不再能够与Redis实例进行通信，则在等待密钥到期时需要付出可用性损失）。</p>
<h2 id="2-10-redisson中的分布式锁"><a href="#2-10-redisson中的分布式锁" class="headerlink" title="2.10. redisson中的分布式锁"></a>2.10. redisson中的分布式锁</h2><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220501155501783.png" srcset="/img/loading.gif" lazyload alt="image-20220501155501783"></p>
<p>​		Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish &#x2F; Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1568176834908.png" srcset="/img/loading.gif" lazyload alt="1568176834908"></p>
<p>官方文档地址：<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki">https://github.com/redisson/redisson/wiki</a></p>
<h3 id="2-10-1-可重入锁（Reentrant-Lock）"><a href="#2-10-1-可重入锁（Reentrant-Lock）" class="headerlink" title="2.10.1. 可重入锁（Reentrant Lock）"></a>2.10.1. 可重入锁（Reentrant Lock）</h3><p>基于Redis的Redisson分布式可重入锁<code>RLock</code> Java对象实现了<code>java.util.concurrent.locks.Lock</code>接口。</p>
<p>大家都知道，如果负责储存这个分布式锁的Redisson节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗检查锁的超时时间是30秒钟，也可以通过修改<code>Config.lockWatchdogTimeout</code>来另行指定。</p>
<p><code>RLock</code>对象完全符合Java的Lock规范。也就是说只有拥有锁的进程才能解锁，其他进程解锁则会抛出<code>IllegalMonitorStateException</code>错误。</p>
<p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br><span class="hljs-comment">// 最常见的使用方法</span><br>lock.lock();<br><br><span class="hljs-comment">// 加锁以后10秒钟自动解锁</span><br><span class="hljs-comment">// 无需调用unlock方法手动解锁</span><br>lock.lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><br><span class="hljs-comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><span class="hljs-keyword">if</span> (res) &#123;<br>   <span class="hljs-keyword">try</span> &#123;<br>     ...<br>   &#125; <span class="hljs-keyword">finally</span> &#123;<br>       lock.unlock();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<ol start="2">
<li>添加配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        <span class="hljs-comment">// 可以用&quot;rediss://&quot;来启用SSL连接</span><br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://172.16.116.100:6379&quot;</span>);<br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<ol start="3">
<li>代码中使用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 加锁，获取锁失败重试</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redissonClient.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br>    lock.lock();<br><br>    <span class="hljs-comment">// 先查询库存是否充足</span><br>    <span class="hljs-type">Stock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.stockMapper.selectById(<span class="hljs-number">1L</span>);<br>    <span class="hljs-comment">// 再减库存</span><br>    <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.getCount() &gt; <span class="hljs-number">0</span>)&#123;<br>        stock.setCount(stock.getCount() - <span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">this</span>.stockMapper.updateById(stock);<br>    &#125;<br><br>    <span class="hljs-comment">// 释放锁</span><br>    lock.unlock();<br>&#125;<br></code></pre></td></tr></table></figure>



<ol start="4">
<li>压力测试</li>
</ol>
<p>性能跟我们手写的区别不大。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606958454966.png" srcset="/img/loading.gif" lazyload alt="1606958454966"></p>
<p>数据库也没有问题</p>
<h3 id="2-10-2-公平锁（Fair-Lock）"><a href="#2-10-2-公平锁（Fair-Lock）" class="headerlink" title="2.10.2. 公平锁（Fair Lock）"></a>2.10.2. 公平锁（Fair Lock）</h3><p>基于Redis的Redisson分布式可重入公平锁也是实现了<code>java.util.concurrent.locks.Lock</code>接口的一种<code>RLock</code>对象。同时还提供了<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockAsync.html">异步（Async）</a>、<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockReactive.html">反射式（Reactive）</a>和<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockRx.html">RxJava2标准</a>的接口。它保证了当多个Redisson客户端线程同时请求加锁时，优先分配给先发出请求的线程。所有请求线程会在一个队列中排队，当某个线程出现宕机时，Redisson会等待5秒后继续下一个线程，也就是说如果前面有5个线程都处于等待状态，那么后面的线程会等待至少25秒。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RLock</span> <span class="hljs-variable">fairLock</span> <span class="hljs-operator">=</span> redisson.getFairLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br><span class="hljs-comment">// 最常见的使用方法</span><br>fairLock.lock();<br><br><span class="hljs-comment">// 10秒钟以后自动解锁</span><br><span class="hljs-comment">// 无需调用unlock方法手动解锁</span><br>fairLock.lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><br><span class="hljs-comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> fairLock.tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>fairLock.unlock();<br></code></pre></td></tr></table></figure>



<h3 id="2-10-3-联锁（MultiLock）"><a href="#2-10-3-联锁（MultiLock）" class="headerlink" title="2.10.3. 联锁（MultiLock）"></a>2.10.3. 联锁（MultiLock）</h3><p>基于Redis的Redisson分布式联锁<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/RedissonMultiLock.html"><code>RedissonMultiLock</code></a>对象可以将多个<code>RLock</code>对象关联为一个联锁，每个<code>RLock</code>对象实例可以来自于不同的Redisson实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RLock</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> redissonInstance1.getLock(<span class="hljs-string">&quot;lock1&quot;</span>);<br><span class="hljs-type">RLock</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> redissonInstance2.getLock(<span class="hljs-string">&quot;lock2&quot;</span>);<br><span class="hljs-type">RLock</span> <span class="hljs-variable">lock3</span> <span class="hljs-operator">=</span> redissonInstance3.getLock(<span class="hljs-string">&quot;lock3&quot;</span>);<br><br><span class="hljs-type">RedissonMultiLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonMultiLock</span>(lock1, lock2, lock3);<br><span class="hljs-comment">// 同时加锁：lock1 lock2 lock3</span><br><span class="hljs-comment">// 所有的锁都上锁成功才算成功。</span><br>lock.lock();<br>...<br>lock.unlock();<br></code></pre></td></tr></table></figure>



<h3 id="2-10-4-红锁（RedLock）"><a href="#2-10-4-红锁（RedLock）" class="headerlink" title="2.10.4. 红锁（RedLock）"></a>2.10.4. 红锁（RedLock）</h3><p>基于Redis的Redisson红锁<code>RedissonRedLock</code>对象实现了<a target="_blank" rel="noopener" href="http://redis.cn/topics/distlock.html">Redlock</a>介绍的加锁算法。该对象也可以用来将多个<code>RLock</code>对象关联为一个红锁，每个<code>RLock</code>对象实例可以来自于不同的Redisson实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RLock</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> redissonInstance1.getLock(<span class="hljs-string">&quot;lock1&quot;</span>);<br><span class="hljs-type">RLock</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> redissonInstance2.getLock(<span class="hljs-string">&quot;lock2&quot;</span>);<br><span class="hljs-type">RLock</span> <span class="hljs-variable">lock3</span> <span class="hljs-operator">=</span> redissonInstance3.getLock(<span class="hljs-string">&quot;lock3&quot;</span>);<br><br><span class="hljs-type">RedissonRedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonRedLock</span>(lock1, lock2, lock3);<br><span class="hljs-comment">// 同时加锁：lock1 lock2 lock3</span><br><span class="hljs-comment">// 红锁在大部分节点上加锁成功就算成功。</span><br>lock.lock();<br>...<br>lock.unlock();<br></code></pre></td></tr></table></figure>



<h3 id="2-10-5-读写锁（ReadWriteLock）"><a href="#2-10-5-读写锁（ReadWriteLock）" class="headerlink" title="2.10.5. 读写锁（ReadWriteLock）"></a>2.10.5. 读写锁（ReadWriteLock）</h3><p>基于Redis的Redisson分布式可重入读写锁<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.4.3/org/redisson/api/RReadWriteLock.html"><code>RReadWriteLock</code></a> Java对象实现了<code>java.util.concurrent.locks.ReadWriteLock</code>接口。其中读锁和写锁都继承了<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8#81-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81reentrant-lock">RLock</a>接口。</p>
<p>分布式可重入读写锁允许同时有多个读锁和一个写锁处于加锁状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwlock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">&quot;anyRWLock&quot;</span>);<br><span class="hljs-comment">// 最常见的使用方法</span><br>rwlock.readLock().lock();<br><span class="hljs-comment">// 或</span><br>rwlock.writeLock().lock();<br><br><span class="hljs-comment">// 10秒钟以后自动解锁</span><br><span class="hljs-comment">// 无需调用unlock方法手动解锁</span><br>rwlock.readLock().lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><span class="hljs-comment">// 或</span><br>rwlock.writeLock().lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><br><span class="hljs-comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> rwlock.readLock().tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><span class="hljs-comment">// 或</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> rwlock.writeLock().tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>...<br>lock.unlock();<br></code></pre></td></tr></table></figure>



<p>添加StockController方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;test/read&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testRead</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> stockService.testRead();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;测试读&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@GetMapping(&quot;test/write&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testWrite</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> stockService.testWrite();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;测试写&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>添加StockService方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testRead</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redissonClient.getReadWriteLock(<span class="hljs-string">&quot;rwLock&quot;</span>);<br>    rwLock.readLock().lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><br>    System.out.println(<span class="hljs-string">&quot;测试读锁。。。。&quot;</span>);<br>    <span class="hljs-comment">// rwLock.readLock().unlock();</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testWrite</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redissonClient.getReadWriteLock(<span class="hljs-string">&quot;rwLock&quot;</span>);<br>    rwLock.writeLock().lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br><br>    System.out.println(<span class="hljs-string">&quot;测试写锁。。。。&quot;</span>);<br>    <span class="hljs-comment">// rwLock.writeLock().unlock();</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>打开开两个浏览器窗口测试：</p>
<ul>
<li>同时访问写：一个写完之后，等待一会儿（约10s），另一个写开始</li>
<li>同时访问读：不用等待</li>
<li>先写后读：读要等待（约10s）写完成</li>
<li>先读后写：写要等待（约10s）读完成</li>
</ul>
<h3 id="2-10-6-信号量（Semaphore）"><a href="#2-10-6-信号量（Semaphore）" class="headerlink" title="2.10.6. 信号量（Semaphore）"></a>2.10.6. 信号量（Semaphore）</h3><p>基于Redis的Redisson的分布式信号量（<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphore.html">Semaphore</a>）Java对象<code>RSemaphore</code>采用了与<code>java.util.concurrent.Semaphore</code>相似的接口和用法。同时还提供了<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreAsync.html">异步（Async）</a>、<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreReactive.html">反射式（Reactive）</a>和<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreRx.html">RxJava2标准</a>的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RSemaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> redisson.getSemaphore(<span class="hljs-string">&quot;semaphore&quot;</span>);<br>semaphore.trySetPermits(<span class="hljs-number">3</span>);<br>semaphore.acquire();<br>semaphore.release();<br></code></pre></td></tr></table></figure>



<p>在StockController添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;test/semaphore&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testSemaphore</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">this</span>.stockService.testSemaphore();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;测试信号量&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在StockService添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSemaphore</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redissonClient.getSemaphore(<span class="hljs-string">&quot;semaphore&quot;</span>);<br>    semaphore.trySetPermits(<span class="hljs-number">3</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        semaphore.acquire();<br><br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);<br>        System.out.println(System.currentTimeMillis());<br><br>        semaphore.release();<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>添加测试用例：并发10次，循环一次</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606961296212.png" srcset="/img/loading.gif" lazyload alt="1606961296212"></p>
<p>控制台效果：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns">控制台<span class="hljs-number">1</span>：<br><span class="hljs-number">1606960790234</span><br><span class="hljs-number">1606960800337</span><br><span class="hljs-number">1606960800443</span><br><span class="hljs-number">1606960805248</span><br><br>控制台<span class="hljs-number">2</span>：<br><span class="hljs-number">1606960790328</span><br><span class="hljs-number">1606960795332</span><br><span class="hljs-number">1606960800245</span><br><br>控制台<span class="hljs-number">3</span>：<br><span class="hljs-number">1606960790433</span><br><span class="hljs-number">1606960795238</span><br><span class="hljs-number">1606960795437</span><br></code></pre></td></tr></table></figure>



<p>由此可知：</p>
<p>1606960790秒有3次请求进来：每个控制台各1次</p>
<p>1606960795秒有3次请求进来：控制台2有1次，控制台3有2次</p>
<p>1606960800秒有3次请求进来：控制台1有2次，控制台2有1次</p>
<p>1606960805秒有1次请求进来：控制台1有1次</p>
<h3 id="2-10-7-闭锁（CountDownLatch）"><a href="#2-10-7-闭锁（CountDownLatch）" class="headerlink" title="2.10.7. 闭锁（CountDownLatch）"></a>2.10.7. 闭锁（CountDownLatch）</h3><p>基于Redisson的Redisson分布式闭锁（<a target="_blank" rel="noopener" href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RCountDownLatch.html">CountDownLatch</a>）Java对象<code>RCountDownLatch</code>采用了与<code>java.util.concurrent.CountDownLatch</code>相似的接口和用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> redisson.getCountDownLatch(<span class="hljs-string">&quot;anyCountDownLatch&quot;</span>);<br>latch.trySetCount(<span class="hljs-number">1</span>);<br>latch.await();<br><br><span class="hljs-comment">// 在其他线程或其他JVM里</span><br><span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> redisson.getCountDownLatch(<span class="hljs-string">&quot;anyCountDownLatch&quot;</span>);<br>latch.countDown();<br></code></pre></td></tr></table></figure>

<p>需要两个方法：一个等待，一个计数countDown</p>
<p>给StockController添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;test/latch&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testLatch</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">this</span>.stockService.testLatch();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;班长锁门。。。&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@GetMapping(&quot;test/countdown&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testCountDown</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">this</span>.stockService.testCountDown();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;出来了一位同学&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>给StockService添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLatch</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redissonClient.getCountDownLatch(<span class="hljs-string">&quot;latch&quot;</span>);<br>    latch.trySetCount(<span class="hljs-number">6</span>);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        latch.await();<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCountDown</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.redissonClient.getCountDownLatch(<span class="hljs-string">&quot;latch&quot;</span>);<br>    latch.trySetCount(<span class="hljs-number">6</span>);<br><br>    latch.countDown();<br>&#125;<br></code></pre></td></tr></table></figure>



<p>重启测试，打开两个页面：当第二个请求执行6次之后，第一个请求才会执行。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606962536746.png" srcset="/img/loading.gif" lazyload alt="1606962536746"></p>
<h1 id="3-基于zookeeper实现分布式锁"><a href="#3-基于zookeeper实现分布式锁" class="headerlink" title="3. 基于zookeeper实现分布式锁"></a>3. 基于zookeeper实现分布式锁</h1><p>实现分布式锁目前有三种流行方案，分别为基于数据库、Redis、Zookeeper的方案。这里主要介绍基于zk怎么实现分布式锁。在实现分布式锁之前，先回顾zookeeper的相关知识点</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220622191952608.png" srcset="/img/loading.gif" lazyload alt="image-20220622191952608"></p>
<h2 id="3-1-知识点回顾"><a href="#3-1-知识点回顾" class="headerlink" title="3.1. 知识点回顾"></a>3.1. 知识点回顾</h2><h3 id="3-1-1-安装启动"><a href="#3-1-1-安装启动" class="headerlink" title="3.1.1. 安装启动"></a>3.1.1. 安装启动</h3><p>安装：把zk安装包上传到&#x2F;opt目录下，并切换到&#x2F;opt目录下，执行以下指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">解压</span><br>tar -zxvf zookeeper-3.7.0-bin.tar.gz<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重命名</span><br>mv apache-zookeeper-3.7.0-bin/ zookeeper<br><span class="hljs-meta prompt_"># </span><span class="language-bash">打开zookeeper根目录</span><br>cd /opt/zookeeper<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建一个数据目录，备用</span><br>mkdir data<br><span class="hljs-meta prompt_"># </span><span class="language-bash">打开zk的配置目录</span><br>cd /opt/zookeeper/conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">copy配置文件，zk启动时会加载zoo.cfg文件</span><br>cp zoo_sample.cfg zoo.cfg<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编辑配置文件</span><br>vim zoo.cfg<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改dataDir参数为之前创建的数据目录：/opt/zookeeper/data</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">切换到bin目录</span><br>cd /opt/zookeeper/bin<br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span> <br>./zkServer.sh start<br>./zkServer.sh status # 查看启动状态<br>./zkServer.sh stop # 停止<br>./zkServer.sh restart # 重启<br>./zkCli.sh # 查看zk客户端<br></code></pre></td></tr></table></figure>

<p>如下，说明启动成功：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220501175644704.png" srcset="/img/loading.gif" lazyload alt="image-20220501175644704"></p>
<h3 id="3-1-2-相关概念"><a href="#3-1-2-相关概念" class="headerlink" title="3.1.2. 相关概念"></a>3.1.2. 相关概念</h3><p>Zookeeper提供一个多层级的节点命名空间（节点称为znode），每个节点都用一个以斜杠（&#x2F;）分隔的路径表示，而且每个节点都有父节点（根节点除外），非常类似于文件系统。并且每个节点都是唯一的。</p>
<p>znode节点有四种类型：</p>
<ul>
<li><strong>PERSISTENT</strong>：永久节点。客户端与zookeeper断开连接后，该节点依旧存在</li>
<li><strong>EPHEMERAL</strong>：临时节点。客户端与zookeeper断开连接后，该节点被删除</li>
<li><strong>PERSISTENT_SEQUENTIAL</strong>：永久节点、序列化。客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号</li>
<li><strong>EPHEMERAL_SEQUENTIAL</strong>：临时节点、序列化。客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号</li>
</ul>
<p>创建这四种节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">[zk: localhost:2181(CONNECTED) 0] create /aa test  # 创建持久化节点<br>Created /aa<br>[zk: localhost:2181(CONNECTED) 1] create -s /bb test  # 创建持久序列化节点<br>Created /bb0000000001<br>[zk: localhost:2181(CONNECTED) 2] create -e /cc test  # 创建临时节点<br>Created /cc<br>[zk: localhost:2181(CONNECTED) 3] create -e -s /dd test  # 创建临时序列化节点<br>Created /dd0000000003<br>[zk: localhost:2181(CONNECTED) 4] ls /   # 查看某个节点下的子节点<br>[aa, bb0000000001, cc, dd0000000003, zookeeper]<br>[zk: localhost:2181(CONNECTED) 5] stat /  # 查看某个节点的状态<br>cZxid = 0x0<br>ctime = Thu Jan 01 08:00:00 CST 1970<br>mZxid = 0x0<br>mtime = Thu Jan 01 08:00:00 CST 1970<br>pZxid = 0x5<br>cversion = 3<br>dataVersion = 0<br>aclVersion = 0<br>ephemeralOwner = 0x0<br>dataLength = 0<br>numChildren = 5<br>[zk: localhost:2181(CONNECTED) 6] get /aa  # 查看某个节点的内容<br>test<br>[zk: localhost:2181(CONNECTED) 11] delete /aa  # 删除某个节点<br>[zk: localhost:2181(CONNECTED) 7] ls /  # 再次查看<br>[bb0000000001, cc, dd0000000003, zookeeper]<br></code></pre></td></tr></table></figure>



<p>事件监听：在读取数据时，我们可以同时对节点设置事件监听，当节点数据或结构变化时，zookeeper会通知客户端。当前zookeeper针对节点的监听有如下四种事件：</p>
<ol>
<li><p>节点创建：stat -w &#x2F;xx</p>
<p>当&#x2F;xx节点创建时：NodeCreated</p>
</li>
<li><p>节点删除：stat -w &#x2F;xx</p>
<p>当&#x2F;xx节点删除时：NodeDeleted</p>
</li>
<li><p>节点数据修改：get -w &#x2F;xx</p>
<p>当&#x2F;xx节点数据发生变化时：NodeDataChanged</p>
</li>
<li><p>子节点变更：ls -w &#x2F;xx</p>
<p>当&#x2F;xx节点的子节点创建或者删除时：NodeChildChanged</p>
</li>
</ol>
<h3 id="3-1-3-java客户端"><a href="#3-1-3-java客户端" class="headerlink" title="3.1.3. java客户端"></a>3.1.3. java客户端</h3><p>ZooKeeper的java客户端有：原生客户端、ZkClient、Curator框架（类似于redisson，有很多功能性封装）。</p>
<ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>常用api及其方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZkTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KeeperException, InterruptedException &#123;<br><br>        <span class="hljs-comment">// 获取zookeeper链接</span><br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">ZooKeeper</span> <span class="hljs-variable">zooKeeper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            zooKeeper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZooKeeper</span>(<span class="hljs-string">&quot;172.16.116.100:2181&quot;</span>, <span class="hljs-number">30000</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent event)</span> &#123;<br>                    <span class="hljs-keyword">if</span> (Event.KeeperState.SyncConnected.equals(event.getState()) <br>                            &amp;&amp; Event.EventType.None.equals(event.getType())) &#123;<br>                        System.out.println(<span class="hljs-string">&quot;获取链接成功。。。。。。&quot;</span> + event);<br>                        countDownLatch.countDown();<br>                    &#125;<br>                &#125;<br>            &#125;);<br><br>            countDownLatch.await();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">// 创建一个节点，1-节点路径 2-节点内容 3-节点的访问权限 4-节点类型</span><br>        <span class="hljs-comment">// OPEN_ACL_UNSAFE：任何人可以操作该节点</span><br>        <span class="hljs-comment">// CREATOR_ALL_ACL：创建者拥有所有访问权限</span><br>        <span class="hljs-comment">// READ_ACL_UNSAFE: 任何人都可以读取该节点</span><br>        <span class="hljs-comment">// zooKeeper.create(&quot;/atguigu/aa&quot;, &quot;haha~~&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br>        zooKeeper.create(<span class="hljs-string">&quot;/test&quot;</span>, <span class="hljs-string">&quot;haha~~&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);<br>        <span class="hljs-comment">// zooKeeper.create(&quot;/atguigu/cc&quot;, &quot;haha~~&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);</span><br>        <span class="hljs-comment">// zooKeeper.create(&quot;/atguigu/dd&quot;, &quot;haha~~&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br>        <span class="hljs-comment">// zooKeeper.create(&quot;/atguigu/dd&quot;, &quot;haha~~&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br>        <span class="hljs-comment">// zooKeeper.create(&quot;/atguigu/dd&quot;, &quot;haha~~&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><br>        <span class="hljs-comment">// 判断节点是否存在</span><br>        <span class="hljs-type">Stat</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> zooKeeper.exists(<span class="hljs-string">&quot;/test&quot;</span>, <span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">if</span> (stat != <span class="hljs-literal">null</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;当前节点存在！&quot;</span> + stat.getVersion());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;当前节点不存在！&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 判断节点是否存在，同时添加监听</span><br>        zooKeeper.exists(<span class="hljs-string">&quot;/test&quot;</span>, event -&gt; &#123;<br>        &#125;);<br><br>        <span class="hljs-comment">// 获取一个节点的数据</span><br>        <span class="hljs-type">byte</span>[] data = zooKeeper.getData(<span class="hljs-string">&quot;/atguigu/ss0000000001&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data));<br><br>        <span class="hljs-comment">// 查询一个节点的所有子节点</span><br>        List&lt;String&gt; children = zooKeeper.getChildren(<span class="hljs-string">&quot;/test&quot;</span>, <span class="hljs-literal">false</span>);<br>        System.out.println(children);<br><br>        <span class="hljs-comment">// 更新</span><br>        zooKeeper.setData(<span class="hljs-string">&quot;/test&quot;</span>, <span class="hljs-string">&quot;wawa...&quot;</span>.getBytes(), stat.getVersion());<br><br>        <span class="hljs-comment">// 删除一个节点</span><br>        <span class="hljs-comment">//zooKeeper.delete(&quot;/test&quot;, -1);</span><br><br>        <span class="hljs-keyword">if</span> (zooKeeper != <span class="hljs-literal">null</span>)&#123;<br>            zooKeeper.close();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3-2-思路分析"><a href="#3-2-思路分析" class="headerlink" title="3.2. 思路分析"></a>3.2. 思路分析</h2><p>分布式锁的步骤：</p>
<ol>
<li>获取锁：create一个节点</li>
<li>删除锁：delete一个节点</li>
<li>重试：没有获取到锁的请求重试</li>
</ol>
<p>参照redis分布式锁的特点：</p>
<ol>
<li>互斥 排他</li>
<li>防死锁：<ol>
<li>可自动释放锁（临时节点） ：获得锁之后客户端所在机器宕机了，客户端没有主动删除子节点；如果创建的是永久的节点，那么这个锁永远不会释放，导致死锁；由于创建的是临时节点，客户端宕机后，过了一定时间zookeeper没有收到客户端的心跳包判断会话失效，将临时节点删除从而释放锁。</li>
<li>可重入锁：借助于ThreadLocal</li>
</ol>
</li>
<li>防误删：宕机自动释放临时节点，不需要设置过期时间，也就不存在误删问题。</li>
<li>加锁&#x2F;解锁要具备原子性</li>
<li>单点问题：使用Zookeeper可以有效的解决单点问题，ZK一般是集群部署的。</li>
<li>集群问题：zookeeper集群是强一致性的，只要集群中有半数以上的机器存活，就可以对外提供服务。</li>
</ol>
<h2 id="3-3-基本实现"><a href="#3-3-基本实现" class="headerlink" title="3.3. 基本实现"></a>3.3. 基本实现</h2><p>实现思路：</p>
<ol>
<li>多个请求同时添加一个相同的临时节点，只有一个可以添加成功。添加成功的获取到锁</li>
<li>执行业务逻辑</li>
<li>完成业务流程后，删除节点释放锁。</li>
</ol>
<p>由于zookeeper获取链接是一个耗时过程，这里可以在项目启动时，初始化链接，并且只初始化一次。借助于spring特性，代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZkClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">connectString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;172.16.116.100:2181&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROOT_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/distributed&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> ZooKeeper zooKeeper;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 连接zookeeper服务器</span><br>            <span class="hljs-built_in">this</span>.zooKeeper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZooKeeper</span>(connectString, <span class="hljs-number">30000</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent event)</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;获取链接成功！！&quot;</span>);<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">// 创建分布式锁根节点</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.zooKeeper.exists(ROOT_PATH, <span class="hljs-literal">false</span>) == <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-built_in">this</span>.zooKeeper.create(ROOT_PATH, <span class="hljs-literal">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;获取链接失败！&quot;</span>);<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@PreDestroy</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (zooKeeper != <span class="hljs-literal">null</span>)&#123;<br>                zooKeeper.close();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 初始化zk分布式锁对象方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> lockName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ZkDistributedLock <span class="hljs-title function_">getZkDistributedLock</span><span class="hljs-params">(String lockName)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZkDistributedLock</span>(zooKeeper, lockName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>zk分布式锁具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZkDistributedLock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROOT_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/distributed&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> String path;<br><br>    <span class="hljs-keyword">private</span> ZooKeeper zooKeeper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ZkDistributedLock</span><span class="hljs-params">(ZooKeeper zooKeeper, String lockName)</span>&#123;<br>        <span class="hljs-built_in">this</span>.zooKeeper = zooKeeper;<br>        <span class="hljs-built_in">this</span>.path = ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + lockName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            zooKeeper.create(path, <span class="hljs-literal">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 重试</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">200</span>);<br>                lock();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123;<br>                ex.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.zooKeeper.delete(path, <span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>改造StockService的checkAndLock方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ZkClient client;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 加锁，获取锁失败重试</span><br>    <span class="hljs-type">ZkDistributedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.client.getZkDistributedLock(<span class="hljs-string">&quot;lock&quot;</span>);<br>    lock.lock();<br><br>    <span class="hljs-comment">// 先查询库存是否充足</span><br>    <span class="hljs-type">Stock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.stockMapper.selectById(<span class="hljs-number">1L</span>);<br>    <span class="hljs-comment">// 再减库存</span><br>    <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.getCount() &gt; <span class="hljs-number">0</span>)&#123;<br>        stock.setCount(stock.getCount() - <span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">this</span>.stockMapper.updateById(stock);<br>    &#125;<br><br>    <span class="hljs-comment">// 释放锁</span><br>    lock.unlock();<br>&#125;<br></code></pre></td></tr></table></figure>



<p>Jmeter压力测试：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607046072239.png" srcset="/img/loading.gif" lazyload alt="1607046072239"></p>
<p>性能一般，mysql数据库的库存余量为0（注意：所有测试之前都要先修改库存量为5000）</p>
<p>基本实现存在的问题：</p>
<ol>
<li>性能一般（比mysql分布式锁略好）</li>
<li>不可重入</li>
</ol>
<p>接下来首先来提高性能</p>
<h2 id="3-4-优化：性能优化"><a href="#3-4-优化：性能优化" class="headerlink" title="3.4. 优化：性能优化"></a>3.4. 优化：性能优化</h2><p>基本实现中由于无限自旋影响性能：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607048160051.png" srcset="/img/loading.gif" lazyload alt="1607048160051"></p>
<p>试想：每个请求要想正常的执行完成，最终都是要创建节点，如果能够避免争抢必然可以提高性能。</p>
<p>这里借助于zk的临时序列化节点，实现分布式锁：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607048783043.png" srcset="/img/loading.gif" lazyload alt="1607048783043"></p>
<h3 id="3-4-1-实现阻塞锁"><a href="#3-4-1-实现阻塞锁" class="headerlink" title="3.4.1. 实现阻塞锁"></a>3.4.1. 实现阻塞锁</h3><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZkDistributedLock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROOT_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/distributed&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> String path;<br><br>    <span class="hljs-keyword">private</span> ZooKeeper zooKeeper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ZkDistributedLock</span><span class="hljs-params">(ZooKeeper zooKeeper, String lockName)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.zooKeeper = zooKeeper;<br>            <span class="hljs-built_in">this</span>.path = zooKeeper.create(ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + lockName + <span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-literal">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> getPreNode(path);<br>        <span class="hljs-comment">// 如果该节点没有前一个节点，说明该节点时最小节点，放行执行业务逻辑</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(preNode))&#123;<br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br>        <span class="hljs-comment">// 重新检查。是否获取到锁</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">20</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123;<br>            ex.printStackTrace();<br>        &#125;<br>        lock();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.zooKeeper.delete(path, <span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取指定节点的前节点</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> path</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPreNode</span><span class="hljs-params">(String path)</span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取当前节点的序列化号</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">curSerial</span> <span class="hljs-operator">=</span> Long.valueOf(StringUtils.substringAfterLast(path, <span class="hljs-string">&quot;-&quot;</span>));<br>            <span class="hljs-comment">// 获取根路径下的所有序列化子节点</span><br>            List&lt;String&gt; nodes = <span class="hljs-built_in">this</span>.zooKeeper.getChildren(ROOT_PATH, <span class="hljs-literal">false</span>);<br><br>            <span class="hljs-comment">// 判空</span><br>            <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(nodes))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 获取前一个节点</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">for</span> (String node : nodes) &#123;<br>                <span class="hljs-comment">// 获取每个节点的序列化号</span><br>                <span class="hljs-type">Long</span> <span class="hljs-variable">serial</span> <span class="hljs-operator">=</span> Long.valueOf(StringUtils.substringAfterLast(node, <span class="hljs-string">&quot;-&quot;</span>));<br>                <span class="hljs-keyword">if</span> (serial &lt; curSerial &amp;&amp; serial &gt; flag)&#123;<br>                    flag = serial;<br>                    preNode = node;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> preNode;<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>主要修改了构造方法和lock方法：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607051823582.png" srcset="/img/loading.gif" lazyload alt="1607051823582"></p>
<p>并添加了getPreNode获取前置节点的方法。</p>
<p>测试结果如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607051896117.png" srcset="/img/loading.gif" lazyload alt="1607051896117"></p>
<p>性能反而更弱了。</p>
<p>原因：虽然不用反复争抢创建节点了，但是会自旋判断自己是最小的节点，这个判断逻辑反而更复杂更耗时。</p>
<p>解决方案：监听。</p>
<h3 id="3-4-2-监听实现阻塞锁"><a href="#3-4-2-监听实现阻塞锁" class="headerlink" title="3.4.2. 监听实现阻塞锁"></a>3.4.2. 监听实现阻塞锁</h3><p>对于这个算法有个极大的优化点：假如当前有1000个节点在等待锁，如果获得锁的客户端释放锁时，这1000个客户端都会被唤醒，这种情况称为“羊群效应”；在这种羊群效应中，zookeeper需要通知1000个客户端，这会阻塞其他的操作，最好的情况应该只唤醒新的最小节点对应的客户端。应该怎么做呢？在设置事件监听时，每个客户端应该对刚好在它之前的子节点设置事件监听，例如子节点列表为&#x2F;locks&#x2F;lock-0000000000、&#x2F;locks&#x2F;lock-0000000001、&#x2F;locks&#x2F;lock-0000000002，序号为1的客户端监听序号为0的子节点删除消息，序号为2的监听序号为1的子节点删除消息。</p>
<p>所以调整后的分布式锁算法流程如下：</p>
<ul>
<li>客户端连接zookeeper，并在&#x2F;lock下创建临时的且有序的子节点，第一个客户端对应的子节点为&#x2F;locks&#x2F;lock-0000000000，第二个为&#x2F;locks&#x2F;lock-0000000001，以此类推；</li>
<li>客户端获取&#x2F;lock下的子节点列表，判断自己创建的子节点是否为当前子节点列表中序号最小的子节点，如果是则认为获得锁，<strong>否则监听刚好在自己之前一位的子节点删除消息</strong>，获得子节点变更通知后重复此步骤直至获得锁；</li>
<li>执行业务代码；</li>
<li>完成业务流程后，删除对应的子节点释放锁。</li>
</ul>
<p>改造ZkDistributedLock的lock方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> getPreNode(path);<br>        <span class="hljs-comment">// 如果该节点没有前一个节点，说明该节点时最小节点，放行执行业务逻辑</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(preNode))&#123;<br>            <span class="hljs-keyword">return</span> ;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.zooKeeper.exists(ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + preNode, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>()&#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent event)</span> &#123;<br>                    countDownLatch.countDown();<br>                &#125;<br>            &#125;) == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 阻塞。。。。</span><br>            countDownLatch.await();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-comment">// 重新检查。是否获取到锁</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">200</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123;<br>            ex.printStackTrace();<br>        &#125;<br>        lock();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>压力测试效果如下：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607052541669.png" srcset="/img/loading.gif" lazyload alt="1607052541669"></p>
<p>由此可见性能提高不少，接近于redis的分布式锁</p>
<h2 id="3-5-优化：可重入锁"><a href="#3-5-优化：可重入锁" class="headerlink" title="3.5. 优化：可重入锁"></a>3.5. 优化：可重入锁</h2><p><strong>引入ThreadLocal线程局部变量保证zk分布式锁的可重入性。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZkDistributedLock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROOT_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/distributed&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Integer&gt; THREAD_LOCAL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> String path;<br><br>    <span class="hljs-keyword">private</span> ZooKeeper zooKeeper;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ZkDistributedLock</span><span class="hljs-params">(ZooKeeper zooKeeper, String lockName)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.zooKeeper = zooKeeper;<br>            <span class="hljs-keyword">if</span> (THREAD_LOCAL.get() == <span class="hljs-literal">null</span> || THREAD_LOCAL.get() == <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-built_in">this</span>.path = zooKeeper.create(ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + lockName + <span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-literal">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> THREAD_LOCAL.get();<br>        <span class="hljs-keyword">if</span> (flag != <span class="hljs-literal">null</span> &amp;&amp; flag &gt; <span class="hljs-number">0</span>) &#123;<br>            THREAD_LOCAL.set(flag + <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> getPreNode(path);<br>            <span class="hljs-comment">// 如果该节点没有前一个节点，说明该节点时最小节点，放行执行业务逻辑</span><br>            <span class="hljs-keyword">if</span> (StringUtils.isEmpty(preNode))&#123;<br>                THREAD_LOCAL.set(<span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">return</span> ;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.zooKeeper.exists(ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + preNode, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>()&#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent event)</span> &#123;<br>                        countDownLatch.countDown();<br>                    &#125;<br>                &#125;) == <span class="hljs-literal">null</span>) &#123;<br>                    THREAD_LOCAL.set(<span class="hljs-number">1</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-comment">// 阻塞。。。。</span><br>                countDownLatch.await();<br>                THREAD_LOCAL.set(<span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-comment">// 重新检查。是否获取到锁</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">200</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123;<br>                ex.printStackTrace();<br>            &#125;<br>            lock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            THREAD_LOCAL.set(THREAD_LOCAL.get() - <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (THREAD_LOCAL.get() == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">this</span>.zooKeeper.delete(path, <span class="hljs-number">0</span>);<br>                THREAD_LOCAL.remove();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取指定节点的前节点</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> path</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPreNode</span><span class="hljs-params">(String path)</span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取当前节点的序列化号</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">curSerial</span> <span class="hljs-operator">=</span> Long.valueOf(StringUtils.substringAfterLast(path, <span class="hljs-string">&quot;-&quot;</span>));<br>            <span class="hljs-comment">// 获取根路径下的所有序列化子节点</span><br>            List&lt;String&gt; nodes = <span class="hljs-built_in">this</span>.zooKeeper.getChildren(ROOT_PATH, <span class="hljs-literal">false</span>);<br><br>            <span class="hljs-comment">// 判空</span><br>            <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(nodes))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 获取前一个节点</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">for</span> (String node : nodes) &#123;<br>                <span class="hljs-comment">// 获取每个节点的序列化号</span><br>                <span class="hljs-type">Long</span> <span class="hljs-variable">serial</span> <span class="hljs-operator">=</span> Long.valueOf(StringUtils.substringAfterLast(node, <span class="hljs-string">&quot;-&quot;</span>));<br>                <span class="hljs-keyword">if</span> (serial &lt; curSerial &amp;&amp; serial &gt; flag)&#123;<br>                    flag = serial;<br>                    preNode = node;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> preNode;<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3-6-zk分布式锁小结"><a href="#3-6-zk分布式锁小结" class="headerlink" title="3.6. zk分布式锁小结"></a>3.6. zk分布式锁小结</h2><p>参照redis分布式锁的特点：</p>
<ol>
<li>互斥 排他：zk节点的不可重复性，以及序列化节点的有序性</li>
<li>防死锁：<ol>
<li>可自动释放锁：临时节点</li>
<li>可重入锁：借助于ThreadLocal</li>
</ol>
</li>
<li>防误删：临时节点</li>
<li>加锁&#x2F;解锁要具备原子性</li>
<li>单点问题：使用Zookeeper可以有效的解决单点问题，ZK一般是集群部署的。</li>
<li>集群问题：zookeeper集群是强一致性的，只要集群中有半数以上的机器存活，就可以对外提供服务。</li>
<li>公平锁：有序性节点</li>
</ol>
<h2 id="3-7-Curator中的分布式锁"><a href="#3-7-Curator中的分布式锁" class="headerlink" title="3.7. Curator中的分布式锁"></a>3.7. Curator中的分布式锁</h2><p>Curator是netflix公司开源的一套zookeeper客户端，目前是Apache的顶级项目。与Zookeeper提供的原生客户端相比，Curator的抽象层次更高，简化了Zookeeper客户端的开发量。Curator解决了很多zookeeper客户端非常底层的细节开发工作，包括连接重连、反复注册wathcer和NodeExistsException 异常等。</p>
<p>通过查看官方文档，可以发现Curator主要解决了三类问题：</p>
<ul>
<li>封装ZooKeeper client与ZooKeeper server之间的连接处理</li>
<li>提供了一套Fluent风格的操作API</li>
<li>提供ZooKeeper各种应用场景(recipe， 比如：分布式锁服务、集群领导选举、共享计数器、缓存机制、分布式队列等)的抽象封装，这些实现都遵循了zk的最佳实践，并考虑了各种极端情况</li>
</ul>
<p>Curator由一系列的模块构成，对于一般开发者而言，常用的是curator-framework和curator-recipes：</p>
<ul>
<li>curator-framework：提供了常见的zk相关的底层操作</li>
<li>curator-recipes：提供了一些zk的典型使用场景的参考。本节重点关注的分布式锁就是该包提供的</li>
</ul>
<p>引入依赖：</p>
<p>最新版本的curator 4.3.0支持zookeeper 3.4.x和3.5，但是需要注意curator传递进来的依赖，需要和实际服务器端使用的版本相符，以我们目前使用的zookeeper 3.4.14为例。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-recipes<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.14<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>添加curator客户端配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CuratorConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CuratorFramework <span class="hljs-title function_">curatorFramework</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 重试策略，这里使用的是指数补偿重试策略，重试3次，初始重试间隔1000ms，每次重试之后重试间隔递增。</span><br>        <span class="hljs-type">RetryPolicy</span> <span class="hljs-variable">retry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExponentialBackoffRetry</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-comment">// 初始化Curator客户端：指定链接信息 及 重试策略</span><br>        <span class="hljs-type">CuratorFramework</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> CuratorFrameworkFactory.newClient(<span class="hljs-string">&quot;172.16.116.100:2181&quot;</span>, retry);<br>        client.start(); <span class="hljs-comment">// 开始链接，如果不调用该方法，很多方法无法工作</span><br>        <span class="hljs-keyword">return</span> client;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-7-1-可重入锁InterProcessMutex"><a href="#3-7-1-可重入锁InterProcessMutex" class="headerlink" title="3.7.1. 可重入锁InterProcessMutex"></a>3.7.1. 可重入锁InterProcessMutex</h3><p>Reentrant和JDK的ReentrantLock类似， 意味着同一个客户端在拥有锁的同时，可以多次获取，不会被阻塞。它是由类<strong>InterProcessMutex</strong>来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 常用构造方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">InterProcessMutex</span><span class="hljs-params">(CuratorFramework client, String path)</span><br><span class="hljs-comment">// 获取锁</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 带超时时间的可重入锁</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span>;<br><span class="hljs-comment">// 释放锁</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>



<h4 id="3-7-1-1-使用案例"><a href="#3-7-1-1-使用案例" class="headerlink" title="3.7.1.1. 使用案例"></a>3.7.1.1. 使用案例</h4><p>改造service测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> CuratorFramework curatorFramework;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">mutex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(curatorFramework, <span class="hljs-string">&quot;/curator/lock&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 加锁</span><br>        mutex.acquire();<br><br>        <span class="hljs-comment">// 先查询库存是否充足</span><br>        <span class="hljs-type">Stock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.stockMapper.selectById(<span class="hljs-number">1L</span>);<br>        <span class="hljs-comment">// 再减库存</span><br>        <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.getCount() &gt; <span class="hljs-number">0</span>)&#123;<br>            stock.setCount(stock.getCount() - <span class="hljs-number">1</span>);<br>            <span class="hljs-built_in">this</span>.stockMapper.updateById(stock);<br>        &#125;<br>        <br>        <span class="hljs-comment">// this.testSub(mutex);</span><br><br>        <span class="hljs-comment">// 释放锁</span><br>        mutex.release();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSub</span><span class="hljs-params">(InterProcessMutex mutex)</span> &#123;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        mutex.acquire();<br>    	System.out.println(<span class="hljs-string">&quot;测试可重入锁。。。。&quot;</span>);<br>        mutex.release();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>注意：<strong>如想重入，则需要使用同一个InterProcessMutex对象。</strong></p>
<p>压力测试结果：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1607069431523.png" srcset="/img/loading.gif" lazyload alt="1607069431523"></p>
<h4 id="3-7-1-2-底层原理"><a href="#3-7-1-2-底层原理" class="headerlink" title="3.7.1.2. 底层原理"></a>3.7.1.2. 底层原理</h4><h3 id="3-7-2-不可重入锁InterProcessSemaphoreMutex"><a href="#3-7-2-不可重入锁InterProcessSemaphoreMutex" class="headerlink" title="3.7.2. 不可重入锁InterProcessSemaphoreMutex"></a>3.7.2. 不可重入锁InterProcessSemaphoreMutex</h3><p>具体实现：InterProcessSemaphoreMutex。与InterProcessMutex调用方法类似，区别在于该锁是不可重入的，在同一个线程中不可重入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">InterProcessSemaphoreMutex</span><span class="hljs-params">(CuratorFramework client, String path)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>



<p>案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> CuratorFramework curatorFramework;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">()</span> &#123;<br><br>    <span class="hljs-type">InterProcessSemaphoreMutex</span> <span class="hljs-variable">mutex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessSemaphoreMutex</span>(curatorFramework, <span class="hljs-string">&quot;/curator/lock&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        mutex.acquire();<br>        <span class="hljs-comment">// 1. 查询库存信息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>).toString();<br><br>        <span class="hljs-comment">// 2. 判断库存是否充足</span><br>        <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.length() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> Integer.valueOf(stock);<br>            <span class="hljs-keyword">if</span> (st &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 3.扣减库存</span><br>                redisTemplate.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, String.valueOf(--st));<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            mutex.release();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-7-3-可重入读写锁InterProcessReadWriteLock"><a href="#3-7-3-可重入读写锁InterProcessReadWriteLock" class="headerlink" title="3.7.3. 可重入读写锁InterProcessReadWriteLock"></a>3.7.3. 可重入读写锁InterProcessReadWriteLock</h3><p>类似JDK的ReentrantReadWriteLock。一个拥有写锁的线程可重入读锁，但是读锁却不能进入写锁。这也意味着写锁可以降级成读锁。从读锁升级成写锁是不成的。主要实现类InterProcessReadWriteLock：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 构造方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">InterProcessReadWriteLock</span><span class="hljs-params">(CuratorFramework client, String basePath)</span>;<br><span class="hljs-comment">// 获取读锁对象</span><br>InterProcessMutex <span class="hljs-title function_">readLock</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 获取写锁对象</span><br>InterProcessMutex <span class="hljs-title function_">writeLock</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>

<p>注意：<strong>写锁在释放之前会一直阻塞请求线程，而读锁不会</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testZkReadLock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">InterProcessReadWriteLock</span> <span class="hljs-variable">rwlock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessReadWriteLock</span>(curatorFramework, <span class="hljs-string">&quot;/curator/rwlock&quot;</span>);<br>        rwlock.readLock().acquire(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>        <span class="hljs-comment">// TODO：一顿读的操作。。。。</span><br>        <span class="hljs-comment">//rwlock.readLock().unlock();</span><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testZkWriteLock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">InterProcessReadWriteLock</span> <span class="hljs-variable">rwlock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessReadWriteLock</span>(curatorFramework, <span class="hljs-string">&quot;/curator/rwlock&quot;</span>);<br>        rwlock.writeLock().acquire(<span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>        <span class="hljs-comment">// TODO：一顿写的操作。。。。</span><br>        <span class="hljs-comment">//rwlock.writeLock().unlock();</span><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-7-4-联锁InterProcessMultiLock"><a href="#3-7-4-联锁InterProcessMultiLock" class="headerlink" title="3.7.4. 联锁InterProcessMultiLock"></a>3.7.4. 联锁InterProcessMultiLock</h3><p>Multi Shared Lock是一个锁的容器。当调用acquire， 所有的锁都会被acquire，如果请求失败，所有的锁都会被release。同样调用release时所有的锁都被release(失败被忽略)。基本上，它就是组锁的代表，在它上面的请求释放操作都会传递给它包含的所有的锁。实现类InterProcessMultiLock：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 构造函数需要包含的锁的集合，或者一组ZooKeeper的path</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">InterProcessMultiLock</span><span class="hljs-params">(List&lt;InterProcessLock&gt; locks)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">InterProcessMultiLock</span><span class="hljs-params">(CuratorFramework client, List&lt;String&gt; paths)</span>;<br><br><span class="hljs-comment">// 获取锁</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span>;<br><br><span class="hljs-comment">// 释放锁</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>



<h3 id="3-7-5-信号量InterProcessSemaphoreV2"><a href="#3-7-5-信号量InterProcessSemaphoreV2" class="headerlink" title="3.7.5. 信号量InterProcessSemaphoreV2"></a>3.7.5. 信号量InterProcessSemaphoreV2</h3><p>一个计数的信号量类似JDK的Semaphore。JDK中Semaphore维护的一组许可(permits)，而Cubator中称之为租约(Lease)。注意，所有的实例必须使用相同的numberOfLeases值。调用acquire会返回一个租约对象。客户端必须在finally中close这些租约对象，否则这些租约会丢失掉。但是，如果客户端session由于某种原因比如crash丢掉， 那么这些客户端持有的租约会自动close， 这样其它客户端可以继续使用这些租约。主要实现类InterProcessSemaphoreV2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 构造方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">InterProcessSemaphoreV2</span><span class="hljs-params">(CuratorFramework client, String path, <span class="hljs-type">int</span> maxLeases)</span>;<br><br><span class="hljs-comment">// 注意一次你可以请求多个租约，如果Semaphore当前的租约不够，则请求线程会被阻塞。</span><br><span class="hljs-comment">// 同时还提供了超时的重载方法</span><br><span class="hljs-keyword">public</span> Lease <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span>;<br><span class="hljs-keyword">public</span> Collection&lt;Lease&gt; <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> qty)</span>;<br><span class="hljs-keyword">public</span> Lease <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span>;<br><span class="hljs-keyword">public</span> Collection&lt;Lease&gt; <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> qty, <span class="hljs-type">long</span> time, TimeUnit unit)</span><br><br><span class="hljs-comment">// 租约还可以通过下面的方式返还</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnAll</span><span class="hljs-params">(Collection&lt;Lease&gt; leases)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnLease</span><span class="hljs-params">(Lease lease)</span>;<br></code></pre></td></tr></table></figure>



<p>案例代码：</p>
<p>StockController中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;test/semaphore&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testSemaphore</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">this</span>.stockService.testSemaphore();<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello Semaphore&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>StockService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSemaphore</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 设置资源量 限流的线程数</span><br>    <span class="hljs-type">InterProcessSemaphoreV2</span> <span class="hljs-variable">semaphoreV2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessSemaphoreV2</span>(curatorFramework, <span class="hljs-string">&quot;/locks/semaphore&quot;</span>, <span class="hljs-number">5</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Lease</span> <span class="hljs-variable">acquire</span> <span class="hljs-operator">=</span> semaphoreV2.acquire();<span class="hljs-comment">// 获取资源，获取资源成功的线程可以继续处理业务操作。否则会被阻塞住</span><br>        <span class="hljs-built_in">this</span>.redisTemplate.opsForList().rightPush(<span class="hljs-string">&quot;log&quot;</span>, <span class="hljs-string">&quot;10010获取了资源，开始处理业务逻辑。&quot;</span> + Thread.currentThread().getName());<br>        TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">10</span>));<br>        <span class="hljs-built_in">this</span>.redisTemplate.opsForList().rightPush(<span class="hljs-string">&quot;log&quot;</span>, <span class="hljs-string">&quot;10010处理完业务逻辑，释放资源=====================&quot;</span> + Thread.currentThread().getName());<br>        semaphoreV2.returnLease(acquire); <span class="hljs-comment">// 手动释放资源，后续请求线程就可以获取该资源</span><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-7-6-栅栏barrier"><a href="#3-7-6-栅栏barrier" class="headerlink" title="3.7.6. 栅栏barrier"></a>3.7.6. 栅栏barrier</h3><ol>
<li><p><strong>DistributedBarrier</strong>构造函数中barrierPath参数用来确定一个栅栏，只要barrierPath参数相同(路径相同)就是同一个栅栏。通常情况下栅栏的使用如下：</p>
<ol>
<li>主client设置一个栅栏</li>
<li>其他客户端就会调用waitOnBarrier()等待栅栏移除，程序处理线程阻塞</li>
<li>主client移除栅栏，其他客户端的处理程序就会同时继续运行。</li>
</ol>
<p>DistributedBarrier类的主要方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">setBarrier() - 设置栅栏<br>waitOnBarrier() - 等待栅栏移除<br>removeBarrier() - 移除栅栏<br></code></pre></td></tr></table></figure>


</li>
<li><p>DistributedDoubleBarrier双栅栏，允许客户端在计算的开始和结束时同步。当足够的进程加入到双栅栏时，进程开始计算，当计算完成时，离开栅栏。DistributedDoubleBarrier实现了双栅栏的功能。构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// client - the client</span><br><span class="hljs-comment">// barrierPath - path to use</span><br><span class="hljs-comment">// memberQty - the number of members in the barrier</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedDoubleBarrier</span><span class="hljs-params">(CuratorFramework client, String barrierPath, <span class="hljs-type">int</span> memberQty)</span>;<br><br>enter()、enter(<span class="hljs-type">long</span> maxWait, TimeUnit unit) - 等待同时进入栅栏<br>leave()、leave(<span class="hljs-type">long</span> maxWait, TimeUnit unit) - 等待同时离开栅栏<br></code></pre></td></tr></table></figure>

<p>memberQty是成员数量，当enter方法被调用时，成员被阻塞，直到所有的成员都调用了enter。当leave方法被调用时，它也阻塞调用线程，直到所有的成员都调用了leave。</p>
<p>注意：参数memberQty的值只是一个阈值，而不是一个限制值。当等待栅栏的数量大于或等于这个值栅栏就会打开！</p>
<p>与栅栏(DistributedBarrier)一样,双栅栏的barrierPath参数也是用来确定是否是同一个栅栏的，双栅栏的使用情况如下：</p>
<ol>
<li>从多个客户端在同一个路径上创建双栅栏(DistributedDoubleBarrier),然后调用enter()方法，等待栅栏数量达到memberQty时就可以进入栅栏。</li>
<li>栅栏数量达到memberQty，多个客户端同时停止阻塞继续运行，直到执行leave()方法，等待memberQty个数量的栅栏同时阻塞到leave()方法中。</li>
<li>memberQty个数量的栅栏同时阻塞到leave()方法中，多个客户端的leave()方法停止阻塞，继续运行。</li>
</ol>
</li>
</ol>
<h3 id="3-7-7-共享计数器"><a href="#3-7-7-共享计数器" class="headerlink" title="3.7.7. 共享计数器"></a>3.7.7. 共享计数器</h3><p>利用ZooKeeper可以实现一个集群共享的计数器。只要使用相同的path就可以得到最新的计数器值， 这是由ZooKeeper的一致性保证的。Curator有两个计数器， 一个是用int来计数，一个用long来计数。</p>
<h4 id="3-7-7-1-SharedCount"><a href="#3-7-7-1-SharedCount" class="headerlink" title="3.7.7.1. SharedCount"></a>3.7.7.1. SharedCount</h4><p>共享计数器SharedCount相关方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 构造方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">SharedCount</span><span class="hljs-params">(CuratorFramework client, String path, <span class="hljs-type">int</span> seedValue)</span>;<br><span class="hljs-comment">// 获取共享计数的值</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 设置共享计数的值</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCount</span><span class="hljs-params">(<span class="hljs-type">int</span> newCount)</span> <span class="hljs-keyword">throws</span> Exception;<br><span class="hljs-comment">// 当版本号没有变化时，才会更新共享变量的值</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>  <span class="hljs-title function_">trySetCount</span><span class="hljs-params">(VersionedValue&lt;Integer&gt; previous, <span class="hljs-type">int</span> newCount)</span>;<br><span class="hljs-comment">// 通过监听器监听共享计数的变化</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addListener</span><span class="hljs-params">(SharedCountListener listener)</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addListener</span><span class="hljs-params">(<span class="hljs-keyword">final</span> SharedCountListener listener, Executor executor)</span>;<br><span class="hljs-comment">// 共享计数在使用之前必须开启</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><span class="hljs-comment">// 关闭共享计数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br></code></pre></td></tr></table></figure>

<p>使用案例：</p>
<p>StockController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;test/zk/share/count&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testZkShareCount</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">this</span>.stockService.testZkShareCount();<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello shareData&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>StockService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testZkShareCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 第三个参数是共享计数的初始值</span><br>        <span class="hljs-type">SharedCount</span> <span class="hljs-variable">sharedCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedCount</span>(curatorFramework, <span class="hljs-string">&quot;/curator/count&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 启动共享计数器</span><br>        sharedCount.start();<br>        <span class="hljs-comment">// 获取共享计数的值</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> sharedCount.getCount();<br>        <span class="hljs-comment">// 修改共享计数的值</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">1000</span>);<br>        sharedCount.setCount(random);<br>        System.out.println(<span class="hljs-string">&quot;我获取了共享计数的初始值：&quot;</span> + count + <span class="hljs-string">&quot;，并把计数器的值改为：&quot;</span> + random);<br>        sharedCount.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="3-7-7-2-DistributedAtomicNumber"><a href="#3-7-7-2-DistributedAtomicNumber" class="headerlink" title="3.7.7.2. DistributedAtomicNumber"></a>3.7.7.2. DistributedAtomicNumber</h4><p>DistributedAtomicNumber接口是分布式原子数值类型的抽象，定义了分布式原子数值类型需要提供的方法。</p>
<p>DistributedAtomicNumber接口有两个实现：<code>DistributedAtomicLong</code> 和 <code>DistributedAtomicInteger</code></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20220711225708066.png" srcset="/img/loading.gif" lazyload alt="image-20220711225708066"></p>
<p>这两个实现将各种原子操作的执行委托给了<code>DistributedAtomicValue</code>，所以这两种实现是类似的，只不过表示的数值类型不同而已。这里以<code>DistributedAtomicLong</code> 为例进行演示</p>
<p>DistributedAtomicLong除了计数的范围比SharedCount大了之外，比SharedCount更简单易用。它首先尝试使用乐观锁的方式设置计数器， 如果不成功(比如期间计数器已经被其它client更新了)， 它使用InterProcessMutex方式来更新计数值。此计数器有一系列的操作：</p>
<ul>
<li>get(): 获取当前值</li>
<li>increment()：加一</li>
<li>decrement(): 减一</li>
<li>add()：增加特定的值</li>
<li>subtract(): 减去特定的值</li>
<li>trySet(): 尝试设置计数值</li>
<li>forceSet(): 强制设置计数值</li>
</ul>
<p>你必须检查返回结果的succeeded()， 它代表此操作是否成功。如果操作成功， preValue()代表操作前的值， postValue()代表操作后的值。</p>
<h1 id="4-基于mysql实现分布式锁"><a href="#4-基于mysql实现分布式锁" class="headerlink" title="4. 基于mysql实现分布式锁"></a>4. 基于mysql实现分布式锁</h1><p>不管是jvm锁还是mysql锁，为了保证线程的并发安全，都提供了悲观独占排他锁。所以<strong>独占排他</strong>也是分布式锁的基本要求。</p>
<p>可以<strong>利用唯一键索引不能重复插入的特点实现</strong>。设计表如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `tb_lock` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT,<br>  `lock_name` varchar(50) NOT NULL COMMENT &#x27;锁名&#x27;,<br>  `class_name` varchar(100) DEFAULT NULL COMMENT &#x27;类名&#x27;,<br>  `method_name` varchar(50) DEFAULT NULL COMMENT &#x27;方法名&#x27;,<br>  `server_name` varchar(50) DEFAULT NULL COMMENT &#x27;服务器ip&#x27;,<br>  `thread_name` varchar(50) DEFAULT NULL COMMENT &#x27;线程名&#x27;,<br>  `create_time` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;获取锁时间&#x27;,<br>  `desc` varchar(100) DEFAULT NULL COMMENT &#x27;描述&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `idx_unique` (`lock_name`)<br>) ENGINE=InnoDB AUTO_INCREMENT=1332899824461455363 DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure>

<p>Lock实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@TableName(&quot;tb_lock&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String lockName;<br>    <span class="hljs-keyword">private</span> String className;<br>    <span class="hljs-keyword">private</span> String methodName;<br>    <span class="hljs-keyword">private</span> String serverName;<br>    <span class="hljs-keyword">private</span> String threadName;<br>    <span class="hljs-keyword">private</span> Date createTime;<br>    <span class="hljs-keyword">private</span> String desc;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>LockMapper接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LockMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Lock&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-1-基本思路"><a href="#4-1-基本思路" class="headerlink" title="4.1. 基本思路"></a>4.1. 基本思路</h2><p>synchronized关键字和ReetrantLock锁都是独占排他锁，即多个线程争抢一个资源时，同一时刻只有一个线程可以抢占该资源，其他线程只能阻塞等待，直到占有资源的线程释放该资源。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606620944823.png" srcset="/img/loading.gif" lazyload alt="1606620944823"></p>
<ol>
<li>线程同时获取锁（insert）</li>
<li>获取成功，执行业务逻辑，执行完成释放锁（delete）</li>
<li>其他线程等待重试</li>
</ol>
<h2 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2. 代码实现"></a>4.2. 代码实现</h2><p>改造StockService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StockMapper stockMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LockMapper lockMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 数据库分布式锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">// 加锁</span><br>        <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Lock</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-built_in">this</span>.getClass().getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.lockMapper.insert(lock);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            <span class="hljs-comment">// 获取锁失败，则重试</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">50</span>);<br>                <span class="hljs-built_in">this</span>.checkAndLock();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 先查询库存是否充足</span><br>        <span class="hljs-type">Stock</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.stockMapper.selectById(<span class="hljs-number">1L</span>);<br><br>        <span class="hljs-comment">// 再减库存</span><br>        <span class="hljs-keyword">if</span> (stock != <span class="hljs-literal">null</span> &amp;&amp; stock.getCount() &gt; <span class="hljs-number">0</span>)&#123;<br><br>            stock.setCount(stock.getCount() - <span class="hljs-number">1</span>);<br>            <span class="hljs-built_in">this</span>.stockMapper.updateById(stock);<br>        &#125;<br><br>        <span class="hljs-comment">// 释放锁</span><br>        <span class="hljs-built_in">this</span>.lockMapper.deleteById(lock.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>加锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 加锁</span><br><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Lock</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-built_in">this</span>.getClass().getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-literal">null</span>);<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">this</span>.lockMapper.insert(lock);<br>&#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>    <span class="hljs-comment">// 获取锁失败，则重试</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">50</span>);<br>        <span class="hljs-built_in">this</span>.checkAndLock();<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 释放锁</span><br><span class="hljs-built_in">this</span>.lockMapper.deleteById(lock.getId());<br></code></pre></td></tr></table></figure>



<p>使用Jmeter压力测试结果：</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/1606625971086.png" srcset="/img/loading.gif" lazyload alt="1606625971086"></p>
<p>可以看到性能感人。mysql数据库库存余量为0，可以保证线程安全。</p>
<h2 id="4-3-缺陷及解决方案"><a href="#4-3-缺陷及解决方案" class="headerlink" title="4.3. 缺陷及解决方案"></a>4.3. 缺陷及解决方案</h2><p><strong>缺点</strong>：</p>
<ol>
<li><p>这把锁强依赖数据库的可用性，数据库是一个单点，一旦数据库挂掉，会导致业务系统不可用。</p>
<p>解决方案：给 锁数据库 搭建主备</p>
</li>
<li><p>这把锁没有失效时间，一旦解锁操作失败，就会导致锁记录一直在数据库中，其他线程无法再获得到锁。</p>
<p>解决方案：只要做一个定时任务，每隔一定时间把数据库中的超时数据清理一遍。</p>
</li>
<li><p>这把锁是非重入的，同一个线程在没有释放锁之前无法再次获得该锁。因为数据中数据已经存在了。</p>
<p>解决方案：记录获取锁的主机信息和线程信息，如果相同线程要获取锁，直接重入。</p>
</li>
<li><p>受制于数据库性能，并发能力有限。</p>
<p>解决方案：无法解决。</p>
</li>
</ol>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h1><p>实现的复杂性或者难度角度：Zookeeper &gt; redis &gt; 数据库</p>
<p>实际性能角度：redis &gt; Zookeeper &gt; 数据库</p>
<p>可靠性角度：Zookeeper &gt; redis &#x3D; 数据库</p>
<p>这三种方式都不是尽善尽美，我们可以根据实际业务情况选择最适合的方案：</p>
<p>如果追求极致性能可以选择：reds方案</p>
<p>如果追求可靠性可以选择：zk</p>
<p>常见锁分类：</p>
<blockquote>
<p><strong>悲观锁</strong>：具有强烈的独占和排他特性，在整个数据处理过程中，将数据处于锁定状态。适合于写比较多，会阻塞读操作。<br><strong>乐观锁</strong>：采取了更加宽松的加锁机制，大多是基于数据版本（ Version ）及时间戳来实现。。适合于读比较多，不会阻塞读</p>
</blockquote>
<blockquote>
<p><strong>独占锁、互斥锁、排他锁</strong>：保证在任一时刻，只能被一个线程独占排他持有。synchronized、ReentrantLock<br><strong>共享锁</strong>：可同时被多个线程共享持有。CountDownLatch到计数器、Semaphore信号量</p>
</blockquote>
<blockquote>
<p><strong>可重入锁</strong>：又名递归锁。同一个线程在外层方法获取锁的时候，在进入内层方法时会自动获取锁。<br><strong>不可重入锁</strong>：例如早期的synchronized</p>
</blockquote>
<blockquote>
<p><strong>公平锁</strong>：有优先级的锁，先来先得，谁先申请锁就先获取到锁<br><strong>非公平锁</strong>：无优先级的锁，后来者也有机会先获取到锁</p>
</blockquote>
<blockquote>
<p><strong>自旋锁</strong>：当线程尝试获取锁失败时（锁已经被其它线程占用了），无限循环重试尝试获取锁<br><strong>阻塞锁</strong>：当线程尝试获取锁失败时，线程进入阻塞状态，直到接收信号后被唤醒。在竞争激烈情况下，性能较高</p>
</blockquote>
<blockquote>
<p><strong>读锁</strong>：共享锁<br><strong>写锁</strong>：独占排他锁</p>
</blockquote>
<blockquote>
<p><strong>偏向锁</strong>：一直被一个线程所访问，那么该线程会自动获取锁<br><strong>轻量级锁</strong>（CAS）：当锁是偏向锁的时候，被另一个线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，提高性能。<br><strong>重量级锁</strong>：当锁为轻量级锁的时候，另一个线程虽然是自旋，但自旋不会一直持续下去，当自旋一定次数的时候（10次），还没有获取到锁，就会进入阻塞，该锁膨胀为重量级锁。重量级锁会让他申请的线程进入阻塞，性能降低。<br>以上其实是synchronized的锁升级过程</p>
</blockquote>
<p>​	</p>
<blockquote>
<p><strong>表级锁</strong>：对整张表加锁，加锁快开销小，不会出现死锁，但并发度低，会增加锁冲突的概率<br><strong>行级锁</strong>：是mysql粒度最小的锁，只针对操作行，可大大减少锁冲突概率，并发度高，但加锁慢，开销大，会出现死锁</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" class="category-chain-item">分布式系统</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">#分布式系统</a>
      
        <a href="/tags/JUC/">#JUC</a>
      
        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">#分布式锁</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>分布式锁-尚</div>
      <div>http://example.com/2023/07/20/分布式系统-大数据/分布式锁/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>where</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年7月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/20/algorithm/%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80%E6%A8%A1%E7%89%88/" title="算法基础模版">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">算法基础模版</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/19/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6+%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/Kubernetes/" title="Kubernetes">
                        <span class="hidden-mobile">Kubernetes</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
