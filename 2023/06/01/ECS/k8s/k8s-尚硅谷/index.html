

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="where">
  <meta name="keywords" content="">
  
    <meta name="description" content="K8S-尚硅谷尚硅谷 k8s1、kubernetes 简介kubernetes 基本介绍 kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。传统的">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S-尚硅谷">
<meta property="og:url" content="http://example.com/2023/06/01/ECS/k8s/k8s-%E5%B0%9A%E7%A1%85%E8%B0%B7/index.html">
<meta property="og:site_name" content="where&#39;s blog">
<meta property="og:description" content="K8S-尚硅谷尚硅谷 k8s1、kubernetes 简介kubernetes 基本介绍 kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。传统的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525135251.png">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525135634.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525141033.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fox1JcLu3VQBEG28wzVNlT-kvIDX%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FpawE4ilhcLt6GRGek7-K9qab9sH%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FhJckGZ8UJtm-ERISgxed-aU8rZ4%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Ft5jWzYoAVMykhCw498dhylhYKxs%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/cFo--tBORlgjOWGRsIdqjY_9a7Poh%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fkyoex4GGGwmjtCatDrKu0r2AhYc">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FhbvD_ymZLIo3-u5V7aMGr-jRs1O%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FFvpIdr-FaklKVGoujBMn4_owEsi3%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FnXwu6fSeS_GWKoBBtE-n9q_uhTj%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FlgWj_5lZnoHrtwgBVuAPxNf3-jx%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/2021011515185798.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fi0X9FlK5dLbEeGirYOefEs60CVH%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fohc-4UR6fY2x4DOgY-_LybDTIsp%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224144556516.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224144603874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224145241487.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224145301467.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224145315730.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224145404669.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/202102241455531.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224145830987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2021022414594754.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210224150220543.png">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525162234.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525162253.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525163252.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525163347.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525163433.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164215.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164234.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164249.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164310.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164349.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164409.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525165720.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525165825.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170007.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170328.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170413.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170552.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170624.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170638.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170651.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525171801.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525171824.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174036.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174800.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174846.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174954.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526093534.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526095617.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526095650.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526104852.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526104929.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526110553.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141020.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141302.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141302.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141400.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141434.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141510.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526150019.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526150051.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526150343.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526152442.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526155049.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526155251.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526174338.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526174711.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526174810.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526180003.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182241.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182311.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182558.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182621.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094054.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094201.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094256.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094621.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094721.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094749.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094814.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527100651.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527100813.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527102817.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527102945.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527103530.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527103556.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527103835.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527105149.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527105638.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527105821.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110733.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110832.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110857.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110948.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111017.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111201.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111222.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111307.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111344.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111417.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111438.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111804.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fox1JcLu3VQBEG28wzVNlT-kvIDX">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/FpawE4ilhcLt6GRGek7-K9qab9sH">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/FrkK-c5PNFR5pNfJt_yVJAVR5Hmf">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/FqCY83Uuqu7PAPr250p0iXkw4t3W">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fqg-cVYpc9t-eWeHz1eVFiFbY3zW">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/FhJckGZ8UJtm-ERISgxed-aU8rZ4">
<meta property="og:image" content="http://img-blog.csdnimg.cn/20200427195817259.jpg">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/FnuJHK-i6l2zEyu8X42_Tq4rXQEW">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/FjKjsotGGsOsc0UfWepZjhEqid_e">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fo6ZVfS41PIWAhLc_WtlCLwa7C1T">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fru9g_G86saznCgz6XIU2kwoEMVj">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fsk-Sd6iD--OB1XHl31_ygG3Uik9">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fh6u3HrfzP7_bDb63Z_AKjRq8TbK">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fvd-q8k_eWDG1h7FsC3ifrOJQr0Z">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fpy4C2p4UQqPgW7Ut1eS-rcVE-aL">
<meta property="og:image" content="http://qiniu-picture.xiyankt.com/Fgq3oIOuZCN58iEuhoTj8Om6c0E9">
<meta property="article:published_time" content="2023-05-31T16:00:00.000Z">
<meta property="article:modified_time" content="2023-06-22T15:33:40.701Z">
<meta property="article:author" content="where">
<meta property="article:tag" content="ECS">
<meta property="article:tag" content="容器">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525135251.png">
  
  
  
  <title>K8S-尚硅谷 - where&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="K8S-尚硅谷"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-01 00:00" pubdate>
          2023年6月1日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          95k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          792 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">K8S-尚硅谷</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="K8S-尚硅谷"><a href="#K8S-尚硅谷" class="headerlink" title="K8S-尚硅谷"></a>K8S-尚硅谷</h1><h2 id="尚硅谷-k8s"><a href="#尚硅谷-k8s" class="headerlink" title="尚硅谷 k8s"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1GT4y1A756">尚硅谷 k8s</a></h2><h1 id="1、kubernetes-简介"><a href="#1、kubernetes-简介" class="headerlink" title="1、kubernetes 简介"></a>1、kubernetes 简介</h1><h4 id="kubernetes-基本介绍"><a href="#kubernetes-基本介绍" class="headerlink" title="kubernetes 基本介绍"></a>kubernetes 基本介绍</h4><blockquote>
<p>kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配 置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新&#x2F;回滚等 操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于 可移植性。 新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件 系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署， 由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进 行迁移。容器占用资源少、部署快，每个应用可以被打包成一个容器镜像，每个应用与容器间 成一对一关系也使容器有更大优势，使用容器可以在 build 或 release 的阶段，为应用创 建容器镜像，因为每个应用不需要与其余的应用堆栈组合，也不依赖于生产环境基础结构， 这使得从研发到测试、生产能提供一致环境。类似地，容器比虚拟机轻量、更“透明”， 这更便于监控和管理。 Kubernetes 是 Google 开源的一个容器编排引擎，它支持自动化部署、大规模可伸缩、 应用容器化管理。在生产环境中部署一个应用程序时，通常要部署该应用的多个实例以便 对应用请求进行负载均衡。 在 Kubernetes 中，我们可以创建多个容器，每个容器里面运行一个应用实例，然后通 过内置的负载均衡策略，实现对这一组应用实例的管理、发现、访问，而这些细节都不需 要运维人员去进行复杂的手工配置和处理。</p>
</blockquote>
<h4 id="kubernetes-功能和架构"><a href="#kubernetes-功能和架构" class="headerlink" title="kubernetes 功能和架构"></a>kubernetes 功能和架构</h4><h5 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h5><p>Kubernetes 是一个轻便的和可扩展的开源平台，用于管理容器化应用和服务。通过 Kubernetes 能够进行应用的自动化部署和扩缩容。在 Kubernetes 中，会将组成应用的容 器组合成一个逻辑单元以更易管理和发现。Kubernetes 积累了作为 Google 生产环境运行 工作负载 15 年的经验，并吸收了来自于社区的最佳想法和实践。</p>
<h5 id="K8s-功能"><a href="#K8s-功能" class="headerlink" title="K8s 功能"></a>K8s 功能</h5><ul>
<li>自动装箱 <ul>
<li>基于容器对应用运行环境的资源配置要求自动部署应用容器</li>
</ul>
</li>
<li>自我修复(自愈能力) <ul>
<li>当容器失败时，会对容器进行重启 </li>
<li>当所部署的 Node 节点有问题时，会对容器进行重新部署和重新调度</li>
<li>当容器未通过监控检查时，会关闭此容器直到容器正常运行时，才会对外提供服务</li>
</ul>
</li>
<li>水平扩展<ul>
<li>通过简单的命令、用户 UI 界面或基于 CPU 等资源使用情况，对应用容器进行规模扩大 或规模剪裁</li>
</ul>
</li>
<li>服务发现 <ul>
<li>用户不需使用额外的服务发现机制，就能够基于 Kubernetes 自身能力实现服务发现和 负载均衡</li>
</ul>
</li>
<li>滚动更新 <ul>
<li>可以根据应用的变化，对应用容器运行的应用，进行一次性或批量式更新</li>
</ul>
</li>
<li>版本回退 <ul>
<li>可以根据应用部署情况，对应用容器运行的应用，进行历史版本即时回退</li>
</ul>
</li>
<li>密钥和配置管理 <ul>
<li>在不需要重新构建镜像的情况下，可以部署和更新密钥和应用配置，类似热部署。</li>
</ul>
</li>
<li>存储编排 <ul>
<li>自动实现存储系统挂载及应用，特别对有状态应用实现数据持久化非常重要 存储系统可以来自于本地目录、网络存储(NFS、Gluster、Ceph 等)、公共云存储服务</li>
</ul>
</li>
<li>批处理 <ul>
<li>提供一次性任务，定时任务；满足批量数据处理和分析的场景</li>
</ul>
</li>
</ul>
<h4 id="应用部署架构分类"><a href="#应用部署架构分类" class="headerlink" title="应用部署架构分类"></a>应用部署架构分类</h4><ul>
<li>(1) 无中心节点架构 <ul>
<li>GlusterFS</li>
</ul>
</li>
<li>(2) 有中心节点架构 <ul>
<li>HDFS K8S</li>
</ul>
</li>
</ul>
<h4 id="k8s-集群架构"><a href="#k8s-集群架构" class="headerlink" title="k8s 集群架构"></a>k8s 集群架构</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525135251.png" srcset="/img/loading.gif" lazyload alt="输入图片说明" title="QQ截图20201229183512.png"></p>
<h4 id="k8s-集群架构节点角色功能"><a href="#k8s-集群架构节点角色功能" class="headerlink" title="k8s 集群架构节点角色功能"></a>k8s 集群架构节点角色功能</h4><ul>
<li>Master Node<ul>
<li>k8s 集群控制节点，对集群进行调度管理，接受集群外用户去集群操作请求； Master Node 由 API Server、Scheduler、ClusterState Store（ETCD 数据库）和 Controller MangerServer 所组成</li>
</ul>
</li>
<li>Worker Node<ul>
<li>集群工作节点，运行用户业务应用容器； Worker Node 包含 kubelet、kube proxy 和 ContainerRuntime</li>
</ul>
</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525135634.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="2、kubernetes-集群搭建-kubeadm-方式"><a href="#2、kubernetes-集群搭建-kubeadm-方式" class="headerlink" title="2、kubernetes 集群搭建(kubeadm 方式)"></a>2、kubernetes 集群搭建(kubeadm 方式)</h1><h4 id="前置知识点"><a href="#前置知识点" class="headerlink" title="前置知识点"></a>前置知识点</h4><h4 id="目前生产部署-Kubernetes-集群主要有两种方式："><a href="#目前生产部署-Kubernetes-集群主要有两种方式：" class="headerlink" title="目前生产部署 Kubernetes 集群主要有两种方式："></a>目前生产部署 Kubernetes 集群主要有两种方式：</h4><ul>
<li>（1）kubeadm <ul>
<li>Kubeadm 是一个 K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部 署 Kubernetes 集群。 </li>
<li>官方地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a></li>
</ul>
</li>
<li>（2）二进制包 <ul>
<li>从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。 </li>
<li>Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可 控，推荐使用二进制包部署 Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很 多工作原理，也利于后期维护。</li>
</ul>
</li>
</ul>
<h4 id="kubeadm-部署方式介绍"><a href="#kubeadm-部署方式介绍" class="headerlink" title="kubeadm 部署方式介绍"></a>kubeadm 部署方式介绍</h4><ul>
<li>kubeadm 是官方社区推出的一个用于快速部署 kubernetes 集群的工具，这个工具能通 过两条指令完成一个 kubernetes 集群的部署： </li>
<li>第一、创建一个 Master 节点 kubeadm init </li>
<li>第二， 将 Node 节点加入到当前集群中 $ kubeadm join &lt;Master 节点的 IP 和端口 &gt;</li>
</ul>
<h4 id="安装要求"><a href="#安装要求" class="headerlink" title="安装要求"></a>安装要求</h4><p>在开始之前，部署 Kubernetes 集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64 </li>
<li>硬件配置：2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多 </li>
<li>集群中所有机器之间网络互通 </li>
<li>可以访问外网，需要拉取镜像 </li>
<li>禁止 swap 分</li>
</ul>
<h4 id="最终目标"><a href="#最终目标" class="headerlink" title="最终目标"></a>最终目标</h4><ul>
<li>（1） 在所有节点上安装 Docker 和 kubeadm </li>
<li>（2）部署 Kubernetes Master </li>
<li>（3）部署容器网络插件 </li>
<li>（4）部署 Kubernetes Node，将节点加入 Kubernetes 集群中 </li>
<li>（5）部署 Dashboard Web 页面，可视化查看 Kubernetes 资源</li>
</ul>
<h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525141033.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>配置环境需要组件我整理了</p>
<p>链接：<a target="_blank" rel="noopener" href="http://pan.baidu.com/s/124SrYHRqK6AevApON-OO4w">http://pan.baidu.com/s/124SrYHRqK6AevApON-OO4w</a></p>
<p>提取码：ivdl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">k8s-master 192.168.181.128<br><br>k8s-node1 192.168.181.129<br><br></code></pre></td></tr></table></figure>
<h4 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h4><p>k8s-master:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hostnamectl set-hostname k8s-master<br></code></pre></td></tr></table></figure>

<p>k8s-node1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hostnamectl set-hostname k8s-node1<br></code></pre></td></tr></table></figure>
<p><code>以下都是二台服务器同时操作请按图片操作打开键盘模式</code></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fox1JcLu3VQBEG28wzVNlT-kvIDX%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="防火墙关闭"><a href="#防火墙关闭" class="headerlink" title="防火墙关闭"></a>防火墙关闭</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl stop firewalld<br>systemctl disable firewalld<br></code></pre></td></tr></table></figure>

<h4 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">setenforce 0 # 临时关闭<br>sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config # 永久关闭<br></code></pre></td></tr></table></figure>
<h4 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">swapoff -a # 临时关闭；关闭swap主要是为了性能考虑<br>sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab<br></code></pre></td></tr></table></figure>
<p><code>free # 可以通过这个命令查看swap是否关闭了 </code></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FpawE4ilhcLt6GRGek7-K9qab9sH%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="添加主机名与IP对应的关系"><a href="#添加主机名与IP对应的关系" class="headerlink" title="添加主机名与IP对应的关系"></a>添加主机名与IP对应的关系</h4><p><code>vim /etc/hosts</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.181.128 k8s-master<br>192.168.181.129 k8s-node-1<br></code></pre></td></tr></table></figure>

<h4 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install ntpdate -y<br>ntpdate time.windows.com<br></code></pre></td></tr></table></figure>
<h4 id="将桥接的IPv4流量传递到iptables的链"><a href="#将桥接的IPv4流量传递到iptables的链" class="headerlink" title="将桥接的IPv4流量传递到iptables的链"></a>将桥接的IPv4流量传递到iptables的链</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>EOF<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sysctl --system<br></code></pre></td></tr></table></figure>
<h4 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O/etc/yum.repos.d/docker-ce.repo<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install docker-ce<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl enable docker #设置开机启动<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl start docker #启动docker<br></code></pre></td></tr></table></figure>
<h4 id="添加阿里云YUM软件源"><a href="#添加阿里云YUM软件源" class="headerlink" title="添加阿里云YUM软件源"></a>添加阿里云YUM软件源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;http://goieqwi4.mirror.aliyuncs.com&quot;]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF<br>[kubernetes]<br>name=Kubernetes<br>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">重启docker</span><br>systemctl restart docker<br></code></pre></td></tr></table></figure>
<h4 id="安装kubeadm，kubelet和kubectl"><a href="#安装kubeadm，kubelet和kubectl" class="headerlink" title="安装kubeadm，kubelet和kubectl"></a>安装kubeadm，kubelet和kubectl</h4><blockquote>
<p>kubelet # 运行在 Cluster 所有节点上，负责启动 Pod 和容器</p>
</blockquote>
<blockquote>
<p>kubeadm # 用于初始化 Cluster</p>
</blockquote>
<blockquote>
<p>kubectl # 是 Kubernetes 命令行工具。通过 kubectl 可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">这里安装最新的v1.20.1</span><br>yum install kubelet kubeadm kubectl -y<br><span class="hljs-meta prompt_"># </span><span class="language-bash">此时，还不能启动kubelet，因为此时配置还不能，现在仅仅可以设置开机自启动</span><br>systemctl enable kubelet<br></code></pre></td></tr></table></figure>
<h4 id="部署Kubernetes-Master（只在master上操作）"><a href="#部署Kubernetes-Master（只在master上操作）" class="headerlink" title="部署Kubernetes Master（只在master上操作）"></a>部署Kubernetes Master（只在master上操作）</h4><p><code>初始化kubeadm（只需要修改apiserver-advertise-address及kubernetes-version）</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm init \<br>--apiserver-advertise-address=192.168.181.128 \<br>--image-repository registry.aliyuncs.com/google_containers \<br>--kubernetes-version v1.20.1 \<br>--service-cidr=10.1.0.0/16 \<br>--pod-network-cidr=10.244.0.0/16<br></code></pre></td></tr></table></figure>
<blockquote>
<p>–image-repository string： 这个用于指定从什么位置来拉取镜像（1.13版本才有的），默认值是k8s.gcr.io，我们将其指定为国内镜像地址：registry.aliyuncs.com&#x2F;google_containers</p>
</blockquote>
<blockquote>
<p>–kubernetes-version string： 指定kubenets版本号，默认值是stable-1，会导致从<a target="_blank" rel="noopener" href="http://dl.k8s.io/release/stable-1.txt%E4%B8%8B%E8%BD%BD%E6%9C%80%E6%96%B0%E7%9A%84%E7%89%88%E6%9C%AC%E5%8F%B7%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%B0%86%E5%85%B6%E6%8C%87%E5%AE%9A%E4%B8%BA%E5%9B%BA%E5%AE%9A%E7%89%88%E6%9C%AC%EF%BC%88v1.15.1%EF%BC%89%E6%9D%A5%E8%B7%B3%E8%BF%87%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E3%80%82">http://dl.k8s.io/release/stable-1.txt下载最新的版本号，我们可以将其指定为固定版本（v1.15.1）来跳过网络请求。</a></p>
</blockquote>
<blockquote>
<p>–apiserver-advertise-address 指明用 Master 的哪个 interface 与 Cluster 的其他节点通信。如果 Master 有多个 interface，建议明确指定，如果不指定，kubeadm 会自动选择有默认网关的 interface。</p>
</blockquote>
<blockquote>
<p>–pod-network-cidr 指定 Pod 网络的范围。Kubernetes支持多种网络方案，而且不同网络方案对 –pod-network-cidr有自己的要求，这里设置为10.244.0.0&#x2F;16是因为我们将使用 flannel 网络方案，必须设置成这个 CIDR。</p>
</blockquote>
<p><code>等待初始化成功后会有提示信息，红色框内的命令是需要后续执行的</code><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FhJckGZ8UJtm-ERISgxed-aU8rZ4%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br></code></pre></td></tr></table></figure>
<h4 id="安装Pod网络插件（CNI）（只在master上操作）"><a href="#安装Pod网络插件（CNI）（只在master上操作）" class="headerlink" title="安装Pod网络插件（CNI）（只在master上操作）"></a>安装Pod网络插件（CNI）（只在master上操作）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以通过这种命令一键执行，如果远程不可以下载，可以用如下我已经下载好的配置文件</span><br>kubectl apply -f http://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f kube-flannel.yml<br></code></pre></td></tr></table></figure>

<p>这是我的配置文件，可以复制好上传到服务器直接执行上面语句</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br></pre></td><td class="code"><pre><code class="hljs YML"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">policy/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PodSecurityPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">psp.flannel.unprivileged</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">seccomp.security.alpha.kubernetes.io/allowedProfileNames:</span> <span class="hljs-string">docker/default</span><br>    <span class="hljs-attr">seccomp.security.alpha.kubernetes.io/defaultProfileName:</span> <span class="hljs-string">docker/default</span><br>    <span class="hljs-attr">apparmor.security.beta.kubernetes.io/allowedProfileNames:</span> <span class="hljs-string">runtime/default</span><br>    <span class="hljs-attr">apparmor.security.beta.kubernetes.io/defaultProfileName:</span> <span class="hljs-string">runtime/default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">configMap</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">secret</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">emptyDir</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">hostPath</span><br>  <span class="hljs-attr">allowedHostPaths:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">pathPrefix:</span> <span class="hljs-string">&quot;/etc/cni/net.d&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">pathPrefix:</span> <span class="hljs-string">&quot;/etc/kube-flannel&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">pathPrefix:</span> <span class="hljs-string">&quot;/run/flannel&quot;</span><br>  <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-comment"># Users and groups</span><br>  <span class="hljs-attr">runAsUser:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">RunAsAny</span><br>  <span class="hljs-attr">supplementalGroups:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">RunAsAny</span><br>  <span class="hljs-attr">fsGroup:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">RunAsAny</span><br>  <span class="hljs-comment"># Privilege Escalation</span><br>  <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">defaultAllowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-comment"># Capabilities</span><br>  <span class="hljs-attr">allowedCapabilities:</span> [<span class="hljs-string">&#x27;NET_ADMIN&#x27;</span>]<br>  <span class="hljs-attr">defaultAddCapabilities:</span> []<br>  <span class="hljs-attr">requiredDropCapabilities:</span> []<br>  <span class="hljs-comment"># Host namespaces</span><br>  <span class="hljs-attr">hostPID:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">hostIPC:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">hostPorts:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">min:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">max:</span> <span class="hljs-number">65535</span><br>  <span class="hljs-comment"># SELinux</span><br>  <span class="hljs-attr">seLinux:</span><br>    <span class="hljs-comment"># SELinux is unused in CaaSP</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">&#x27;RunAsAny&#x27;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&#x27;extensions&#x27;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&#x27;podsecuritypolicies&#x27;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&#x27;use&#x27;</span>]<br>    <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&#x27;psp.flannel.unprivileged&#x27;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/status</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">patch</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-cfg</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">cni-conf.json:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="hljs-string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br><span class="hljs-string">      &quot;plugins&quot;: [</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">          &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="hljs-string">          &quot;delegate&quot;: &#123;</span><br><span class="hljs-string">            &quot;hairpinMode&quot;: true,</span><br><span class="hljs-string">            &quot;isDefaultGateway&quot;: true</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">          &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="hljs-string">          &quot;capabilities&quot;: &#123;</span><br><span class="hljs-string">            &quot;portMappings&quot;: true</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      ]</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span>  <span class="hljs-attr">net-conf.json:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="hljs-string">      &quot;Backend&quot;: &#123;</span><br><span class="hljs-string">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-ds-amd64</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">nodeAffinity:</span><br>          <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-attr">nodeSelectorTerms:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/os</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/arch</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">amd64</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">flannel</span><br>      <span class="hljs-attr">initContainers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install-cni</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-amd64</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">cp</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-f</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/kube-flannel/cni-conf.json</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/cni/net.d/10-flannel.conflist</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-amd64</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/bin/flanneld</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--ip-masq</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kube-subnet-mgr</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>            <span class="hljs-attr">add:</span> [<span class="hljs-string">&quot;NET_ADMIN&quot;</span>]<br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-cfg</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-ds-arm64</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">nodeAffinity:</span><br>          <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-attr">nodeSelectorTerms:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/os</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/arch</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">arm64</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">flannel</span><br>      <span class="hljs-attr">initContainers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install-cni</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-arm64</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">cp</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-f</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/kube-flannel/cni-conf.json</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/cni/net.d/10-flannel.conflist</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-arm64</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/bin/flanneld</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--ip-masq</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kube-subnet-mgr</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>             <span class="hljs-attr">add:</span> [<span class="hljs-string">&quot;NET_ADMIN&quot;</span>]<br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-cfg</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-ds-arm</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">nodeAffinity:</span><br>          <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-attr">nodeSelectorTerms:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/os</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/arch</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">arm</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">flannel</span><br>      <span class="hljs-attr">initContainers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install-cni</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-arm</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">cp</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-f</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/kube-flannel/cni-conf.json</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/cni/net.d/10-flannel.conflist</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-arm</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/bin/flanneld</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--ip-masq</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kube-subnet-mgr</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>             <span class="hljs-attr">add:</span> [<span class="hljs-string">&quot;NET_ADMIN&quot;</span>]<br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-cfg</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-ds-ppc64le</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">nodeAffinity:</span><br>          <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-attr">nodeSelectorTerms:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/os</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/arch</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">ppc64le</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">flannel</span><br>      <span class="hljs-attr">initContainers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install-cni</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-ppc64le</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">cp</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-f</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/kube-flannel/cni-conf.json</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/cni/net.d/10-flannel.conflist</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-ppc64le</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/bin/flanneld</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--ip-masq</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kube-subnet-mgr</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>             <span class="hljs-attr">add:</span> [<span class="hljs-string">&quot;NET_ADMIN&quot;</span>]<br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-cfg</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-ds-s390x</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">tier:</span> <span class="hljs-string">node</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">flannel</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">nodeAffinity:</span><br>          <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-attr">nodeSelectorTerms:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/os</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">beta.kubernetes.io/arch</span><br>                    <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                    <span class="hljs-attr">values:</span><br>                      <span class="hljs-bullet">-</span> <span class="hljs-string">s390x</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">flannel</span><br>      <span class="hljs-attr">initContainers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install-cni</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-s390x</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">cp</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-f</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/kube-flannel/cni-conf.json</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/cni/net.d/10-flannel.conflist</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/coreos/flannel:v0.11.0-s390x</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/opt/bin/flanneld</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--ip-masq</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kube-subnet-mgr</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;50Mi&quot;</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>             <span class="hljs-attr">add:</span> [<span class="hljs-string">&quot;NET_ADMIN&quot;</span>]<br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-flannel/</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/flannel</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/cni/net.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel-cfg</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">kube-flannel-cfg</span><br></code></pre></td></tr></table></figure>
<h4 id="Node节点加入集群（只在node上操作）"><a href="#Node节点加入集群（只在node上操作）" class="headerlink" title="Node节点加入集群（只在node上操作）"></a>Node节点加入集群（只在node上操作）</h4><p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm join 10.238.211.9:6443 --token iz96vy.f5ukew9geeome5is \<br>--discovery-token-ca-cert-hash sha256:72b689426bfc34512294c29b39ea3b2af3a94e39f62c4434f3a49f16d51a1382<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get nodes<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Ft5jWzYoAVMykhCw498dhylhYKxs%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pods -n kube-system    #查看运行时容器pod （一个pod里面运行了多个docker容器）<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/cFo--tBORlgjOWGRsIdqjY_9a7Poh%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="集群测试"><a href="#集群测试" class="headerlink" title="集群测试"></a>集群测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create deployment nginx --image=nginx<br><br>kubectl expose deployment nginx --port=80 --type=NodePort<br><br>kubectl get pod,svc<br><br>访问地址：http://NodeIP:Port<br></code></pre></td></tr></table></figure>
<h1 id="3、DashBoard和KubeSphere监控平台任选，我这里选择DashBoard部署方式"><a href="#3、DashBoard和KubeSphere监控平台任选，我这里选择DashBoard部署方式" class="headerlink" title="3、DashBoard和KubeSphere监控平台任选，我这里选择DashBoard部署方式"></a>3、DashBoard和KubeSphere监控平台任选，我这里选择DashBoard部署方式</h1><blockquote>
<p>Dashboard 是基于网页的 Kubernetes 用户界面。您可以使用 Dashboard 将容器应用部署到 Kubernetes 集群中，也可以对容器应用排错，还能管理集群资源。您可以使用 Dashboard 获取运行在集群中的应用的概览信息，也可以创建或者修改 Kubernetes 资源（如 Deployment，Job，DaemonSet 等等）。例如，您可以对 Deployment 实现弹性伸缩、发起滚动升级、重启 Pod 或者使用向导创建新的应用。</p>
</blockquote>
<h4 id="获取并修改Yaml文件"><a href="#获取并修改Yaml文件" class="headerlink" title="获取并修改Yaml文件"></a>获取并修改Yaml文件</h4><p>项目地址 <a target="_blank" rel="noopener" href="http://github.com/kubernetes/dashboard/releases">http://github.com/kubernetes/dashboard/releases</a><br>我下载的是最新的V2.1.0，之前使用网上大神说的V1.8.3出现各种神奇问题，还会报404，后来又看了一篇文章，发现是版本问题</p>
<p>下载dashboard-2.1.0.tar.gz<br>找到配置文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">dashboard<span class="hljs-regexp">/v2.0.0-beta8/</span>aio<span class="hljs-regexp">/deploy/</span>recommended.yaml<br></code></pre></td></tr></table></figure>
<p>修改service通过NodePort方式访问K8S Dashboard</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span> <span class="hljs-comment">#新加此行</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8443</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31080</span> <span class="hljs-comment">#新加此行</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br></code></pre></td></tr></table></figure>
<h4 id="应用配置文件-耐心等待一会"><a href="#应用配置文件-耐心等待一会" class="headerlink" title="应用配置文件 (耐心等待一会)"></a>应用配置文件 (耐心等待一会)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f recommended.yaml<br></code></pre></td></tr></table></figure>
<p>查看一下pod是否成功，注意命名空间是在kubernetes-dashboard下面；</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> pod -n kubernetes-dashboard<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fkyoex4GGGwmjtCatDrKu0r2AhYc" srcset="/img/loading.gif" lazyload alt="输入图片说明" title="QQ截图20201229183512.png"></p>
<h4 id="访问-http-ip-31080"><a href="#访问-http-ip-31080" class="headerlink" title="访问 http:ip:31080"></a>访问 http:ip:31080</h4><p><code>注：通过http是不行的需要http</code><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FhbvD_ymZLIo3-u5V7aMGr-jRs1O%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br>创建service account并绑定默认cluster-admin管理员集群角色：【依次执行】</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create serviceaccount dashboard-admin -n kube-system<br>kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin<br></code></pre></td></tr></table></figure>
<p>获取Token</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">kubectl describe secrets -n kube-system <span class="hljs-constructor">$(<span class="hljs-params">kubectl</span> -<span class="hljs-params">n</span> <span class="hljs-params">kube</span>-<span class="hljs-params">system</span> <span class="hljs-params">get</span> <span class="hljs-params">secret</span> | <span class="hljs-params">awk</span> &#x27;<span class="hljs-operator">/</span><span class="hljs-params">dashboard</span>-<span class="hljs-params">admin</span><span class="hljs-operator">/</span>&#123;<span class="hljs-params">print</span> $1&#125;&#x27;)</span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FFvpIdr-FaklKVGoujBMn4_owEsi3%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="登录dashboard"><a href="#登录dashboard" class="headerlink" title="登录dashboard"></a>登录dashboard</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FnXwu6fSeS_GWKoBBtE-n9q_uhTj%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="4、部署Metrics-Server服务"><a href="#4、部署Metrics-Server服务" class="headerlink" title="4、部署Metrics-Server服务"></a>4、部署Metrics-Server服务</h1><p>在新版的K8S中，系统资源的采集均使用Metrics-Server服务，可以通过Metrics-Server服务采集节点和Pod的内存、磁盘、CPU和网络的使用率等信息。</p>
<h4 id="下载并解压Metrics-Server"><a href="#下载并解压Metrics-Server" class="headerlink" title="下载并解压Metrics-Server"></a>下载并解压Metrics-Server</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">http://github.com/kubernetes-sigs/metrics-server/archive/v0.3.6.tar.gz<br></code></pre></td></tr></table></figure>
<h4 id="修改Metrics-Server配置文件"><a href="#修改Metrics-Server配置文件" class="headerlink" title="修改Metrics-Server配置文件"></a>修改Metrics-Server配置文件</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">vim</span> metrics-server-<span class="hljs-number">0</span>.<span class="hljs-number">3</span>.<span class="hljs-number">6</span>/deploy/<span class="hljs-number">1</span>.<span class="hljs-number">8</span>+/metrics-server-deployment.yaml<br></code></pre></td></tr></table></figure>
<p>这是我的配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">metrics-server</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">metrics-server</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">metrics-server</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">metrics-server</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-dir</span><br>        <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>        <span class="hljs-comment"># 修改image 和 imagePullPolicy</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-comment"># 新增command配置</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/metrics-server</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kubelet-insecure-tls</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-dir</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span><br>        <span class="hljs-comment"># 新增resources配置</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">300m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br></code></pre></td></tr></table></figure>
<h4 id="应用配置文件"><a href="#应用配置文件" class="headerlink" title="应用配置文件"></a>应用配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd metrics-server-0.3.6/deploy/1.8+<br>kubectl apply -f .<br></code></pre></td></tr></table></figure>
<h4 id="安装完Metrics-Server之后，查看node信息"><a href="#安装完Metrics-Server之后，查看node信息" class="headerlink" title="安装完Metrics-Server之后，查看node信息"></a>安装完Metrics-Server之后，查看node信息</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl top <span class="hljs-keyword">node</span><span class="hljs-title"></span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/FlgWj_5lZnoHrtwgBVuAPxNf3-jx%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="再次登录DashBoard"><a href="#再次登录DashBoard" class="headerlink" title="再次登录DashBoard"></a>再次登录DashBoard</h4><p>各种炫酷图表就可以显示啦~大功告成<br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/2021011515185798.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="K8S命令自动补全"><a href="#K8S命令自动补全" class="headerlink" title="K8S命令自动补全"></a>K8S命令自动补全</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum <span class="hljs-keyword">install </span><span class="hljs-keyword">bash-completion </span>-y<br></code></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">source</span> <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/bash-completion/</span>bash_completion<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> &lt;(kubectl completion bash)<br></code></pre></td></tr></table></figure>
<h4 id="推荐二个自动生成YML文件的地址"><a href="#推荐二个自动生成YML文件的地址" class="headerlink" title="推荐二个自动生成YML文件的地址"></a>推荐二个自动生成YML文件的地址</h4><h4 id="http-k8syaml-com"><a href="#http-k8syaml-com" class="headerlink" title="http://k8syaml.com/"></a><a target="_blank" rel="noopener" href="http://k8syaml.com/">http://k8syaml.com/</a></h4><h4 id="http-www-kubebiz-com-（推荐安装什么都有）"><a href="#http-www-kubebiz-com-（推荐安装什么都有）" class="headerlink" title="http://www.kubebiz.com/ （推荐安装什么都有）"></a><a target="_blank" rel="noopener" href="http://www.kubebiz.com/">http://www.kubebiz.com/</a> <code>（推荐安装什么都有）</code></h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fi0X9FlK5dLbEeGirYOefEs60CVH%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/Fohc-4UR6fY2x4DOgY-_LybDTIsp%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="5、kubernetes-集群搭建-二进制方式"><a href="#5、kubernetes-集群搭建-二进制方式" class="headerlink" title="5、kubernetes 集群搭建(二进制方式)"></a>5、kubernetes 集群搭建(二进制方式)</h1><h4 id="1-修改主机名"><a href="#1-修改主机名" class="headerlink" title="1.修改主机名"></a>1.修改主机名</h4><p>k8s-master:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl set-hostname m1<br></code></pre></td></tr></table></figure>

<p>k8s-node1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl set-hostname n1<br></code></pre></td></tr></table></figure>

<p>以下都是二台服务器同时操作请按图片操作打开键盘模式</p>
<p><img src="https://img-blog.csdnimg.cn/20210224144556516.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="2-防火墙关闭"><a href="#2-防火墙关闭" class="headerlink" title="2.防火墙关闭"></a>2.防火墙关闭</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl stop firewalld<br>systemctl <span class="hljs-built_in">disable</span> firewalld<br></code></pre></td></tr></table></figure>


<h4 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3.关闭selinux"></a>3.关闭selinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">setenforce 0 <span class="hljs-comment"># 临时关闭</span><br>sed -i <span class="hljs-string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;</span> /etc/selinux/config <span class="hljs-comment"># 永久关闭</span><br></code></pre></td></tr></table></figure>

<h4 id="4-关闭swap"><a href="#4-关闭swap" class="headerlink" title="4.关闭swap"></a>4.关闭swap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">swapoff -a <span class="hljs-comment"># 临时关闭；关闭swap主要是为了性能考虑</span><br>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab<br>free <span class="hljs-comment"># 可以通过这个命令查看swap是否关闭了 </span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210224144603874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>时间同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install ntpdate -y<br>ntpdate time.windows.com<br></code></pre></td></tr></table></figure>

<h4 id="5-将桥接的IPv4流量传递到iptables的链"><a href="#5-将桥接的IPv4流量传递到iptables的链" class="headerlink" title="5.将桥接的IPv4流量传递到iptables的链"></a>5.将桥接的IPv4流量传递到iptables的链</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sysctl --system<br></code></pre></td></tr></table></figure>

<h4 id="6-添加主机名与IP对应的关系-master上操作"><a href="#6-添加主机名与IP对应的关系-master上操作" class="headerlink" title="6.添加主机名与IP对应的关系 ( master上操作 )"></a>6.添加主机名与IP对应的关系 ( master上操作 )</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/hosts<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">192.168.181.128 k8s-master<br>192.168.181.129 k8s-node-1<br></code></pre></td></tr></table></figure>

<h4 id="7-准备-cfssl-证书生成工具-master上操作"><a href="#7-准备-cfssl-证书生成工具-master上操作" class="headerlink" title="7.准备 cfssl 证书生成工具 ( master上操作 )"></a>7.准备 cfssl 证书生成工具 ( master上操作 )</h4><p>cfssl 是一个开源的证书管理工具，使用 json 文件生成证书，相比 openssl 更方便使用。 找任意一台服务器操作，这里用 Master 节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64<br><span class="hljs-built_in">chmod</span> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64<br><span class="hljs-built_in">mv</span> cfssl_linux-amd64 /usr/local/bin/cfssl<br><span class="hljs-built_in">mv</span> cfssljson_linux-amd64 /usr/local/bin/cfssljson<br><span class="hljs-built_in">mv</span> cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo<br><span class="hljs-built_in">chmod</span> +x /usr/bin/cfssl*<br></code></pre></td></tr></table></figure>

<h4 id="7-1生成-Etcd-证书-（1）自签证书颁发机构（CA）-创建工作目录："><a href="#7-1生成-Etcd-证书-（1）自签证书颁发机构（CA）-创建工作目录：" class="headerlink" title="7.1生成 Etcd 证书 （1）自签证书颁发机构（CA） 创建工作目录："></a>7.1生成 Etcd 证书 （1）自签证书颁发机构（CA） 创建工作目录：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p ~/TLS/&#123;etcd,k8s&#125;<br><br><span class="hljs-built_in">cd</span> TLS/etcd<br></code></pre></td></tr></table></figure>

<h4 id="7-2自签-CA"><a href="#7-2自签-CA" class="headerlink" title="7.2自签 CA"></a>7.2自签 CA</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; ca-config.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;signing&quot;: &#123;</span><br><span class="hljs-string">    &quot;default&quot;: &#123;</span><br><span class="hljs-string">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;profiles&quot;: &#123;</span><br><span class="hljs-string">      &quot;www&quot;: &#123;</span><br><span class="hljs-string">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="hljs-string">         &quot;usages&quot;: [</span><br><span class="hljs-string">            &quot;signing&quot;,</span><br><span class="hljs-string">            &quot;key encipherment&quot;,</span><br><span class="hljs-string">            &quot;server auth&quot;,</span><br><span class="hljs-string">            &quot;client auth&quot;</span><br><span class="hljs-string">        ]</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; ca-csr.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="hljs-string">    &quot;key&quot;: &#123;</span><br><span class="hljs-string">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="hljs-string">        &quot;size&quot;: 2048</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;names&quot;: [</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="hljs-string">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="hljs-string">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="7-3生成证书："><a href="#7-3生成证书：" class="headerlink" title="7.3生成证书："></a>7.3生成证书：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br><br><span class="hljs-built_in">ls</span> *pem<br></code></pre></td></tr></table></figure>

<h4 id="7-4使用自签-CA-签发-Etcd-HTTPS-证书-创建证书申请文件：-修改对应的master和node的IP地址"><a href="#7-4使用自签-CA-签发-Etcd-HTTPS-证书-创建证书申请文件：-修改对应的master和node的IP地址" class="headerlink" title="7.4使用自签 CA 签发 Etcd HTTPS 证书 创建证书申请文件：(修改对应的master和node的IP地址)"></a>7.4使用自签 CA 签发 Etcd HTTPS 证书 创建证书申请文件：(修改对应的master和node的IP地址)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; server-csr.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="hljs-string">    &quot;hosts&quot;: [</span><br><span class="hljs-string">    &quot;192.168.31.71&quot;,</span><br><span class="hljs-string">    &quot;192.168.31.72&quot;,</span><br><span class="hljs-string">    &quot;192.168.31.73&quot;</span><br><span class="hljs-string">    ],</span><br><span class="hljs-string">    &quot;key&quot;: &#123;</span><br><span class="hljs-string">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="hljs-string">        &quot;size&quot;: 2048</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;names&quot;: [</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="hljs-string">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="hljs-string">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="7-5注：上述文件-hosts-字段中-IP-为所有-etcd-节点的集群内部通信-IP，一个都不能少！为了-方便后期扩容可以多写几个预留的-IP。-生成证书："><a href="#7-5注：上述文件-hosts-字段中-IP-为所有-etcd-节点的集群内部通信-IP，一个都不能少！为了-方便后期扩容可以多写几个预留的-IP。-生成证书：" class="headerlink" title="7.5注：上述文件 hosts 字段中 IP 为所有 etcd 节点的集群内部通信 IP，一个都不能少！为了 方便后期扩容可以多写几个预留的 IP。 生成证书："></a>7.5注：上述文件 hosts 字段中 IP 为所有 etcd 节点的集群内部通信 IP，一个都不能少！为了 方便后期扩容可以多写几个预留的 IP。 生成证书：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server <span class="hljs-built_in">ls</span> server*pem<br></code></pre></td></tr></table></figure>

<h4 id="8-从-Github-下载二进制文件-下载地址："><a href="#8-从-Github-下载二进制文件-下载地址：" class="headerlink" title="8.从 Github 下载二进制文件 下载地址："></a>8.从 Github 下载二进制文件 下载地址：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/etcd-io/etcd/releases<br></code></pre></td></tr></table></figure>

<p>git下载太慢，我下载保持在了百度云</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1xGbuTDcWy6wmbqLvMxWsRQ">https://pan.baidu.com/s/1xGbuTDcWy6wmbqLvMxWsRQ</a><br>提取码：ob9k<br>复制这段内容后打开百度网盘手机App，操作更方便哦</p>
<h4 id="9-部署-Etcd-集群-以下在节点-1-上操作，为简化操作，待会将节点-1-生成的所有文件拷贝到节点-2-和节点-3"><a href="#9-部署-Etcd-集群-以下在节点-1-上操作，为简化操作，待会将节点-1-生成的所有文件拷贝到节点-2-和节点-3" class="headerlink" title="9.部署 Etcd 集群 以下在节点 1 上操作，为简化操作，待会将节点 1 生成的所有文件拷贝到节点 2 和节点 3"></a>9.部署 Etcd 集群 以下在节点 1 上操作，为简化操作，待会将节点 1 生成的所有文件拷贝到节点 2 和节点 3</h4><p>（1）创建工作目录并解压二进制包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /opt/etcd/&#123;bin,cfg,ssl&#125; -p<br>tar zxvf etcd-v3.4.14-linux-amd64.tar.gz<br><span class="hljs-built_in">mv</span> etcd-v3.4.14-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/<br></code></pre></td></tr></table></figure>

<h4 id="10-创建etcd-conf-（修改对应的master的ip地址）"><a href="#10-创建etcd-conf-（修改对应的master的ip地址）" class="headerlink" title="10.创建etcd.conf （修改对应的master的ip地址）"></a>10.创建etcd.conf （修改对应的master的ip地址）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">#[Member]</span><br><span class="hljs-string">ETCD_NAME=&quot;etcd-1&quot;</span><br><span class="hljs-string">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="hljs-string">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.31.71:2380&quot;</span><br><span class="hljs-string">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.31.71:2379&quot;</span><br><span class="hljs-string">#[Clustering]</span><br><span class="hljs-string">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.31.71:2380&quot;</span><br><span class="hljs-string">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.31.71:2379&quot;</span><br><span class="hljs-string">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380&quot;</span><br><span class="hljs-string">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="hljs-string">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>ETCD_NAME：节点名称，集群中唯一<br>ETCD_DATA_DIR：数据目录<br>ETCD_LISTEN_PEER_URLS：集群通信监听地址<br>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址<br>ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址<br>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址<br>ETCD_INITIAL_CLUSTER：集群节点地址<br>ETCD_INITIAL_CLUSTER_TOKEN：集群 Token<br>ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new 是新集群，existing 表示加入 已有集群</p>
<h4 id="11-创建etcd-service"><a href="#11-创建etcd-service" class="headerlink" title="11.创建etcd.service"></a>11.创建etcd.service</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Etcd Server</span><br><span class="hljs-string">After=network.target</span><br><span class="hljs-string">After=network-online.target</span><br><span class="hljs-string">Wants=network-online.target</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">Type=notify</span><br><span class="hljs-string">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span><br><span class="hljs-string">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="hljs-string">--cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="hljs-string">--key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="hljs-string">--peer-cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="hljs-string">--peer-key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="hljs-string">--trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="hljs-string">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="hljs-string">--logger=zap</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">LimitNOFILE=65536</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="12-拷贝刚才生成的证书-把刚才生成的证书拷贝到配置文件中的路径："><a href="#12-拷贝刚才生成的证书-把刚才生成的证书拷贝到配置文件中的路径：" class="headerlink" title="12.拷贝刚才生成的证书 把刚才生成的证书拷贝到配置文件中的路径："></a>12.拷贝刚才生成的证书 把刚才生成的证书拷贝到配置文件中的路径：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/<br></code></pre></td></tr></table></figure>

<h4 id="13-启动并设置开机启动"><a href="#13-启动并设置开机启动" class="headerlink" title="13.启动并设置开机启动"></a>13.启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl start etcd  <span class="hljs-comment">#启动后会卡住因为需要和node节点一起执行改命令</span><br>systemctl <span class="hljs-built_in">enable</span> etcd<br></code></pre></td></tr></table></figure>

<h4 id="14-将上面节点-1-所有生成的文件拷贝到节点-2-和节点-3"><a href="#14-将上面节点-1-所有生成的文件拷贝到节点-2-和节点-3" class="headerlink" title="14.将上面节点 1 所有生成的文件拷贝到节点 2 和节点 3"></a>14.将上面节点 1 所有生成的文件拷贝到节点 2 和节点 3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">scp -r /opt/etcd/ root@192.168.31.72:/opt/<br><br>scp /usr/lib/systemd/system/etcd.service root@192.168.31.72:/usr/lib/systemd/system/<br><br>scp -r /opt/etcd/ root@192.168.31.73:/opt/<br><br>scp /usr/lib/systemd/system/etcd.service root@192.168.31.73:/usr/lib/systemd/system/<br></code></pre></td></tr></table></figure>

<h4 id="15-然后在节点-2-和节点-3-分别修改-etcd-conf-配置文件中的节点名称和当前服务器-IP："><a href="#15-然后在节点-2-和节点-3-分别修改-etcd-conf-配置文件中的节点名称和当前服务器-IP：" class="headerlink" title="15.然后在节点 2 和节点 3 分别修改 etcd.conf 配置文件中的节点名称和当前服务器 IP："></a>15.然后在节点 2 和节点 3 分别修改 etcd.conf 配置文件中的节点名称和当前服务器 IP：</h4><p>#[Member] ETCD_NAME&#x3D;”etcd-1” # 修改此处，节点 2 改为 <code>etcd-2</code>，节点 3 改为 <code>etcd-3</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi /opt/etcd/cfg/etcd.conf<br></code></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20210224145241487.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="16-最后启动-etcd-并设置开机启动，同上。"><a href="#16-最后启动-etcd-并设置开机启动，同上。" class="headerlink" title="16.最后启动 etcd 并设置开机启动，同上。"></a>16.最后启动 etcd 并设置开机启动，同上。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br><br>systemctl start etcd<br><br>systemctl <span class="hljs-built_in">enable</span> etcd<br></code></pre></td></tr></table></figure>

<p>需要二边一起执行</p>
<p><img src="https://img-blog.csdnimg.cn/20210224145301467.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="17-查看集群状态"><a href="#17-查看集群状态" class="headerlink" title="17.查看集群状态"></a>17.查看集群状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=<span class="hljs-string">&quot;https://192.168.248.202:2379,https://192.168.248.220:2379,https://192.168.248.224:2379&quot;</span> endpoint status --write-out=table<br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210224145315730.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="18-安装docker-以下在所有节点操作。这里采用二进制安装，用-yum-安装也一样-（多台节点安装可以采用键盘工具）"><a href="#18-安装docker-以下在所有节点操作。这里采用二进制安装，用-yum-安装也一样-（多台节点安装可以采用键盘工具）" class="headerlink" title="18.安装docker 以下在所有节点操作。这里采用二进制安装，用 yum 安装也一样 （多台节点安装可以采用键盘工具）"></a>18.安装docker 以下在所有节点操作。这里采用二进制安装，用 yum 安装也一样 （多台节点安装可以采用键盘工具）</h4><p>下载地址：<a target="_blank" rel="noopener" href="https://download.docker.com/linux/static/stable/x86_64/docker-20.10.3.tgz">https://download.docker.com/linux/static/stable/x86_64/docker-20.10.3.tgz</a></p>
<p>百度云下载地址  </p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1HcdeAAakAIMpDBSbN1ABQg">https://pan.baidu.com/s/1HcdeAAakAIMpDBSbN1ABQg</a><br>提取码：w93r<br>复制这段内容后打开百度网盘手机App，操作更方便哦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar zxvf docker-20.10.3.tgz <br><span class="hljs-built_in">mv</span> docker/* /usr/bin<br></code></pre></td></tr></table></figure>

<h4 id="19-systemd-管理-docker"><a href="#19-systemd-管理-docker" class="headerlink" title="19.systemd 管理 docker"></a>19.systemd 管理 docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/docker.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Docker Application Container Engine</span><br><span class="hljs-string">Documentation=https://docs.docker.com</span><br><span class="hljs-string">After=network-online.target firewalld.service</span><br><span class="hljs-string">Wants=network-online.target</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">Type=notify</span><br><span class="hljs-string">ExecStart=/usr/bin/dockerd</span><br><span class="hljs-string">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="hljs-string">LimitNOFILE=infinity</span><br><span class="hljs-string">LimitNPROC=infinity</span><br><span class="hljs-string">LimitCORE=infinity</span><br><span class="hljs-string">TimeoutStartSec=0</span><br><span class="hljs-string">Delegate=yes</span><br><span class="hljs-string">KillMode=process</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">StartLimitBurst=3</span><br><span class="hljs-string">StartLimitInterval=60s</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="20-配置阿里云加速"><a href="#20-配置阿里云加速" class="headerlink" title="20.配置阿里云加速"></a>20.配置阿里云加速</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /etc/docker<br><span class="hljs-built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="21-启动并设置开机启动"><a href="#21-启动并设置开机启动" class="headerlink" title="21.启动并设置开机启动"></a>21.启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br><br>systemctl start docker<br><br>systemctl <span class="hljs-built_in">enable</span> docker<br></code></pre></td></tr></table></figure>
<h4 id="22-查询docker是否成功安装"><a href="#22-查询docker是否成功安装" class="headerlink" title="22.查询docker是否成功安装"></a>22.查询docker是否成功安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker -v<br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210224145404669.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="23-部署-Master-Node"><a href="#23-部署-Master-Node" class="headerlink" title="23.部署 Master Node"></a>23.部署 Master Node</h4><h6 id="23-1-生成-kube-apiserver-证书-（1）自签证书颁发机构（CA）"><a href="#23-1-生成-kube-apiserver-证书-（1）自签证书颁发机构（CA）" class="headerlink" title="23.1 生成 kube-apiserver 证书 （1）自签证书颁发机构（CA）"></a>23.1 生成 kube-apiserver 证书 （1）自签证书颁发机构（CA）</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> TLS/k8s<br></code></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; ca-config.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;signing&quot;: &#123;</span><br><span class="hljs-string">    &quot;default&quot;: &#123;</span><br><span class="hljs-string">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;profiles&quot;: &#123;</span><br><span class="hljs-string">      &quot;kubernetes&quot;: &#123;</span><br><span class="hljs-string">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="hljs-string">         &quot;usages&quot;: [</span><br><span class="hljs-string">            &quot;signing&quot;,</span><br><span class="hljs-string">            &quot;key encipherment&quot;,</span><br><span class="hljs-string">            &quot;server auth&quot;,</span><br><span class="hljs-string">            &quot;client auth&quot;</span><br><span class="hljs-string">        ]</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; ca-csr.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="hljs-string">    &quot;key&quot;: &#123;</span><br><span class="hljs-string">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="hljs-string">        &quot;size&quot;: 2048</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;names&quot;: [</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="hljs-string">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="hljs-string">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="hljs-string">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="hljs-string">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h6 id="23-2生成证书"><a href="#23-2生成证书" class="headerlink" title="23.2生成证书"></a>23.2生成证书</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br><span class="hljs-built_in">ls</span> *pem<br></code></pre></td></tr></table></figure>

<h6 id="23-3使用自签-CA-签发-kube-apiserver-HTTPS-证书-创建证书申请文件："><a href="#23-3使用自签-CA-签发-kube-apiserver-HTTPS-证书-创建证书申请文件：" class="headerlink" title="23.3使用自签 CA 签发 kube-apiserver HTTPS 证书 创建证书申请文件："></a>23.3使用自签 CA 签发 kube-apiserver HTTPS 证书 创建证书申请文件：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; server-csr.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="hljs-string">    &quot;hosts&quot;: [</span><br><span class="hljs-string">      &quot;10.0.0.1&quot;,</span><br><span class="hljs-string">      &quot;127.0.0.1&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.71&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.72&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.73&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.74&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.81&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.82&quot;,</span><br><span class="hljs-string">      &quot;192.168.1.88&quot;,</span><br><span class="hljs-string">      &quot;kubernetes&quot;,</span><br><span class="hljs-string">      &quot;kubernetes.default&quot;,</span><br><span class="hljs-string">      &quot;kubernetes.default.svc&quot;,</span><br><span class="hljs-string">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="hljs-string">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="hljs-string">    ],</span><br><span class="hljs-string">    &quot;key&quot;: &#123;</span><br><span class="hljs-string">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="hljs-string">        &quot;size&quot;: 2048</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;names&quot;: [</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="hljs-string">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="hljs-string">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="hljs-string">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="hljs-string">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h6 id="23-4生成证书："><a href="#23-4生成证书：" class="headerlink" title="23.4生成证书："></a>23.4生成证书：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server<br><br><span class="hljs-built_in">ls</span> server*pem<br></code></pre></td></tr></table></figure>

<h4 id="24-从-Github-下载二进制文件"><a href="#24-从-Github-下载二进制文件" class="headerlink" title="24.从 Github 下载二进制文件"></a>24.从 Github 下载二进制文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG- 1.20.1.md<span class="hljs-comment">#v1183</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/202102241455531.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>git下载太慢我保存在了百度云</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1mQPZCxjCnjFxvorkQo9zcA">https://pan.baidu.com/s/1mQPZCxjCnjFxvorkQo9zcA</a><br>提取码：ue5n<br>复制这段内容后打开百度网盘手机App，操作更方便哦</p>
<h4 id="25-解压二进制包"><a href="#25-解压二进制包" class="headerlink" title="25.解压二进制包"></a>25.解压二进制包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;<br>tar zxvf kubernetes-server-linux-amd64.tar.gz<br><span class="hljs-built_in">cd</span> kubernetes/server/bin<br><span class="hljs-built_in">cp</span> kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin<br><span class="hljs-built_in">cp</span> kubectl /usr/bin/<br></code></pre></td></tr></table></figure>

<h4 id="26-部署-kube-apiserver"><a href="#26-部署-kube-apiserver" class="headerlink" title="26.部署 kube-apiserver"></a>26.部署 kube-apiserver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\</span><br><span class="hljs-string">--v=2 \\</span><br><span class="hljs-string">--log-dir=/opt/kubernetes/logs \\</span><br><span class="hljs-string">--etcd-servers=https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 \\</span><br><span class="hljs-string">--bind-address=192.168.1.71 \\</span><br><span class="hljs-string">--secure-port=6443 \\</span><br><span class="hljs-string">--advertise-address=192.168.1.71 \\</span><br><span class="hljs-string">--allow-privileged=true \\</span><br><span class="hljs-string">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="hljs-string">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="hljs-string">--authorization-mode=RBAC,Node \\</span><br><span class="hljs-string">--enable-bootstrap-token-auth=true \\</span><br><span class="hljs-string">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="hljs-string">--service-node-port-range=30000-32767 \\</span><br><span class="hljs-string">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="hljs-string">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="hljs-string">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span><br><span class="hljs-string">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="hljs-string">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="hljs-string">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="hljs-string">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span><br><span class="hljs-string">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span><br><span class="hljs-string">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span><br><span class="hljs-string">--audit-log-maxage=30 \\</span><br><span class="hljs-string">--audit-log-maxbackup=3 \\</span><br><span class="hljs-string">--audit-log-maxsize=100 \\</span><br><span class="hljs-string">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>注：上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用 EOF 保留换 行符。<br>–logtostderr：启用日志<br>—v：日志等级<br>–log-dir：日志目录<br>–etcd-servers：etcd 集群地址<br>–bind-address：监听地址<br>–secure-port：https 安全端口<br>–advertise-address：集群通告地址<br>–allow-privileged：启用授权<br>–service-cluster-ip-range：Service 虚拟 IP 地址段<br>–enable-admission-plugins：准入控制模块<br>–authorization-mode：认证授权，启用 RBAC 授权和节点自管理<br>–enable-bootstrap-token-auth：启用 TLS bootstrap 机制<br>–token-auth-file：bootstrap token 文件<br>–service-node-port-range：Service nodeport 类型默认分配端口范围<br>–kubelet-client-xxx：apiserver 访问 kubelet 客户端证书<br>–tls-xxx-file：apiserver https 证书<br>–etcd-xxxfile：连接 Etcd 集群证书<br>–audit-log-xxx：审计日志</p>
<h4 id="27-把刚才生成的证书拷贝到配置文件中的路径："><a href="#27-把刚才生成的证书拷贝到配置文件中的路径：" class="headerlink" title="27.把刚才生成的证书拷贝到配置文件中的路径："></a>27.把刚才生成的证书拷贝到配置文件中的路径：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/<br></code></pre></td></tr></table></figure>

<h4 id="28-创建上述配置文件中-token-文件"><a href="#28-创建上述配置文件中-token-文件" class="headerlink" title="28.创建上述配置文件中 token 文件"></a>28.创建上述配置文件中 token 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>格式：token，用户名，UID，用户组 token 也可自行生成替换： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">head</span> -c 16 /dev/urandom | <span class="hljs-built_in">od</span> -An -t x | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span><br></code></pre></td></tr></table></figure>

<h4 id="29-systemd-管理-apiserver"><a href="#29-systemd-管理-apiserver" class="headerlink" title="29.systemd 管理 apiserver"></a>29.systemd 管理 apiserver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Kubernetes API Server</span><br><span class="hljs-string">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="hljs-string">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="30-启动并设置开机启动"><a href="#30-启动并设置开机启动" class="headerlink" title="30.启动并设置开机启动"></a>30.启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl start kube-apiserver<br>systemctl <span class="hljs-built_in">enable</span> kube-apiserver<br>systemctl status kube-apiserver <br></code></pre></td></tr></table></figure>

<h4 id="31-授权-kubelet-bootstrap-用户允许请求证书"><a href="#31-授权-kubelet-bootstrap-用户允许请求证书" class="headerlink" title="31.授权 kubelet-bootstrap 用户允许请求证书"></a>31.授权 kubelet-bootstrap 用户允许请求证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create clusterrolebinding kubelet-bootstrap \<br>--clusterrole=system:node-bootstrapper \<br>--user=kubelet-bootstrap<br></code></pre></td></tr></table></figure>

<h4 id="32-部署-kube-controller-manager"><a href="#32-部署-kube-controller-manager" class="headerlink" title="32.部署 kube-controller-manager"></a>32.部署 kube-controller-manager</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\</span><br><span class="hljs-string">--v=2 \\</span><br><span class="hljs-string">--log-dir=/opt/kubernetes/logs \\</span><br><span class="hljs-string">--leader-elect=true \\</span><br><span class="hljs-string">--master=127.0.0.1:8080 \\</span><br><span class="hljs-string">--bind-address=127.0.0.1 \\</span><br><span class="hljs-string">--allocate-node-cidrs=true \\</span><br><span class="hljs-string">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="hljs-string">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="hljs-string">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="hljs-string">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span><br><span class="hljs-string">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="hljs-string">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="hljs-string">--experimental-cluster-signing-duration=87600h0m0s&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>–master：通过本地非安全本地端口 8080 连接 apiserver。</p>
<p>–leader-elect：当该组件启动多个时，自动选举（HA）</p>
<p>–cluster-signing-cert-file&#x2F;–cluster-signing-key-file：自动为 kubelet 颁发证书</p>
<p>的 CA，与 apiserver 保持一致</p>
<h4 id="33-systemd-管理-controller-manager"><a href="#33-systemd-管理-controller-manager" class="headerlink" title="33.systemd 管理 controller-manager"></a>33.systemd 管理 controller-manager</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Kubernetes Controller Manager</span><br><span class="hljs-string">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="hljs-string">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="34-启动并设置开机启动"><a href="#34-启动并设置开机启动" class="headerlink" title="34. 启动并设置开机启动"></a>34. 启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl start kube-controller-manager<br>systemctl <span class="hljs-built_in">enable</span> kube-controller-manager<br>systemctl status kube-controller-manager<br></code></pre></td></tr></table></figure>

<h4 id="35-部署-kube-scheduler"><a href="#35-部署-kube-scheduler" class="headerlink" title="35.部署 kube-scheduler"></a>35.部署 kube-scheduler</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \</span><br><span class="hljs-string">--v=2 \</span><br><span class="hljs-string">--log-dir=/opt/kubernetes/logs \</span><br><span class="hljs-string">--leader-elect \</span><br><span class="hljs-string">--master=127.0.0.1:8080 \</span><br><span class="hljs-string">--bind-address=127.0.0.1&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>–master：通过本地非安全本地端口 8080 连接 apiserver。</p>
<p>–leader-elect：当该组件启动多个时，自动选举（HA） </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Kubernetes Scheduler</span><br><span class="hljs-string">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="hljs-string">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="36-启动并设置开机启动"><a href="#36-启动并设置开机启动" class="headerlink" title="36.启动并设置开机启动"></a>36.启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl start kube-scheduler<br>systemctl <span class="hljs-built_in">enable</span> kube-scheduler<br>systemctl status kube-scheduler<br></code></pre></td></tr></table></figure>

<h4 id="37-查看集群状态"><a href="#37-查看集群状态" class="headerlink" title="37.查看集群状态"></a>37.查看集群状态</h4><p>所有组件都已经启动成功，通过 kubectl 工具查看当前集群组件状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get cs<br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210224145830987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwOTQyNDkw,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="38-部署node节点"><a href="#38-部署node节点" class="headerlink" title="38.部署node节点"></a>38.部署node节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;<br>tar zxvf kubernetes-server-linux-amd64.tar.gz<br><span class="hljs-built_in">cd</span> kubernetes/server/bin<br><br><span class="hljs-built_in">cp</span> kubelet kube-proxy /opt/kubernetes/bin<br><br><span class="hljs-built_in">cp</span> kubectl /usr/bin/<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">KUBELET_OPTS=&quot;--logtostderr=false \\</span><br><span class="hljs-string">--v=2 \\</span><br><span class="hljs-string">--log-dir=/opt/kubernetes/logs \\</span><br><span class="hljs-string">--hostname-override=m1 \\</span><br><span class="hljs-string">--network-plugin=cni \\</span><br><span class="hljs-string">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span><br><span class="hljs-string">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span><br><span class="hljs-string">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span><br><span class="hljs-string">--cert-dir=/opt/kubernetes/ssl \\</span><br><span class="hljs-string">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>–hostname-override：显示名称，集群中唯一<br>–network-plugin：启用CNI<br>–kubeconfig：空路径，会自动生成，后面用于连接apiserver<br>–bootstrap-kubeconfig：首次启动向apiserver申请证书<br>–config：配置参数文件<br>–cert-dir：kubelet证书生成目录<br>–pod-infra-container-image：管理Pod网络容器的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">kind: KubeletConfiguration</span><br><span class="hljs-string">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="hljs-string">address: 0.0.0.0</span><br><span class="hljs-string">port: 10250</span><br><span class="hljs-string">readOnlyPort: 10255</span><br><span class="hljs-string">cgroupDriver: cgroupfs</span><br><span class="hljs-string">clusterDNS:</span><br><span class="hljs-string">- 10.0.0.2</span><br><span class="hljs-string">clusterDomain: cluster.local </span><br><span class="hljs-string">failSwapOn: false</span><br><span class="hljs-string">authentication:</span><br><span class="hljs-string">  anonymous:</span><br><span class="hljs-string">    enabled: false</span><br><span class="hljs-string">  webhook:</span><br><span class="hljs-string">    cacheTTL: 2m0s</span><br><span class="hljs-string">    enabled: true</span><br><span class="hljs-string">  x509:</span><br><span class="hljs-string">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span><br><span class="hljs-string">authorization:</span><br><span class="hljs-string">  mode: Webhook</span><br><span class="hljs-string">  webhook:</span><br><span class="hljs-string">    cacheAuthorizedTTL: 5m0s</span><br><span class="hljs-string">    cacheUnauthorizedTTL: 30s</span><br><span class="hljs-string">evictionHard:</span><br><span class="hljs-string">  imagefs.available: 15%</span><br><span class="hljs-string">  memory.available: 100Mi</span><br><span class="hljs-string">  nodefs.available: 10%</span><br><span class="hljs-string">  nodefs.inodesFree: 5%</span><br><span class="hljs-string">maxOpenFiles: 1000000</span><br><span class="hljs-string">maxPods: 110</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="39-将master一些配置文件拷贝到node节点上"><a href="#39-将master一些配置文件拷贝到node节点上" class="headerlink" title="39.将master一些配置文件拷贝到node节点上"></a>39.将master一些配置文件拷贝到node节点上</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">scp -r /opt/kubernetes/ssl root@192.168.181.134:/opt/kubernetes<br></code></pre></td></tr></table></figure>

<h4 id="40-生成bootstrap-kubeconfig文件"><a href="#40-生成bootstrap-kubeconfig文件" class="headerlink" title="40.生成bootstrap.kubeconfig文件"></a>40.生成bootstrap.kubeconfig文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">KUBE_APISERVER=<span class="hljs-string">&quot;https://192.168.1.71:6443&quot;</span> <span class="hljs-comment"># apiserver IP:PORT</span><br>TOKEN=<span class="hljs-string">&quot;c47ffb939f5ca36231d9e3121a252940&quot;</span> <span class="hljs-comment"># 与token.csv里保持一致</span><br></code></pre></td></tr></table></figure>

<h4 id="生成-kubelet-bootstrap-kubeconfig-配置文件"><a href="#生成-kubelet-bootstrap-kubeconfig-配置文件" class="headerlink" title="生成 kubelet bootstrap kubeconfig 配置文件"></a>生成 kubelet bootstrap kubeconfig 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=<span class="hljs-literal">true</span> \<br>  --server=<span class="hljs-variable">$&#123;KUBE_APISERVER&#125;</span> \<br>  --kubeconfig=bootstrap.kubeconfig<br>kubectl config set-credentials <span class="hljs-string">&quot;kubelet-bootstrap&quot;</span> \<br>  --token=<span class="hljs-variable">$&#123;TOKEN&#125;</span> \<br>  --kubeconfig=bootstrap.kubeconfig<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=<span class="hljs-string">&quot;kubelet-bootstrap&quot;</span> \<br>  --kubeconfig=bootstrap.kubeconfig<br>kubectl config use-context default --kubeconfig=bootstrap.kubeconfig<br><br><br><span class="hljs-built_in">mv</span> bootstrap.kubeconfig /opt/kubernetes/cfg<br></code></pre></td></tr></table></figure>

<h4 id="41-systemd管理kubelet"><a href="#41-systemd管理kubelet" class="headerlink" title="41.systemd管理kubelet"></a>41.systemd管理kubelet</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Kubernetes Kubelet</span><br><span class="hljs-string">After=docker.service</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="hljs-string">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">LimitNOFILE=65536</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="42-启动并设置开机启动"><a href="#42-启动并设置开机启动" class="headerlink" title="42.启动并设置开机启动"></a>42.启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br><br>systemctl start kubelet<br><br>systemctl <span class="hljs-built_in">enable</span> kubelet<br></code></pre></td></tr></table></figure>

<h4 id="43-批准kubelet证书申请并加入集群-Master操作"><a href="#43-批准kubelet证书申请并加入集群-Master操作" class="headerlink" title="43.批准kubelet证书申请并加入集群(Master操作)"></a>43.批准kubelet证书申请并加入集群(Master操作)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看kubelet证书请求</span><br>kubectl get csr<br>NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION<br>node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending<br><br><span class="hljs-comment"># 批准申请</span><br>kubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A<br><br><span class="hljs-comment"># 查看节点</span><br>kubectl get node<br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/2021022414594754.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p>注：由于网络插件还没有部署，节点会没有准备就绪 NotReady</p>
<h4 id="44、部署kube-proxy"><a href="#44、部署kube-proxy" class="headerlink" title="44、部署kube-proxy"></a>44、部署kube-proxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\</span><br><span class="hljs-string">--v=2 \\</span><br><span class="hljs-string">--log-dir=/opt/kubernetes/logs \\</span><br><span class="hljs-string">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">kind: KubeProxyConfiguration</span><br><span class="hljs-string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="hljs-string">bindAddress: 0.0.0.0</span><br><span class="hljs-string">metricsBindAddress: 0.0.0.0:10249</span><br><span class="hljs-string">clientConnection:</span><br><span class="hljs-string">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="hljs-string">hostnameOverride: m1</span><br><span class="hljs-string">clusterCIDR: 10.0.0.0/24</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="45-生成kube-proxy-kubeconfig文件-master生成在传到node"><a href="#45-生成kube-proxy-kubeconfig文件-master生成在传到node" class="headerlink" title="45.生成kube-proxy.kubeconfig文件(master生成在传到node)"></a>45.生成kube-proxy.kubeconfig文件(master生成在传到node)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 切换工作目录</span><br><span class="hljs-built_in">cd</span> TLS/k8s<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建证书请求文件</span><br><span class="hljs-built_in">cat</span> &gt; kube-proxy-csr.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="hljs-string">  &quot;hosts&quot;: [],</span><br><span class="hljs-string">  &quot;key&quot;: &#123;</span><br><span class="hljs-string">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="hljs-string">    &quot;size&quot;: 2048</span><br><span class="hljs-string">  &#125;,</span><br><span class="hljs-string">  &quot;names&quot;: [</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="hljs-string">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="hljs-string">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="hljs-string">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="hljs-string">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 生成证书</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">scp -r /root/TLS/k8s root@192.168.181.134:/opt/TLS/<br></code></pre></td></tr></table></figure>

<h4 id="46-生成kubeconfig文件"><a href="#46-生成kubeconfig文件" class="headerlink" title="46.生成kubeconfig文件"></a>46.生成kubeconfig文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">KUBE_APISERVER=<span class="hljs-string">&quot;https://192.168.1.71:6443&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=<span class="hljs-literal">true</span> \<br>  --server=<span class="hljs-variable">$&#123;KUBE_APISERVER&#125;</span> \<br>  --kubeconfig=kube-proxy.kubeconfig<br>kubectl config set-credentials kube-proxy \<br>  --client-certificate=./kube-proxy.pem \<br>  --client-key=./kube-proxy-key.pem \<br>  --embed-certs=<span class="hljs-literal">true</span> \<br>  --kubeconfig=kube-proxy.kubeconfig<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-proxy \<br>  --kubeconfig=kube-proxy.kubeconfig<br>kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig<br><br><br><span class="hljs-built_in">cp</span> kube-proxy.kubeconfig /opt/kubernetes/cfg/<br></code></pre></td></tr></table></figure>

<h4 id="47-systemd管理kube-proxy"><a href="#47-systemd管理kube-proxy" class="headerlink" title="47.systemd管理kube-proxy"></a>47.systemd管理kube-proxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description=Kubernetes Proxy</span><br><span class="hljs-string">After=network.target</span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="hljs-string">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">LimitNOFILE=65536</span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h4 id="48-启动并设置开机启动"><a href="#48-启动并设置开机启动" class="headerlink" title="48.启动并设置开机启动"></a>48.启动并设置开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br><br>systemctl start kube-proxy<br><br>systemctl <span class="hljs-built_in">enable</span> kube-proxy<br><br>systemctl status kube-proxy<br></code></pre></td></tr></table></figure>

<h4 id="49-部署CNI网络"><a href="#49-部署CNI网络" class="headerlink" title="49.部署CNI网络"></a>49.部署CNI网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载地址：https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz<br></code></pre></td></tr></table></figure>

<p>node节点操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /opt/cni/bin<br>tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin<br></code></pre></td></tr></table></figure>

<p>master节点操作</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1abu6OwzAgcRdpbEpPPpDnw">https://pan.baidu.com/s/1abu6OwzAgcRdpbEpPPpDnw</a><br>提取码：hvf3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f kube-flannel.yml<br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210224150220543.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h1 id="6、kubernetes-集群-YAML-文件详解"><a href="#6、kubernetes-集群-YAML-文件详解" class="headerlink" title="6、kubernetes 集群 YAML 文件详解"></a>6、kubernetes 集群 YAML 文件详解</h1><h4 id="YAML-文件概述"><a href="#YAML-文件概述" class="headerlink" title="YAML 文件概述"></a>YAML 文件概述</h4><p>k8s 集群中对资源管理和资源对象编排部署都可以通过声明样式（YAML）文件来解决，也 就是可以把需要对资源对象操作编辑到 YAML 格式文件中，我们把这种文件叫做资源清单文 件，通过 kubectl 命令直接使用资源清单文件就可以实现对大量的资源对象进行编排部署 了。</p>
<h4 id="YAML-文件书写格式"><a href="#YAML-文件书写格式" class="headerlink" title="YAML 文件书写格式"></a>YAML 文件书写格式</h4><ul>
<li>YAML ：仍是一种标记语言。为了强调这种语言以数据做为中心，而不是以标记语言为重点。 </li>
<li>YAML 是一个可读性高，用来表达数据序列的格式。</li>
</ul>
<h4 id="YAML-基本语法"><a href="#YAML-基本语法" class="headerlink" title="YAML 基本语法"></a>YAML 基本语法</h4><ul>
<li>使用空格做为缩进 </li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可 </li>
<li>低版本缩进时不允许使用 Tab 键，只允许使用空格 </li>
<li>使用#标识注释，从这个字符一直到行尾，都会被解释器忽略</li>
</ul>
<h4 id="YAML-支持的数据结构"><a href="#YAML-支持的数据结构" class="headerlink" title="YAML 支持的数据结构"></a>YAML 支持的数据结构</h4><ul>
<li>对象<ul>
<li>键值对的集合，又称为映射(mapping) &#x2F; 哈希（hashes） &#x2F; 字典（dictionary）</li>
</ul>
</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525162234.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<ul>
<li>数组<ul>
<li>一组按次序排列的值，又称为序列（sequence） &#x2F; 列表 （list）</li>
</ul>
</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525162253.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<ul>
<li>纯量（scalars）<ul>
<li>单个的、不可再分的值</li>
</ul>
</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525163252.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525163347.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="资源清单描述方法"><a href="#资源清单描述方法" class="headerlink" title="资源清单描述方法"></a>资源清单描述方法</h4><p>在 k8s 中，一般使用 YAML 格式的文件来创建符合我们预期期望的 pod,这样的 YAML 文件称为资源清单。<br>常用字段<br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525163433.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164215.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164234.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164249.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164310.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="举例说明"><a href="#举例说明" class="headerlink" title="举例说明"></a>举例说明</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164349.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525164409.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="7、kubernetes-集群命令行工具-kubectl"><a href="#7、kubernetes-集群命令行工具-kubectl" class="headerlink" title="7、kubernetes 集群命令行工具 kubectl"></a>7、kubernetes 集群命令行工具 kubectl</h1><h4 id="kubectl-概述"><a href="#kubectl-概述" class="headerlink" title="kubectl 概述"></a>kubectl 概述</h4><p>kubectl 是 Kubernetes 集群的命令行工具，通过 kubectl 能够对集群本身进行管理，并能 够在集群上进行容器化应用的安装部署。</p>
<h4 id="kubectl-命令的语法"><a href="#kubectl-命令的语法" class="headerlink" title="kubectl 命令的语法"></a>kubectl 命令的语法</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525165720.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<ul>
<li>（1）comand：指定要对资源执行的操作，例如 create、get、describe 和 delete </li>
<li>（2）TYPE：指定资源类型，资源类型是大小写敏感的，开发者能够以单数、复数和缩略的 形式。<br>例如：</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525165825.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<ul>
<li>（3）NAME：指定资源的名称，名称也大小写敏感的。如果省略名称，则会显示所有的资源，<br>例如:</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170007.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<ul>
<li>（4）flags：指定可选的参数。例如，可用-s 或者–server 参数指定 Kubernetes API server 的地址和端口。</li>
</ul>
<h4 id="kubectl-help-获取更多信息"><a href="#kubectl-help-获取更多信息" class="headerlink" title="kubectl help 获取更多信息"></a>kubectl help 获取更多信息</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170328.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170413.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<h4 id="kubectl-子命令使用分类"><a href="#kubectl-子命令使用分类" class="headerlink" title="kubectl 子命令使用分类"></a>kubectl 子命令使用分类</h4><ul>
<li>（1）基础命令</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170552.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<ul>
<li>（2）部署和集群管理命令</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170624.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<ul>
<li>（3）故障和调试命令</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170638.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<ul>
<li>（4）其他命令</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525170651.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"> </p>
<h1 id="8、kubernetes-核心技术-Pod"><a href="#8、kubernetes-核心技术-Pod" class="headerlink" title="8、kubernetes 核心技术-Pod"></a>8、kubernetes 核心技术-Pod</h1><h4 id="Pod-概述"><a href="#Pod-概述" class="headerlink" title="Pod 概述"></a>Pod 概述</h4><p>Pod 是 k8s 系统中可以创建和管理的最小单元，是资源对象模型中由用户创建或部署的最 小资源对象模型，也是在 k8s 上运行容器化应用的资源对象，其他的资源对象都是用来支 撑或者扩展 Pod 对象功能的，比如控制器对象是用来管控 Pod 对象的，Service 或者 Ingress 资源对象是用来暴露 Pod 引用对象的，PersistentVolume 资源对象是用来为 Pod 提供存储等等，k8s 不会直接处理容器，而是 Pod，Pod 是由一个或多个 container 组成 Pod 是 Kubernetes 的最重要概念，每一个 Pod 都有一个特殊的被称为”根容器“的 Pause 容器。Pause 容器对应的镜 像属于 Kubernetes 平台的一部分，除了 Pause 容器，每个 Pod 还包含一个或多个紧密相关的用户业务容器</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525171801.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525171824.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<ul>
<li>（1）Pod vs 应用 每个 Pod 都是应用的一个实例，有专用的 IP </li>
<li>（2）Pod vs 容器 一个 Pod 可以有多个容器，彼此间共享网络和存储资源，每个 Pod 中有一个 Pause 容器保 存所有的容器状态， 通过管理 pause 容器，达到管理 pod 中所有容器的效果 </li>
<li>（3）Pod vs 节点 同一个 Pod 中的容器总会被调度到相同 Node 节点，不同节点间 Pod 的通信基于虚拟二层网 络技术实现</li>
<li>（4）Pod vs Pod 普通的 Pod 和静态 Pod</li>
</ul>
<h4 id="Pod-特性"><a href="#Pod-特性" class="headerlink" title="Pod 特性"></a>Pod 特性</h4><ul>
<li>（1）资源共享 <ul>
<li>一个 Pod 里的多个容器可以共享存储和网络，可以看作一个逻辑的主机。共享的如 namespace,cgroups 或者其他的隔离资源。 </li>
<li>多个容器共享同一 network namespace，由此在一个 Pod 里的多个容器共享 Pod 的 IP 和 端口 namespace，所以一个 Pod 内的多个容器之间可以通过 localhost 来进行通信,所需要 注意的是不同容器要注意不要有端口冲突即可。不同的 Pod 有不同的 IP,不同 Pod 内的多 个容器之前通信，不可以使用 IPC（如果没有特殊指定的话）通信，通常情况下使用 Pod 的 IP 进行通信。 </li>
<li>一个 Pod 里的多个容器可以共享存储卷，这个存储卷会被定义为 Pod 的一部分，并且可 以挂载到该 Pod 里的所有容器的文件系统上。</li>
</ul>
</li>
<li>（2）生命周期短暂 <ul>
<li>Pod 属于生命周期比较短暂的组件，比如，当 Pod 所在节点发生故障，那么该节点上的 Pod 会被调度到其他节点，但需要注意的是，被重新调度的 Pod 是一个全新的 Pod,跟之前的 Pod 没有半毛钱关系</li>
</ul>
</li>
<li>（3）平坦的网络 <ul>
<li>K8s 集群中的所有 Pod 都在同一个共享网络地址空间中，也就是说每个 Pod 都可以通过其 他 Pod 的 IP 地址来实现访问。</li>
</ul>
</li>
</ul>
<h4 id="Pod-定义"><a href="#Pod-定义" class="headerlink" title="Pod 定义"></a>Pod 定义</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174036.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="Pod-的分类"><a href="#Pod-的分类" class="headerlink" title="Pod 的分类"></a>Pod 的分类</h4><h5 id="Pod-有两种类型"><a href="#Pod-有两种类型" class="headerlink" title="Pod 有两种类型"></a>Pod 有两种类型</h5><ul>
<li>（1）普通 Pod 普通 Pod 一旦被创建，就会被放入到 etcd 中存储，随后会被 Kubernetes Master 调度到某 个具体的 Node 上并进行绑定，随后该 Pod 对应的 Node 上的 kubelet 进程实例化成一组相 关的 Docker 容器并启动起来。在默认情 况下，当 Pod 里某个容器停止时，Kubernetes 会 自动检测到这个问题并且重新启动这个 Pod 里某所有容器， 如果 Pod 所在的 Node 宕机， 则会将这个 Node 上的所有 Pod 重新调度到其它节点上。 </li>
<li>（2）静态 Pod 静态 Pod 是由 kubelet 进行管理的仅存在于特定 Node 上的 Pod,它们不能通过 API Server 进行管理，无法与 ReplicationController、Deployment 或 DaemonSet 进行关联，并且 kubelet 也无法对它们进行健康检查。</li>
</ul>
<h4 id="Pod-生命周期和重启策略"><a href="#Pod-生命周期和重启策略" class="headerlink" title="Pod 生命周期和重启策略"></a>Pod 生命周期和重启策略</h4><ul>
<li>（1）Pod 的状态</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174800.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<ul>
<li>（2）Pod 重启策略<br>Pod 的重启策略包括 Always、OnFailure 和 Never，默认值是 Always</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174846.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<ul>
<li>（3）常见状态转换</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210525174954.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="Pod-资源配置"><a href="#Pod-资源配置" class="headerlink" title="Pod 资源配置"></a>Pod 资源配置</h4><p>每个 Pod 都可以对其能使用的服务器上的计算资源设置限额，Kubernetes 中可以设置限额 的计算资源有 CPU 与 Memory 两种，其中 CPU 的资源单位为 CPU 数量,是一个绝对值而非相 对值。Memory 配额也是一个绝对值，它的单 位是内存字节数。 </p>
<p>Kubernetes 里，一个计算资源进行配额限定需要设定以下两个参数： Requests 该资源最 小申请数量，系统必须满足要求 Limits 该资源最大允许使用的量，不能突破，当容器试 图使用超过这个量的资源时，可能会被 Kubernetes Kill 并重启</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526093534.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="kubernetes-核心技术-Label"><a href="#kubernetes-核心技术-Label" class="headerlink" title="kubernetes 核心技术-Label"></a>kubernetes 核心技术-Label</h4><p>Label 概述<br>Label 是 Kubernetes 系统中另一个核心概念。一个 Label 是一个 key&#x3D;value 的键值对，其 中 key 与 value 由用户自己指 定。Label 可以附加到各种资源对象上，如 Node、Pod、 Service、RC，一个资源对象可以定义任意数量的 Label， 同一个 Label 也可以被添加到 任意数量的资源对象上，Label 通常在资源对象定义时确定，也可以在对象创建后动态 添 加或删除。 Label 的最常见的用法是使用 metadata.labels 字段，来为对象添加 Label，通过 spec.selector 来引用对象</p>
<h1 id="9、kubernetes-核心技术-Controller-控制器"><a href="#9、kubernetes-核心技术-Controller-控制器" class="headerlink" title="9、kubernetes 核心技术-Controller 控制器"></a>9、kubernetes 核心技术-Controller 控制器</h1><h4 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h4><p>Replication Controller(RC)是 Kubernetes 系统中核心概念之一，当我们定义了一个 RC 并提交到 Kubernetes 集群中以后，Master 节点上的 Controller Manager 组件就得到通知， 定期检查系统中存活的 Pod,并确保目标 Pod 实例的数量刚好等于 RC 的预期值，如果有过 多或过少的 Pod 运行，系统就会停掉或创建一些 Pod.此外我们也可以通过修改 RC 的副本 数量，来实现 Pod 的动态缩放功能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl scale rc nginx --replicas=5<br></code></pre></td></tr></table></figure>
<p>由于 Replication Controller 与 Kubernetes 代码中的模块 Replication Controller 同名， 所以在 Kubernetes v1.2 时， 它就升级成了另外一个新的概念 Replica Sets,官方解释为 下一代的 RC，它与 RC 区别是:Replica Sets 支援基于集合的 Label selector,而 RC 只支 持基于等式的 Label Selector。我们很少单独使用 Replica Set,它主要被 Deployment 这 个更高层面的资源对象所使用，从而形成一整套 Pod 创建、删除、更新的编排机制。最好 不要越过 RC 直接创建 Pod， 因为 Replication Controller 会通过 RC 管理 Pod 副本，实 现自动创建、补足、替换、删除 Pod 副本，这样就能提高应用的容灾能力，减少由于节点 崩溃等意外状况造成的损失。即使应用程序只有一个 Pod 副本，也强烈建议使用 RC 来 定 义 Pod</p>
<h4 id="Replica-Set"><a href="#Replica-Set" class="headerlink" title="Replica Set"></a>Replica Set</h4><p>ReplicaSet 跟 ReplicationController 没有本质的不同，只是名字不一样，并且 ReplicaSet 支持集合式的 selector（ReplicationController 仅支持等式）。 Kubernetes 官方强烈建议避免直接使用 ReplicaSet，而应该通过 Deployment 来创建 RS 和 Pod。由于 ReplicaSet 是 ReplicationController 的代替物，因此用法基本相同，唯一的 区别在于 ReplicaSet 支持集合式的 selector。</p>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>Deployment 是 Kubenetes v1.2 引入的新概念，引入的目的是为了更好的解决 Pod 的编排 问题，Deployment 内部使用了 Replica Set 来实现。Deployment 的定义与 Replica Set 的 定义很类似，除了 API 声明与 Kind 类型有所区别：</p>
<h4 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h4><p>Horizontal Pod Autoscal(Pod 横向扩容 简称 HPA)与 RC、Deployment 一样，也属于一种 Kubernetes 资源对象。通过追踪分析 RC 控制的所有目标 Pod 的负载变化情况，来确定是 否需要针对性地调整目标 Pod 的副本数，这是 HPA 的 实现原理。 Kubernetes 对 Pod 扩容与缩容提供了手动和自动两种模式，手动模式通过 kubectl scale 命令对一个 Deployment&#x2F;RC 进行 Pod 副本数量的设置。自动模式则需要用户根据某个性能 指标或者自定义业务指标，并指定 Pod 副本数量的范围，系统将自动在这个范围内根据性 能指标的变化进行调整。</p>
<ul>
<li>（1）手动扩容和缩容</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">kubectl scale deployment frontend <span class="hljs-comment">--replicas 1</span><br></code></pre></td></tr></table></figure>

<ul>
<li>（2）自动扩容和缩容</li>
</ul>
<p>HPA 控制器基本 Master 的 kube-controller-manager 服务启动参数 –horizontal-pod- autoscaler-sync-period 定义的时长(默认值为 30s),周期性地监测 Pod 的 CPU 使用率， 并在满足条件时对 RC 或 Deployment 中的 Pod 副 本数量进行调整，以符合用户定义的平均 Pod CPU 使用率。</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526095617.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526095650.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="10、kubernetes-核心技术-Volume"><a href="#10、kubernetes-核心技术-Volume" class="headerlink" title="10、kubernetes 核心技术-Volume"></a>10、kubernetes 核心技术-Volume</h1><h4 id="Volume-概述"><a href="#Volume-概述" class="headerlink" title="Volume 概述"></a>Volume 概述</h4><p>Volume 是 Pod 中能够被多个容器访问的共享目录。Kubernetes 的 Volume 定义在 Pod 上， 它被一个 Pod 中的多个容 器挂载到具体的文件目录下。Volume 与 Pod 的生命周期相同， 但与容器的生命周期不相关，当容器终止或重启时，Volume 中的数据也不会丢失。要使用 volume，pod 需要指定 volume 的类型和内容（ 字段），和映射到容器的位置（ 字段）。 Kubernetes 支持多种类型的 Volume,包括：emptyDir、hostPath、gcePersistentDisk、 awsElasticBlockStore、nfs、iscsi、flocker、glusterfs、rbd、cephfs、gitRepo、 secret、persistentVolumeClaim、downwardAPI、azureFileVolume、azureDisk、 vsphereVolume、Quobyte、PortworxVolume、ScaleIO。emptyDirEmptyDir 类型的 volume 创建于 pod 被调度到某个宿主机上的时候，而同一个 pod 内的容器都能读写 EmptyDir 中 的同一个文件。一旦这个 pod 离开了这个宿主机，EmptyDir 中的数据就会被永久删除。所 以目前 EmptyDir 类型的 volume 主要用作临时空间，比如 Web 服务器写日志或者 tmp 文件 需要的临时目录</p>
<h4 id="yaml-示例如下"><a href="#yaml-示例如下" class="headerlink" title="yaml 示例如下"></a>yaml 示例如下</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">test-pd</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">docker.io/nazarpc/webserver</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">test-container</span><br>   <span class="hljs-attr">volumeMounts:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/cache</span> <br>     <span class="hljs-attr">name:</span> <span class="hljs-string">cache-volume</span> <br> <span class="hljs-attr">volumes:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cache-volume</span> <br>   <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br></code></pre></td></tr></table></figure>
<h4 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h4><p>HostPath 属性的 volume 使得对应的容器能够访问当前宿主机上的指定目录。例如，需要 运行一个访问 Docker 系统目录的容器，那么就使用&#x2F;var&#x2F;lib&#x2F;docker 目录作为一个 HostDir 类型的 volume；或者要在一个容器内部运行 CAdvisor，那么就使用&#x2F;dev&#x2F;cgroups 目录作为一个 HostDir 类型的 volume。一旦这个 pod 离开了这个宿主机，HostDir 中的数 据虽然不会被永久删除，但数据也不会随 pod 迁移到其他宿主机上。因此，需要 注意的是， 由于各个宿主机上的文件系统结构和内容并不一定完全相同，所以相同 pod 的 HostDir 可 能会在不 同的宿主机上表现出不同的行为。yaml 示例如下：\</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">test-pd</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-string">-image:</span> <span class="hljs-string">docker.io/nazarpc/webserver</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-container</span> <span class="hljs-comment"># 指定在容器中挂接路径 </span><br>  <span class="hljs-attr">volumeMounts:</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/test-pd</span> <br>    <span class="hljs-attr">name:</span> <span class="hljs-string">test-volume</span> <span class="hljs-comment"># 指定所提供的存储卷 </span><br>  <span class="hljs-attr">volumes:</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-volume</span> <span class="hljs-comment"># 宿主机上的目录 </span><br>    <span class="hljs-attr">hostPath:</span> <span class="hljs-comment"># directory location on host </span><br>     <span class="hljs-attr">path:</span> <span class="hljs-string">/data</span><br></code></pre></td></tr></table></figure>
<h4 id="nfs"><a href="#nfs" class="headerlink" title="nfs"></a>nfs</h4><p>NFS 类型 volume。允许一块现有的网络硬盘在同一个 pod 内的容器间共享。yaml 示例如下</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <span class="hljs-comment"># for versions before 1.9.0 use apps/v1beta2 </span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">selector:</span> <br>  <span class="hljs-attr">matchLabels:</span><br>   <span class="hljs-attr">app:</span> <span class="hljs-string">redis</span> <br>   <span class="hljs-attr">revisionHistoryLimit:</span> <span class="hljs-number">2</span> <br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> <span class="hljs-string">redis</span> <br>  <span class="hljs-attr">spec:</span> <br>   <span class="hljs-attr">containers:</span> <span class="hljs-comment"># 应用的镜像 </span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">redis</span> <br>     <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span> <br>     <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span> <span class="hljs-comment"># 应用的内部端口 </span><br>     <span class="hljs-attr">ports:</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">6379</span> <br>       <span class="hljs-attr">name:</span> <span class="hljs-string">redis6379</span> <br>       <span class="hljs-attr">env:</span> <br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ALLOW_EMPTY_PASSWORD</span> <br>         <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;yes&quot;</span> <br>         <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">REDIS_PASSWORD</span> <br>           <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;redis&quot;</span> <span class="hljs-comment"># 持久化挂接位置，在 docker 中 </span><br>     <span class="hljs-attr">volumeMounts:</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis-persistent-storage</span> <br>       <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span> <br>     <span class="hljs-attr">volumes:</span> <span class="hljs-comment"># 宿主机上的目录 </span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis-persistent-storage</span> <span class="hljs-string">\</span><br>       <span class="hljs-attr">nfs:</span> <br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/k8s-nfs/redis/data</span> <br>        <span class="hljs-attr">server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.126</span><span class="hljs-number">.112</span><br></code></pre></td></tr></table></figure>
<h1 id="11、kubernetes-核心技术-PVC-和-PV"><a href="#11、kubernetes-核心技术-PVC-和-PV" class="headerlink" title="11、kubernetes 核心技术-PVC 和 PV"></a>11、kubernetes 核心技术-PVC 和 PV</h1><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p>管理存储是管理计算的一个明显问题。该 PersistentVolume 子系统为用户和管理员提供了 一个 API，用于抽象如何根据消费方式提供存储的详细信息。为此，我们引入了两个新的 API 资源：PersistentVolume 和 PersistentVolumeClaim </p>
<p>PersistentVolume（PV）是集群中由管理员配置的一段网络存储。 它是集群中的资源，就 像节点是集群资源一样。 PV 是容量插件，如 Volumes，但其生命周期独立于使用 PV 的任 何单个 pod。 此 API 对象捕获存储实现的详细信息，包括 NFS，iSCSI 或特定于云提供程 序的存储系统</p>
<p>PersistentVolumeClaim（PVC）是由用户进行存储的请求。 它类似于 pod。 Pod 消耗节点 资源，PVC 消耗 PV 资源。Pod 可以请求特定级别的资源（CPU 和内存）。声明可以请求特 定的大小和访问模式（例如，可以一次读&#x2F;写或多次只读）。 </p>
<p>虽然 PersistentVolumeClaims 允许用户使用抽象存储资源，但是 PersistentVolumes 对于 不同的问题，用户通常需要具有不同属性（例如性能）。群集管理员需要能够提供各种 PersistentVolumes 不同的方式，而不仅仅是大小和访问模式，而不会让用户了解这些卷 的实现方式。对于这些需求，有 StorageClass 资源。 </p>
<p>StorageClass 为管理员提供了一种描述他们提供的存储的“类”的方法。 不同的类可能 映射到服务质量级别，或备份策略，或者由群集管理员确定的任意策略。 Kubernetes 本 身对于什么类别代表是不言而喻的。 这个概念有时在其他存储系统中称为“配置文件”。 </p>
<p>PVC 和 PV 是一一对应的。</p>
<h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><p>PV 是群集中的资源。PVC 是对这些资源的请求，并且还充当对资源的检查。PV 和 PVC 之间 的相互作用遵循以下生命周期：</p>
<h6 id="Provisioning-——-gt-Binding-——–-gt-Using——-gt-Releasing——-gt-Recycling"><a href="#Provisioning-——-gt-Binding-——–-gt-Using——-gt-Releasing——-gt-Recycling" class="headerlink" title="Provisioning ——-&gt; Binding ——–&gt;Using——&gt;Releasing——&gt;Recycling"></a>Provisioning ——-&gt; Binding ——–&gt;Using——&gt;Releasing——&gt;Recycling</h6><p>供应准备 Provisioning—通过集群外的存储系统或者云平台来提供存储持久化支持。</p>
<ul>
<li><p>静态提供 Static：集群管理员创建多个 PV。 它们携带可供集群用户使用的真实存储的 详细信息。 它们存在于 Kubernetes API 中，可用于消费</p>
</li>
<li><p>动态提供 Dynamic：当管理员创建的静态 PV 都不匹配用户的 PersistentVolumeClaim 时，集群可能会尝试为 PVC 动态配置卷。 此配置基于 StorageClasses：PVC 必须请求一个 类，并且管理员必须已创建并配置该类才能进行动态配置。 要求该类的声明有效地为自己 禁用动态配置。</p>
</li>
</ul>
<p>绑定 Binding—用户创建 pvc 并指定需要的资源和访问模式。在找到可用 pv 之前，pvc 会保持未绑定状态。</p>
<p>使用 Using—用户可在 pod 中像 volume 一样使用 pvc。</p>
<p>释放 Releasing—用户删除 pvc 来回收存储资源，pv 将变成“released”状态。由于还 保留着之前的数据，这些数据需要根据不同的策略来处理，否则这些存储资源无法被其他 pvc 使用。</p>
<p>回收 Recycling—pv 可以设置三种回收策略：保留（Retain），回收（Recycle）和删除 （Delete）。</p>
<ul>
<li>保留策略：允许人工处理保留的数据。 </li>
<li>删除策略：将删除 pv 和外部关联的存储资源，需要插件支持。 </li>
<li>回收策略：将执行清除操作，之后可以被新的 pvc 使用，需要插件支持</li>
</ul>
<h4 id="PV-类型"><a href="#PV-类型" class="headerlink" title="PV 类型"></a>PV 类型</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">GCEPersistentDisk <br>AWSElasticBlockStore <br>AzureFile <br>AzureDisk FC (Fibre Channel) <br>Flexvolume F<br>locker <br>NFS <br>iSCSI <br>RBD (Ceph Block Device) <br>CephFS <br>Cinder (OpenStack block <span class="hljs-keyword">storage</span>) <br>Glusterfs <br>VsphereVolume <br>Quobyte Volumes <br>HostPath (Single node testing <span class="hljs-keyword">only</span> – <span class="hljs-keyword">local</span> <span class="hljs-keyword">storage</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> supported <span class="hljs-keyword">in</span> <span class="hljs-keyword">any</span> way <span class="hljs-keyword">and</span> WILL <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">WORK</span> <span class="hljs-keyword">in</span> a multi-node <span class="hljs-keyword">cluster</span>) <br>Portworx Volumes <br>ScaleIO Volumes <br>StorageOS<br></code></pre></td></tr></table></figure>
<h4 id="PV-卷阶段状态"><a href="#PV-卷阶段状态" class="headerlink" title="PV 卷阶段状态"></a>PV 卷阶段状态</h4><ul>
<li>Available – 资源尚未被 claim 使用 </li>
<li>Bound – 卷已经被绑定到 claim 了 </li>
<li>Released – claim 被删除，卷处于释放状态，但未被集群回收。 </li>
<li>Failed – 卷自动回收失败</li>
</ul>
<h4 id="演示：创建-PV"><a href="#演示：创建-PV" class="headerlink" title="演示：创建 PV"></a>演示：创建 PV</h4><ul>
<li>（1）第一步：编写 yaml 文件，并创建 pv</li>
</ul>
<p>创建 5 个 pv，存储大小各不相同，是否可读也不相同</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pv001</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv001</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">nfs:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/data/volumes/v1</span> <br>  <span class="hljs-attr">server:</span> <span class="hljs-string">nfs</span> <br> <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteMany&quot;</span>,<span class="hljs-string">&quot;ReadWriteOnce&quot;</span>] <br> <span class="hljs-attr">capacity:</span> <br>  <span class="hljs-attr">storage:</span> <span class="hljs-string">2Gi</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pv002</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv002</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">nfs:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/data/volumes/v2</span> <br>  <span class="hljs-attr">server:</span> <span class="hljs-string">nfs</span> <br> <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteOnce&quot;</span>] <br> <span class="hljs-attr">capacity:</span> <br>  <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pv003</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv003</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">nfs:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/data/volumes/v3</span> <br>  <span class="hljs-attr">server:</span> <span class="hljs-string">nfs</span> <br> <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteMany&quot;</span>,<span class="hljs-string">&quot;ReadWriteOnce&quot;</span>] <br> <span class="hljs-attr">capacity:</span> <br>  <span class="hljs-attr">storage:</span> <span class="hljs-string">20Gi</span> <br><span class="hljs-meta">--- </span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pv004</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv004</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">nfs:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/data/volumes/v4</span> <br>  <span class="hljs-attr">server:</span> <span class="hljs-string">nfs</span> <br> <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteMany&quot;</span>,<span class="hljs-string">&quot;ReadWriteOnce&quot;</span>] <br> <span class="hljs-attr">capacity:</span> <br>  <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pv005</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv005</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">nfs:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/data/volumes/v5</span> <br>  <span class="hljs-attr">server:</span> <span class="hljs-string">nfs</span> <br> <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteMany&quot;</span>,<span class="hljs-string">&quot;ReadWriteOnce&quot;</span>] <br> <span class="hljs-attr">capacity:</span> <br>  <span class="hljs-attr">storage:</span> <span class="hljs-string">15Gi</span><br></code></pre></td></tr></table></figure>
<ul>
<li><p>（2）第二步：执行创建命令</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">kubectl <span class="hljs-built_in">apply</span> -f <span class="hljs-built_in">pv</span>-damo.yaml<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526104852.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
</li>
<li><p>（3）第三步：查询验证<br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526104929.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
</li>
</ul>
<h4 id="演示：创建-PVC，绑定-PV"><a href="#演示：创建-PVC，绑定-PV" class="headerlink" title="演示：创建 PVC，绑定 PV"></a>演示：创建 PVC，绑定 PV</h4><ul>
<li>（1）第一步：编写 yaml 文件，并创建 pvc</li>
</ul>
<p>创建一个 pvc，需要 6G 存储；所以不会匹配 pv001、pv002、pv003</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">mypvc</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteMany&quot;</span>] <br> <span class="hljs-attr">resources:</span> <br>  <span class="hljs-attr">requests:</span> <br>   <span class="hljs-attr">storage:</span> <span class="hljs-string">6Gi</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">vol-pvc</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">volumes:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">html</span> <br>   <span class="hljs-attr">persistentVolumeClaim:</span> <br>    <span class="hljs-attr">claimName:</span> <span class="hljs-string">mypvc</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span> <br>   <span class="hljs-attr">volumeMounts:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">html</span> <br>     <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html/</span><br></code></pre></td></tr></table></figure>
<ul>
<li><p>（2）第二步：执行命令创建</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">kubectl <span class="hljs-built_in">apply</span> -f vol-pvc-<span class="hljs-built_in">demo</span>.yaml<br></code></pre></td></tr></table></figure>
</li>
<li><p>（3）第三步：查询验证</p>
</li>
</ul>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526110553.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="12、kubernetes-核心技术-Secret"><a href="#12、kubernetes-核心技术-Secret" class="headerlink" title="12、kubernetes 核心技术-Secret"></a>12、kubernetes 核心技术-Secret</h1><ul>
<li>1、Secret 存在意义 Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露 到镜像或者 Pod Spec 中。Secret 可以以 Volume 或者环境变量的方式使用 </li>
<li>2、Secret 有三种类型 • Service Account :用来访问 Kubernetes API,由 Kubernetes 自动创建，并且会自动挂 载到 Pod 的 &#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount 目录中 • Opaque : base64 编码格式的 Secret,用来存储密码、密钥等 • kubernetes.io&#x2F;dockerconfigjson ：用来存储私有 docker registry 的认证信息 </li>
<li>3、Service Account</li>
</ul>
<p>Service Account 用来访问 Kubernetes API,甶 Kubernetes 自动创建，并且会自动挂载到 Pod 的&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount 目录中</p>
<h4 id="Opaque-Secret"><a href="#Opaque-Secret" class="headerlink" title="Opaque Secret"></a>Opaque Secret</h4><ul>
<li>（1）创建说明：Opaque 类型的数据是一个 map 类型，要求 value 是 base64 编码格式</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;admin&quot;</span> | <span class="hljs-built_in">base64</span></span> <br>YWRtaW4= <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;1f2d1e2e67df&quot;</span> | <span class="hljs-built_in">base64</span></span> <br>MWYyZDFlMmU2N2Rm:<br></code></pre></td></tr></table></figure>

<ul>
<li>（2）secrets.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysecret</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">username:</span> <span class="hljs-string">YWRtaW4=</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-string">MWYyZDFlMmU2N2Rm</span><br></code></pre></td></tr></table></figure>

<ul>
<li>（3）使用方式 将 Secret 挂载到 Volume 中</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">seret-test</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">seret-test</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">volumes:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets</span> <br>   <span class="hljs-attr">secret:</span> <br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">mysecret</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">hub.atguigu.com/library/myapp:v1</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">db</span> <br>   <span class="hljs-attr">volumeMounts:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secrets</span> <br>     <span class="hljs-attr">mountPath:</span> <br>      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>将 Secret 导出到环境变量中</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-deployment</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> <span class="hljs-string">pod-deployment</span> <br>  <span class="hljs-attr">spec:</span> <br>   <span class="hljs-attr">containers:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-1</span> <br>     <span class="hljs-attr">image:</span> <span class="hljs-string">hub.atguigu.com/library/myapp:v1</span> <br>     <span class="hljs-attr">ports:</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span> <br>       <span class="hljs-attr">env:</span> <br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">TEST_USER</span> <br>         <span class="hljs-attr">valueFrom:</span> <br>          <span class="hljs-attr">secretKeyRef:</span> <br>           <span class="hljs-attr">name:</span> <span class="hljs-string">mysecret</span> <br><span class="hljs-attr">key:</span> <span class="hljs-string">username</span><br></code></pre></td></tr></table></figure>
<h4 id="kubernetes-io-x2F-dockerconfigjson"><a href="#kubernetes-io-x2F-dockerconfigjson" class="headerlink" title="kubernetes.io&#x2F;dockerconfigjson"></a>kubernetes.io&#x2F;dockerconfigjson</h4><p>使用 Kuberctl 创建 docker registry 认证的 secret</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create secret docker-registry myregistrykey --docker- server=DOCKER_REGISTRY_SERVER -- docker-username=DOCKER_USER --docker- password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL secret &quot;myregistrykey&quot;<br></code></pre></td></tr></table></figure>
<p>在创建 Pod 的时候，通过 imagePullSecrets 来引用刚创建的’myregistrykey</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">foo</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">foo</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">roc/awangyang:v1</span> <br>   <span class="hljs-attr">imagePullSecrets:</span> <br>    <span class="hljs-string">-name:</span> <span class="hljs-string">myregistrykey</span><br></code></pre></td></tr></table></figure>
<h1 id="13、kubernetes-核心技术-configMap"><a href="#13、kubernetes-核心技术-configMap" class="headerlink" title="13、kubernetes 核心技术-configMap"></a>13、kubernetes 核心技术-configMap</h1><h4 id="ConfigMap-概述"><a href="#ConfigMap-概述" class="headerlink" title="ConfigMap 概述"></a>ConfigMap 概述</h4><p>ConfigMap 功能在 Kubernetes1.2 版本中引入，许多应用程序会从配置文件、命令行参数 或环境变量中读取配 置信息。ConfigMap AP 丨给我们提供了向容器中注入配置信息的机 制，ConfigMap 可以被用来保存单个属性，也 可以用来保存整个配置文件或者 JSON 二进 制大对象</p>
<h4 id="ConfigMap-的创建"><a href="#ConfigMap-的创建" class="headerlink" title="ConfigMap 的创建"></a>ConfigMap 的创建</h4><ul>
<li>（1）使用目录创建<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">ls</span> <span class="hljs-string">docs/user-guide/configmap/kubectl/</span><br></code></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">cat</span> <span class="hljs-string">docs/user-guide/configmap/kubectl/game.properties</span><br></code></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">cat</span> <span class="hljs-string">docs/user-guide/configmap/kubectl/ui.properties</span><br></code></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">kubectl</span> <span class="hljs-string">create</span> <span class="hljs-string">configmap</span> <span class="hljs-string">game-config</span> <span class="hljs-string">--from-file=docs/user-</span> <span class="hljs-string">guide/configmap/kubectl</span><br></code></pre></td></tr></table></figure>
-from-file 指定在目录下的所有文件都会被用在 ConfigMap 里面创建一个键值对，键的名 字就是文件名，值就 是文件的内容</li>
</ul>
<h4 id="使用文件创建"><a href="#使用文件创建" class="headerlink" title="使用文件创建"></a>使用文件创建</h4><p>只要指定为一个文件就可以从单个文件中创建 ConfigMap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create configmap game-config-2 --from-file=docs/user- guide/configmap/kubectl/game.properties<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get configmaps game-config-2 -o yaml<br></code></pre></td></tr></table></figure>

<p>-from-file 这个参数可以使用多次，你可以使用两次分別指定上个实例中的那两个配置文 件，效果就跟指定整个 目录是一样的</p>
<h4 id="使用字面值创建"><a href="#使用字面值创建" class="headerlink" title="使用字面值创建"></a>使用字面值创建</h4><p>使用文字值创建，利用-from-literal 参数传递配置信息，该参数可以使用多次，格式如 下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create configmap special-config --from-literal=special.how=very -- from-literal=special.type=charm<br>kubectl get configmaps special-config -o yaml<br></code></pre></td></tr></table></figure>
<h4 id="Pod-中使用-ConfigMap"><a href="#Pod-中使用-ConfigMap" class="headerlink" title="Pod 中使用 ConfigMap"></a>Pod 中使用 ConfigMap</h4><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141020.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141302.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>通过数据卷插件使用 ConfigMap</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141302.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>在数据卷里面使用这个 ConfigMap,有不同的选项。最基本的就是将文件填入数据卷，在这 个文件中，键就是文 件名，键值就是文件内容</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141400.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>ConfigMap 的热更新</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141434.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526141510.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">kubectl exec &#x27;kubectl <span class="hljs-keyword">get</span> pods -l <span class="hljs-built_in">run</span>=<span class="hljs-keyword">my</span>-nginx -o=<span class="hljs-built_in">name</span>|cut -d <span class="hljs-string">&quot;/&quot;</span> -f2&#x27; cat /etc/config/log_level<br></code></pre></td></tr></table></figure>
<p>修改 ConfigMap</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">kubectl <span class="hljs-keyword">edit</span> configmap <span class="hljs-built_in">log</span>-config<br></code></pre></td></tr></table></figure>

<p>修改 log_level 的值为 DEBUG 等待大概 10 秒钟时间，再次查看环境变量的值</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">kubectl exec &#x27;kubectl <span class="hljs-keyword">get</span> pods -l <span class="hljs-built_in">run</span>=<span class="hljs-keyword">my</span>-nginx -o=<span class="hljs-built_in">name</span>|cut -d <span class="hljs-string">&quot;/&quot;</span> -f2&#x27; cat /tmp/log_level DEBUG<br></code></pre></td></tr></table></figure>
<h4 id="ConfigMap-更新后滚动更新-Pod"><a href="#ConfigMap-更新后滚动更新-Pod" class="headerlink" title="ConfigMap 更新后滚动更新 Pod"></a>ConfigMap 更新后滚动更新 Pod</h4><p>更新 ConfigMap 目前并不会触发相关 Pod 的滚动更新，可以通过修改 pod annotations 的 方式强制触发滚动更新</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">kubectl <span class="hljs-keyword">patch</span> deployment my-nginx <span class="hljs-params">--patch</span> &#x27;&#123;<span class="hljs-string">&quot;spec&quot;</span>: &#123;<span class="hljs-string">&quot;template&quot;</span>: &#123;<span class="hljs-string">&quot;metadata&quot;</span>: &#123;<span class="hljs-string">&quot;annotations&quot;</span>: &#123;<span class="hljs-string">&quot;version/config&quot;</span>: <span class="hljs-string">&quot;20190411&quot;</span> &#125;&#125;&#125;&#125;&#125;&#x27;<br></code></pre></td></tr></table></figure>
<p>这个例子里我们在.spec.template.metadata.annotations 中添加 version&#x2F;config ,每次 通过修改 version&#x2F;config 来触发滚动更新 更新 ConfigMap 后： </p>
<ul>
<li>使用该 ConfigMap 挂载的 Env 不会同步更新 </li>
<li>使用该 ConfigMap 挂载的 Volume 中的数据需要一段时间（实测大概 10 秒）才能同步更新</li>
</ul>
<h1 id="14、kubernetes-核心技术-Namespace"><a href="#14、kubernetes-核心技术-Namespace" class="headerlink" title="14、kubernetes 核心技术-Namespace"></a>14、kubernetes 核心技术-Namespace</h1><h6 id="Namespace-概述"><a href="#Namespace-概述" class="headerlink" title="Namespace 概述"></a>Namespace 概述</h6><p>Namespace 在很多情况下用于实现多用户的资源隔离，通过将集群内部的资源对象分配到 不同的 Namespace 中， 形成逻辑上的分组，便于不同的分组在共享使用整个集群的资源同 时还能被分别管理。Kubernetes 集群在启动后，会创建一个名为”default”的 Namespace， 如果不特别指明 Namespace,则用户创建的 Pod，RC，Service 都将 被系统 创建到这个默 认的名为 default 的 Namespace 中。</p>
<h6 id="Namespace-创建"><a href="#Namespace-创建" class="headerlink" title="Namespace 创建"></a>Namespace 创建</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">development</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">development</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span> <br>   <span class="hljs-attr">command:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-string">-&quot;3600&quot;</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span><br></code></pre></td></tr></table></figure>
<h6 id="Namespace-查看"><a href="#Namespace-查看" class="headerlink" title="Namespace 查看"></a>Namespace 查看</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> pods <span class="hljs-attribute">--namespace</span>=development<br></code></pre></td></tr></table></figure>

<h1 id="15、kubernetes-核心技术-Service"><a href="#15、kubernetes-核心技术-Service" class="headerlink" title="15、kubernetes 核心技术-Service"></a>15、kubernetes 核心技术-Service</h1><h6 id="Service-概述"><a href="#Service-概述" class="headerlink" title="Service 概述"></a>Service 概述</h6><p>Service 是 Kubernetes 最核心概念，通过创建 Service,可以为一组具有相同功能的容器应 用提供一个统一的入口地 址，并且将请求负载分发到后端的各个容器应用上。</p>
<h6 id="Service-的定义"><a href="#Service-的定义" class="headerlink" title="Service 的定义"></a>Service 的定义</h6><ul>
<li>（1）yaml 格式的 Service 定义文件</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span> <br><span class="hljs-attr">matadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">string</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span> <br>    <span class="hljs-attr">annotations:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">selector:</span> [] <br> <span class="hljs-attr">type:</span> <span class="hljs-string">string</span> <br> <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">string</span> <br> <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">string</span> <br> <span class="hljs-attr">ports:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span> <br>   <span class="hljs-attr">protocol:</span> <span class="hljs-string">string</span> <br>   <span class="hljs-attr">port:</span> <span class="hljs-string">int</span> <br>   <span class="hljs-attr">targetPort:</span> <span class="hljs-string">int</span> <br>   <span class="hljs-attr">nodePort:</span> <span class="hljs-string">int</span> <br>   <span class="hljs-attr">status:</span> <br>    <span class="hljs-attr">loadBalancer:</span> <br>     <span class="hljs-attr">ingress:</span> <br>      <span class="hljs-attr">ip:</span> <span class="hljs-string">string</span> <br>      <span class="hljs-attr">hostname:</span> <span class="hljs-string">string</span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526150019.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526150051.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526150343.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="Service-的基本用法"><a href="#Service-的基本用法" class="headerlink" title="Service 的基本用法"></a>Service 的基本用法</h4><ul>
<li>（1）一般来说，对外提供服务的应用程序需要通过某种机制来实现，对于容器应用最简便 的方式就是通过 TCP&#x2F;IP 机制及 监听 IP 和端口号来实现。创建一个基本功能的 Service</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicationController</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">mywebapp</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span> <br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">mywebapp</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> <span class="hljs-string">mywebapp</span> <br>  <span class="hljs-attr">spec:</span> <br>   <span class="hljs-attr">containers:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mywebapp</span> <br>     <span class="hljs-attr">image:</span> <span class="hljs-string">tomcat</span> <br>     <span class="hljs-attr">ports:</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>
<ul>
<li>（2）我们可以通过 kubectl get pods -l app&#x3D;mywebapp -o yaml | grep podIP 来获取 Pod 的 IP 地址和端口号来访问 Tomcat 服务，但是直接通过 Pod 的 IP 地址和端口访问应用 服务是不可靠的，因为当 Pod 所在的 Node 发生故障时， Pod 将被 kubernetes 重新调度到 另一台 Node，Pod 的地址会发生改变。我们可以通过配置文件来定义 Service，再 通过 kubectl create 来创建，这样可以通过 Service 地址来访问后端的 Pod.</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span> <br><span class="hljs-attr">metadata:</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">mywebAppService</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">ports:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span> <br>     <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span> <br> <span class="hljs-attr">selector:</span> <br>   <span class="hljs-attr">app:</span> <span class="hljs-string">mywebapp</span><br></code></pre></td></tr></table></figure>
<h4 id="多端口-Service"><a href="#多端口-Service" class="headerlink" title="多端口 Service"></a>多端口 Service</h4><p>有时一个容器应用也可能需要提供多个端口的服务，那么在 Service 的定义中也可以相应 地设置为将多个端口对应 到多个应用服务。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">mywebAppService</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">ports:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <br>   <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">web</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8005</span> <br>     <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8005</span> <br>     <span class="hljs-attr">name:</span> <span class="hljs-string">management</span> <br><span class="hljs-attr">selector:</span> <br> <span class="hljs-attr">app:</span> <span class="hljs-string">mywebapp</span><br></code></pre></td></tr></table></figure>

<h4 id="外部服务-Service"><a href="#外部服务-Service" class="headerlink" title="外部服务 Service"></a>外部服务 Service</h4><p>在某些特殊环境中，应用系统需要将一个外部数据库作为后端服务进行连接，或将另一个 集群或 Namespace 中的 服务作为服务的后端，这时可以通过创建一个无 Label Selector 的 Service 来实现。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">ports:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span> <br>   <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <br>   <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Endpoints</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span> <br> <span class="hljs-attr">subsets:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span> <br>    <span class="hljs-attr">IP:</span> <span class="hljs-number">10.254</span><span class="hljs-number">.74</span><span class="hljs-number">.3</span> <br>   <span class="hljs-attr">ports:</span> <br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>
<h1 id="16、kubernetes-核心技术-探针"><a href="#16、kubernetes-核心技术-探针" class="headerlink" title="16、kubernetes 核心技术-探针"></a>16、kubernetes 核心技术-探针</h1><h4 id="探针类型"><a href="#探针类型" class="headerlink" title="探针类型"></a>探针类型</h4><p>K8s 中存在两种类型的探针：liveness probe 和 readiness probe。</p>
<h4 id="liveness-probe（存活探针）"><a href="#liveness-probe（存活探针）" class="headerlink" title="liveness probe（存活探针）"></a>liveness probe（存活探针）</h4><p>用于判断容器是否存活，即 Pod 是否为 running 状态，如果 LivenessProbe 探针探测到容 器不健康，则 kubelet 将 kill 掉容器，并根据容器的重启策略是否重启。如果一个容器不 包含 LivenessProbe 探针，则 Kubelet 认为容器的 LivenessProbe 探针的返回值永远成功。 有时应用程序可能因为某些原因（后端服务故障等）导致暂时无法对外提供服务，但应用 软件没有终止，导致 K8S 无法隔离有故障的 pod，调用者可能会访问到有故障的 pod，导致 业务不稳定。K8S 提供 livenessProbe 来检测应用程序是否正常运行，并且对相应状况进 行相应的补救措施。</p>
<h4 id="readiness-probe（就绪探针）"><a href="#readiness-probe（就绪探针）" class="headerlink" title="readiness probe（就绪探针）"></a>readiness probe（就绪探针）</h4><p>用于判断容器是否启动完成，即容器的 Ready 是否为 True，可以接收请求，如果 ReadinessProbe 探测失败，则容器的 Ready 将为 False，控制器将此 Pod 的 Endpoint 从对 应的 service 的 Endpoint 列表中移除，从此不再将任何请求调度此 Pod 上，直到下次探测 成功。通过使用 Readiness 探针，Kubernetes 能够等待应用程序完全启动，然后才允许服 务将流量发送到新副本。 </p>
<p>比如使用 tomcat 的应用程序来说，并不是简单地说 tomcat 启动成功就可以对外提供服务 的，还需要等待 spring 容器初始化，数据库连接没连上等等。对于 spring boot 应用，默 认的 actuator 带有&#x2F;health 接口，可以用来进行启动成功的判断</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526152442.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="每类探针都支持三种探测方法："><a href="#每类探针都支持三种探测方法：" class="headerlink" title="每类探针都支持三种探测方法："></a>每类探针都支持三种探测方法：</h4><ul>
<li>（1）exec：通过执行命令来检查服务是否正常，针对复杂检测或无 HTTP 接口的服务，命 令返回值为 0 则表示容器健康。 </li>
<li>（2）httpGet：通过发送 http 请求检查服务是否正常，返回 200-399 状态码则表明容器健 康。</li>
<li>（3）tcpSocket：通过容器的 IP 和 Port 执行 TCP 检查，如果能够建立 TCP 连接，则表明 容器健康。</li>
</ul>
<h4 id="探针探测的结果"><a href="#探针探测的结果" class="headerlink" title="探针探测的结果"></a>探针探测的结果</h4><ul>
<li>（1）Success：Container 通过了检查。 </li>
<li>（2）Failure：Container 未通过检查。 </li>
<li>（3）Unknown：未能执行检查，因此不采取任何措施。</li>
</ul>
<h4 id="Pod-重启策略："><a href="#Pod-重启策略：" class="headerlink" title="Pod 重启策略："></a>Pod 重启策略：</h4><ul>
<li>（1）Always: 总是重启 </li>
<li>（2）OnFailure: 如果失败就重启 </li>
<li>（3）Never: 永远不重启</li>
</ul>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">goproxy</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">app:</span> <span class="hljs-string">goproxy</span><br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">goproxy</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/goproxy:0.1</span> <br>   <span class="hljs-attr">ports:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span> <br>     <span class="hljs-attr">readinessProbe:</span> <br>      <span class="hljs-attr">tcpSocket:</span> <br>       <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <br>      <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span> <br>      <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span> <br>     <span class="hljs-attr">livenessProbe:</span> <br>      <span class="hljs-attr">tcpSocket:</span> <br>       <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <br>      <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">15</span> <br>      <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure>
<p>探针(Probe)有许多可选字段，可以用来更加精确的控制 Liveness 和 Readiness 两种探针 的行为。这些参数包括： </p>
<p>initialDelaySeconds：容器启动后第一次执行探测是需要等待多少秒。 </p>
<p>periodSeconds：执行探测的频率。默认是 10 秒，最小 1 秒。 </p>
<p>timeoutSeconds：探测超时时间。默认 1 秒，最小 1 秒。 </p>
<p>successThreshold：探测失败后，最少连续探测成功多少次才被认定为成功。默认是 1。 对于 liveness 必须是 1。最小值是 1。 </p>
<p>failureThreshold：探测成功后，最少连续探测失败多少次才被认定为失败。默认是 3。 最小值是 1。</p>
<h1 id="17、kubernetes-核心技术-调度器"><a href="#17、kubernetes-核心技术-调度器" class="headerlink" title="17、kubernetes 核心技术-调度器"></a>17、kubernetes 核心技术-调度器</h1><h6 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h6><p>一个容器平台的主要功能就是为容器分配运行时所需要的计算，存储和网络资源。容器调 度系统负责选择在最合适的主机上启动容器，并且将它们关联起来。它必须能够自动的处 理容器故障并且能够在更多的主机上自动启动更多的容器来应对更多的应用访问。 </p>
<p>目前三大主流的容器平台 Swarm, Mesos 和 Kubernetes 具有不同的容器调度系统。<br>1.Swarm 的特点是直接调度 Docker 容器，并且提供和标准 Docker API 一致的 API。 </p>
<p>2.Mesos 针对不同的运行框架采用相对独立的调度系统，其中 Marathon 框架提供了 Docker 容器的原生支持。 </p>
<p>3.Kubernetes 则采用了 Pod 和 Label 这样的概念把容器组合成一个个的互相存在依赖关系 的逻辑单元。相关容器被组合成 Pod 后被共同部署和调度，形成服务（Service）。 </p>
<p>这个是 Kubernetes 和 Swarm，Mesos 的主要区别。 </p>
<p>相对来说，Kubernetes 采用这样的方式简化了集群范围内相关容器被共同调度管理的复杂 性。换一种角度来看，Kubernetes 采用这种方式能够相对容易的支持更强大，更复杂的容 器调度算法</p>
<h4 id="k8s-调度工作方式"><a href="#k8s-调度工作方式" class="headerlink" title="k8s 调度工作方式"></a>k8s 调度工作方式</h4><p>Kubernetes 调度器作为集群的大脑，在如何提高集群的资源利用率、保证集群中服务的稳 定运行中也会变得越来越重要 </p>
<p>Kubernetes 的资源分为两种属性。 </p>
<p>1.可压缩资源（例如 CPU 循环，Disk I&#x2F;O 带宽）都是可以被限制和被回收的，对于一个 Pod 来说可以降低这些资源的使用量而不去杀掉 Pod。 </p>
<p>2.不可压缩资源（例如内存、硬盘空间）一般来说不杀掉 Pod 就没法回收。未来 Kubernetes 会加入更多资源，如网络带宽，存储 IOPS 的支持。</p>
<h4 id="k8s-调度器"><a href="#k8s-调度器" class="headerlink" title="k8s 调度器"></a>k8s 调度器</h4><ul>
<li>（1）kube-scheduler 是 kubernetes 系统的核心组件之一，主要负责整个集群资源的调 度功能，根据特定的调度算法和策略，将 Pod 调度到最优的工作节点上面去，从而更加合 理、更加充分的利用集群的资源，这也是选择使用 kubernetes 一个非常重要的理由。如 果一门新的技术不能帮助企业节约成本、提供效率，我相信是很难推进的。 </li>
<li>（2）调度流程 默认情况下，kube-scheduler 提供的默认调度器能够满足我们绝大多数的要求，之前接触 的示例也基本上用的默认的策略，都可以保证我们的 Pod 可以被分配到资源充足的节点上 运行。但是在实际的线上项目中，可能我们自己会比 kubernetes 更加了解我们自己的应 用，比如我们希望一个 Pod 只能运行在特定的几个节点上，或者这几个节点只能用来运行 特定类型的应用，这就需要我们的调度器能够可控。</li>
</ul>
<p>kube-scheduler 是 kubernetes 的调度器，它的主要作用就是根据特定的调度算法和调度 策略将 Pod 调度到合适的 Node 节点上去，是一个独立的二进制程序，启动之后会一直监 听 API Server，获取到 PodSpec.NodeName 为空的 Pod，对每个 Pod 都会创建一个 binding。</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526155049.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>调度主要分为以下几个部分： </p>
<p>首先是预选过程，过滤掉不满足条件的节点，这个过程称为 Predicates </p>
<p>然后是优选过程，对通过的节点按照优先级排序，称之为 Priorities </p>
<p>最后从中选择优先级最高的节点，如果中间任何一步骤有错误，就直接返回错误 </p>
<p>Predicates 阶段首先遍历全部节点，过滤掉不满足条件的节点，属于强制性规则，这一阶 段输出的所有满足要求的 Node 将被记录并作为第二阶段的输入，如果所有的节点都不满 足条件，那么 Pod 将会一直处于 Pending 状态，直到有节点满足条件，在这期间调度器 会不断的重试。 </p>
<p>所以我们在部署应用的时候，如果发现有 Pod 一直处于 Pending 状态，那么就是没有满 足调度条件的节点，这个时候可以去检查下节点资源是否可用。 </p>
<p>Priorities 阶段即再次对节点进行筛选，如果有多个节点都满足条件的话，那么系统会按 照节点的优先级(priorites)大小对节点进行排序，最后选择优先级最高的节点来部署 Pod 应用。 </p>
<p>下面是调度过程的简单示意图<br><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526155251.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="更详细的流程是这样的："><a href="#更详细的流程是这样的：" class="headerlink" title="更详细的流程是这样的："></a>更详细的流程是这样的：</h6><p>首先，客户端通过 API Server 的 REST API 或者 kubectl 工具创建 Pod 资源 </p>
<p>API Server 收到用户请求后，存储相关数据到 etcd 数据库中 </p>
<p>调度器监听 API Server 查看为调度(bind)的 Pod 列表，循环遍历地为每个 Pod 尝试分 配节点，这个分配过程就是我们上面提到的两个阶段：</p>
<p>预选阶段(Predicates)，过滤节点，调度器用一组规则过滤掉不符合要求的 Node 节点， 比如 Pod 设置了资源的 request，那么可用资源比 Pod 需要的资源少的主机显然就会被 过滤掉 </p>
<p>优选阶段(Priorities)，为节点的优先级打分，将上一阶段过滤出来的 Node 列表进行打 分，调度器会考虑一些整体的优化策略，比如把 Deployment 控制的多个 Pod 副本分布到 不同的主机上，使用最低负载的主机等等策略 </p>
<p>经过上面的阶段过滤后选择打分最高的 Node 节点和 Pod 进行 binding 操作，然后将结 果存储到 etcd 中 </p>
<p>最后被选择出来的 Node 节点对应的 kubelet 去执行创建 Pod 的相关操作 </p>
<p>其中 Predicates 过滤有一系列的算法可以使用，我们这里简单列举几个： </p>
<p>PodFitsResources：节点上剩余的资源是否大于 Pod 请求的资源 </p>
<p>PodFitsHost：如果 Pod 指定了 NodeName，检查节点名称是否和 NodeName 匹配 </p>
<p>PodFitsHostPorts：节点上已经使用的 port 是否和 Pod 申请的 port 冲突 </p>
<p>PodSelectorMatches：过滤掉和 Pod 指定的 label 不匹配的节点 </p>
<p>NoDiskConflict：已经 mount 的 volume 和 Pod 指定的 volume 不冲突，除非它们都是 只读的 </p>
<p>CheckNodeDiskPressure：检查节点磁盘空间是否符合要求 </p>
<p>CheckNodeMemoryPressure：检查节点内存是否够用 </p>
<p>除了这些过滤算法之外，还有一些其他的算法，更多更详细的我们可以查看源码文件： k8s.io&#x2F;kubernetes&#x2F;pkg&#x2F;scheduler&#x2F;algorithm&#x2F;predicates&#x2F;predicates.go。 </p>
<p>而 Priorities 优先级是由一系列键值对组成的，键是该优先级的名称，值是它的权重值， 同样，我们这里给大家列举几个具有代表性的选项： </p>
<p>LeastRequestedPriority：通过计算 CPU 和内存的使用率来决定权重，使用率越低权重越 高，当然正常肯定也是资源是使用率越低权重越高，能给别的 Pod 运行的可能性就越大 </p>
<p>SelectorSpreadPriority：为了更好的高可用，对同属于一个 Deployment 或者 RC 下面 的多个 Pod 副本，尽量调度到多个不同的节点上，当一个 Pod 被调度的时候，会先去查 找该 Pod 对应的 controller，然后查看该 controller 下面的已存在的 Pod，运行 Pod 越少的节点权重越高 </p>
<p>ImageLocalityPriority：就是如果在某个节点上已经有要使用的镜像节点了，镜像总大小 值越大，权重就越高 </p>
<p>NodeAffinityPriority：这个就是根据节点的亲和性来计算一个权重值，后面我们会详细 讲解亲和性的使用方法</p>
<h6 id="节点调度亲和性"><a href="#节点调度亲和性" class="headerlink" title="节点调度亲和性"></a>节点调度亲和性</h6><p>节点亲和性规则：硬亲和性 required 、软亲和性 preferred。</p>
<p>硬亲和性规则不满足时，Pod 会置于 Pending 状态，软亲和性规则不满足时，会选择一个 不匹配的节点。当节点标签改变而不再符合此节点亲和性规则时，不会将 Pod 从该节点移 出，仅对新建的 Pod 对象生效</p>
<h6 id="（1）节点硬亲和性"><a href="#（1）节点硬亲和性" class="headerlink" title="（1）节点硬亲和性"></a>（1）节点硬亲和性</h6><p>requiredDuringSchedulingIgnoredDuringExecution </p>
<p>方式一：Pod 使用 spec.nodeSelector (基于等值关系) </p>
<p>方式二：Pod 使用 spec.affinity 支持 matchExpressions 属性 (复杂标签选择机制)</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 调度至 zone = foo 的节点 </span><br><span class="hljs-string">kubectllabelnodeskube-node1zone=foo</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">with-required-nodeaffinity</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">affinity:</span> <br>  <span class="hljs-attr">nodeAffinity:</span> <span class="hljs-string">requiredDuringSchedulingIgnoredDuringExecution:#</span> <span class="hljs-string">定义硬亲和性</span> <br>   <span class="hljs-attr">nodeSelectorTerms:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment">#集合选择器 </span><br>     <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:zone</span>,<span class="hljs-string">operator:In</span>,<span class="hljs-string">values:</span>[<span class="hljs-string">&quot;foo&quot;</span>]&#125; <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span><br></code></pre></td></tr></table></figure>
<h6 id="（2）节点软亲和性"><a href="#（2）节点软亲和性" class="headerlink" title="（2）节点软亲和性"></a>（2）节点软亲和性</h6><p>preferredDuringSchedulingIgnoredDuringExecution \</p>
<p>柔性控制逻辑，当条件不满足时，能接受被编排于其他不符合条件的节点之上 </p>
<p>权重 weight 定义优先级，1-100 值越大优先级越高</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-deploy-with-node-affinity</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span> <br> <span class="hljs-attr">selector:</span> <br>  <span class="hljs-attr">matchLabels:</span> <br>   <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-pod</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br>  <span class="hljs-attr">spec:</span> <br>   <span class="hljs-attr">affinity:</span> <br>    <span class="hljs-attr">nodeAffinity:</span> <br>     <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment">#节点软亲和性 </span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">60</span> <br>       <span class="hljs-attr">preference:</span> <br>        <span class="hljs-attr">matchExpressions:</span> <br>        <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:zone</span>,<span class="hljs-string">operator:In</span>,<span class="hljs-string">values:</span>[<span class="hljs-string">&quot;foo&quot;</span>]&#125; <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">30</span> <br>       <span class="hljs-attr">preference:</span> <br>        <span class="hljs-attr">matchExpressions:</span> <br>        <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:ssd</span>,<span class="hljs-string">operator:Exists</span>,<span class="hljs-string">values:</span>[]&#125; <br>   <span class="hljs-attr">containers:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>     <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span><br></code></pre></td></tr></table></figure>
<h4 id="Pod-资源亲和调度"><a href="#Pod-资源亲和调度" class="headerlink" title="Pod 资源亲和调度"></a>Pod 资源亲和调度</h4><p>Pod 对象间亲和性，将一些 Pod 对象组织在相近的位置(同一节点、机架、区域、地区) </p>
<p>Pod 对象间反亲和性，将一些 Pod 在运行位置上隔开</p>
<ul>
<li>（1）Pod 硬亲和调度</li>
</ul>
<p>requiredDuringSchedulingIgnoredDuringExecution </p>
<p>Pod 亲和性描述一个 Pod 与具有某特征的现存 Pod 运行位置的依赖关系；即需要事先存在 被依赖的 Pod 对象</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">with-pod-affinity</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">affinity:</span> <br>  <span class="hljs-attr">podAffinity:</span> <br>   <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment"># 硬亲和调度 </span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span> <br>      <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment">#集合选择器 </span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:app</span>,<span class="hljs-string">operator:In</span>,<span class="hljs-string">values:</span>[<span class="hljs-string">&quot;tomcat&quot;</span>]&#125; <span class="hljs-comment"># 选择被依赖 Pod </span><br>     <span class="hljs-comment"># 上面意思是，当前 pod 要跟标签为 app 值为 tomcat 的 pod 在一起 </span><br>     <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span> <span class="hljs-comment"># 根据挑选出的 Pod 所有节点的 hostname 作为同一位置的判定 </span><br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span><br></code></pre></td></tr></table></figure>
<ul>
<li>（2）Pod 软亲和调度</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-string">name:myapp-with-preferred-pod-affinity</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span> <br> <span class="hljs-attr">selector:</span> <br>  <span class="hljs-attr">matchLabels:</span> <br>   <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br>  <span class="hljs-attr">spec:</span> <br>   <span class="hljs-attr">affinity:</span> <br>    <span class="hljs-attr">podAffinity:</span> <br>     <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">80</span> <br>       <span class="hljs-attr">podAffinityTerm:</span> <br>        <span class="hljs-attr">labelSelector:</span> <br>         <span class="hljs-attr">matchExpressions:</span> <br>         <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:app</span>,<span class="hljs-string">operator:In</span>,<span class="hljs-string">values:</span>[<span class="hljs-string">&quot;cache&quot;</span>]&#125; <br>        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">zone</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">20</span> <br>       <span class="hljs-attr">podAffinityTerm:</span> <br>        <span class="hljs-attr">labelSelector:</span> <br>         <span class="hljs-attr">matchExpressions:</span> <br>         <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:app</span>,<span class="hljs-string">operator:In</span>,<span class="hljs-string">values:</span>[<span class="hljs-string">&quot;db&quot;</span>]&#125;<br>        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">zone</span> <br>   <span class="hljs-attr">containers:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>     <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span><br></code></pre></td></tr></table></figure>
<ul>
<li>（3）Pod 反亲和调度</li>
</ul>
<p>Pod 反亲和调度用于分散同一类应用，调度至不同的区域、机架或节点等 将 spec.affinity.podAffinity 替换为 spec.affinity.podAntiAffinity </p>
<p>反亲和调度也分为柔性约束和强制约束</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-first</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br>  <span class="hljs-attr">tier:</span> <span class="hljs-string">fronted</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-second</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">app:</span> <span class="hljs-string">backend</span> <br>  <span class="hljs-attr">tier:</span> <span class="hljs-string">db</span> <br><span class="hljs-attr">spec:</span><br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:latest</span> <br>   <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span> <br>   <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;sleep 3600&quot;</span>] <br> <span class="hljs-attr">affinity:</span> <br>  <span class="hljs-attr">podAntiAffinity:</span> <br>   <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span> <br>      <span class="hljs-attr">matchExpressions:</span> <br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-string">key:app</span>,<span class="hljs-string">operator:In</span>,<span class="hljs-string">values:</span>[<span class="hljs-string">&quot;myapp&quot;</span>]&#125; <br>     <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">zone</span><br></code></pre></td></tr></table></figure>
<h4 id="污点和容忍度"><a href="#污点和容忍度" class="headerlink" title="污点和容忍度"></a>污点和容忍度</h4><p>污点 taints 是定义在节点上的键值型属性数据，用于让节点拒绝将 Pod 调度运行于其上， 除非 Pod 有接纳节点污点的容忍度容忍度 tolerations 是定义在 Pod 上的键值属性数据， 用于配置可容忍的污点，且调度器将 Pod 调度至其能容忍该节点污点的节点上或没有污点 的节点上</p>
<h6 id="使用-PodToleratesNodeTaints-预选策略和-TaintTolerationPriority-优选函数完成该机-制"><a href="#使用-PodToleratesNodeTaints-预选策略和-TaintTolerationPriority-优选函数完成该机-制" class="headerlink" title="使用 PodToleratesNodeTaints 预选策略和 TaintTolerationPriority 优选函数完成该机 制"></a>使用 PodToleratesNodeTaints 预选策略和 TaintTolerationPriority 优选函数完成该机 制</h6><p>节点亲和性使得 Pod 对象被吸引到一类特定的节点 (nodeSelector 和 affinity) </p>
<p>污点提供让节点排斥特定 Pod 对象的能力</p>
<ul>
<li>（1）定义污点和容忍度<br>污点定义于 nodes.spec.taints 容忍度定义于 pods.spec.tolerations</li>
</ul>
<p>语法： key&#x3D;value:effect</p>
<ul>
<li>（2）effect 定义排斥等级：<br>NoSchedule，不能容忍，但仅影响调度过程，已调度上去的 pod 不受影响，仅对新增加的 pod 生效。</li>
</ul>
<p>PreferNoSchedule，柔性约束，节点现存 Pod 不受影响，如果实在是没有符合的节点，也 可以调度上来 </p>
<p>NoExecute，不能容忍，当污点变动时，Pod 对象会被驱逐</p>
<ul>
<li>（3）在 Pod 上定义容忍度时：</li>
</ul>
<p>等值比较 容忍度与污点在 key、value、effect 三者完全匹配 </p>
<p>存在性判断 key、effect 完全匹配，value 使用空值 </p>
<p>一个节点可配置多个污点，一个 Pod 也可有多个容忍度</p>
<ul>
<li>（4）管理节点的污点</li>
</ul>
<p>同一个键值数据，effect 不同，也属于不同的污点 </p>
<p>给节点添加污点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl taint node &lt;node-name&gt;&lt;key&gt;=&lt;value&gt;:&lt;effect&gt; <br>kubectl taint node node2 node-type=production:NoShedule #举例<br></code></pre></td></tr></table></figure>

<p>查看节点污点：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">kubectl get nodes <span class="hljs-tag">&lt;<span class="hljs-name">nodename</span>&gt;</span> -o go-template=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">.spec.taints</span>&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p>删除节点污点：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">&lt;node-name</span>&gt;<span class="hljs-tag">&lt;key&gt;</span>[:<span class="hljs-tag">&lt;effect&gt;</span>]- <br>kubectl patch nodes <span class="hljs-tag">&lt;node-name&gt;</span> -p &#x27;&#123;<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;taints&quot;</span>:[]&#125;&#125;&#x27; <br>kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">kube-node1</span> <span class="hljs-keyword">node</span><span class="hljs-title">-type</span>=production:NoSchedule <br>kubectl get nodes kube-node1 -o <span class="hljs-attr">go-template=</span>&#123;&#123;.<span class="hljs-keyword">spec</span>.taints&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>删除 key 为 node-type，effect 为 NoSchedule 的污点</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">kube-node1</span> <span class="hljs-keyword">node</span>-type:<span class="hljs-title">NoSchedule-</span><br></code></pre></td></tr></table></figure>

<p>删除 key 为 node-type 的所有污点</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">kube-node1</span> <span class="hljs-keyword">node</span><span class="hljs-title">-type-</span><br></code></pre></td></tr></table></figure>

<p>删除所有污点</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">kubectl <span class="hljs-keyword">patch</span> nodes kube-node1 -p &#x27;&#123;<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;taints&quot;</span>:[]&#125;&#125;&#x27;<br></code></pre></td></tr></table></figure>

<p>给 Pod 对象容忍度</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">spec</span>.tolerations 字段添加 <br>tolerationSeconds 用于定义延迟驱逐 Pod 的时长<br></code></pre></td></tr></table></figure>

<p>等值判断</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">tolerations:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;key1&quot;</span> <br>  <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Equal&quot;</span> <span class="hljs-comment">#判断条件为 Equal </span><br>  <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;value1&quot;</span> <br>  <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span> <br>  <span class="hljs-attr">tolerationSeconds:</span> <span class="hljs-number">3600</span><br></code></pre></td></tr></table></figure>

<p>存在性判断</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">tolerations:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;key1&quot;</span> <br>  <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span> <span class="hljs-comment">#存在性判断，只要污点键存在，就可以匹配 </span><br>  <span class="hljs-string">effect:&quot;NoExecute&quot;</span> <br>  <span class="hljs-string">tolerationSeconds:3600</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-deploy</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br><span class="hljs-attr">spec:</span><br> <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span> <br> <span class="hljs-attr">selector:</span> <br>  <span class="hljs-attr">matchLabels:</span> <br>   <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">release:</span> <span class="hljs-string">canary</span><br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <br>    <span class="hljs-attr">release:</span> <span class="hljs-string">canary</span> <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">containers:</span> <br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span> <br>   <span class="hljs-attr">image:</span> <span class="hljs-string">ikubernetes/myapp:v1</span> <br>   <span class="hljs-attr">ports:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span> <br>     <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span> <br>   <span class="hljs-attr">tolerations:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;node-type&quot;</span> <br>     <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Equal&quot;</span> <br>     <span class="hljs-attr">value:</span> <span class="hljs-attr">&quot;production&quot;:</span> <br>     <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span> <br>     <span class="hljs-attr">tolerationSeconds:</span> <span class="hljs-number">3600</span><br></code></pre></td></tr></table></figure>

<h4 id="问题节点标识"><a href="#问题节点标识" class="headerlink" title="问题节点标识"></a>问题节点标识</h4><p>自动为节点添加污点信息，使用 NoExecute 效用标识，会驱逐现有 Pod </p>
<p>K8s 核心组件通常都容忍此类污点 </p>
<p>node.kubernetes.io&#x2F;not-ready 节点进入 NotReady 状态时自动添加 </p>
<p>node.alpha.kubernetes.io&#x2F;unreachable 节点进入 NotReachable 状态时自动添加 </p>
<p>node.kubernetes.io&#x2F;out-of-disk 节点进入 OutOfDisk 状态时自动添加 </p>
<p>node.kubernetes.io&#x2F;memory-pressure 节点内存资源面临压力 </p>
<p>node.kubernetes.io&#x2F;disk-pressure 节点磁盘面临压力 </p>
<p>node.kubernetes.io&#x2F;network-unavailable 节点网络不可用 </p>
<p>node.cloudprovider.kubernetes.io&#x2F;uninitialized kubelet 由外部云环境程序启动时， 自动添加，待到去控制器初始化此节点时再将其删除</p>
<h4 id="Pod-优选级和抢占式调度"><a href="#Pod-优选级和抢占式调度" class="headerlink" title="Pod 优选级和抢占式调度"></a>Pod 优选级和抢占式调度</h4><p>优选级，Pod 对象的重要程度 </p>
<p>优选级会影响节点上 Pod 的调度顺序和驱逐次序 </p>
<p>一个 Pod 对象无法被调度时，调度器会尝试抢占(驱逐)较低优先级的 Pod 对象，以便可以 调度当前 Pod</p>
<h4 id="Pod-优选级和抢占机制默认处于禁用状态"><a href="#Pod-优选级和抢占机制默认处于禁用状态" class="headerlink" title="Pod 优选级和抢占机制默认处于禁用状态"></a>Pod 优选级和抢占机制默认处于禁用状态</h4><p>启用：同时为 kube-apiserver、kube-scheduler、kubelet 程序的 –feature-gates 添加 PodPriority&#x3D;true </p>
<p>使用：事先创建优先级类别，并在创建 Pod 资源时通过 priorityClassName 属性指定所属 优选级类别</p>
<h1 id="18、kubernetes-核心技术-集群安全机制-RBAC"><a href="#18、kubernetes-核心技术-集群安全机制-RBAC" class="headerlink" title="18、kubernetes 核心技术-集群安全机制 RBAC"></a>18、kubernetes 核心技术-集群安全机制 RBAC</h1><h6 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h6><p>RBAC(Role-Based Access Control，基于角色的访问控制)在 k8s v1.5 中引入，在 v1.6 版 本时升级为 Beta 版本，并成为 kubeadm 安装方式下的默认选项，相对于其他访问控制方式， 新的 RBAC 具有如下优势： </p>
<ul>
<li>（1）对集群中的资源和非资源权限均有完整的覆盖 </li>
<li>（2）整个 RBAC 完全由几个 API 对象完成，同其他 API 对象一样，可以用 kubectl 或 API 进行操作 </li>
<li>（3）可以在运行时进行调整，无需重启 API Server 要使用 RBAC 授权模式，需要在 API Server 的启动参数中加上–authorization-mode&#x3D;RBAC</li>
</ul>
<h6 id="RBAC-原理和用法"><a href="#RBAC-原理和用法" class="headerlink" title="RBAC 原理和用法"></a>RBAC 原理和用法</h6><p>RBAC 引入了 4 个新的顶级资源对象：Role、ClusterRole、RoleBinding、 ClusterRoleBinding。同其他 API 资源对象一样，用户可以使用 kubectl 或者 API 调用等 方式操作这些资源对象。</p>
<p>角色(Role)</p>
<p>一个角色就是一组权限的集合，这里的权限都是许可形式的，不存在拒绝的规则。在一个 命名空间中，可以用角色来定义一个角色，如果是集群级别的，就需要使用 ClusterRole 了。角色只能对命名空间内的资源进行授权，下面的例子中定义的角色具备读取 Pod 的权 限：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader</span> <br><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <span class="hljs-comment"># 空字符串表示核心 API 群 </span><br>  <span class="hljs-attr">resource:</span> [<span class="hljs-string">&quot;pods&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]<br></code></pre></td></tr></table></figure>

<p>rules 中的参数说明： </p>
<ul>
<li>apiGroup：支持的 API 组列表，例如：APIVersion: batch&#x2F;v1、APIVersion: extensions:v1、apiVersion:apps&#x2F;v1 等</li>
</ul>
<p>resources：支持的资源对象列表，例如：pods、deployments、jobs 等 </p>
<p>verbs：对资源对象的操作方法列表，例如：get、watch、list、delete、 replace 等</p>
<h4 id="集群角色-ClusterRole"><a href="#集群角色-ClusterRole" class="headerlink" title="集群角色(ClusterRole)"></a>集群角色(ClusterRole)</h4><p>集群角色除了具有和角色一致的命名空间内资源的管理能力，因其集群级别的范围，还可 以用于以下特殊元素的授权。 </p>
<ul>
<li>集群范围的资源，例如 Node</li>
</ul>
<p>非资源型的路径，例如&#x2F;healthz </p>
<p>包含全部命名空间的资源，例如 pods </p>
<p>下面的集群角色可以让用户有权访问任意一个或所有命名空间的 secrets：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-comment"># name: secret-reader </span><br> <span class="hljs-comment"># ClusterRole 不受限于命名空间，所以省略了 namespace name 的定义 </span><br> <span class="hljs-attr">rules:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>   <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;secrets&quot;</span>] <br>   <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]<br></code></pre></td></tr></table></figure>

<h4 id="角色绑定-RoleBinding-和集群角色绑定-ClusterRoleBinding"><a href="#角色绑定-RoleBinding-和集群角色绑定-ClusterRoleBinding" class="headerlink" title="角色绑定(RoleBinding)和集群角色绑定(ClusterRoleBinding)"></a>角色绑定(RoleBinding)和集群角色绑定(ClusterRoleBinding)</h4><p>角色绑定或集群角色绑定用来把一个角色绑定到一个目标上，绑定目标可以是 User、 Group 或者 Service Account。使用 RoleBinding 为某个命名空间授权， ClusterRoleBinding 为集群范围内授权。 </p>
<p>RoleBinding 可以引用 Role 进行授权，下例中的 RoleBinding 将在 default 命名空间中把 pod-reader 角色授予用户 jane，可以让 jane 用户读取 default 命名空间的 Pod：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">read-pods</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">jane</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br><span class="hljs-attr">roleRef:</span> <br> <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader</span> <br> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<p>RoleBinding 也可以引用 ClusterRole，对属于同一命名空间内 ClusterRole 定义的资源主 体进行授权。一种常见的做法是集群管理员为集群范围预先定义好一组角色(ClusterRole)， 然后在多个命名空间中重复使用这些 ClusterRole。 </p>
<p>使用 RoleBinding 绑定集群角色 secret-reader，使 dave 只能读取 development 命名空间 中的 secret：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">read-secrets</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">development</span> <br><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dave</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br><span class="hljs-attr">roleRef:</span> <br> <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-reader</span> <br> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>
<p>集群角色绑定中的角色只能是集群角色，用于进行集群级别或者对所有命名空间都生效授 权。允许 manager 组的用户读取任意 namespace 中的 secret</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">read-secrets-global</span> <br><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">manager</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br><span class="hljs-attr">roleRef:</span> <br> <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-reader</span> <br> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>
<h4 id="对资源的引用方式"><a href="#对资源的引用方式" class="headerlink" title="对资源的引用方式"></a>对资源的引用方式</h4><p>多数资源可以用其名称的字符串来表达，也就是 Endpoint 中的 URL 相对路径，例如 pods。 然后，某些 Kubernetes API 包含下级资源，例如 Pod 的日志(logs)。Pod 日志的 Endpoint 是 GET &#x2F;api&#x2F;v1&#x2F;namespaces&#x2F;{namespaces}&#x2F;pods&#x2F;{name}&#x2F;log。 </p>
<p>Pod 是一个命名空间内的资源，log 就是一个下级资源。要在一个 RBAC 角色中体现，则需 要用斜线&#x2F;来分割资源和下级资源。若想授权让某个主体同时能够读取 Pod 和 Pod log，则 可以配置 resources 为一个数组：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">pod-and-pod-logs-reader</span> <br><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>, <span class="hljs-string">&quot;pods/log&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>]<br></code></pre></td></tr></table></figure>
<p>资源还可以通过名字(ResourceName)进行引用。在指定 ResourceName 后，使用 get、 delete、update、patch 动词的请求，就会被限制在这个资源实例范围内。例如下面的声 明让一个主体只能对一个叫 my-configmap 的 configmap 进行 get 和 update 操作：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">configmap-updater</span> <br><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmap&quot;</span>] <br>  <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;my-configmap&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>]<br></code></pre></td></tr></table></figure>
<h4 id="常见的角色-Role-示例"><a href="#常见的角色-Role-示例" class="headerlink" title="常见的角色(Role)示例"></a>常见的角色(Role)示例</h4><h6 id="（1）允许读取核心-API-组中-Pod-的资源："><a href="#（1）允许读取核心-API-组中-Pod-的资源：" class="headerlink" title="（1）允许读取核心 API 组中 Pod 的资源："></a>（1）允许读取核心 API 组中 Pod 的资源：</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br></code></pre></td></tr></table></figure>

<h6 id="（2）允许读写”extensions”和”apps”两个-API-组中的-deployment-资源"><a href="#（2）允许读写”extensions”和”apps”两个-API-组中的-deployment-资源" class="headerlink" title="（2）允许读写”extensions”和”apps”两个 API 组中的 deployment 资源"></a>（2）允许读写”extensions”和”apps”两个 API 组中的 deployment 资源</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;extensions&quot;</span>, <span class="hljs-string">&quot;apps&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;deployments&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br></code></pre></td></tr></table></figure>

<h6 id="（3）允许读写-pods-及读写-jobs"><a href="#（3）允许读写-pods-及读写-jobs" class="headerlink" title="（3）允许读写 pods 及读写 jobs"></a>（3）允许读写 pods 及读写 jobs</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>] <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;batch&quot;</span>, <span class="hljs-string">&quot;extensions&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;jobs&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br></code></pre></td></tr></table></figure>

<h6 id="（4）允许读取一个名为-my-config-的-ConfigMap-必须绑定到一个-RoleBinding-来限制到-一个-namespace"><a href="#（4）允许读取一个名为-my-config-的-ConfigMap-必须绑定到一个-RoleBinding-来限制到-一个-namespace" class="headerlink" title="（4）允许读取一个名为 my-config 的 ConfigMap(必须绑定到一个 RoleBinding 来限制到 一个 namespace"></a>（4）允许读取一个名为 my-config 的 ConfigMap(必须绑定到一个 RoleBinding 来限制到 一个 namespace</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>] <br>  <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;my-config&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>]<br></code></pre></td></tr></table></figure>

<h6 id="（5）读取核心组的-node-资源-Node-属于集群级别的资源，必须放在-ClusterRole-中，并-使用-ClusterRoleBinding-进行绑定-："><a href="#（5）读取核心组的-node-资源-Node-属于集群级别的资源，必须放在-ClusterRole-中，并-使用-ClusterRoleBinding-进行绑定-：" class="headerlink" title="（5）读取核心组的 node 资源(Node 属于集群级别的资源，必须放在 ClusterRole 中，并 使用 ClusterRoleBinding 进行绑定)："></a>（5）读取核心组的 node 资源(Node 属于集群级别的资源，必须放在 ClusterRole 中，并 使用 ClusterRoleBinding 进行绑定)：</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;nodes&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br></code></pre></td></tr></table></figure>

<h6 id="（6）允许对非资源端点-x2F-healthz-及其所有子路径进行-GET-x2F-POST-操作-必须使用-ClusterRole-和-ClusterRoleBinding-："><a href="#（6）允许对非资源端点-x2F-healthz-及其所有子路径进行-GET-x2F-POST-操作-必须使用-ClusterRole-和-ClusterRoleBinding-：" class="headerlink" title="（6）允许对非资源端点&#x2F;healthz 及其所有子路径进行 GET&#x2F;POST 操作(必须使用 ClusterRole 和 ClusterRoleBinding)："></a>（6）允许对非资源端点&#x2F;healthz 及其所有子路径进行 GET&#x2F;POST 操作(必须使用 ClusterRole 和 ClusterRoleBinding)：</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">nonResourceURLs:</span> [<span class="hljs-string">&quot;/healthz&quot;</span>, <span class="hljs-string">&quot;/healthz/*&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;post&quot;</span>]<br></code></pre></td></tr></table></figure>

<h4 id="常用的角色绑定"><a href="#常用的角色绑定" class="headerlink" title="常用的角色绑定"></a>常用的角色绑定</h4><ul>
<li>用户名 <a href="mailto:&#65;&#108;&#x69;&#x63;&#101;&#64;&#x65;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;">&#65;&#108;&#x69;&#x63;&#101;&#64;&#x65;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;</a></li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">subjects: <br>- kind: <span class="hljs-keyword">User</span> <br>  <span class="hljs-title">name</span>: <span class="hljs-string">&quot;Alice@example.com&quot;</span> <br>  apiGroup: rbac.authorization.k8s.io<br></code></pre></td></tr></table></figure>

<ul>
<li>组名 frontend-admins</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;frontend-admins&quot;</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<ul>
<li>kube-system 命名空间中的默认 Service Account</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default</span> <br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br></code></pre></td></tr></table></figure>

<ul>
<li>qa 命名空间中的所有 Service Account</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:serviceaccounts:qa</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<ul>
<li>所有 Service Account</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:serviceaccounts</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<ul>
<li>所有认证用户</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:authentication</span> <span class="hljs-string">a</span><br>  <span class="hljs-attr">piGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<ul>
<li>所有未认证用户</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:unauthentication</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<ul>
<li>全部用户</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:authentication</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:unauthentication</span> <br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure>

<h4 id="默认的角色和角色绑定"><a href="#默认的角色和角色绑定" class="headerlink" title="默认的角色和角色绑定"></a>默认的角色和角色绑定</h4><p>API Server 会创建一套默认的 ClusterRole 和 ClusterRoleBinding 对象，其中很多 是以 system:为前缀的，以表明这些资源属于基础架构，对这些对象的改动可能造成集群 故障。 </p>
<p>所有默认的 ClusterRole 和 RoleBinding 都会用标签 kubernetes.io&#x2F;bootstrapping&#x3D;rbac-defaults 进行标记。 </p>
<p>常见的系统角色如下：</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526174338.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>有些默认角色不是以 system:为前缀的，这部分角色是针对用户的，其中包含超级用户角 色 cluster-admin，有的用于集群一级的角色 cluster-status，还有针对 namespace 的角 色 admin、edit、view</p>
<h6 id="常见的用户角色如下："><a href="#常见的用户角色如下：" class="headerlink" title="常见的用户角色如下："></a>常见的用户角色如下：</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526174711.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="核心-Master-组件角色"><a href="#核心-Master-组件角色" class="headerlink" title="核心 Master 组件角色"></a>核心 Master 组件角色</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526174810.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="授权注意事项：预防提权和授权初始化"><a href="#授权注意事项：预防提权和授权初始化" class="headerlink" title="授权注意事项：预防提权和授权初始化"></a>授权注意事项：预防提权和授权初始化</h4><p>RBAC API 拒绝用户利用编辑角色或者角色绑定的方式进行提权。这一限制是在 API 层 面做出的，因此即使 RBAC 没有启用也仍然有效。 用户只能在拥有一个角色的所有权限，且与该角色的生效范围一致的前提下，才能对 角色进行创建和更新。例如用户 user-1 没有列出集群中所有 secret 的权限，就不能创建 具有这一权限的集群角色。要让一个用户能够创建或更新角色，需要以下权限： - 为其授予一个允许创建&#x2F;更新 Role 或 ClusterRole 资源对象的角色； 为用户授予角色，要覆盖该用户所能控制的所有权限范围。用户如果尝试创建超出 其自身权限的角色或者集群角色，则该 API 调用会被禁止。 如果一个用户的权限包含了一个角色的所有权限，那么就可以为其创建和更新角色绑 定；或者如果被授予了针对某个角色的绑定授权，则也有权完成此操作。 例如：user1 没有列出集群内所有 secret 的权限，就无法为一个具有这样权限的角色 创建集群角色绑定。要使用户能够创建、更新这一角色绑定，则需要有如下做法： - 为其授予一个允许创建和更新角色绑定或者集群角色绑定的角色 为其授予绑定某一角色的权限，有隐式或显式两种方法 - 隐式：让其具有所有该角色的权限 - 显式：让用户授予针对该角色或集群角色绑定操作的权限 让 user-1 有对 user-1-namespace 命名空间中的其他用户授予 admin、edit 及 view 角 色</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span> <br><span class="hljs-attr">metadata:</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">role-grantor</span> <br><span class="hljs-attr">rules:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;rbac.authorization.k8s.io&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;rolebindings&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;create&quot;</span>] <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;rbac.authorization.k8s.io&quot;</span>] <br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;clusterroles&quot;</span>] <br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;bind&quot;</span>] <br>  <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;edit&quot;</span>, <span class="hljs-string">&quot;view&quot;</span>] <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span> <br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">role-grantor-binding</span> <br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">user-1-namespace</span> <br><span class="hljs-attr">roleRef:</span> <br> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br> <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">role-grantor</span> <br><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">user-1</span><br></code></pre></td></tr></table></figure>
<p>在进行第一个角色和角色绑定时，必须让初始用户具备其尚未被授予的权限，要进行初始 的角色和角色绑定设置，有以下两种方法： - 使用属于 system:masters 组的身份，这一群组默认具有 cluster-admin 这一超级角 色的绑定。如果 API Server 以–insecure-port 参数运行，则客户端通过这个非安全端口进行 接口调用，这一端口没有认证鉴权的限制。</p>
<h1 id="19、kubernetes-部署性能监控平台"><a href="#19、kubernetes-部署性能监控平台" class="headerlink" title="19、kubernetes-部署性能监控平台"></a>19、kubernetes-部署性能监控平台</h1><h5 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h5><p>开源软件 cAdvisor（Container Advisor）用于监控所在节点的容器运行状态，当前已经 被默认集成到 kubelet 组件内，默认使用 tcp 4194 端口。在大规模容器集群，一般使用 Heapster+Influxdb+Grafana 平台实现集群性能数据的采集，存储与展示。 </p>
<h4 id="2、环境准备"><a href="#2、环境准备" class="headerlink" title="2、环境准备"></a>2、环境准备</h4><h6 id="2-1-基础环境"><a href="#2-1-基础环境" class="headerlink" title="2.1 基础环境"></a>2.1 基础环境</h6><p>Kubernetes + heapster + Influxdb + grafana </p>
<h6 id="2-2-原理"><a href="#2-2-原理" class="headerlink" title="2.2 原理"></a>2.2 原理</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526180003.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>Heapster：集群中各 node 节点的 cAdvisor 的数据采集汇聚系统，通过调用 node 上 kubelet 的 api，再通过 kubelet 调用 cAdvisor 的 api 来采集所在节点上所有容器的性能 数据。Heapster 对性能数据进行聚合，并将结果保存到后端存储系统，heapster 支持多种 后端存储系统，如 memory，Influxdb 等。 Influxdb：分布式时序数据库（每条记录有带有时间戳属性），主要用于实时数据采集， 时间跟踪记录，存储时间图表，原始数据等。Influxdb 提供 rest api 用于数据的存储与 查询。 Grafana：通过 dashboard 将 Influxdb 中的时序数据展现成图表或曲线等形式，便于查看 集群运行状态。 Heapster，Influxdb，Grafana 均以 Pod 的形式启动与运行。</p>
<h4 id="部署-Kubernetes-集群性能监控"><a href="#部署-Kubernetes-集群性能监控" class="headerlink" title="部署 Kubernetes 集群性能监控"></a>部署 Kubernetes 集群性能监控</h4><h6 id="准备-images"><a href="#准备-images" class="headerlink" title="准备 images"></a>准备 images</h6><p>kubernetes 部署服务时，为避免部署时发生 pull 镜像超时的问题，建议提前将相关镜像 pull 到相关所有节点（以下以 kubenode1 为例），或搭建本地镜像系统。 需要从 gcr.io pull 的镜像，已利用 Docker Hub 的”Create Auto-Build GitHub”功能 （Docker Hub 利用 GitHub 上的 Dockerfile 文件 build 镜像），在个人的 Docker Hub build 成功，可直接 pull 到本地使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull netonline/heapster-amd64:v1.5.1<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull netonline/heapster-influxdb-amd64:v1.3.3<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull netonline/heapster-grafana-amd64:v4.4.3<br></code></pre></td></tr></table></figure>

<h6 id="下载-yaml-范本"><a href="#下载-yaml-范本" class="headerlink" title="下载 yaml 范本"></a>下载 yaml 范本</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">release 下载页：https://github.com/kubernetes/heapster/releases <span class="hljs-comment"># release 中的 yaml 范本有时较</span></span> <br>https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/influxdb 的 yaml 新，但区别不大<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/src/<br>wget -O heapster-v1.5.1.tar.gz https://github.com/kubernetes/heapster/archive/v1.5.1.tar.gz<br><span class="hljs-meta prompt_"># </span><span class="language-bash">yaml 范本在 heapster/deploy/kube-config/influxdb 目录，另有 1 个 heapster- rbac.yaml 在 heapster/deploy/kube-config/rbac 目录，两者目录结构同 github</span><br>tar -zxvf heapster-v1.5.1.tar.gz -C /usr/local/<br>mv /usr/local/heapster-1.5.1 /usr/local/heapster<br></code></pre></td></tr></table></figure>

<h6 id="heapster-rbac-yaml"><a href="#heapster-rbac-yaml" class="headerlink" title="heapster-rbac.yaml"></a>heapster-rbac.yaml</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">heapster 需要向 kubernetes-master 请求 node 列表，需要设置相应权限；</span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash">默认不需要对 heapster-rbac.yaml 修改，将 kubernetes 集群自带的 ClusterRole ： system:heapster 做 ClusterRoleBinding，完成授权</span> <br>cd /usr/local/heapster/deploy/kube-config/rbac/ <br>cat heapster-rbac.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span> <br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span> <br><span class="hljs-attr">metadata:</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">heapster</span> <br><span class="hljs-attr">roleRef:</span> <br> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span> <br> <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span> <br> <span class="hljs-attr">name:</span> <span class="hljs-string">system:heapster</span> <br><span class="hljs-attr">subjects:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">heapster</span> <br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br></code></pre></td></tr></table></figure>

<h4 id="heapster-yaml"><a href="#heapster-yaml" class="headerlink" title="heapster.yaml"></a>heapster.yaml</h4><p>hepster.yaml 由 3 个模块组成：ServiceAccout，Deployment，Service。</p>
<p>1）ServiceAccount</p>
<p>默认不需要修改 ServiceAccount 部分，设置 ServiceAccount 资源，获取 rbac 中定义的权 限。</p>
<p>2）Deployment</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改处：第 23 行，变更镜像名；</span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash">--<span class="hljs-built_in">source</span>：配置采集源，使用安全端口调用 kubernetes 集群 api；</span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash">--sink：配置后端存储为 influxdb；地址采用 influxdb 的 service 名，需要集群 dns 正常工作，如果没有配置 dns 服务，可使用 service 的 ClusterIP 地址</span> <br>cd /usr/local/heapster/deploy/kube-config/influxdb/ <br>sed -i &#x27;s|gcr.io/google_containers/heapster- amd64:v1.5.1|netonline/heapster-amd64:v1.5.1|g&#x27; heapster.yaml <br>cat heapster.yaml <br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182241.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182311.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>3）Service</p>
<p>默认不需要修改 Service 部分。</p>
<h4 id="influxdb-yaml"><a href="#influxdb-yaml" class="headerlink" title="influxdb.yaml"></a>influxdb.yaml</h4><p>influxdb.yaml 由 2 个模块组成：Deployment，Service。 </p>
<p>1）Deployment</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改处：第 16 行，变更镜像名；</span> <br>sed -i &#x27;s|gcr.io/google_containers/heapster- influxdb-amd64:v1.3.3|netonline/heapster-influxdb-amd64:v1.3.3|g&#x27; influxdb.yaml<br></code></pre></td></tr></table></figure>

<p>2）Service</p>
<p>默认不需要修改 Service 部分，注意 Service 名字的对应即可。</p>
<h4 id="grafana-yaml"><a href="#grafana-yaml" class="headerlink" title="grafana.yaml"></a>grafana.yaml</h4><p>grafana.yaml 由 2 个模块组成：Deployment，Service。 </p>
<p>1）Deployment</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182558.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210526182621.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>2）Service </p>
<p>默认不需要修改 Service 部分，注意 Service 名字的对应即可。</p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>启动监控相关服务</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 将 heapster-rbac.yaml 复制到 influxdb/目录；</span><br><span class="hljs-string">cd</span> <span class="hljs-string">/usr/local/heapster/deploy/kube-config/influxdb/</span> <br><span class="hljs-string">cp</span> <span class="hljs-string">/usr/local/heapster/deploy/kube-</span> <span class="hljs-string">config/rbac/heapster-rbac.yaml</span> <span class="hljs-string">.</span> <br><span class="hljs-string">kubectl</span> <span class="hljs-string">create</span> <span class="hljs-string">-f</span> <span class="hljs-string">.</span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094054.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="查看相关服务"><a href="#查看相关服务" class="headerlink" title="查看相关服务"></a>查看相关服务</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 查看 deployment 与 Pod 运行状态 </span><br><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">deploy</span> <span class="hljs-string">-n</span> <span class="hljs-string">kube-system</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-E</span> <span class="hljs-string">&#x27;heapster|monitoring&#x27;</span> <br><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">pods</span> <span class="hljs-string">-n</span> <span class="hljs-string">kube-system</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-E</span> <span class="hljs-string">&#x27;heapster|monitoring&#x27;</span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094201.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 查看 service 运行状态 </span><br><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">svc</span> <span class="hljs-string">-n</span> <span class="hljs-string">kube-system</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-E</span> <span class="hljs-string">&#x27;heapster|monitoring&#x27;</span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094256.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="访问-dashboard"><a href="#访问-dashboard" class="headerlink" title="访问 dashboard"></a>访问 dashboard</h4><p>浏览器访问访问 dashboard：<a target="_blank" rel="noopener" href="https://172.30.200.10:6443/api/v1/namespaces/kube-">https://172.30.200.10:6443/api/v1/namespaces/kube-</a> system&#x2F;services&#x2F;https:kubernetes-dashboard:&#x2F;proxy 注意：Dasheboard 没有配置 hepster 监控平台时，不能展示 node，Pod 资源的 CPU 与内存 等 metric 图形 Node 资源 CPU&#x2F;内存 metric 图形：</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094621.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h4 id="访问-grafana"><a href="#访问-grafana" class="headerlink" title="访问 grafana"></a>访问 grafana</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">kubectl</span> cluster-<span class="hljs-literal">info</span><br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094721.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p>浏览器访问访问 dashboard：<a target="_blank" rel="noopener" href="https://172.30.200.10:6443/api/v1/namespaces/kube-">https://172.30.200.10:6443/api/v1/namespaces/kube-</a> system&#x2F;services&#x2F;monitoring-grafana&#x2F;proxy 集群节点信息：</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094749.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527094814.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h1 id="20、kubernetes-核心技术-Helm"><a href="#20、kubernetes-核心技术-Helm" class="headerlink" title="20、kubernetes 核心技术-Helm"></a>20、kubernetes 核心技术-Helm</h1><h4 id="Helm-引入"><a href="#Helm-引入" class="headerlink" title="Helm 引入"></a>Helm 引入</h4><p>K8S 上的应用对象，都是由特定的资源描述组成，包括 deployment、service 等。都保存 各自文件中或者集中写到一个配置文件。然后 kubectl apply –f 部署。如果应用只由一 个或几个这样的服务组成，上面部署方式足够了。而对于一个复杂的应用，会有很多类似 上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达十个，几十个。如 果有更新或回滚应用的需求，可能要修改和维护所涉及的大量资源文件，而这种组织和管 理应用的方式就显得力不从心了。且由于缺少对发布过的应用版本管理和控制，使 Kubernetes 上的应用维护和更新等面临诸多的挑战，主要面临以下问题：（1）如何将这 些服务作为一个整体管理 （2）这些资源文件如何高效复用 （3）不支持应用级别的版本 管理</p>
<h4 id="Helm-介绍"><a href="#Helm-介绍" class="headerlink" title="Helm 介绍"></a>Helm 介绍</h4><p>很方便的将之前打包好的 yaml 文件部署到 kubernetes 上。 Helm 有 3 个重要概念： </p>
<ul>
<li>（1）helm：一个命令行客户端工具，主要用于 Kubernetes 应用 chart 的创建、打包、发 布和管理。 </li>
<li>（2）Chart：应用描述，一系列用于描述 k8s 资源相关文件的集合。 </li>
<li>（3）Release：基于 Chart 的部署实体，一个 chart 被 Helm 运行后将会生成对应的一个 release；将在 k8s 中创建出真实运行的资源对象。</li>
</ul>
<h4 id="Helm-v3-变化"><a href="#Helm-v3-变化" class="headerlink" title="Helm v3 变化"></a>Helm v3 变化</h4><p>2019 年 11 月 13 日， Helm 团队发布 Helm v3 的第一个稳定版本。 该版本主要变化如下： 架构变化： </p>
<ul>
<li>1、最明显的变化是 Tiller 的删除</li>
<li>2、Release 名称可以在不同命名空间重用</li>
<li>3、支持将 Chart 推送至 Docker 镜像仓库中 </li>
<li>4、使用 JSONSchema 验证 chart values </li>
<li>5、其他</li>
</ul>
<h4 id="Helm-客户端"><a href="#Helm-客户端" class="headerlink" title="Helm 客户端"></a>Helm 客户端</h4><h6 id="部署-helm-客户端"><a href="#部署-helm-客户端" class="headerlink" title="部署 helm 客户端"></a>部署 helm 客户端</h6><p>Helm 客户端下载地址：<a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a> </p>
<p>解压移动到&#x2F;usr&#x2F;bin&#x2F;目录即可。 </p>
<p>wget <a target="_blank" rel="noopener" href="https://get.helm.sh/helm-vv3.2.1-linux-amd64.tar.gz">https://get.helm.sh/helm-vv3.2.1-linux-amd64.tar.gz</a> </p>
<p>tar zxvf helm-v3.2.1-linux-amd64.tar.gz </p>
<p>mv linux-amd64&#x2F;helm &#x2F;usr&#x2F;bin&#x2F;</p>
<h6 id="helm-常用命令"><a href="#helm-常用命令" class="headerlink" title="helm 常用命令"></a>helm 常用命令</h6><table>
<thead>
<tr>
<th>命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td>dependency</td>
<td align="center">管理 chart 依赖</td>
</tr>
<tr>
<td>get</td>
<td align="center">下载一个 release。可用子命令：all、hooks、manifest、notes、values</td>
</tr>
<tr>
<td>history</td>
<td align="center">获取 release 历史</td>
</tr>
<tr>
<td>install</td>
<td align="center">安装一个 chart</td>
</tr>
<tr>
<td>list</td>
<td align="center">列出 release</td>
</tr>
<tr>
<td>package</td>
<td align="center">将 chart 目录打包到 chart 存档文件中</td>
</tr>
<tr>
<td>pull</td>
<td align="center">从远程仓库中下载 chart 并解压到本地 # helm pull stable&#x2F;mysql – untar</td>
</tr>
<tr>
<td>repo</td>
<td align="center">添加，列出，移除，更新和索引 chart 仓库。可用子命令：add、index、 list、remove、update</td>
</tr>
<tr>
<td>rollback</td>
<td align="center">从之前版本回滚</td>
</tr>
<tr>
<td>search</td>
<td align="center">根据关键字搜索 chart。可用子命令：hub、repo</td>
</tr>
<tr>
<td>show</td>
<td align="center">查看 chart 详细信息。可用子命令：all、chart、readme、values</td>
</tr>
<tr>
<td>status</td>
<td align="center">显示已命名版本的状态</td>
</tr>
<tr>
<td>template</td>
<td align="center">本地呈现模板</td>
</tr>
<tr>
<td>uninstall</td>
<td align="center">卸载一个 release</td>
</tr>
<tr>
<td>upgrade</td>
<td align="center">更新一个 release</td>
</tr>
<tr>
<td>version</td>
<td align="center">查看 helm 客户端版本</td>
</tr>
</tbody></table>
<h4 id="配置国内-chart-仓库"><a href="#配置国内-chart-仓库" class="headerlink" title="配置国内 chart 仓库"></a>配置国内 chart 仓库</h4><ul>
<li>微软仓库（<a target="_blank" rel="noopener" href="http://mirror.azure.cn/kubernetes/charts/%EF%BC%89%E8%BF%99%E4%B8%AA%E4%BB%93%E5%BA%93%E6%8E%A8%E8%8D%90%EF%BC%8C%E5%9F%BA%E6%9C%AC">http://mirror.azure.cn/kubernetes/charts/）这个仓库推荐，基本</a> 上官网有的 chart 这里都有。 </li>
<li>阿里云仓库（<a target="_blank" rel="noopener" href="https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts">https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</a> ）</li>
<li>官方仓库（<a target="_blank" rel="noopener" href="https://hub.kubeapps.com/charts/incubator%EF%BC%89%E5%AE%98%E6%96%B9">https://hub.kubeapps.com/charts/incubator）官方</a> chart 仓库，国 内有点不好使。</li>
</ul>
<h6 id="添加存储库"><a href="#添加存储库" class="headerlink" title="添加存储库"></a>添加存储库</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm repo add stable http://mirror.azure.cn/kubernetes/charts <br>helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts <br>helm repo update<br></code></pre></td></tr></table></figure>

<h6 id="查看配置的存储库"><a href="#查看配置的存储库" class="headerlink" title="查看配置的存储库"></a>查看配置的存储库</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm repo list <br>helm search repo stable<br></code></pre></td></tr></table></figure>
<h6 id="删除存储库："><a href="#删除存储库：" class="headerlink" title="删除存储库："></a>删除存储库：</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm repo remove aliyun<br></code></pre></td></tr></table></figure>

<h4 id="helm-基本使用"><a href="#helm-基本使用" class="headerlink" title="helm 基本使用"></a>helm 基本使用</h4><p>主要介绍三个命令： </p>
<ul>
<li>chart install</li>
<li>hart upgrade </li>
<li>chart rollback</li>
</ul>
<h4 id="使用-chart-部署一个应用"><a href="#使用-chart-部署一个应用" class="headerlink" title="使用 chart 部署一个应用"></a>使用 chart 部署一个应用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查找 chart</span> <br>helm search repo weave <br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看 chrt 信息</span> <br>helm show chart stable/mysql <br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装包</span> <br>helm install ui stable/weave-scope <br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看发布状态</span> <br>helm list  <br>helm status ui<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改 service Type: NodePort 即可访问 ui</span><br></code></pre></td></tr></table></figure>
<h4 id="安装前自定义-chart-配置选项"><a href="#安装前自定义-chart-配置选项" class="headerlink" title="安装前自定义 chart 配置选项"></a>安装前自定义 chart 配置选项</h4><p>自定义选项是因为并不是所有的 chart 都能按照默认配置运行成功，可能会需要一些环境 依赖，例如 PV。 所以我们需要自定义 chart 配置选项，安装过程中有两种方法可以传递配置数据： </p>
<ul>
<li>–values（或-f）：指定带有覆盖的 YAML 文件。这可以多次指定，最右边的文件 优先</li>
<li>–set：在命令行上指定替代。如果两者都用，–set 优先级高</li>
</ul>
<h6 id="–values-使用，先将修改的变量写到一个文件中"><a href="#–values-使用，先将修改的变量写到一个文件中" class="headerlink" title="–values 使用，先将修改的变量写到一个文件中"></a>–values 使用，先将修改的变量写到一个文件中</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm show values stable/mysql<br>cat config.yaml<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527100651.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm install db -f config.yaml stable/mysql<br>kubectl get pods<br>kubectl run -it db-client --rm --restart=Never --image=mysql:5.7 -- bash<br>mysql -hdb-mysql -uk8s -p123456<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527100813.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527102817.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="命令行替代变量："><a href="#命令行替代变量：" class="headerlink" title="命令行替代变量："></a>命令行替代变量：</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm install db --set persistence.storageClass=&quot;managed-nfs-storage&quot; stable/mysql<br></code></pre></td></tr></table></figure>
<p>也可以把 chart 包下载下来查看详情：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm pull stable/mysql --untar<br></code></pre></td></tr></table></figure>

<p>values yaml 与 set 使用：</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527102945.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="该-helm-install-命令可以从多个来源安装："><a href="#该-helm-install-命令可以从多个来源安装：" class="headerlink" title="该 helm install 命令可以从多个来源安装："></a>该 helm install 命令可以从多个来源安装：</h6><ul>
<li>chart 存储库 </li>
<li>本地 chart 存档（helm install foo-0.1.1.tgz） </li>
<li>chart 目录（helm install path&#x2F;to&#x2F;foo） </li>
<li>完整的 URL（helm install <a href="https://example.com/charts/foo-1.2.3.tgz%EF%BC%89">https://example.com/charts/foo-1.2.3.tgz）</a></li>
</ul>
<h6 id="构建一个-Helm-Chart"><a href="#构建一个-Helm-Chart" class="headerlink" title="构建一个 Helm Chart"></a>构建一个 Helm Chart</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm create mychart<br>tree mychart/<br></code></pre></td></tr></table></figure>
<ul>
<li>Chart.yaml：用于描述这个 Chart 的基本信息，包括名字、描述信息以及版本等。</li>
<li>values.yaml ：用于存储 templates 目录中模板文件中用到变量的值。 </li>
<li>Templates： 目录里面存放所有 yaml 模板文件。 </li>
<li>charts：目录里存放这个 chart 依赖的所有子 chart。 </li>
<li>NOTES.txt ：用于介绍 Chart 帮助信息， helm install 部署后展示给用户。例如： 如何使用这个 Chart、列出缺省的设置等。 </li>
<li>_helpers.tpl：放置模板助手的地方，可以在整个 chart 中重复使用</li>
</ul>
<h6 id="创建-Chart-后，接下来就是将其部署："><a href="#创建-Chart-后，接下来就是将其部署：" class="headerlink" title="创建 Chart 后，接下来就是将其部署："></a>创建 Chart 后，接下来就是将其部署：</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm install web mychart/<br></code></pre></td></tr></table></figure>
<p>也可以打包推送的 charts 仓库共享别人使用。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">helm <span class="hljs-keyword">package</span> <span class="hljs-title">mychart/</span><br></code></pre></td></tr></table></figure>

<h6 id="chart-模板"><a href="#chart-模板" class="headerlink" title="chart 模板"></a>chart 模板</h6><p>Helm 最核心的就是模板，即模板化的 K8S manifests 文件。 它本质上就是一个 Go 的 template 模板。Helm 在 Go template 模板的基础上，还会增加很 多东西。如一些自定义的元数据信息、扩展的库以及一些类似于编程形式的工作流，例如 条件语句、管道等等。这些东西都会使得我们的模板变得更加丰富。 有了模板，我们怎么把我们的配置融入进去呢？用的就是这个 values 文件。这两部分内容 其实就是 chart 的核心功能。 接下来，部署 nginx 应用，熟悉模板使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm create nginx<br>vim nginx/Chart.yaml<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527103530.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">vim</span> nginx/<span class="hljs-built_in">values</span>.yaml<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527103556.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim nginx<span class="hljs-regexp">/templates/</span>NOTES.txt<br>vim nginx<span class="hljs-regexp">/templates/</span>deployment.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span> <br> <span class="hljs-attr">labels:</span> <br>  <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Values.label</span> &#125;&#125; <br> <span class="hljs-attr">name:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125; <br><span class="hljs-attr">spec:</span> <br> <span class="hljs-attr">replicas:</span> &#123;&#123; <span class="hljs-string">.Values.replicas</span> &#125;&#125; <br> <span class="hljs-attr">selector:</span> <br>  <span class="hljs-attr">matchLabels:</span> <br>   <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Values.label</span> &#125;&#125; <br> <span class="hljs-attr">template:</span> <br>  <span class="hljs-attr">metadata:</span> <br>   <span class="hljs-attr">labels:</span> <br>    <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Values.label</span> &#125;&#125; <br>  <span class="hljs-attr">spec:</span> <br>   <span class="hljs-attr">containers:</span> <br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> &#123;&#123; <span class="hljs-string">.Values.image</span> &#125;&#125;<span class="hljs-string">:&#123;&#123;</span> <span class="hljs-string">.Values.tag</span> <span class="hljs-string">&#125;&#125;</span> <br>     <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim nginx<span class="hljs-regexp">/templates/</span>service.yaml<br></code></pre></td></tr></table></figure>

<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527103835.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看实际的模板被渲染过后的资源文件</span> <br>helm get manifest web <br>helm install web nginx/ <br>helm list <br>kubectl get pod<br></code></pre></td></tr></table></figure>

<p>这个 deployment 就是一个 Go template 的模板，这里定义的 Release 模板对象属于 Helm 内置的一种对象，是从 values 文件中读取出来的。这样一来，我们可以将需要变化的地方 都定义变量</p>
<h6 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h6><p>Helm 也提供了–dry-run –debug 调试参数，帮助你验证模板正确性。在执行 helm install 时候带上这两个参数就可以把对应的 values 值和渲染的资源清单打印出来，而不 会真正的去部署一个 release。 比如我们来调试上面创建的 chart 包：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">helm install web --dry-<span class="hljs-built_in">run</span> nginx/<br></code></pre></td></tr></table></figure>

<h6 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a>内置对象</h6><p>刚刚我们使用 将 release 的名称插入到模板中。这里的 Release 就 是 Helm 的内置对象，下面是一些常用的内置对象：</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527105149.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="Values"><a href="#Values" class="headerlink" title="Values"></a>Values</h6><p>Values 对象是为 Chart 模板提供值，这个对象的值有 4 个来源： </p>
<ul>
<li>chart 包中的 values.yaml 文件 </li>
<li>父 chart 包的 values.yaml 文件 </li>
<li>通过 helm install 或者 helm upgrade 的 -f 或者 –values 参数传入的自定 义的 yaml 文件 </li>
<li>通过 –set 参数传入的值 chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，而该文件同样可以 被 –set 提供的参数所覆盖。</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">helm<span class="hljs-built_in"> upgrade </span>web --<span class="hljs-built_in">set</span> <span class="hljs-attribute">replicas</span>=5 nginx/<br>helm history web<br>kubectl <span class="hljs-built_in">get</span> pod<br></code></pre></td></tr></table></figure>

<h6 id="升级、回滚和删除"><a href="#升级、回滚和删除" class="headerlink" title="升级、回滚和删除"></a>升级、回滚和删除</h6><p>发布新版本的 chart 时，或者当您要更改发布的配置时，可以使用该 helm upgrade 命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm upgrade --set imageTag=1.17 web nginx<br>helm upgrade -f values.yaml web nginx<br></code></pre></td></tr></table></figure>

<p>如果在发布后没有达到预期的效果，则可以使用 helm rollback 回滚到之前的版本。 例如将应用回滚到第一个版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm rollback web 1<br></code></pre></td></tr></table></figure>

<p>卸载发行版，请使用以下 helm uninstall 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm uninstall web<br></code></pre></td></tr></table></figure>

<p>查看历史版本配置信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm get all --revision 1 web<br></code></pre></td></tr></table></figure>

<h6 id="管道与函数"><a href="#管道与函数" class="headerlink" title="管道与函数"></a>管道与函数</h6><p>前面讲的模块，其实就是将值传给模板引擎进行渲染，模板引擎还支持对拿到数据进行二 次处理。<br>例如从.Values 中读取的值变成字符串，可以使用 quote 函数实现：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">vi templates/deployment.yaml<br>helm install --dry-run web ../mychart/<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527105638.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"><br>另外还会经常使用一个 default 函数，该函数允许在模板中指定默认值，以防止该值被忽 略掉。 例如忘记定义，执行 helm install 会因为缺少字段无法创建资源，这时就可以定义一个 默认值</p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527105821.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h6><p>流程控制是为模板提供了一种能力，满足更复杂的数据逻辑处理。 Helm 模板语言提供以下流程控制语句： </p>
<ul>
<li>if&#x2F;else 条件块 </li>
<li>with 指定范围 </li>
<li>range 循环块</li>
</ul>
<h6 id="if"><a href="#if" class="headerlink" title="if"></a>if</h6><p>if&#x2F;else 块是用于在模板中有条件地包含文本块的方法，条件块的基本结构如下：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name"><span class="hljs-built_in">if</span></span> PIPELINE &#125;&#125;</span><span class="language-xml"> </span><br><span class="language-xml"># Do something </span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">elseif</span> OTHER PIPELINE &#125;&#125;</span><span class="language-xml"> </span><br><span class="language-xml"># Do something </span><br><span class="language-xml">else </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">else</span> &#125;&#125;</span><span class="language-xml"> </span><br><span class="language-xml"># Default case </span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">end</span> &#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> templates/deployment.yaml<br></code></pre></td></tr></table></figure>

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">...</span><br><span class="language-xml">template: </span><br><span class="language-xml"> metadata: </span><br><span class="language-xml">  labels:</span><br><span class="language-xml">  app: nginx </span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name"><span class="hljs-built_in">if</span></span> eq .Values.devops <span class="hljs-string">&quot;k8s&quot;</span> &#125;&#125;</span><span class="language-xml"> </span><br><span class="language-xml">devops: 123 </span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">else</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">devops: 456 </span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">end</span> &#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p>在上面条件语句使用了 eq 运算符判断是否相等，除此之外，还支持 ne、 lt、 gt、 and、 or 等运算符。<br>注意数据类型。 通过模板引擎来渲染一下，会得到如下结果：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">helm install --dry-run web ..<span class="hljs-regexp">/mychart/</span><br></code></pre></td></tr></table></figure>

<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110733.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110832.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110857.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="range"><a href="#range" class="headerlink" title="range"></a>range</h6><p>在 Helm 模板语言中，使用 range 关键字来进行循环操作。 我们在 values.yaml 文件中添加上一个变量列表：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> <span class="hljs-built_in">values</span>.yaml<br></code></pre></td></tr></table></figure>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527110948.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111017.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="with"><a href="#with" class="headerlink" title="with"></a>with</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111201.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111222.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111307.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111344.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111417.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111438.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
<h6 id="开发自己的-chart"><a href="#开发自己的-chart" class="headerlink" title="开发自己的 chart"></a>开发自己的 chart</h6><p>1、先创建模板 </p>
<p>2、修改 Chart.yaml，Values.yaml，添加常用的变量 </p>
<p>3、 在 templates 目录下创建部署镜像所需要的 yaml 文件，并变量引用 yaml 里经常变动 的字段</p>
<h1 id="21、kubernetes-高可用集群搭建"><a href="#21、kubernetes-高可用集群搭建" class="headerlink" title="21、kubernetes 高可用集群搭建"></a>21、kubernetes 高可用集群搭建</h1><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>Kubernetes 作为容器集群系统，通过健康检查+重启策略实现了 Pod 故障自我修复能力， 通过调度算法实现将 Pod 分布式部署，监控其预期副本数，并根据 Node 失效状态自动在正 常 Node 启动 Pod，实现了应用层的高可用性。 </p>
<p>针对 Kubernetes 集群，高可用性还应包含以下两个层面的考虑：Etcd 数据库的高可用性 和 Kubernetes Master 组件的高可用性。 而 Etcd 我们已经采用 3 个节点组建集群实现高 可用，本节将对 Master 节点高可用进行说明和实施。 </p>
<p>Master 节点扮演着总控中心的角色，通过不断与工作节点上的 Kubelet 和 kube-proxy 进 行通信来维护整个集群的健康工作状态。如果 Master 节点故障，将无法使用 kubectl 工具 或者 API 任何集群管理。 </p>
<p>Master 节点主要有三个服务 kube-apiserver、kube-controller-mansger 和 kube- scheduler，其中 kube-controller-mansger 和 kube-scheduler 组件自身通过选择机制已 经实现了高可用，所以 Master 高可用主要针对 kube-apiserver 组件，而该组件是以 HTTP API 提供服务，因此对他高可用与 Web 服务器类似，增加负载均衡器对其负载均衡即可， 并且可水平扩容。</p>
<h6 id="多-Master-架构图："><a href="#多-Master-架构图：" class="headerlink" title="多 Master 架构图："></a>多 Master 架构图：</h6><p><img src="/../java%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E8%AE%AD%E7%BB%83/images/QQ%E6%88%AA%E5%9B%BE20210527111804.png%22QQ%E6%88%AA%E5%9B%BE20201229183512.png%22" srcset="/img/loading.gif" lazyload alt="输入图片说明"></p>
</p><h2>部署方式</h2><blockquote><p><font size="3">（1）minikube<br>minikube可以在本地运行Kubernetes的工具，minikube可以在个人计算机（包括Windows，macOS和Linux PC）上运行一个单节点Kubernetes集群，以便您可以试用Kubernetes或进行日常开发工作；<br>http://kubernetes.io/docs/tutorials/hello-minikube/<br>（2）kind<br>Kind和minikube类似的工具，让你在本地计算机上运行Kubernetes，此工具需要安装并配置Docker；<br>http://kind.sigs.k8s.io/<br>（3）kubeadm<br>Kubeadm是一个K8s部署工具，提供kubeadm init 和 kubeadm join两个操作命令，可以快速部署一个Kubernetes集群；<br>官方地址：<br>http://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/<br>http://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/<br>（4）二进制包<br>从Github下载发行版的二进制包，手动部署安装每个组件，组成Kubernetes集群，步骤比较繁琐，但是能让你对各个组件有更清晰的认识；<br>（5）yum安装<br>通过yum安装Kubernetes的每个组件，组成Kubernetes集群，不过yum源里面的k8s版本已经比较老了，所以这种方式用得也比较少了；<br>（6）第三方工具<br>有一些大神封装了一些工具，利用这些工具进行k8s环境的安装；<br>（7）花钱购买<br>直接购买类似阿里云这样的公有云平台k8s，一键搞定；</font></p></blockquote><h1>一、K8S集群搭建（v1.20.1&nbsp; kubeadm部署方式）</h1><p><font size="3">Kubernetes（简称K8S）是开源的容器集群管理系统，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。它既是一款容器编排工具，也是全新的基于容器技术的分布式架构领先方案。在Docker技术的基础上，为容器化的应用提供部署运行、资源调度、服务发现和动态伸缩等功能，提高了大规模容器集群管理的便捷性。</font><br><br></p><h2>1.安装要求</h2><p><font size="3">一台或多台机器，操作系统 CentOS7.x-86_x64<br>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多<br>集群中所有机器之间网络互通<br>可以访问外网，需要拉取镜像<br>禁止swap分区</font></p><p><br></p><p><font size="3">配置环境需要组件我整理了</font></p><p><font size="3">链接：http://pan.baidu.com/s/124SrYHRqK6AevApON-OO4w<br>提取码：ivdl<br>复制这段内容后打开百度网盘手机App，操作更方便哦</font></p><h2>2.环境</h2>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">master1</span> <span class="hljs-number">192.168.18.128</span><br>master2 <span class="hljs-number">192.168.18.129</span><br>node1 <span class="hljs-number">192.168.18.130</span><br>node2 <span class="hljs-number">192.168.18.131</span><br>k8s-vip <span class="hljs-number">192.168.18.132</span> <span class="hljs-comment">#虚拟ip</span><br></code></pre></td></tr></table></figure>
<p></code></pre><p><br></p><h2>3.修改主机名</h2><p><br><font size="3">master1:&amp;nbsp;&amp;nbsp;192.168.18.128</font><br><br></p><pre><code class="hljs">hostnamectl set-hostname master1</code></pre><p><br></p><p><font size="3">master2:&amp;nbsp;&amp;nbsp;192.168.18.129</font><br><br></p><pre><code class="hljs">hostnamectl set-hostname master2</code></pre><p><br></p><p><font size="3">node1:&amp;nbsp;&amp;nbsp;192.168.18.130</font><br><br></p><pre><code class="hljs">hostnamectl set-hostname node1</code></pre><p><br></p><p><font size="3">node2:&amp;nbsp;&amp;nbsp;192.168.18.131</font><br><br></p><pre><code class="hljs">hostnamectl set-hostname node2</code></pre><p><br></p><p><font color="#f9963b" size="5">设置完重启服务器</font></p><p><font size="4" color="#f9963b"><br></font></p><p><b><font color="#f9963b" size="4">以下都是四台服务器同时操作请按图片操作打开键盘模式</font></b></p><p><img src="http://qiniu-picture.xiyankt.com/Fox1JcLu3VQBEG28wzVNlT-kvIDX" srcset="/img/loading.gif" lazyload><b><br></b></p><h2>4.防火墙关闭</h2><pre><code class="hljs">systemctl stop firewalld<br>systemctl disable firewalld</code></pre><p><br></p><h2>5.关闭selinux</h2><pre><code class="hljs">sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config # 永久关闭<br></code><code>setenforce 0 # 临时关闭<br></code></pre><p><br></p><h2>6.关闭swap</h2><pre><code class="hljs">swapoff -a # 临时关闭；关闭swap主要是为了性能考虑<br>sed -ri 's/.<em>swap.</em>/#&amp;/' /etc/fstab</code></pre><p>free # 可以通过这个命令查看swap是否关闭了&amp;nbsp;<br></p><p><img src="http://qiniu-picture.xiyankt.com/FpawE4ilhcLt6GRGek7-K9qab9sH" srcset="/img/loading.gif" lazyload><br></p><h2>7.添加主机名与IP对应的关系</h2><p><br></p><pre type="Bash"><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br><span class="hljs-number">192.168.18.132</span>    master.k8s.io    k8s-vip<br><span class="hljs-number">192.168.18.128</span>    master01.k8s.io  master<span class="hljs-number">1</span><br><span class="hljs-number">192.168.18.129</span>    master02.k8s.io  master<span class="hljs-number">2</span><br><span class="hljs-number">192.168.18.130</span>    node01.k8s.io    node<span class="hljs-number">1</span><br><span class="hljs-number">192.168.18.131</span>    node02.k8s.io    node<span class="hljs-number">2</span><br>EOF</code></pre><p><br></p><p><b><font size="4" color="#f9963b">时间同步</font></b></p><pre><code class="hljs">yum install ntpdate -y</code><code><br>ntpdate time.windows.com</code></pre><p><br></p><h2>8.将桥接的IPv4流量传递到iptables的链</h2><pre><code class="hljs">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>EOF</code></pre><p><br></p><pre><code class="hljs">sysctl --system</code></pre><p><br></p><h2>9. 所有master节点部署keepalived</h2><h3>9.1 安装相关包和keepalived</h3><pre type="Bash"><code>yum <span class="hljs-keyword">install</span> -y conntrack-tools libseccomp libtool-ltdl</p>
<p>yum <span class="hljs-keyword">install</span> -y keepalived</code></pre><p><br></p><h3>9.2配置master节点</h3><p><b><font size="3" color="#f9963b">master1节点配置</font></b></p><pre type="Bash"><code><span class="hljs-attr">cat</span> <span class="hljs-string">&gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="hljs-comment">! Configuration File for keepalived</span></p>
<p><span class="hljs-attr">global_defs</span> <span class="hljs-string">&#123;</span><br>   <span class="hljs-attr">router_id</span> <span class="hljs-string">k8s</span><br><span class="hljs-attr">&#125;</span></p>
<p><span class="hljs-attr">vrrp_script</span> <span class="hljs-string">check_haproxy &#123;</span><br>    <span class="hljs-attr">script</span> <span class="hljs-string">"killall -0 haproxy"</span><br>    <span class="hljs-attr">interval</span> <span class="hljs-string">3</span><br>    <span class="hljs-attr">weight</span> <span class="hljs-string">-2</span><br>    <span class="hljs-attr">fall</span> <span class="hljs-string">10</span><br>    <span class="hljs-attr">rise</span> <span class="hljs-string">2</span><br><span class="hljs-attr">&#125;</span></p>
<p><span class="hljs-attr">vrrp_instance</span> <span class="hljs-string">VI_1 &#123;</span><br>    <span class="hljs-attr">state</span> <span class="hljs-string">MASTER </span><br>    <span class="hljs-attr">interface</span> <span class="hljs-string">ens33 </span><br>    <span class="hljs-attr">virtual_router_id</span> <span class="hljs-string">51</span><br>    <span class="hljs-attr">priority</span> <span class="hljs-string">250</span><br>    <span class="hljs-attr">advert_int</span> <span class="hljs-string">1</span><br>    <span class="hljs-attr">authentication</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">auth_type</span> <span class="hljs-string">PASS</span><br>        <span class="hljs-attr">auth_pass</span> <span class="hljs-string">ceb1b3ec013d66163d6ab</span><br>    <span class="hljs-attr">&#125;</span><br>    <span class="hljs-attr">virtual_ipaddress</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">192.168.18.132</span><br>    <span class="hljs-attr">&#125;</span><br>    <span class="hljs-attr">track_script</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">check_haproxy</span><br>    <span class="hljs-attr">&#125;</span></p>
<p><span class="hljs-attr">&#125;</span><br><span class="hljs-attr">EOF</span></code></pre><p><br></p><p><font size="3" color="#f9963b"><b>master2节点配置</b></font><b><font size="3"><br></font></b></p><p><br></p><pre type="Bash"><code><span class="hljs-attr">cat</span> <span class="hljs-string">&gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="hljs-comment">! Configuration File for keepalived</span></p>
<p><span class="hljs-attr">global_defs</span> <span class="hljs-string">&#123;</span><br>   <span class="hljs-attr">router_id</span> <span class="hljs-string">k8s</span><br><span class="hljs-attr">&#125;</span></p>
<p><span class="hljs-attr">vrrp_script</span> <span class="hljs-string">check_haproxy &#123;</span><br>    <span class="hljs-attr">script</span> <span class="hljs-string">"killall -0 haproxy"</span><br>    <span class="hljs-attr">interval</span> <span class="hljs-string">3</span><br>    <span class="hljs-attr">weight</span> <span class="hljs-string">-2</span><br>    <span class="hljs-attr">fall</span> <span class="hljs-string">10</span><br>    <span class="hljs-attr">rise</span> <span class="hljs-string">2</span><br><span class="hljs-attr">&#125;</span></p>
<p><span class="hljs-attr">vrrp_instance</span> <span class="hljs-string">VI_1 &#123;</span><br>    <span class="hljs-attr">state</span> <span class="hljs-string">BACKUP </span><br>    <span class="hljs-attr">interface</span> <span class="hljs-string">ens33 </span><br>    <span class="hljs-attr">virtual_router_id</span> <span class="hljs-string">51</span><br>    <span class="hljs-attr">priority</span> <span class="hljs-string">200</span><br>    <span class="hljs-attr">advert_int</span> <span class="hljs-string">1</span><br>    <span class="hljs-attr">authentication</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">auth_type</span> <span class="hljs-string">PASS</span><br>        <span class="hljs-attr">auth_pass</span> <span class="hljs-string">ceb1b3ec013d66163d6ab</span><br>    <span class="hljs-attr">&#125;</span><br>    <span class="hljs-attr">virtual_ipaddress</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">192.168.18.132</span><br>    <span class="hljs-attr">&#125;</span><br>    <span class="hljs-attr">track_script</span> <span class="hljs-string">&#123;</span><br>        <span class="hljs-attr">check_haproxy</span><br>    <span class="hljs-attr">&#125;</span></p>
<p><span class="hljs-attr">&#125;</span><br><span class="hljs-attr">EOF</span></code></pre><h3>9.3 启动和检查</h3><p><font size="3" color="#c24f4a">在两台master节点都执行</font><br></p><pre type="Bash"><code><span class="hljs-meta">#</span><span class="bash"> 启动keepalived</span><br><span class="bash">systemctl start keepalived.service</span></p>
<h4 id="设置开机启动"><a href="#设置开机启动" class="headerlink" title="设置开机启动"></a>设置开机启动</h4><p><span class="bash">systemctl <span class="hljs-built_in">enable</span> keepalived.service</span><br><span class="hljs-meta">#</span><span class="bash"> 查看启动状态</span><br><span class="bash">systemctl status keepalived.service</span></code></pre><p><font size="3">启动后查看master1的网卡信息</font><br></p><pre type="Bash"><code>ip a s e<span class="hljs-symbol">ns33</span></code></pre><p><br></p><p><img src="http://qiniu-picture.xiyankt.com/FrkK-c5PNFR5pNfJt_yVJAVR5Hmf" srcset="/img/loading.gif" lazyload style="max-width:100%;"><br></p><h2><br></h2><h2>10. 部署haproxy (二台master节点执行)</h2><h3>10.1 安装</h3><pre type="Bash"><code>yum <span class="hljs-keyword">install</span> -y haproxy</code></pre><p><br></p><h3>10.2 配置</h3><h2><p><font size="4"><font color="#f9963b">两台master节点的配置均相同</font>，配置中声明了后端代理的两个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口</font></p><p><font size="4"><br></font></p><pre type="Bash"><code><font size="3">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF<br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># Global settings</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br>global<br>    # <span class="hljs-keyword">to</span> have these messages end up <span class="hljs-keyword">in</span> /var/log/haproxy.log you will<br>    # need <span class="hljs-keyword">to</span>:<br>    # 1) configure syslog <span class="hljs-keyword">to</span> accept<span class="hljs-built_in"> network </span>log events.  This is done<br>    #    by adding the <span class="hljs-string">'-r'</span> option <span class="hljs-keyword">to</span> the SYSLOGD_OPTIONS <span class="hljs-keyword">in</span><br>    #    /etc/sysconfig/syslog<br>    # 2) configure local2 events <span class="hljs-keyword">to</span> go <span class="hljs-keyword">to</span> the /var/log/haproxy.log<br>    #   file. A line like the following can be added <span class="hljs-keyword">to</span><br>    #   /etc/sysconfig/syslog<br>    #<br>    #    local2.*                       /var/log/haproxy.log<br>    #<br>    log         127.0.0.1 local2</p>
<pre><code class="hljs">chroot      /var/lib/haproxy
pidfile     /var/run/haproxy.pid
maxconn     4000
</code></pre>
<p>   <span class="hljs-built_in"> user </span>       haproxy<br>   <span class="hljs-built_in"> group </span>      haproxy<br>    daemon </p>
<pre><code class="hljs"># turn on stats unix socket
stats socket /var/lib/haproxy/stats
</code></pre>
<p><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># common defaults that all the 'listen' and 'backend' sections will</span><br><span class="hljs-comment"># use if not designated in their block</span><br><span class="hljs-comment">#---------------------------------------------------------------------  </span><br>defaults<br>    mode                    http<br>    log                     global<br>    option                  httplog<br>    option                  dontlognull<br>    option http-server-close<br>    option forwardfor       except 127.0.0.0/8<br>    option                  redispatch<br>    retries                 3<br>    timeout http-request    10s<br>    timeout<span class="hljs-built_in"> queue </span>          1m<br>    timeout connect         10s<br>    timeout<span class="hljs-built_in"> client </span>         1m<br>    timeout<span class="hljs-built_in"> server </span>         1m<br>    timeout http-keep-alive 10s<br>    timeout check           10s<br>    maxconn                 3000<br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># kubernetes apiserver frontend which proxys to the backends</span><br><span class="hljs-comment">#--------------------------------------------------------------------- </span><br>frontend kubernetes-apiserver<br>    mode                 tcp<br>    bind                 *:16443<br>    option               tcplog<br>    default_backend      kubernetes-apiserver<br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># round robin balancing between the various backends</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br>backend kubernetes-apiserver<br>    mode        tcp<br>    balance     roundrobin<br>   <span class="hljs-built_in"> server </span>     master01.k8s.io   192.168.18.128:6443 check<br>   <span class="hljs-built_in"> server </span>     master02.k8s.io   192.168.18.129:6443 check<br><span class="hljs-comment">#---------------------------------------------------------------------</span><br><span class="hljs-comment"># collection haproxy statistics message</span><br><span class="hljs-comment">#---------------------------------------------------------------------</span><br>listen stats<br>    bind                 *:1080<br>    stats auth           admin:awesomePassword<br>    stats refresh        5s<br>    stats realm          HAProxy\ Statistics<br>    stats uri            /admin?stats<br>EOF</font></code></pre></h2><h3>10.3 启动和检查</h3><p><font size="3">两台master都启动(<font color="#c24f4a">使用键盘工具可以同时一起执行</font>)</font></p><p><font size="4" color="#f9963b">192.168.18.128 先启动</font></p><pre type="Bash"><code><span class="hljs-comment"># 开启haproxy</span><br>systemctl <span class="hljs-literal">start</span> haproxy</code></pre><p><br></p><p><font size="4" color="#f9963b">192.168.18.129 在启动</font></p><pre type="Bash"><code><span class="hljs-comment"># 开启haproxy</span><br>systemctl <span class="hljs-literal">start</span> haproxy</code></pre><p><br></p><p><font color="#f9963b" size="4">二台服务器启动后在继续后面的二条命令</font></p><pre type="Bash"><code># 设置开机启动<br>systemctl enable haproxy<br><span class="hljs-meta">#</span><span class="bash"> 查看启动状态</span><br><span class="bash">systemctl status haproxy</span></code></pre><p><img src="http://qiniu-picture.xiyankt.com/FqCY83Uuqu7PAPr250p0iXkw4t3W" srcset="/img/loading.gif" lazyload style="max-width:100%;" width="894" height="295.37"><br></p><p><br></p><h2 id="l663a"><font color="#f9963b">10.4如果启动出现如下情况卸载haproxy进行重新安装在重新启动</font></h2><p><img src="http://qiniu-picture.xiyankt.com/Fqg-cVYpc9t-eWeHz1eVFiFbY3zW" srcset="/img/loading.gif" lazyload style="max-width:100%;" width="935.16" height="295.6"><br></p><h2>11. <font color="#f9963b">所有节点</font>安装Docker&#x2F;kubeadm&#x2F;kubelet</h2><p><font size="3">Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</font></p><h3>11.1 安装Docker</h3><pre type="Bash"><code>wget <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a> -O/etc/yum.repos.d/docker-ce.repo<br></code><code><br></code><code>yum -y install docker-ce-19.03.9-3.el7<br></code><code><br>systemctl enable docker &amp;&amp; systemctl start docker</code><code><br>docker --<span class="hljs-keyword">version</span><br></code></pre><p><br></p><h3>11.2 添加阿里云YUM软件源</h3><pre type="Bash"><code>cat &gt; /etc/docker/daemon.json &lt;&lt; <span class="hljs-keyword">EOF</span><br>&#123;<br>  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"<a target="_blank" rel="noopener" href="http://goieqwi4.mirror.aliyuncs.com/">http://goieqwi4.mirror.aliyuncs.com</a>"</span>]<br>&#125;<br><span class="hljs-keyword">EOF</span></code></pre><p><br></p><pre type="Bash"><code>cat &gt; <span class="hljs-regexp">/etc/yum</span>.repos.d/kubernetes.repo &lt;&lt; EOF<br>[kubernetes]<br>name=Kubernetes<br>baseurl=<span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/mirrors.aliyun.com/kubernetes</span><span class="hljs-regexp">/yum/repos</span><span class="hljs-regexp">/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/kubernetes</span><span class="hljs-regexp">/yum/doc</span><span class="hljs-regexp">/yum-key.gpg http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/kubernetes</span><span class="hljs-regexp">/yum/doc</span><span class="hljs-regexp">/rpm-package-key.gpg<br>EOF</span></code></pre><p><br></p><pre type="Bash"><code><span class="hljs-comment">#重启docker</span><br><span class="hljs-attribute">systemctl</span> restart docker</code></pre><p><br></p><blockquote><h2 id="xg0wm">11.3 安装kubeadm，kubelet和kubectl（所有节点都安装）</h2><p><br></p><p><font size="3">kubelet # 运行在 Cluster 所有节点上，负责启动 Pod 和容器<br><br>kubeadm # 用于初始化 Cluster<br><br>kubectl # 是 Kubernetes 命令行工具。通过 kubectl 可以部署和管理应用，查看各种资源，创建、删除和更新各种组件<br></font></p><font size="3"><br>由于版本更新频繁，这里指定版本号部署：</font></blockquote><p><br></p><pre type="Bash"><code><span class="hljs-comment"># 这里安装最新的v1.20.1</span><br>yum install -y kubelet-1.20.1 kubeadm-1.20.1 kubectl-1.20.1<br><span class="hljs-comment"># 此时，还不能启动kubelet，因为此时配置还不能，现在仅仅可以设置开机自启动</span><br><span class="hljs-attr">systemctl</span> <span class="hljs-string">enable kubelet</span></code></pre><p><br></p><p><br></p><h2>12. 部署Kubernetes Master</h2><h3>12.1 创建kubeadm配置文件</h3><p><font size="4" style="color: rgb(249, 150, 59);">在具有vip的master上操作，</font><font size="5" style="" color="#7b5ba1">这里为master1</font></p><pre type="Bash"><code>mkdir <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/kubernetes/m</span>anifests -p</code></pre><p><br></p><pre type="Bash"><code>cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/kubernetes/m</span>anifests<span class="hljs-regexp">/</span></code></pre><p><br></p><pre type="Bash"><code>vi kubeadm-<span class="hljs-built_in">config</span>.yaml</code></pre><p><br></p><pre type="Bash"><code><span class="hljs-attr">apiServer:</span><br>  <span class="hljs-attr">certSANs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">master1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">master2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">master.k8s.io</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.18.132</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.</span>18.128<br>    <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.18.129</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>  <span class="hljs-attr">extraArgs:</span><br>    <span class="hljs-attr">authorization-mode:</span> <span class="hljs-string">Node,RBAC</span><br>  <span class="hljs-attr">timeoutForControlPlane:</span> <span class="hljs-string">4m0s</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta1</span><br><span class="hljs-attr">certificatesDir:</span> <span class="hljs-string">/etc/kubernetes/pki</span><br><span class="hljs-attr">clusterName:</span> <span class="hljs-string">kubernetes</span><br><span class="hljs-attr">controlPlaneEndpoint:</span> <span class="hljs-string">"master.k8s.io:16443"</span><br><span class="hljs-attr">controllerManager:</span> <span class="hljs-string">&#123;&#125;</span><br><span class="hljs-attr">dns:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">CoreDNS</span><br><span class="hljs-attr">etcd:</span><br>  <span class="hljs-attr">local:</span><br>    <span class="hljs-attr">dataDir:</span> <span class="hljs-string">/var/lib/etcd</span><br><span class="hljs-attr">imageRepository:</span> <span class="hljs-string">registry.aliyuncs.com/google_containers</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">kubernetesVersion:</span> <span class="hljs-string">v1.20.1</span><br><span class="hljs-attr">networking:</span><br>  <span class="hljs-attr">dnsDomain:</span> <span class="hljs-string">cluster.local</span><br>  <span class="hljs-attr">podSubnet:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span><br>  <span class="hljs-attr">serviceSubnet:</span> <span class="hljs-number">10.1</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span><br><span class="hljs-attr">scheduler:</span> <span class="hljs-string">&#123;&#125;</span></code></pre><p><br></p><p><br></p><h3>12.2 在<font color="#c24f4a">master1</font>节点执行</h3><pre type="Bash"><code>kubeadm init --<span class="hljs-built_in">config</span> kubeadm-<span class="hljs-built_in">config</span>.yaml</code></pre><p><img src="http://qiniu-picture.xiyankt.com/FhJckGZ8UJtm-ERISgxed-aU8rZ4" srcset="/img/loading.gif" lazyload width="1250" height="682.29"><font size="3"><br></font></p><p><font size="3"><br></font></p><p>出现启动不起来的话执行如下命令再次init初始化</p><pre><code class="hljs">#重启kubeadm<br></code><code>kubeadm reset</code></pre><p><font size="3"><br></font></p><p><font size="3">按照提示配置环境变量，使用kubectl工具</font><br></p><pre type="Bash"><code>mkdir -p $HOME/.kube</code><code><br></code><code>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</code><code><br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br></code><code><span class="hljs-built_in"><br></span>kubectl <span class="hljs-builtin-name">get</span> nodes</code><code><br>kubectl <span class="hljs-builtin-name">get</span> pods -n kube-system</code><code><br></code></pre><p><strong><font size="3">按照提示保存以下内容，一会要使用：</font></strong><br></p><pre type="Bash"><code><span class="hljs-selector-tag">kubeadm</span> <span class="hljs-selector-tag">join</span> <span class="hljs-selector-tag">master</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span><span class="hljs-selector-pseudo">:16443</span> <span class="hljs-selector-tag">--token</span> dxfk7f.nljvs04qf8mm3fgo <br>    --discovery-token-ca-cert-hash sha256:73d0ac5b260d52d2e29eb0dc77b2c7ac6215ba10506c5dc1372158b5531e6e84 <br>    <span class="hljs-selector-tag">--control-plane</span> </code></pre><p><br></p><p><font size="3">查看集群状态</font><br></p><pre type="Bash"><code>kubectl <span class="hljs-builtin-name">get</span> cs</p>
<p>kubectl <span class="hljs-builtin-name">get</span> pods -n kube-system</code></pre><p><br></p><h2>13.安装集群网络</h2><p><font size="3">从官方地址获取到flannel的yaml，在master1上执行&amp;nbsp;</font></p><pre type="Bash"><code>wget -c http:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/coreos/</span>flannel<span class="hljs-regexp">/master/</span>Documentation<span class="hljs-regexp">/kube-flannel.yml</span></code></pre><p><br></p><p><font size="4" color="#c24f4a">报错文件解决</font></p><p><img src="http://img-blog.csdnimg.cn/20200427195817259.jpg" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br></p><p><font size="3">进入网站：<font color="#f9963b"><a target="_blank" rel="noopener" href="http://site.ip138.com/raw.Githubusercontent.com/">http://site.ip138.com/raw.Githubusercontent.com/</a></font></font><br><br><font size="3">输入<font color="#f9963b">raw.githubusercontent.com</font><br>查询其相关的IP地址:</font><br><img src="http://qiniu-picture.xiyankt.com/FnuJHK-i6l2zEyu8X42_Tq4rXQEW" srcset="/img/loading.gif" lazyload style="max-width:100%;" width="696" height="414.53"><br><font size="4">在Ubuntu终端输入：<br>sudo vi &#x2F;etc&#x2F;hosts</font><br><br><font size="4">选择上面一个添加内容即可：<br>比如：<br><a href="http://site.ip138.com/185.199.111.133/" target="_blank">185.199.111.133</a>&amp;nbsp;raw.githubusercontent.com<br>或者<br><a href="http://site.ip138.com/185.199.111.133/" target="_blank">185.199.109.133</a>&amp;nbsp;raw.githubusercontent.com</font><br><br><font size="4">然后保存，退出<br><br>然后再次执行</font></p><p><img src="http://qiniu-picture.xiyankt.com/FjKjsotGGsOsc0UfWepZjhEqid_e" srcset="/img/loading.gif" lazyload style="max-width:100%;"><br></p><p><font size="3"><br></font></p><p><font size="3">修改镜像，不要会出现失败的现象</font></p><pre type="Bash"><code>quay.io/coreos/flannel:v0<span class="hljs-number">.12</span><span class="hljs-number">.0</span>-amd64</code></pre><p><br></p><p><img src="http://qiniu-picture.xiyankt.com/Fo6ZVfS41PIWAhLc_WtlCLwa7C1T" srcset="/img/loading.gif" lazyload style="max-width:100%;"><font size="3"><br></font></p><p><br></p><p><font size="3">安装flannel网络，<font color="#f9963b">执行需要时间请耐心等待</font></font></p><pre type="Bash"><code>kubectl <span class="hljs-built_in">apply</span> -f kube-flannel.yml </code></pre><p><font size="3"><br></font></p><p><font size="3">检查<br></font></p><pre type="Bash"><code>kubectl <span class="hljs-built_in">get</span> pods -n kube-<span class="hljs-keyword">system</span></code><code><span class="hljs-keyword"><br></span></code><code><span class="hljs-keyword">kubectl get nodes<br></span></code></pre><p><br></p><p><img src="http://qiniu-picture.xiyankt.com/Fru9g_G86saznCgz6XIU2kwoEMVj" srcset="/img/loading.gif" lazyload style="max-width:100%;"><font size="3"><br></font></p><h2><br>14、master2节点加入集群</h2><h3>14.1 复制密钥及相关文件</h3><p><font size="3">从master1复制密钥及相关文件到master2</font><br></p><pre type="Bash"><code>ssh root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.18</span>.<span class="hljs-number">129</span> mkdir -p /etc/kubernetes/pki/etcd</p>
<p>scp /etc/kubernetes/admin.conf root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.18</span>.<span class="hljs-number">129</span><span class="hljs-symbol">:/etc/kubernetes</span></p>
<p>scp /etc/kubernetes/pki/&#123;ca.<em>,sa.</em>,front-proxy-ca.*&#125; root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.18</span>.<span class="hljs-number">129</span><span class="hljs-symbol">:/etc/kubernetes/pki</span></p>
<p>scp /etc/kubernetes/pki/etcd/ca.* root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.18</span>.<span class="hljs-number">129</span><span class="hljs-symbol">:/etc/kubernetes/pki/etcd</span></code></pre><p><br></p><p><img src="http://qiniu-picture.xiyankt.com/Fsk-Sd6iD--OB1XHl31_ygG3Uik9" srcset="/img/loading.gif" lazyload style="max-width:100%;" width="939" height="536.68"><font size="3"><br></font></p><p><font size="3"><br></font></p><h3>14.2 master2加入集群</h3><p><font size="4">执行在master1上init后输出的join命令,需要带上参数<code style=""><font color="#f9963b">--control-plane</font></code>表示把master控制节点加入集群</font></p><pre type="Bash"><code>kubeadm join master.k8s.io:16443 --token 88j8wr.yh2xbehma91953w1 --discovery-token-ca-cert-hash sha256:7fe1dc775ab7e54c54189615a5762fbce5135e132e5c0b83da2ffb2d54013efc --control-plane<br></code></pre><p><br></p><p><img src="http://qiniu-picture.xiyankt.com/Fh6u3HrfzP7_bDb63Z_AKjRq8TbK" srcset="/img/loading.gif" lazyload style="max-width:100%;" width="848" height="484.87"><br></p><p><br></p><pre type="Bash"><code>mkdir -p <span class="hljs-variable">$HOME</span>/.kube</code><code><br>sudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube<span class="hljs-built_in">/config</span></code><code><span class="hljs-built_in"><br></span>sudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config</code></pre><p><br></p><p><br></p><p>检查状态<br></p><pre type="Bash"><code>kubectl get <span class="hljs-keyword">node</span></p>
<p><span class="hljs-title">kubectl</span> get pods --all-namespaces</code></pre><p><img src="http://qiniu-picture.xiyankt.com/Fvd-q8k_eWDG1h7FsC3ifrOJQr0Z" srcset="/img/loading.gif" lazyload style="max-width:100%;"><br></p><h2>15. 加入Kubernetes Node</h2><p><font size="4">在node1，node2上执行</font></p><p><font size="4">向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：唯一不同的地方是少了–control-plane这个命令</font></p><p><font size="4">这个命令可以创建新的令牌&amp;nbsp;</font><span style="font-size: 1em;"></span><span style="background-color: rgb(241, 241, 241); font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;">kubeadm </span><span class="hljs-built_in" style="font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;">token</span><span style="background-color: rgb(241, 241, 241); font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;"> </span><span class="hljs-keyword" style="font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;">create</span><span style="background-color: rgb(241, 241, 241); font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;"> –</span><span class="hljs-keyword" style="font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;">print</span><span style="background-color: rgb(241, 241, 241); font-family: Consolas, Menlo, Courier, monospace; font-size: 1em;">-join-command</span></p><p><br></p><pre type="Bash"><code><span class="hljs-selector-tag">kubeadm</span> <span class="hljs-selector-tag">join</span> <span class="hljs-selector-tag">master</span><span class="hljs-selector-class">.k8s</span><span class="hljs-selector-class">.io</span><span class="hljs-selector-pseudo">:16443</span> <span class="hljs-selector-tag">--token</span> <span class="hljs-selector-tag">dxfk7f</span><span class="hljs-selector-class">.nljvs04qf8mm3fgo</span> <br>    <span class="hljs-selector-tag">--discovery-token-ca-cert-hash</span> <span class="hljs-selector-tag">sha256</span><span class="hljs-selector-pseudo">:73d0ac5b260d52d2e29eb0dc77b2c7ac6215ba10506c5dc1372158b5531e6e84</span></code></pre><h3><strong id="x11vm">集群网络重新安装，因为添加了新的node节点，<font color="#f9963b">如果出现下载失败可以持续执行以下操作，直到下载成功</font>（<font color="#f9963b">master1执行</font>）</strong></h3><div><pre type="Bash"><code><span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">delete</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">kube-flannel</span><span class="hljs-selector-class">.yml</span></p>
<p><span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">apply</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">kube-flannel</span><span class="hljs-selector-class">.yml</span></code></pre></div><p><br></p><p><img src="http://qiniu-picture.xiyankt.com/Fpy4C2p4UQqPgW7Ut1eS-rcVE-aL" srcset="/img/loading.gif" lazyload style="max-width:100%;"><br></p><p><br></p><p><font size="3">检查状态</font></p><pre type="Bash"><code>kubectl get <span class="hljs-keyword">node</span></p>
<p><span class="hljs-title">kubectl</span> get pods --all-namespaces</code></pre><h2><br></h2><p><img src="http://qiniu-picture.xiyankt.com/Fgq3oIOuZCN58iEuhoTj8Om6c0E9" srcset="/img/loading.gif" lazyload style="max-width:100%;"><br></p><h2>16. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p><pre type="Bash"><code>kubectl create deployment nginx <span class="hljs-attribute">--image</span>=nginx</code><code><br>kubectl expose deployment nginx <span class="hljs-attribute">--port</span>=80 <span class="hljs-attribute">--type</span>=NodePort</code><code><br>kubectl <span class="hljs-builtin-name">get</span> pod,svc</code></pre><p><font size="4"><br></font></p><p><font size="4">访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a></font></p></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/ECS/" class="category-chain-item">ECS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ECS/">#ECS</a>
      
        <a href="/tags/%E5%AE%B9%E5%99%A8/">#容器</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>K8S-尚硅谷</div>
      <div>http://example.com/2023/06/01/ECS/k8s/k8s-尚硅谷/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>where</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/06/01/ECS/Linux/" title="Linux">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Linux</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/01/Java%E7%B2%BE%E9%80%9A/JUC/" title="JUC">
                        <span class="hidden-mobile">JUC</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
