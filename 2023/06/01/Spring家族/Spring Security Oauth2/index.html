

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="where">
  <meta name="keywords" content="">
  
    <meta name="description" content="Spring Security Oauth2(7条消息) Spring Security、oauth2、单点登陆SSO的关系_spring security sso_云川之下的博客-CSDN博客 SpringBoot整合spring-security-oauth2完整实现例子 - 腾讯云开发者社区-腾讯云 (tencent.com) 问：spring security鉴权服务器的实现方式有哪几种，">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security Oauth2">
<meta property="og:url" content="http://example.com/2023/06/01/Spring%E5%AE%B6%E6%97%8F/Spring%20Security%20Oauth2/index.html">
<meta property="og:site_name" content="where&#39;s blog">
<meta property="og:description" content="Spring Security Oauth2(7条消息) Spring Security、oauth2、单点登陆SSO的关系_spring security sso_云川之下的博客-CSDN博客 SpringBoot整合spring-security-oauth2完整实现例子 - 腾讯云开发者社区-腾讯云 (tencent.com) 问：spring security鉴权服务器的实现方式有哪几种，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/5427637/hezsjuukja.jpeg?imageView2/2/w/2560/h/7000">
<meta property="og:image" content="https://i.loli.net/2021/05/19/nPs9DNFuUB52AOV.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411171949920.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411165825002.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411171743153.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411164517724.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411165614516.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411162420293.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411163311176.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411142414027.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411142606892.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411150420681.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411141720762.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411150753639.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411150954164.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411163450073.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411151307233.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411141429570.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230414111137460.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e9c06a4b707745fb8a8a6f2b58c85cb4.png#pic_center">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415232218398.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411200251565.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415233714075.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415231804100.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415235732084.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415235922873.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225357091.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416000039830.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416102157558.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225845688.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416103930151.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416104056853.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225945367.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225321835.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411203927984.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416082643200.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411204322994.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416144137597.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416233446586.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416084046723.png">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23a944f928644727a74de80d42c8dd2c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411182043644.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230417175859959.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/fadsfewrqwredsfq3r.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/watermark%252Ctype_ZmFuZ3poZW5naGVpdGk%252Cshadow_10%252Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NubTEwMDUw%252Csize_16%252Ccolor_FFFFFF%252Ct_70">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230417180224185.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411173833116.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411181723899.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230414085922878.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411174705602.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416143518588.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416143708979.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/4069933/m9kd4b9pdm.png?imageView2/2/w/2560/h/7000">
<meta property="article:published_time" content="2023-05-31T16:00:00.000Z">
<meta property="article:modified_time" content="2023-06-22T15:33:40.706Z">
<meta property="article:author" content="where">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ask.qcloudimg.com/http-save/5427637/hezsjuukja.jpeg?imageView2/2/w/2560/h/7000">
  
  
  
  <title>Spring Security Oauth2 - where&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring Security Oauth2"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-01 00:00" pubdate>
          2023年6月1日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          93k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          779 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Spring Security Oauth2</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Spring-Security-Oauth2"><a href="#Spring-Security-Oauth2" class="headerlink" title="Spring Security Oauth2"></a>Spring Security Oauth2</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_45406092/article/details/123797710">(7条消息) Spring Security、oauth2、单点登陆SSO的关系_spring security sso_云川之下的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1786077">SpringBoot整合spring-security-oauth2完整实现例子 - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<p>问：spring security鉴权服务器的实现方式有哪几种，以及接口级权限校验如何进行鉴权服务器的设计</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Spring <span class="hljs-keyword">Security</span> 是一个基于 Spring 的安全框架，提供了完备的安全解决方案，包括身份验证、授权、攻击防护等功能。在使用 Spring <span class="hljs-keyword">Security</span> 时，我们可以采用以下几种方式实现鉴权服务器：<br><br>基于 <span class="hljs-keyword">Session</span> 的鉴权<br>通过在用户登录成功后在服务器端创建一个 <span class="hljs-keyword">Session</span>，并将 <span class="hljs-keyword">Session</span> ID 返回给客户端浏览器，在后续操作中，客户端浏览器会将该 <span class="hljs-keyword">Session</span> ID 发送到服务器端，从而进行用户身份的鉴别和权限的控制。<br><br>基于 Token 的鉴权<br>Token 鉴权是指，在客户端请求服务器时，将一段特定的字符串作为参数传递给服务器，服务器根据该 Token 进行用户身份鉴别和权限控制。Token 可以保存在 Cookie、<span class="hljs-keyword">Header</span> 或请求参数中，具有较好的通用性和跨域支持能力。<br><br>OAuth2 鉴权<br>OAuth2 是目前应用最广泛的认证与授权协议之一，它通过向第三方应用颁发访问令牌（<span class="hljs-keyword">Access</span> Token），来确保第三方应用可以获取到用户的信息或进行相关操作。<br><br>对于接口级别的权限校验，Spring <span class="hljs-keyword">Security</span> 主要通过定义拦截器或过滤器(<span class="hljs-keyword">Filter</span>)来实现。我们可以通过自定义 <span class="hljs-keyword">Filter</span> 对请求进行过滤，并在其中添加相应的鉴权逻辑，在鉴权通过的情况下才允许用户继续访问受保护的资源。同时，Spring <span class="hljs-keyword">Security</span> 还提供了丰富的注解和标签，可以在控制器(Controller)或业务逻辑层(Service)中对方法进行鉴权。例如，@PreAuthorize 和 @PostAuthorize 注解可以分别在方法执行前后进行鉴权，确保只有满足特定条件的用户才能够调用该方法。<br></code></pre></td></tr></table></figure>



<p>authentication 权限问题</p>
<p>token作为信息校验的载体</p>
<p>访问一个接口，判断用户是否需要 某个角色的权限，</p>
<p>接口级权限校验：自定义@PreAuthorize 注解的判定方式，</p>
<p>问：<strong>接口级权限校验</strong>的实现方式 </p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-number">1</span>、gateway 网关统一进行<span class="hljs-built_in">token</span>校验解析，转发请求等， 资源服务器根据网关转发的信息，进行权限校验<br><br>网关在认证授权体系里主要负责两件事：<br>（<span class="hljs-number">1</span>）作为OAuth2<span class="hljs-number">.0</span>的资源服务器角色，实现接入方权限拦截。<br>（<span class="hljs-number">2</span>）令牌解析并转发当前登录用户信息（明文<span class="hljs-built_in">token</span>）给微服务<br><br>微服务拿到明文<span class="hljs-built_in">token</span>(明文<span class="hljs-built_in">token</span>中包含登录用户的身份和权限信息)后也需要做两件事：<br>（<span class="hljs-number">1</span>）用户授权拦截（看当前用户是否有权访问该资源）<br>（<span class="hljs-number">2</span>）将用户信息存储进当前线程上下文（有利于后续业务逻辑随时获取当前用户信息）<br><br>问题：直接访问接口，会失效吗<br><br><span class="hljs-number">2</span>、资源服务器 和 授权服务器绑定 √<br>xx服务器实现 认证请求的转发与解析，资源服务器可以直接将解析后的数据用于判定用户是否具有访问权限<br>问题：服务器业务逻辑过于复杂<br></code></pre></td></tr></table></figure>



<p>问：拥有后台接口的全路径uri，如何避免直接访问到接口</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">如果已经有后台接口的全路径URI，想要避免直接访问到接口，可以考虑以下措施：<br><br><span class="hljs-number">1.</span>认证验证：为后台接口添加认证方案（比如JWT令牌、OAuth2等），只有通过认证的用户才能访问相应的接口。<br><br><span class="hljs-number">2.</span>API网关：使用API网关来对所有请求进行管理，只有经过网关转发的请求才能够到达后台接口。这样可以有效地隔离外部直接访问后台的风险。<br><br><span class="hljs-number">3.</span><span class="hljs-built_in">URL</span>重写：在Web服务器层面上可以通过<span class="hljs-built_in">URL</span>重写技术，将后台接口的<span class="hljs-built_in">URL</span>地址伪装成其他不易被猜测到的形式，例如随机生成<span class="hljs-built_in">URL</span>路径或加密<span class="hljs-built_in">URL</span>参数。<br><br><span class="hljs-number">4.</span>IP白名单：在服务器防火墙或反向代理中设置IP白名单，只有指定的IP地址才可以访问后台接口。<br><br><span class="hljs-number">5.</span>加密传输：使用HTTPS协议进行加密传输，这样可以有效防止黑客窃取数据包，保护网络安全。<br><br>以上措施都是可以有效避免直接访问后台接口的方法，建议根据实际情况，综合考虑采取一定的组合解决方案。<br></code></pre></td></tr></table></figure>



<h1 id="API网关"><a href="#API网关" class="headerlink" title="API网关"></a>API网关</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/371986798">API网关（API GATEWAY）是什么？有什么作用？ - 知乎 (zhihu.com)</a></p>
<p>统一认证，分发请求</p>
<p>网关：网关进行统一权限验证</p>
<h1 id="OAuth-（Open-Authority）"><a href="#OAuth-（Open-Authority）" class="headerlink" title="OAuth - （Open Authority）"></a>OAuth - （Open Authority）</h1><p>验证授权的开放标准 </p>
<p>组件：资源拥有者 Resource Owner、第三方软件 Client:、授权服务 Authorization Server、资源服务 Resource Server</p>
<ul>
<li>Resource Owner: 用户拥有资源服务器上面的数据。例如：我是一名Facebook的用户，我拥有我的Facebook 个人简介的信息。</li>
<li>Resource Server: 存储用户信息的API Service</li>
<li>Client: 想要访问用户的客户端</li>
<li>Authorization Server: OAuth的主要引擎，授权服务器，获取token。、</li>
</ul>
<p><img src="https://ask.qcloudimg.com/http-save/5427637/hezsjuukja.jpeg?imageView2/2/w/2560/h/7000" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://i.loli.net/2021/05/19/nPs9DNFuUB52AOV.png" srcset="/img/loading.gif" lazyload alt="image-20210519120117924"></p>
<blockquote>
<p>（A）用户打开客户端以后，客户端要求用户给予授权。</p>
<p>（B）用户同意给予客户端授权。</p>
<p>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</p>
<p>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</p>
<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p>
<p>（F）资源服务器确认令牌无误，同意向客户端开放资源</p>
</blockquote>
<h1 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h1><h2 id="资源服务器如何校验access-token："><a href="#资源服务器如何校验access-token：" class="headerlink" title="资源服务器如何校验access token："></a>资源服务器如何校验access token：</h2><p>OAuth 2.0没有规定资源服务器如何校验access token，只是说资源服务器与授权服务器之间自己协调。实操中一般采用以下方法校验：</p>
<p>对于小型Web应用：资源服务器通常与授权服务器同为一体，自然能够通过读库来校验。<br>对于大型Web应用：授权服务器和资源服务器通常是独立部署的，有三种方式校验：<br>1、使用读库令牌作为access token，在数据库存储层面做共享，使得资源服务器能够通过读库来校验。<br>2、使用读库令牌作为access token，由授权服务器提供一个令牌校验接口，资源服务器请求该接口来校验。OAuth2.0在补充规范RFC 7662 中定义了令牌校验接口（Introspection Endpoint）的相关标准。<br>3、使用自包含令牌作为access token，资源服务器和授权服务器双方约定好自包含令牌的结构、签名密钥、加密方法，资源服务器按照约定规则自行校验。</p>
<h1 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h1><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2149012">jwt三个组成部分_jwt加密算法 - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<h2 id="详细介绍"><a href="#详细介绍" class="headerlink" title="详细介绍"></a>详细介绍</h2><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/826786">理解JWT的使用场景和优劣-阿里云开发者社区 (aliyun.com)</a></p>
<p><strong>rsa 加密</strong>和<strong>rsa 签名</strong> 是两个概念！(吓得我都换行了)</p>
<p>这两个用法很好理解：</p>
<ul>
<li>既然是加密，自然是不希望别人知道我的消息，只有我自己才能解密，所以<strong>公钥负责加密，私钥负责解密</strong>。这是大多数的使用场景，使用 rsa 来加密。</li>
<li>既然是签名，自然是希望别人不能冒充我发消息，只有我才能发布签名，所以<strong>私钥负责签名，公钥负责验证</strong>。</li>
</ul>
<p>所以，在客户端使用 rsa 算法生成 jwt 串时，是使用私钥来“加密”的，而公钥是公开的，谁都可以解密，内容也无法变更（篡改者无法得知私钥）。</p>
<p>所以，在 jwt 中并没有纯粹的加密过程，而是使加密之虚，行签名之实。</p>
<h2 id="JWT的构成"><a href="#JWT的构成" class="headerlink" title="JWT的构成"></a>JWT的构成</h2><p>第一部分我们称它为头部（header),第二部分我们称其为载荷（payload, 类似于飞机上承载的物品)，第三部分是签证（signature).</p>
<h2 id="header"><a href="#header" class="headerlink" title="header"></a>header</h2><p>jwt的头部承载两部分信息：</p>
<ul>
<li>声明类型，这里是jwt</li>
<li>声明加密的算法 通常直接使用 HMAC SHA256</li>
</ul>
<p>完整的头部就像下面这样的JSON：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&#x27;typ&#x27;</span>: <span class="hljs-string">&#x27;JWT&#x27;</span>,<br>  <span class="hljs-string">&#x27;alg&#x27;</span>: <span class="hljs-string">&#x27;HS256&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>然后将头部进行<strong>base64加密（该加密是可以对称解密的)</strong>,构成了第一部分.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9<br></code></pre></td></tr></table></figure>

<p>复制</p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分</p>
<ul>
<li>标准中注册的声明</li>
<li>公共的声明</li>
<li>私有的声明</li>
</ul>
<p><strong>标准中注册的声明</strong> (建议但不强制使用) ：</p>
<ul>
<li>iss: jwt签发者</li>
<li>sub: jwt所面向的用户</li>
<li>aud: 接收jwt的一方</li>
<li>exp: jwt的过期时间，这个过期时间必须要大于签发时间</li>
<li>nbf: 定义在什么时间之前，该jwt都是不可用的.</li>
<li>iat: jwt的签发时间</li>
<li>jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</li>
</ul>
<p><strong>公共的声明</strong> ： 公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</p>
<p><strong>私有的声明</strong> ： 私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>定义一个payload:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&quot;sub&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span>,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;John Doe&quot;</span>,<br>  <span class="hljs-string">&quot;admin&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>复制</p>
<p>然后将其进行base64加密，得到JWT的第二部分。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9<br></code></pre></td></tr></table></figure>

<p>复制</p>
<h2 id="signature"><a href="#signature" class="headerlink" title="signature"></a>signature</h2><p>JWT的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<ul>
<li>header (base64后的)</li>
<li>payload (base64后的)</li>
<li>secret</li>
</ul>
<p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// javascript</span><br><span class="hljs-keyword">var</span> encodedString = <span class="hljs-title function_">base64UrlEncode</span>(header) + <span class="hljs-string">&#x27;.&#x27;</span> + <span class="hljs-title function_">base64UrlEncode</span>(payload);<br><br><span class="hljs-keyword">var</span> signature = <span class="hljs-title class_">HMACSHA256</span>(encodedString, <span class="hljs-string">&#x27;secret&#x27;</span>); <span class="hljs-comment">// TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></code></pre></td></tr></table></figure>

<p><strong>secret – 私钥</strong></p>
<p><strong>secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</strong></p>
<h2 id="JWT和cookie-x2F-session的区别及优缺点"><a href="#JWT和cookie-x2F-session的区别及优缺点" class="headerlink" title="JWT和cookie&#x2F;session的区别及优缺点"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gj0151/p/15333826.html">JWT和cookie&#x2F;session的区别及优缺点</a></h2><h3 id="存储位置"><a href="#存储位置" class="headerlink" title="存储位置"></a>存储位置</h3><p>三者都是应用在web中对http无状态协议的补充，达到状态保持的目的</p>
<p><strong>cookie</strong>：cookie中的信息是以键值对的形式储存在浏览器中，而且在浏览器中可以直接看到数据。</p>
<p><strong>session</strong>：session存储在服务器中，然后发送一个cookie存储在浏览器中，cookie中存储的是session_id，之后每次请求服务器通过session_id可以获取对应的session信息</p>
<p><strong>JWT</strong>：JWT存储在浏览器的storage或者cookie中。由服务器产生加密的json数据包括：header，payload和signature三部分组成。header中通常来说由token的生成算法和类型组成；payload中则用来保存相关的状态信息；signature部分由header，payload，secret_key三部分加密生成。 注意，不要在JWT的payload或header中放置敏感信息，除非它们是加密的。</p>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p>cookie:</p>
<ul>
<li>优点：</li>
</ul>
<ol>
<li>结构简单。cookie是一种基于文本的轻量结构，包含简单的键值对。</li>
<li>数据持久。虽然客户端计算机上cookie的持续时间取决于客户端上的cookie过期处理和用户干预，cookie通常是客户端上持续时间最长的数据保留形式。</li>
</ol>
<ul>
<li>缺点：</li>
</ul>
<ol>
<li>大小受到限制。大多数浏览器对 cookie 的大小有 4096 字节的限制，尽管在当今新的浏览器和客户端设备版本中，支持 8192 字节的 cookie 大小已愈发常见。</li>
<li>非常不安全。cookie将数据裸露在浏览器中，这样大大增大了数据被盗取的风险，所有我们不应该将中要的数据放在cookie中，或者将数据加密处理。</li>
<li>容易被csrf攻击。可以设置csrf_token来避免攻击。</li>
</ol>
<p>session：</p>
<ul>
<li>优点：</li>
</ul>
<ol>
<li>session的信息存储在服务端，相比于cookie就在一定程度上加大了数据的安全性；相比于jwt方便进行管理，也就是说当用户登录和主动注销，只需要添加删除对应的session就可以，这样管理起来很方便。</li>
</ol>
<ul>
<li>缺点：</li>
</ul>
<ol>
<li>session存储在服务端，这就增大了服务器的开销，当用户多的情况下，服务器性能会大大降低。</li>
<li>因为是基于cookie来进行用户识别的, cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。</li>
<li>用户认证之后，服务端做认证记录，如果认证的记录被保存在内存中的话，这意味着用户下次请求还必须要请求在这台服务器上,这样才能拿到授权的资源，这样在分布式的应用上，会限制负载均衡和集群水平拓展的能力。</li>
</ol>
<p>JWT：</p>
<ul>
<li>优点：</li>
</ul>
<ol>
<li>因为json的通用性，jwt可以支持跨语言请求，像JAVA,JavaScript,PHP等很多语言都可以使用。</li>
<li>因为有了payload部分，所以JWT可以在自身存储一些其他业务逻辑所必要的非敏感信息。</li>
<li>便于传输，JWT的构成非常简单，字节占用很小，所以它是非常便于传输的。</li>
<li>不需要在服务端保存会话信息, 利于服务器横向拓展。</li>
</ol>
<ul>
<li>缺点：</li>
</ul>
<ol>
<li><p>登录状态信息续签问题。比如设置token的有效期为一个小时，那么一个小时后，如果用户仍然在这个web应用上，这个时候当然不能指望用户再登录一次。目前可用的解决办法是在每次用户发出请求都返回一个新的token，前端再用这个新的token来替代旧的，这样每一次请求都会刷新token的有效期。但是这样，需要频繁的生成token。另外一种方案是判断还有多久这个token会过期，在token快要过期时，返回一个新的token。</p>
</li>
<li><p>用户主动注销。JWT并不支持用户主动退出登录，客户端在别处使用token仍然可以正常访问。为了支持注销，我的解决方案是在注销时将该token加入到服务器的redis黑名单中。</p>
</li>
<li><p><strong>JWT与OAuth的区别</strong></p>
</li>
<li><p>&gt; 这两个概念总有人用混淆，所以一起介绍了。</p>
<p>OAuth2是一种授权框架，用在使用第三方账号登录的情况（比如使用weibo, qq, github登录某个app）<br>JWT是一种认证协议，用在前后端分离，需要简单的对后台API进行保护时使用。 &gt; 无论使用哪种方式切记用HTTPS来保证数据的安全性；</p>
</li>
</ol>
<h1 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h1><p>适用于单体服务</p>
<p>案例：Spring Security的<strong>用户名密码</strong>登录的校验流程</p>
<p>Spring Security 过滤器执行流程</p>
<p>问：spring security如何保证url被对应的过滤器拦截，并正确代理，即attemptAuthentication()方法的调用到正确的filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Spring Security使用一组过滤器链来保护Web应用程序中的URL资源。每个过滤器都有一个明确定义的目的，用于执行不同的安全任务。<br><br>在Spring Security的过滤器链中，第一条FilterChainProxy会根据请求的路径匹配到对应的过滤器链，然后依次执行过滤器链中的每个过滤器。默认情况下，Spring Security会按照以下顺序将过滤器添加到过滤器链中：<br><br><span class="hljs-number">1.</span> ChannelProcessingFilter：处理HTTP和HTTPS的问题<br><span class="hljs-number">2.</span> SecurityContextPersistenceFilter：处理SecurityContext的存储<br><span class="hljs-number">3.</span> ConcurrentSessionFilter：防止并发登录<br><span class="hljs-number">4.</span> LogoutFilter：处理注销操作<br><span class="hljs-number">5.</span> UsernamePasswordAuthenticationFilter：处理基于表单的身份验证<br><span class="hljs-number">6.</span> DefaultLoginPageGeneratingFilter：生成默认的登录页面<br><span class="hljs-number">7.</span> CasAuthenticationFilter：CAS身份验证过滤器<br><span class="hljs-number">8.</span> BasicAuthenticationFilter：处理basic认证<br><span class="hljs-number">9.</span> RequestCacheAwareFilter：处理请求的缓存<br><span class="hljs-number">10.</span> ExceptionTranslationFilter：转换异常<br><span class="hljs-number">11.</span> FilterSecurityInterceptor：基于配置的访问控制<br><br>当请求到达过滤器链时，FilterChainProxy首先会检查请求路径是否匹配某个拦截规则，如果匹配，则会将该请求交给对应的过滤器链处理。 在过滤器链内部，URL被匹配到时，存在一个用于处理身份验证的拦截器，即UsernamePasswordAuthenticationFilter。这个过滤器会拦截到用户登录请求，并通过调用attemptAuthentication()方法对用户进行身份验证。如果验证成功，Spring Security 会创建一个认证对象（Authentication），并将其保存在当前线程的SecurityContextHolder中。<br><br>因此，使用Spring Security保护URL资源需要按照以下步骤操作：<br><br><span class="hljs-number">1.</span> 定义一组过滤器链<br><span class="hljs-number">2.</span> 配置url匹配规则来决定哪些资源需要被保护<br><span class="hljs-number">3.</span> 在过滤器链中添加处理身份验证的拦截器<br><span class="hljs-number">4.</span> 实现自定义的身份验证逻辑，在attemptAuthentication()方法中完成身份验证<br><span class="hljs-number">5.</span> 如果身份验证成功，通过令牌（Token）生成认证对象，并将其保存在当前线程的SecurityContextHolder中<br></code></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig var1)</span> <span class="hljs-keyword">throws</span> ServletException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest var1, ServletResponse var2, FilterChain var3)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="配置注入"><a href="#配置注入" class="headerlink" title="配置注入"></a>配置注入</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1972872">Spring Security即将弃用配置类WebSecurityConfigurerAdapter - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>HttpSecurity 和 WebSecurity </p>
<p>WebSecurityCofnigurerAdapter和SecurityCofnigurerAdapter</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">HttpSecurity和WebSecurity是Spring <span class="hljs-keyword">Security</span>框架中的两个主要配置类。HttpSecurity用于配置HTTP请求路径级别的安全性，例如在哪些请求路径上需要进行身份验证以及使用何种授权策略；而WebSecurity则用于全局的安全性配置，如设置忽略哪些请求路径、开启或禁用跨站点请求伪造保护等。<br><br>WebSecurityConfigurerAdapter和SecurityConfigurerAdapter都是Spring <span class="hljs-keyword">Security</span>提供的配置适配器类，用于简化配置过程。其中，WebSecurityConfigurerAdapter主要用于对WebSecurity进行配置，包括设置认证方式、用户信息服务、密码加密方式等；而SecurityConfigurerAdapter主要用于配置HttpSecurity，例如添加过滤器、授权规则等。<br><br>总的来说，WebSecurity和HttpSecurity都是用于配置Spring <span class="hljs-keyword">Security</span>的安全性策略，但它们各自负责不同的配置任务；而WebSecurityConfigurerAdapter和SecurityConfigurerAdapter则是用于简化安全性配置的适配器类，它们也分别面向不同的配置对象。<br></code></pre></td></tr></table></figure>





<h3 id="SecurityBuilder"><a href="#SecurityBuilder" class="headerlink" title="SecurityBuilder"></a>SecurityBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt; &#123;<br>    O <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411171949920.png" srcset="/img/loading.gif" lazyload alt="image-20230411171949920"></p>
<h4 id="AuthenticationManagerBuilder"><a href="#AuthenticationManagerBuilder" class="headerlink" title="AuthenticationManagerBuilder"></a>AuthenticationManagerBuilder</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411165825002.png" srcset="/img/loading.gif" lazyload alt="image-20230411165825002"></p>
<p>创建Manager对象</p>
<p>构建ProviderManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationManagerBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;AuthenticationManager, AuthenticationManagerBuilder&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProviderManagerBuilder</span>&lt;AuthenticationManagerBuilder&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">private</span> AuthenticationManager parentAuthenticationManager;<br>    <span class="hljs-comment">// 持有 authenticationProviders的集合，用于构建AuthenticationManager对象</span><br>    <span class="hljs-keyword">private</span> List&lt;AuthenticationProvider&gt; authenticationProviders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-comment">// 持有UserDetailsService 默认的验证方式</span><br>    <span class="hljs-keyword">private</span> UserDetailsService defaultUserDetailsService;<br>    <span class="hljs-keyword">private</span> Boolean eraseCredentials;<br>    <span class="hljs-comment">// 发布 校验成功/失败 的时间发布 ----成功后可以通过监听事件获取Authenticaiton对象</span><br>    <span class="hljs-keyword">private</span> AuthenticationEventPublisher eventPublisher;<br>    <br>    <span class="hljs-comment">// 构建ProviderManager对象</span><br>    <span class="hljs-keyword">protected</span> ProviderManager <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 如果Provider集合为空，则无法构建 Manager对象</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isConfigured()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">ProviderManager</span> <span class="hljs-variable">providerManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(<span class="hljs-built_in">this</span>.authenticationProviders, <span class="hljs-built_in">this</span>.parentAuthenticationManager);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eraseCredentials != <span class="hljs-literal">null</span>) &#123;<br>                providerManager.setEraseCredentialsAfterAuthentication(<span class="hljs-built_in">this</span>.eraseCredentials);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eventPublisher != <span class="hljs-literal">null</span>) &#123;<br>                providerManager.setAuthenticationEventPublisher(<span class="hljs-built_in">this</span>.eventPublisher);<br>            &#125;<br><br>            providerManager = (ProviderManager)<span class="hljs-built_in">this</span>.postProcess(providerManager);<br>            <span class="hljs-keyword">return</span> providerManager;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 添加Provider</span><br>    <span class="hljs-keyword">public</span> AuthenticationManagerBuilder <span class="hljs-title function_">authenticationProvider</span><span class="hljs-params">(</span><br><span class="hljs-params">			AuthenticationProvider authenticationProvider)</span> &#123;<br>		<span class="hljs-built_in">this</span>.authenticationProviders.add(authenticationProvider);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ProviderManagerBuilder"><a href="#ProviderManagerBuilder" class="headerlink" title="ProviderManagerBuilder"></a>ProviderManagerBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProviderManagerBuilder</span>&lt;B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ProviderManagerBuilder</span>&lt;B&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;AuthenticationManager&gt; &#123;<br>    <span class="hljs-comment">// 通过Provider，创建ProviderManager （创建管理 Provider - 校验提供者的对象Manager）</span><br>    B <span class="hljs-title function_">authenticationProvider</span><span class="hljs-params">(AuthenticationProvider var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="SecurityConfigurer"><a href="#SecurityConfigurer" class="headerlink" title="SecurityConfigurer"></a>SecurityConfigurer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; &#123;<br>    <span class="hljs-comment">// 初始化</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(B var1)</span> <span class="hljs-keyword">throws</span> Exception;<br>	<span class="hljs-comment">// 配置</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(B var1)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411171743153.png" srcset="/img/loading.gif" lazyload alt="image-20230411171743153"></p>
<h4 id="SecurityConfigurerAdapter"><a href="#SecurityConfigurerAdapter" class="headerlink" title="SecurityConfigurerAdapter"></a>SecurityConfigurerAdapter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt; &#123;<br>    <span class="hljs-comment">// SecurityBuilder创建</span><br>    <span class="hljs-keyword">private</span> B securityBuilder;<br>    <span class="hljs-keyword">private</span> SecurityConfigurerAdapter.<span class="hljs-type">CompositeObjectPostProcessor</span> <span class="hljs-variable">objectPostProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>.CompositeObjectPostProcessor();<br> 	<br>    <span class="hljs-comment">// 内部类</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeObjectPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;Object&gt; &#123;<br>        <span class="hljs-keyword">private</span> List&lt;ObjectPostProcessor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Object</span>&gt;&gt; postProcessors;<br>    	<br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcess</span><span class="hljs-params">(Object object)</span> &#123;<br>            <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.postProcessors.iterator();<br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>                ObjectPostProcessor opp;<br>                Class oppType;<br>                <span class="hljs-keyword">do</span> &#123;<br>                    <span class="hljs-keyword">if</span> (!var2.hasNext()) &#123;<br>                        <span class="hljs-keyword">return</span> object;<br>                    &#125;<br>                    opp = (ObjectPostProcessor)var2.next();<br>                    Class&lt;?&gt; oppClass = opp.getClass();<br>                    oppType = GenericTypeResolver.resolveTypeArgument(oppClass, ObjectPostProcessor.class);<br>                &#125; <span class="hljs-keyword">while</span>(oppType != <span class="hljs-literal">null</span> &amp;&amp; !oppType.isAssignableFrom(object.getClass()));<br>				<span class="hljs-comment">// </span><br>                object = opp.postProcess(object);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ObejctPostProcessror</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;T&gt; &#123;<br>    &lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">T</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411164517724.png" srcset="/img/loading.gif" lazyload alt="image-20230411164517724"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411165614516.png" srcset="/img/loading.gif" lazyload alt="image-20230411165614516"></p>
<p>WebSecurity</p>
<h3 id="WebSecurityConfigurer"><a href="#WebSecurityConfigurer" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h3><h4 id="WebSecurityConfigurerAdapter"><a href="#WebSecurityConfigurerAdapter" class="headerlink" title="WebSecurityConfigurerAdapter"></a>WebSecurityConfigurerAdapter</h4><p>这里没有使用</p>
<p>适配器类，用于管理配置类的注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Order(100)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSecurityConfigurer</span>&lt;WebSecurity&gt; &#123;<br>    <span class="hljs-comment">// 上下文</span><br>    <span class="hljs-keyword">private</span> ApplicationContext context;<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> ContentNegotiationStrategy contentNegotiationStrategy;<br>    <span class="hljs-keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectPostProcessor;<br>    <span class="hljs-comment">// 验证的配置类</span><br>    <span class="hljs-keyword">private</span> AuthenticationConfiguration authenticationConfiguration;<br>    <span class="hljs-comment">// 验证管理的创建类</span><br>    <span class="hljs-keyword">private</span> AuthenticationManagerBuilder authenticationBuilder;<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> AuthenticationManagerBuilder localConfigureAuthenticationBldr;<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> disableLocalConfigureAuthenticationBldr;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> authenticationManagerInitialized;<br>    <span class="hljs-comment">// 验证的管理类</span><br>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-keyword">private</span> AuthenticationTrustResolver trustResolver;<br>    <br>    <span class="hljs-keyword">private</span> HttpSecurity http;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> disableDefaults;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="注解引入配置类"><a href="#注解引入配置类" class="headerlink" title="注解引入配置类"></a>注解引入配置类</h3><h4 id="EnableWebSecurity"><a href="#EnableWebSecurity" class="headerlink" title="@EnableWebSecurity"></a>@EnableWebSecurity</h4><p>引入WebSecurityConfiguration 和 SpringWebMvcImportSelector配置类</p>
<p>打开Spring Security配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;WebSecurityConfiguration.class, SpringWebMvcImportSelector.class&#125;)</span><br><span class="hljs-meta">@EnableGlobalAuthentication</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableWebSecurity &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringWebMvcImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>    SpringWebMvcImportSelector() &#123;<br>    &#125;<br><br>    <span class="hljs-comment">// 判断能否DispatcherServlet是否已经记载（MVC的分配类）</span><br>    <span class="hljs-comment">// 不能就返回 WebMvcSecurityConfiguration的全路径</span><br>    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">webmvcPresent</span> <span class="hljs-operator">=</span> ClassUtils.isPresent(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>        <span class="hljs-keyword">return</span> webmvcPresent ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration&quot;</span>&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="EnableResourceServer"><a href="#EnableResourceServer" class="headerlink" title="@EnableResourceServer"></a>@EnableResourceServer</h4><p>引入ResourceServerConfiguration配置类 – Oauth2的资源服务器</p>
<p><strong>开启资源服务器配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;ResourceServerConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableResourceServer &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="EnableAuthorizationServer"><a href="#EnableAuthorizationServer" class="headerlink" title="@EnableAuthorizationServer"></a>@EnableAuthorizationServer</h4><p>引入AuthorizationServerSecurityConfiguration 和 AuthorizationServerEndpointsConfiguration配置类 </p>
<p>​			– Oauth2的认证服务器配置</p>
<p><strong>开启授权服务器配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;AuthorizationServerEndpointsConfiguration.class, AuthorizationServerSecurityConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAuthorizationServer &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>错误</p>
<p>调用链：Filter ## doFilter() -&gt; GenericFilterBean ## doFilter() -&gt; AbstractAuthenticationProcessingFilter  ## doFilter()  ## <strong>attemptAuthentication()</strong> -&gt; UserNamePasswordAuthenticationFilter ##  <strong>attemptAuthentication()</strong></p>
<h3 id="GenericFilterBean"><a href="#GenericFilterBean" class="headerlink" title="GenericFilterBean"></a>GenericFilterBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericFilterBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span>, BeanNameAware, EnvironmentAware, EnvironmentCapable, ServletContextAware, InitializingBean, DisposableBean &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-comment">// 实现BeanNameAware，获取beanName</span><br>    <span class="hljs-keyword">private</span> String beanName;<br>    <span class="hljs-comment">// 实现EnvironmentAware接口，获取Environment</span><br>    <span class="hljs-keyword">private</span> Environment environment;<br>    <span class="hljs-comment">// 实现ServletContextAware接口，获取ServletContext</span><br>    <span class="hljs-keyword">private</span> ServletContext servletContext;<br>    <span class="hljs-comment">// 实现Filter，通过init(FilterConfig var1)获取FilterConfig</span><br>    <span class="hljs-keyword">private</span> FilterConfig filterConfig;<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; requiredProperties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>(<span class="hljs-number">4</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411162420293.png" srcset="/img/loading.gif" lazyload alt="image-20230411162420293"></p>
<h5 id="AbstractPreAuthenticationProcessingFilter"><a href="#AbstractPreAuthenticationProcessingFilter" class="headerlink" title="AbstractPreAuthenticationProcessingFilter"></a>AbstractPreAuthenticationProcessingFilter</h5><h5 id="AbstractAuthenticationProcessingFilter"><a href="#AbstractAuthenticationProcessingFilter" class="headerlink" title="AbstractAuthenticationProcessingFilter"></a>AbstractAuthenticationProcessingFilter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationEventPublisherAware</span>, MessageSourceAware &#123;<br>    <span class="hljs-keyword">protected</span> ApplicationEventPublisher eventPublisher;<br>    <span class="hljs-keyword">protected</span> AuthenticationDetailsSource&lt;HttpServletRequest, ?&gt; authenticationDetailsSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAuthenticationDetailsSource</span>();<br>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">MessageSourceAccessor</span> <span class="hljs-variable">messages</span> <span class="hljs-operator">=</span> SpringSecurityMessageSource.getAccessor();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">RememberMeServices</span> <span class="hljs-variable">rememberMeServices</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullRememberMeServices</span>();<br>    <span class="hljs-comment">// 用于</span><br>    <span class="hljs-keyword">private</span> RequestMatcher requiresAuthenticationRequestMatcher;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">continueChainBeforeSuccessfulAuthentication</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">SessionAuthenticationStrategy</span> <span class="hljs-variable">sessionStrategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullAuthenticatedSessionStrategy</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">allowSessionCreation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AuthenticationSuccessHandler</span> <span class="hljs-variable">successHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SavedRequestAwareAuthenticationSuccessHandler</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AuthenticationFailureHandler</span> <span class="hljs-variable">failureHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleUrlAuthenticationFailureHandler</span>();<br>    <br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>         <span class="hljs-comment">// 判断当前请求是否满足匹配规则，满足则调用 attemptAuthentication()方法</span><br>     <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.requiresAuthentication(request, response)) &#123;<br>            chain.doFilter(request, response);<br>     &#125; <span class="hljs-keyword">else</span> <br>   		Authentication authResult;<br>       	<span class="hljs-comment">// 在过滤器链中，调用方法尝试进行校验</span><br>         authResult = <span class="hljs-built_in">this</span>.attemptAuthentication(request, response);<br>         <span class="hljs-comment">// 校验不通过直接返回</span><br>        <span class="hljs-keyword">if</span> (authResult == <span class="hljs-literal">null</span>) &#123;<br>        	<span class="hljs-keyword">return</span>;<br>	    &#125;<br>     &#125;<br>    <span class="hljs-comment">// 抽象方法，子类实现</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2)</span> <span class="hljs-keyword">throws</span> AuthenticationException, IOException, ServletException;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="UserNamePasswordAuthenticationFilter"><a href="#UserNamePasswordAuthenticationFilter" class="headerlink" title="UserNamePasswordAuthenticationFilter"></a>UserNamePasswordAuthenticationFilter</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;username&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">usernameParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;username&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">passwordParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">postOnly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.postOnly &amp;&amp; !request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.obtainUsername(request);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.obtainPassword(request);<br>            <span class="hljs-keyword">if</span> (username == <span class="hljs-literal">null</span>) &#123;<br>                username = <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (password == <span class="hljs-literal">null</span>) &#123;<br>                password = <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>            username = username.trim();<br>            <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);<br>            <span class="hljs-built_in">this</span>.setDetails(request, authRequest);<br>            <span class="hljs-comment">// 调用Manager的 authenticate()方法进行校验，</span><br>            <span class="hljs-comment">// 返回校验后的完整Authentication对象 ---或者自定义AbstractAuthenticationToken -- Token</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>        &#125;<br>    &#125;    <br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411163311176.png" srcset="/img/loading.gif" lazyload alt="image-20230411163311176"></p>
<h3 id="FilterChainProxy"><a href="#FilterChainProxy" class="headerlink" title="FilterChainProxy"></a>FilterChainProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterChainProxy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(FilterChainProxy.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILTER_APPLIED</span> <span class="hljs-operator">=</span> FilterChainProxy.class.getName().concat(<span class="hljs-string">&quot;.APPLIED&quot;</span>);<br>    <span class="hljs-comment">// 管理所有  过滤器链</span><br>    <span class="hljs-keyword">private</span> List&lt;SecurityFilterChain&gt; filterChains;<br>    <span class="hljs-keyword">private</span> FilterChainProxy.FilterChainValidator filterChainValidator;<br>    <span class="hljs-keyword">private</span> HttpFirewall firewall;<br>&#125;<br><span class="hljs-comment">// 过滤器链配置</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityFilterChain</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br><br>    List&lt;Filter&gt; <span class="hljs-title function_">getFilters</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>自动注入</p>
<h2 id="权限验证调用链"><a href="#权限验证调用链" class="headerlink" title="权限验证调用链"></a>权限验证调用链</h2><h3 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h3><p>Manager对象通过调用 具体的校验Provider类，调用authenticate()方法，获取Authentication对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> &#123;<br>    Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication var1)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ProviderManager"><a href="#ProviderManager" class="headerlink" title="ProviderManager"></a>ProviderManager</h4><p>实现类，具体逻辑实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationManager</span>, MessageSourceAware, InitializingBean &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(ProviderManager.class);<br>    <span class="hljs-keyword">private</span> AuthenticationEventPublisher eventPublisher;<br>    <span class="hljs-comment">// 可以用于校验当前xx的Provider</span><br>    <span class="hljs-keyword">private</span> List&lt;AuthenticationProvider&gt; providers;<br>    <span class="hljs-keyword">protected</span> MessageSourceAccessor messages;<br>    <span class="hljs-keyword">private</span> AuthenticationManager parent;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> eraseCredentialsAfterAuthentication;<br>    <br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Authentication</span>&gt; toTest = authentication.getClass();<br>        <span class="hljs-type">AuthenticationException</span> <span class="hljs-variable">lastException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">AuthenticationException</span> <span class="hljs-variable">parentException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Authentication</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Authentication</span> <span class="hljs-variable">parentResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">debug</span> <span class="hljs-operator">=</span> logger.isDebugEnabled();<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getProviders().iterator();<br><br>        <span class="hljs-keyword">while</span>(var8.hasNext()) &#123;<br>            <span class="hljs-type">AuthenticationProvider</span> <span class="hljs-variable">provider</span> <span class="hljs-operator">=</span> (AuthenticationProvider)var8.next();<br>            <span class="hljs-keyword">if</span> (provider.supports(toTest)) &#123;<br>                <span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">// 调用具体的验证逻辑</span><br>                    result = provider.authenticate(authentication);<br>                    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-built_in">this</span>.copyDetails(authentication, result);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (AccountStatusException var13) &#123;<br>                    <span class="hljs-comment">// 异常处理</span><br>                    <span class="hljs-built_in">this</span>.prepareException(var13, authentication);<br>                    <span class="hljs-keyword">throw</span> var13;<br>                &#125; <span class="hljs-keyword">catch</span> (InternalAuthenticationServiceException var14) &#123;<br>                    <span class="hljs-built_in">this</span>.prepareException(var14, authentication);<br>                    <span class="hljs-keyword">throw</span> var14;<br>                &#125; <span class="hljs-keyword">catch</span> (AuthenticationException var15) &#123;<br>                    lastException = var15;<br>                &#125;<br>            &#125;<br>        &#125;<br>		<span class="hljs-comment">// 如果结果为空，调用父类 AuthenticationManager进行再次验证</span><br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.parent != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                result = parentResult = <span class="hljs-built_in">this</span>.parent.authenticate(authentication);<br>            &#125; <span class="hljs-keyword">catch</span> (ProviderNotFoundException var11) &#123;<br>            &#125; <span class="hljs-keyword">catch</span> (AuthenticationException var12) &#123;<br>                parentException = var12;<br>                lastException = var12;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eraseCredentialsAfterAuthentication &amp;&amp; result <span class="hljs-keyword">instanceof</span> CredentialsContainer) &#123;<br>                ((CredentialsContainer)result).eraseCredentials();<br>            &#125;<br>            <span class="hljs-keyword">if</span> (parentResult == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 发布验证成功事件</span><br>                <span class="hljs-built_in">this</span>.eventPublisher.publishAuthenticationSuccess(result);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (parentException == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-built_in">this</span>.prepareException((AuthenticationException)lastException, authentication);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> lastException;<br>        &#125;<br>    &#125;<br>&#125;   <br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411142414027.png" srcset="/img/loading.gif" lazyload alt="image-20230411142414027"></p>
<h3 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h3><p>具体的校验逻辑的实现，通过support()方法，可以<strong>专门处理一种校验方式</strong>。</p>
<p>Sms短信校验，用户名密码登录校验，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationProvider</span> &#123;<br>    <span class="hljs-comment">// 实现该接口，调用校验方法，将校验结果封装到Authentication对象中，用于上下文传递</span><br>    Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication var1)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br>	<span class="hljs-comment">// 判断当前Provider实现类 是否是 处理对应Class对象的Provider</span><br>    <span class="hljs-comment">// 如果是，则调用该方法的authentication，不是继续遍历Provider集合</span><br>    <br>    <span class="hljs-comment">// Class为实现了 Authentication接口的类 -&gt; 实现了AbstractAuthenticationToken -&gt;</span><br>    <span class="hljs-comment">//  UsernamePasswordAuthenticationToken / SmsCodeAuthenticationTokne</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; var1)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="AbstractUserDetailsAuthenticationProvider"><a href="#AbstractUserDetailsAuthenticationProvider" class="headerlink" title="AbstractUserDetailsAuthenticationProvider"></a>AbstractUserDetailsAuthenticationProvider</h4><p>用户名密码的校验 提供者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractUserDetailsAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationProvider</span>, InitializingBean, MessageSourceAware &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">MessageSourceAccessor</span> <span class="hljs-variable">messages</span> <span class="hljs-operator">=</span> SpringSecurityMessageSource.getAccessor();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">UserCache</span> <span class="hljs-variable">userCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullUserCache</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">forcePrincipalAsString</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hideUserNotFoundExceptions</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">UserDetailsChecker</span> <span class="hljs-variable">preAuthenticationChecks</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractUserDetailsAuthenticationProvider</span>.DefaultPreAuthenticationChecks();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">UserDetailsChecker</span> <span class="hljs-variable">postAuthenticationChecks</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractUserDetailsAuthenticationProvider</span>.DefaultPostAuthenticationChecks();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">GrantedAuthoritiesMapper</span> <span class="hljs-variable">authoritiesMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullAuthoritiesMapper</span>();<br>	<br>    <span class="hljs-comment">// 验证当前Authentication（UsernamePasswordAuthenticationToken）是否能验证通过</span><br>    <span class="hljs-comment">// 验证通过则返回 完整的信息，进行上下文设置</span><br>     <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> &#123;<br>        <span class="hljs-comment">// 从缓存获取UserDetails</span><br>    	<span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userCache.getUserFromCache(username);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 如果缓存为空，调用 方法检索UserDeatil对象 </span><br>            <span class="hljs-comment">// 检索User对象的方法</span><br>            user = <span class="hljs-built_in">this</span>.retrieveUser(username, (UsernamePasswordAuthenticationToken)authentication);<br>        &#125;<br>         <span class="hljs-comment">// 封装为Authentication对象	</span><br>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createSuccessAuthentication(principalToReturn, authentication, user);<br>    &#125;<br>	<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> &#123;<br>        <span class="hljs-keyword">return</span> UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> UserDetails <span class="hljs-title function_">retrieveUser</span><span class="hljs-params">(String var1, UsernamePasswordAuthenticationToken var2)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br><br>&#125;<br><br><span class="hljs-comment">// 通过 Dao检索校验</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DaoAuthenticationProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractUserDetailsAuthenticationProvider</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_NOT_FOUND_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;userNotFoundPassword&quot;</span>;<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> String userNotFoundEncodedPassword;<br>    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<br>    <br>    <span class="hljs-comment">// 调用UserDetailsService## loadUserByUsername() 获取 UserDetial</span><br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> UserDetails <span class="hljs-title function_">retrieveUser</span><span class="hljs-params">(String username, UsernamePasswordAuthenticationToken authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>       <span class="hljs-comment">// 通过缓存获取 或者 通过JdbcDaoImpl调用方法查询数据库获取</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">loadedUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(username);<br>        <span class="hljs-keyword">return</span> loadedUser;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411142606892.png" srcset="/img/loading.gif" lazyload alt="image-20230411142606892"></p>
<h3 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h3><p>通过用户名进行获取用户信息的方法接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="UserDetailsManager"><a href="#UserDetailsManager" class="headerlink" title="UserDetailsManager"></a>UserDetailsManager</h4><p>用户信息管理接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(UserDetails var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(UserDetails var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(String var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">changePassword</span><span class="hljs-params">(String var1, String var2)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">userExists</span><span class="hljs-params">(String var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="JdbcUserDetailsManager-JdbcDaoImpl"><a href="#JdbcUserDetailsManager-JdbcDaoImpl" class="headerlink" title="JdbcUserDetailsManager + JdbcDaoImpl"></a>JdbcUserDetailsManager + JdbcDaoImpl</h5><p>查询数据库获取UserDetails</p>
<p>JdbcUserDetailsManager :包含各种SQL语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// JdbcUserDetailsManager </span><br><span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">usersByUsernameQuery</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select username,password,enabled from users where username = ?&quot;</span>;<br><span class="hljs-comment">//JdbcDaoImpl</span><br><span class="hljs-keyword">protected</span> List&lt;UserDetails&gt; <span class="hljs-title function_">loadUsersByUsername</span><span class="hljs-params">(String username)</span> &#123;<br>    <span class="hljs-comment">// 调用JdbcUserDetailsManager的sql进行查询数据库</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getJdbcTemplate().query(<span class="hljs-built_in">this</span>.usersByUsernameQuery, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;username&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RowMapper</span>&lt;UserDetails&gt;() &#123;<br>        <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">mapRow</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> rowNum)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-number">1</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-number">2</span>);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">enabled</span> <span class="hljs-operator">=</span> rs.getBoolean(<span class="hljs-number">3</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(username, password, enabled, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, AuthorityUtils.NO_AUTHORITIES);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="InMemoryUserdetailsManager"><a href="#InMemoryUserdetailsManager" class="headerlink" title="InMemoryUserdetailsManager"></a>InMemoryUserdetailsManager</h5><p>查询缓存获取UserDetails</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (UserDetails)<span class="hljs-built_in">this</span>.users.get(username.toLowerCase());<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(username);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(user.getUsername(), user.getPassword(), user.isEnabled(), user.isAccountNonExpired(), user.isCredentialsNonExpired(), user.isAccountNonLocked(), user.getAuthorities());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>





<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411150420681.png" srcset="/img/loading.gif" lazyload alt="image-20230411150420681"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411141720762.png" srcset="/img/loading.gif" lazyload alt="image-20230411141720762"></p>
<h3 id="UserDetails"><a href="#UserDetails" class="headerlink" title="UserDetails"></a>UserDetails</h3><p>当前校验用户的详情信息 接口封装 — 仅用于 用户名&#x2F;密码 校验过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="User"><a href="#User" class="headerlink" title="User"></a>User</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span>, CredentialsContainer &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">500L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(User.class);<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;<br>    <span class="hljs-comment">// 当前被授予的角色权限</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;GrantedAuthority&gt; authorities;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> accountNonExpired;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> accountNonLocked;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> credentialsNonExpired;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> enabled;<br>    <span class="hljs-comment">// 实现凭证删除</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eraseCredentials</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.password = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 用于凭证的删除</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CredentialsContainer</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">eraseCredentials</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411150753639.png" srcset="/img/loading.gif" lazyload alt="image-20230411150753639"></p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="AbstractAuthenticationToken"><a href="#AbstractAuthenticationToken" class="headerlink" title="AbstractAuthenticationToken"></a>AbstractAuthenticationToken</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AbstractAuthenticationToken   -- token令牌</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Authentication</span>, CredentialsContainer &#123;<br>    <span class="hljs-comment">// 权限</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Collection&lt;GrantedAuthority&gt; authorities;<br>    <span class="hljs-comment">// 当前需要校验的信息    ----校验后：完善的信息</span><br>    <span class="hljs-keyword">private</span> Object details;<br>    <span class="hljs-comment">// 是否校验通过</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">authenticated</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411150954164.png" srcset="/img/loading.gif" lazyload alt="image-20230411150954164"></p>
<h5 id="UsernamePasswordAuthenticationToken"><a href="#UsernamePasswordAuthenticationToken" class="headerlink" title="UsernamePasswordAuthenticationToken"></a>UsernamePasswordAuthenticationToken</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">500L</span>;<br>    <span class="hljs-comment">// 主要的 == username ---</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<br>    <span class="hljs-comment">// 凭证 -- password ---</span><br>    <span class="hljs-keyword">private</span> Object credentials;<br>    <br>    <span class="hljs-comment">// UsernamePasswordAuthenticationFilter ## attemptAuthentication()</span><br>    <span class="hljs-comment">//  UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UsernamePasswordAuthenticationToken</span><span class="hljs-params">(Object principal, Object credentials)</span> &#123;<br>        <span class="hljs-built_in">super</span>((Collection)<span class="hljs-literal">null</span>);<br>        <span class="hljs-built_in">this</span>.principal = principal;<br>        <span class="hljs-built_in">this</span>.credentials = credentials;<br>        <span class="hljs-built_in">this</span>.setAuthenticated(<span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="SmsCodeAuthenticationTokne"><a href="#SmsCodeAuthenticationTokne" class="headerlink" title="SmsCodeAuthenticationTokne"></a>SmsCodeAuthenticationTokne</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsCodeAuthenticationToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411163450073.png" srcset="/img/loading.gif" lazyload alt="image-20230411163450073"></p>
<h3 id="GrantedAuthority"><a href="#GrantedAuthority" class="headerlink" title="GrantedAuthority"></a>GrantedAuthority</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取当前的权限列表 -- </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GrantedAuthority</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    String <span class="hljs-title function_">getAuthority</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleGrantedAuthority</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GrantedAuthority</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">500L</span>;<br>    <span class="hljs-comment">// 封装 被授予的角色权限 </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String role;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthority</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.role;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SimpleGrantedAuthority"><a href="#SimpleGrantedAuthority" class="headerlink" title="SimpleGrantedAuthority"></a>SimpleGrantedAuthority</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleGrantedAuthority</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GrantedAuthority</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">500L</span>;<br>    <span class="hljs-comment">// 封装 被授予的角色权限 </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String role;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthority</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.role;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411151307233.png" srcset="/img/loading.gif" lazyload alt="image-20230411151307233"></p>
<p>SecurityBuilder</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411141429570.png" srcset="/img/loading.gif" lazyload alt="image-20230411141429570"></p>
<h1 id="Spring-Security-OAuth2"><a href="#Spring-Security-OAuth2" class="headerlink" title="Spring Security OAuth2"></a>Spring Security OAuth2</h1><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903952643784711#heading-5">Spring Security 解析(七) —— Spring Security Oauth2 源码解析 - 掘金 (juejin.cn)</a></p>
<h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><p>两大流程：</p>
<p>一、访问授权服务器 &#x2F;oauth&#x2F;**路径，进入Endpoint进行相关处理，逻辑代码再Endpoint中；例如四种访问模式，最终通过Endpoint （在这解析request的信息  — grantType和BaseRequest子类） ，进入TokenGranter – （五个实现类）通过不同的逻辑最终生成OAuth2AccessToken &#x2F;  &#x2F;  ，然后通过TokenEnhance生成增强token</p>
<p>二、携带 系统定义的验证信息（用户名密码，短信验证） 通过SecurityConfigurationAdapter过滤器链的请求，通过解析URL转发到对应的过滤器（过滤器将信息，封装为 Authetication – token），调用对应的验证流程 (Provider)，生成最终的携带完整信息的Authentication （无法生成则说明验证不通过，抛出异常Handler），系统通过Authentication判断有无权限。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230414111137460.png" srcset="/img/loading.gif" lazyload alt="image-20230414111137460"></p>
<h2 id="配置类Configuration-过滤器链"><a href="#配置类Configuration-过滤器链" class="headerlink" title="配置类Configuration 过滤器链"></a>配置类Configuration 过滤器链</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c6ce913a3d52">spring cloud OAuth2资源服务器的过滤器链路浅析 - 简书 (jianshu.com)</a></p>
<p><img src="https://img-blog.csdnimg.cn/e9c06a4b707745fb8a8a6f2b58c85cb4.png#pic_center" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="SecurityBuilder-重点"><a href="#SecurityBuilder-重点" class="headerlink" title="SecurityBuilder - 重点"></a>SecurityBuilder - 重点</h2><p>用于构建 WebSecurity 的Filter 或者是 HttpSecurity的 FilterChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// WebSecurity ---Filter , HttpSecurity ---DefaultSecurityFilterChain  / SecurityFilterChain</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt; &#123;<br>    O <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415232218398.png" srcset="/img/loading.gif" lazyload alt="image-20230415232218398"></p>
<h3 id="AbstractSecurityBuilder"><a href="#AbstractSecurityBuilder" class="headerlink" title="AbstractSecurityBuilder"></a>AbstractSecurityBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSecurityBuilder</span>&lt;O&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">building</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>();<br>    <span class="hljs-keyword">private</span> O object;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> O <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.building.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) &#123;<br>            <span class="hljs-built_in">this</span>.object = <span class="hljs-built_in">this</span>.doBuild();<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.object;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 抽象方法 ---子类实现 AbstractConfiguredSecurityBuilder ## doBuild()</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> O <span class="hljs-title function_">doBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AbstractConfiguredSecurityBuilder-重点"><a href="#AbstractConfiguredSecurityBuilder-重点" class="headerlink" title="AbstractConfiguredSecurityBuilder - 重点"></a>AbstractConfiguredSecurityBuilder - 重点</h3><p>持有 SecurityConfigurer接口的子类</p>
<p>统一调度 SecurityConfigurer接口的init() 和 config() 方法 SecurityConfigurerAdapter和 WebSecurityConfigurerAdapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// B  WebSecurity ---O Filter , B  HttpSecurity ---O  DefaultSecurityFilterChain/SecurityFilterChain</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSecurityBuilder</span>&lt;O&gt; &#123;<br>    <span class="hljs-comment">// 当前的SecurityConfigurer的子类</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LinkedHashMap&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt;&gt;, List&lt;SecurityConfigurer&lt;O, B&gt;&gt;&gt; configurers;<br>    <span class="hljs-comment">// 自定义添加的 SecurityConfigurer子类</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurersAddedInInitializing;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Object</span>&gt;, Object&gt; sharedObjects;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> allowConfigurersOfSameType;<br>    <span class="hljs-comment">// 配置方法构建状态状态</span><br>    <span class="hljs-keyword">private</span> AbstractConfiguredSecurityBuilder.BuildState buildState;<br>    <br>    <span class="hljs-comment">// 子类实现-- HttpSecurity - WebSecurity -- AuthenticationManagerBuilder</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> O <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>   <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> O <span class="hljs-title function_">doBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.configurers) &#123;<br>            <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.INITIALIZING;<br>            <span class="hljs-built_in">this</span>.beforeInit();<br>            <span class="hljs-comment">/*Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = this.getConfigurers();</span><br><span class="hljs-comment">            Iterator var2 = configurers.iterator();</span><br><span class="hljs-comment">            SecurityConfigurer configurer;</span><br><span class="hljs-comment">            while(var2.hasNext()) &#123;</span><br><span class="hljs-comment">                    configurer = (SecurityConfigurer)var2.next();</span><br><span class="hljs-comment">                    configurer.init(this);</span><br><span class="hljs-comment">            &#125;*/</span><br>            <span class="hljs-built_in">this</span>.init();<br>            <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.CONFIGURING;<br>            <span class="hljs-built_in">this</span>.beforeConfigure();<br>            <span class="hljs-built_in">this</span>.configure();<br>            <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.BUILDING;<br>            <span class="hljs-comment">// 获取 WebSecurity的filter ， HttpSecurity的</span><br>            <span class="hljs-type">O</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.performBuild();<br>            <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.BUILT;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// SecurityConfigurer的 init()方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = <span class="hljs-built_in">this</span>.getConfigurers();<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> configurers.iterator();<br><br>        SecurityConfigurer configurer;<br>        <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>            configurer = (SecurityConfigurer)var2.next();<br>            configurer.init(<span class="hljs-built_in">this</span>);<br>        &#125;<br>		<span class="hljs-comment">// </span><br>        var2 = <span class="hljs-built_in">this</span>.configurersAddedInInitializing.iterator();<br><br>        <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>            configurer = (SecurityConfigurer)var2.next();<br>            configurer.init(<span class="hljs-built_in">this</span>);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-comment">// SecurityConfigurer的 configure()</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = <span class="hljs-built_in">this</span>.getConfigurers();<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> configurers.iterator();<br><br>        <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>            SecurityConfigurer&lt;O, B&gt; configurer = (SecurityConfigurer)var2.next();<br>            configurer.configure(<span class="hljs-built_in">this</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="WebSecurity"><a href="#WebSecurity" class="headerlink" title="WebSecurity"></a>WebSecurity</h3><p>初始化：被 WebSecurityConfiguration （@EnableWebConfiguration）创建</p>
<p>作用：<strong>用于构建FilterChainProxy ，</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*The WebSecurity is created by WebSecurityConfiguration to create the FilterChainProxy known as the Spring Security Filter Chain (springSecurityFilterChain). The springSecurityFilterChain is the Filter that the DelegatingFilterProxy delegates to.</span><br><span class="hljs-comment">Customizations to the WebSecurity can be made by creating a WebSecurityConfigurer or more likely by overriding WebSecurityConfigurerAdapter.</span><br><span class="hljs-comment">Since:</span><br><span class="hljs-comment">3.2</span><br><span class="hljs-comment">See Also:</span><br><span class="hljs-comment">EnableWebSecurity, WebSecurityConfiguration*/</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;Filter, WebSecurity&gt; <br>    		<span class="hljs-comment">// O-- Filter -- 构建</span><br><span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;Filter&gt;, ApplicationContextAware &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;RequestMatcher&gt; ignoredRequests = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;SecurityBuilder&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityFilterChain</span>&gt;&gt; securityFilterChainBuilders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-keyword">private</span> WebSecurity.IgnoredRequestConfigurer ignoredRequestRegistry;<br>    <span class="hljs-keyword">private</span> FilterSecurityInterceptor filterSecurityInterceptor;<br>    <span class="hljs-keyword">private</span> HttpFirewall httpFirewall;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> debugEnabled;<br>    <span class="hljs-keyword">private</span> WebInvocationPrivilegeEvaluator privilegeEvaluator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">DefaultWebSecurityExpressionHandler</span> <span class="hljs-variable">defaultWebSecurityExpressionHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebSecurityExpressionHandler</span>();<br>    <span class="hljs-keyword">private</span> SecurityExpressionHandler&lt;FilterInvocation&gt; expressionHandler;<br>    <span class="hljs-keyword">private</span> Runnable postBuildAction;<br>    <span class="hljs-comment">// FilterChainProxy ---管理一些列的过滤器执行链（包含多个过滤器）</span><br>    <span class="hljs-keyword">protected</span> Filter <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">chainSize</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.ignoredRequests.size() + <span class="hljs-built_in">this</span>.securityFilterChainBuilders.size();<br>        <span class="hljs-comment">// </span><br>        List&lt;SecurityFilterChain&gt; securityFilterChains = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(chainSize);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.ignoredRequests.iterator();<br><br>        <span class="hljs-keyword">while</span>(var3.hasNext()) &#123;<br>            <span class="hljs-type">RequestMatcher</span> <span class="hljs-variable">ignoredRequest</span> <span class="hljs-operator">=</span> (RequestMatcher)var3.next();<br>            <span class="hljs-comment">// 添加 DefaultSecurityFilterChain - </span><br>            securityFilterChains.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityFilterChain</span>(ignoredRequest, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>[<span class="hljs-number">0</span>]));<br>        &#125;<br><br>        var3 = <span class="hljs-built_in">this</span>.securityFilterChainBuilders.iterator();<br><br>        <span class="hljs-keyword">while</span>(var3.hasNext()) &#123;<br>            SecurityBuilder&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityFilterChain</span>&gt; securityFilterChainBuilder = (SecurityBuilder)var3.next();<br>            securityFilterChains.add(securityFilterChainBuilder.build());<br>        &#125;<br>		<span class="hljs-comment">// 构建FilterChainProxy ----过滤器执行链，有多个过滤器链</span><br>        <span class="hljs-type">FilterChainProxy</span> <span class="hljs-variable">filterChainProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterChainProxy</span>(securityFilterChains);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.httpFirewall != <span class="hljs-literal">null</span>) &#123;<br>            filterChainProxy.setFirewall(<span class="hljs-built_in">this</span>.httpFirewall);<br>        &#125;<br><br>        filterChainProxy.afterPropertiesSet();<br>        <span class="hljs-type">Filter</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> filterChainProxy;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.debugEnabled) &#123;<br>            result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DebugFilter</span>(filterChainProxy);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.postBuildAction.run();<br>        <span class="hljs-keyword">return</span> (Filter)result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="HttpSecurity"><a href="#HttpSecurity" class="headerlink" title="HttpSecurity"></a>HttpSecurity</h3><p>初始化：被SecurityConfigurerAdapter （AuthorizationServerSecurityConfigurer等子类） 构建</p>
<p>作用：它允许为特定的http请求配置基于web的安全性。默认情况下，它将应用于所有请求，但可以使用requestMatcher(requestMatcher)或其他类似方法进行限制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// O -- DefaultSecurityFilterChain -- B-- HttpSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpSecurity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractConfiguredSecurityBuilder</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt;, HttpSecurityBuilder&lt;HttpSecurity&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpSecurity.RequestMatcherConfigurer requestMatcherConfigurer;<br>    <span class="hljs-comment">// 过滤器链</span><br>    <span class="hljs-keyword">private</span> List&lt;Filter&gt; filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-comment">// 路径匹配判断</span><br>    <span class="hljs-keyword">private</span> RequestMatcher requestMatcher;<br> 	<span class="hljs-comment">// 重写Order排序</span><br>    <span class="hljs-keyword">private</span> FilterComparator comparator;<br>    <br>     <span class="hljs-keyword">protected</span> DefaultSecurityFilterChain <span class="hljs-title function_">performBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Collections.sort(<span class="hljs-built_in">this</span>.filters, <span class="hljs-built_in">this</span>.comparator);<br>         <span class="hljs-comment">// 封装为 DefaultSecurityFilterChain</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityFilterChain</span>(<span class="hljs-built_in">this</span>.requestMatcher, <span class="hljs-built_in">this</span>.filters);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// DefaultSecurityFilterChain</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSecurityFilterChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityFilterChain</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RequestMatcher requestMatcher;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Filter&gt; filters;<br><br>&#125;<br><br><span class="hljs-comment">/*The most basic form based configuration can be seen below. The configuration will require that any URL that is requested will require a User with the role &quot;ROLE_USER&quot;. It also defines an in memory authentication scheme with a user that has the username &quot;user&quot;, the password &quot;password&quot;, and the role &quot;ROLE_USER&quot;. For additional examples, refer to the Java Doc of individual methods on HttpSecurity.</span><br><span class="hljs-comment">   @Configuration</span><br><span class="hljs-comment">   @EnableWebSecurity</span><br><span class="hljs-comment">   public class FormLoginSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">   	@Override</span><br><span class="hljs-comment">   	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="hljs-comment">   		http.authorizeRequests().antMatchers(&quot;/**&quot;).hasRole(&quot;USER&quot;).and().formLogin();</span><br><span class="hljs-comment">   	&#125;</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">   	@Override</span><br><span class="hljs-comment">   	protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="hljs-comment">   		auth.inMemoryAuthentication().withUser(&quot;user&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;);</span><br><span class="hljs-comment">   	&#125;</span><br><span class="hljs-comment">   &#125;</span><br><span class="hljs-comment">   */</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411200251565.png" srcset="/img/loading.gif" lazyload alt="image-20230411200251565"></p>
<h2 id="RequestMatcher-组件"><a href="#RequestMatcher-组件" class="headerlink" title="RequestMatcher - 组件"></a>RequestMatcher - 组件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestMatcher</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AntPathRequestMatcher"><a href="#AntPathRequestMatcher" class="headerlink" title="AntPathRequestMatcher"></a>AntPathRequestMatcher</h3><p>用于配置过滤器路径，判断是否匹配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AntPathRequestMatcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestMatcher</span>, RequestVariablesExtractor &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(AntPathRequestMatcher.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MATCH_ALL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/**&quot;</span>;<br>    <span class="hljs-comment">// 保存匹配路径</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AntPathRequestMatcher.Matcher matcher;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String pattern;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpMethod httpMethod;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> caseSensitive;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UrlPathHelper urlPathHelper;<br>	<span class="hljs-comment">// 内部接口</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Matcher</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String var1)</span>;<br><br>        Map&lt;String, String&gt; <span class="hljs-title function_">extractUriTemplateVariables</span><span class="hljs-params">(String var1)</span>;<br>    &#125;<br>    <span class="hljs-comment">// 调用spring工具包进行判断</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringAntMatcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AntPathRequestMatcher</span>.Matcher &#123;<br>        <span class="hljs-comment">// 匹配</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AntPathMatcher antMatcher;<br>        <span class="hljs-comment">// 路径</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String pattern;<br>    &#125;<br>    <span class="hljs-comment">// /**前缀匹配判断</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubpathMatcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AntPathRequestMatcher</span>.Matcher &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String subpath;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> length;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> caseSensitive;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AndRequestMatcher"><a href="#AndRequestMatcher" class="headerlink" title="AndRequestMatcher"></a>AndRequestMatcher</h3><p>校验方式的一种</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AndRequestMatcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestMatcher</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Log logger;<br>   <span class="hljs-comment">// 多个RequestMatcher</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;RequestMatcher&gt; requestMatchers;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AndRequestMatcher</span><span class="hljs-params">(List&lt;RequestMatcher&gt; requestMatchers)</span> &#123;<br>        <span class="hljs-built_in">this</span>.requestMatchers = requestMatchers;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AndRequestMatcher</span><span class="hljs-params">(RequestMatcher... requestMatchers)</span> &#123;<br>        <span class="hljs-built_in">this</span>(Arrays.asList(requestMatchers));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.requestMatchers.iterator();<br>        RequestMatcher matcher;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-keyword">if</span> (!var2.hasNext()) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;All requestMatchers returned true&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            matcher = (RequestMatcher)var2.next();<br>            <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Trying to match using &quot;</span> + matcher);<br>            &#125;<br>        <span class="hljs-comment">// 调用具体的matches()方法实现 === Ip，Regex，MvcRequest, RequestHeader</span><br>        &#125; <span class="hljs-keyword">while</span>(matcher.matches(request));<br><br>        <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Did not match&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// IP</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.matches(request.getRemoteAddr());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String address)</span> &#123;<br>        <span class="hljs-type">InetAddress</span> <span class="hljs-variable">remoteAddress</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.parseAddress(address);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.requiredAddress.getClass().equals(remoteAddress.getClass())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.nMaskBits &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> remoteAddress.equals(<span class="hljs-built_in">this</span>.requiredAddress);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">byte</span>[] remAddr = remoteAddress.getAddress();<br>            <span class="hljs-type">byte</span>[] reqAddr = <span class="hljs-built_in">this</span>.requiredAddress.getAddress();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">oddBits</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.nMaskBits % <span class="hljs-number">8</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">nMaskBytes</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.nMaskBits / <span class="hljs-number">8</span> + (oddBits == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);<br>            <span class="hljs-type">byte</span>[] mask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[nMaskBytes];<br>            Arrays.fill(mask, <span class="hljs-number">0</span>, oddBits == <span class="hljs-number">0</span> ? mask.length : mask.length - <span class="hljs-number">1</span>, (<span class="hljs-type">byte</span>)-<span class="hljs-number">1</span>);<br>            <span class="hljs-type">int</span> i;<br>            <span class="hljs-keyword">if</span> (oddBits != <span class="hljs-number">0</span>) &#123;<br>                i = (<span class="hljs-number">1</span> &lt;&lt; oddBits) - <span class="hljs-number">1</span>;<br>                i &lt;&lt;= <span class="hljs-number">8</span> - oddBits;<br>                mask[mask.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>)i;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; mask.length; ++i) &#123;<br>                <span class="hljs-keyword">if</span> ((remAddr[i] &amp; mask[i]) != (reqAddr[i] &amp; mask[i])) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415233714075.png" srcset="/img/loading.gif" lazyload alt="image-20230415233714075"></p>
<h2 id="SecurityConfigurer-–-重点"><a href="#SecurityConfigurer-–-重点" class="headerlink" title="SecurityConfigurer – 重点"></a>SecurityConfigurer – 重点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 泛型B -- WebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(B var1)</span> <span class="hljs-keyword">throws</span> Exception;<br>	<span class="hljs-comment">// B -- WebSecurity / HttpSecurity </span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(B var1)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415231804100.png" srcset="/img/loading.gif" lazyload alt="image-20230415231804100"></p>
<h3 id="SecurityConfigurerAdapter-1"><a href="#SecurityConfigurerAdapter-1" class="headerlink" title="SecurityConfigurerAdapter"></a>SecurityConfigurerAdapter</h3><p> 持有 <strong>SecurityBuilder</strong>（串联SecurityBuilder 和SeucrityConfigrer），可以调用其方法build()，构建configuration</p>
<p>用于<strong>配置HttpSecurity和 构建 DefaultFilterChain</strong></p>
<p>会被 SecurityBuilder 调用 init() 和 config()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;O, B <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;O&gt;&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;O, B&gt; &#123;<br>    <span class="hljs-comment">// 持有 securityBuilder，可以调用其方法build()，构建configuration</span><br>    <span class="hljs-keyword">private</span> B securityBuilder;<br>    <span class="hljs-keyword">private</span> SecurityConfigurerAdapter.<span class="hljs-type">CompositeObjectPostProcessor</span> <span class="hljs-variable">objectPostProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>.CompositeObjectPostProcessor();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AuthorizationServerSecurityConfigurer"><a href="#AuthorizationServerSecurityConfigurer" class="headerlink" title="AuthorizationServerSecurityConfigurer"></a>AuthorizationServerSecurityConfigurer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 向上传递泛型 为 O ---DefaultSecurityFilterChain, B -- HttpSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerSecurityConfigurer</span> <span class="hljs-keyword">extends</span><br>      <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt; &#123;<br>	<span class="hljs-comment">// </span><br>   <span class="hljs-keyword">private</span> AuthenticationEntryPoint authenticationEntryPoint;<br>	<span class="hljs-comment">// 访问异常处理</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">AccessDeniedHandler</span> <span class="hljs-variable">accessDeniedHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2AccessDeniedHandler</span>();<br>	<span class="hljs-comment">// 配置密码的加密方式</span><br>   <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder; <span class="hljs-comment">// for client secrets</span><br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">realm</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;oauth2/client&quot;</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">allowFormAuthenticationForClients</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">tokenKeyAccess</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;denyAll()&quot;</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">checkTokenAccess</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;denyAll()&quot;</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">sslOnly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415235732084.png" srcset="/img/loading.gif" lazyload alt="image-20230415235732084"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415235922873.png" srcset="/img/loading.gif" lazyload alt="image-20230415235922873"></p>
<h3 id="WebSecurityConfigurer-1"><a href="#WebSecurityConfigurer-1" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h3><p>一个空接口，用于与SecurityConfigurer区别 —- 用于配置WebSecurity</p>
<h3 id="WebSecurityConfigurerAdapter-1"><a href="#WebSecurityConfigurerAdapter-1" class="headerlink" title="WebSecurityConfigurerAdapter"></a>WebSecurityConfigurerAdapter</h3><p>[注解](#注解引入配置类  - 入口)</p>
<p>作用 – 用于配置WebSecurity 和  构建Filter</p>
<p>会被 SecurityBuilder 调用 init() 和 config()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WebSecurityConfigurer</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;Filter&gt;&gt; <span class="hljs-keyword">extends</span><br>		<span class="hljs-title class_">SecurityConfigurer</span>&lt;Filter, T&gt; &#123;<br>&#125;<br><br><span class="hljs-meta">@Order(100)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSecurityConfigurer</span>&lt;WebSecurity&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Log logger;<br>    <span class="hljs-keyword">private</span> ApplicationContext context;<br>    <span class="hljs-keyword">private</span> ContentNegotiationStrategy contentNegotiationStrategy;<br>    <span class="hljs-keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectPostProcessor;<br>    <span class="hljs-comment">// Authentication（授权）配置</span><br>    <span class="hljs-keyword">private</span> AuthenticationConfiguration authenticationConfiguration;<br>    <span class="hljs-keyword">private</span> AuthenticationManagerBuilder authenticationBuilder;<br>    <span class="hljs-keyword">private</span> AuthenticationManagerBuilder localConfigureAuthenticationBldr;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> disableLocalConfigureAuthenticationBldr;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> authenticationManagerInitialized;<br>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-keyword">private</span> AuthenticationTrustResolver trustResolver;<br>    <span class="hljs-keyword">private</span> HttpSecurity http;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> disableDefaults;<br>	<br>    <span class="hljs-comment">// WebSecurity 继承自 父接口</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br>	<span class="hljs-comment">// 子类重写配置方法</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        ((HttpSecurity)((HttpSecurity)((AuthorizedUrl)http.authorizeRequests().anyRequest()).authenticated().and()).formLogin().and()).httpBasic();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225357091.png" srcset="/img/loading.gif" lazyload alt="image-20230415225357091"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416000039830.png" srcset="/img/loading.gif" lazyload alt="image-20230416000039830"></p>
<h4 id="ResourceServerConfiguration"><a href="#ResourceServerConfiguration" class="headerlink" title="ResourceServerConfiguration"></a>ResourceServerConfiguration</h4><p>通过**@EnableResourceServer**注解引入，调度 ResourceServerConfigurer的方法 config()，添加各种配置信息，例如 资源服务器配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceServerConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><br>   <span class="hljs-meta">@Autowired(required = false)</span><br>   <span class="hljs-keyword">private</span> TokenStore tokenStore;<br>   <span class="hljs-meta">@Autowired(required = false)</span><br>   <span class="hljs-keyword">private</span> AuthenticationEventPublisher eventPublisher;<br><br>   <span class="hljs-meta">@Autowired(required = false)</span><br>   <span class="hljs-keyword">private</span> Map&lt;String, ResourceServerTokenServices&gt; tokenServices;<br><br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> ApplicationContext context;<br>	<span class="hljs-comment">// 调度 ResourceServerConfigurer</span><br>   <span class="hljs-keyword">private</span> List&lt;ResourceServerConfigurer&gt; configurers = Collections.emptyList();<br><br>   <span class="hljs-meta">@Autowired(required = false)</span><br>    <span class="hljs-comment">// @EnableAuthorizationServer  ##  @Import(&#123;AuthorizationServerEndpointsConfiguration.class&#125;)</span><br>   <span class="hljs-keyword">private</span> AuthorizationServerEndpointsConfiguration endpoints;<br>    <span class="hljs-comment">/*@Target(ElementType.TYPE)</span><br><span class="hljs-comment">    @Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-comment">    @Documented</span><br><span class="hljs-comment">    @Import(&#123;AuthorizationServerEndpointsConfiguration.class, AuthorizationServerSecurityConfiguration.class&#125;)</span><br><span class="hljs-comment">    public @interface EnableAuthorizationServer &#123;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    &#125;*/</span><br></code></pre></td></tr></table></figure>



<h4 id="AuthorizationServerSecurityConfiguration"><a href="#AuthorizationServerSecurityConfiguration" class="headerlink" title="AuthorizationServerSecurityConfiguration"></a>AuthorizationServerSecurityConfiguration</h4><p>通过**@EnableAuthorizationServer**注解 引入，调度 AuthorizationServerConfigurer的方法 config()，添加各种配置信息，（下文有详情 <a href="#@EnableAuthorizationServer">@EnableAuthorizationServer</a>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Order(0)</span><br><span class="hljs-meta">@Import(&#123; ClientDetailsServiceConfiguration.class, AuthorizationServerEndpointsConfiguration.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerSecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>   <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-comment">// AuthorizationServerConfigurer</span><br>   <span class="hljs-keyword">private</span> List&lt;AuthorizationServerConfigurer&gt; configurers = Collections.emptyList();<br><br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>f<img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416102157558.png" srcset="/img/loading.gif" lazyload alt="image-20230416102157558"></p>
<h2 id="Configurer"><a href="#Configurer" class="headerlink" title="Configurer"></a>Configurer</h2><p>WebSecurityConfigurerAdapter的子类 — （WebSecurity）</p>
<p>被<strong>ResourceServerConfiguration</strong> 和 <strong>AuthorizationServerSecurityConfiguration</strong> 持有</p>
<p>用于配置信息</p>
<h3 id="ResourceServerConfigurer"><a href="#ResourceServerConfigurer" class="headerlink" title="ResourceServerConfigurer"></a>ResourceServerConfigurer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceServerConfigurer</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Add resource-server specific properties (like a resource id). The defaults should work for many applications, but</span><br><span class="hljs-comment">	 * you might want to change at least the resource id.</span><br><span class="hljs-comment">	 * </span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> resources configurer for the resource server</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception if there is a problem</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Use this to configure the access rules for secure resources. By default all resources &lt;i&gt;not&lt;/i&gt; in &quot;/oauth/**&quot;</span><br><span class="hljs-comment">	 * are protected (but no specific rules about scopes are given, for instance). You also get an</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> OAuth2WebSecurityExpressionHandler&#125; by default.</span><br><span class="hljs-comment">	 * </span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> http the current http filter configuration</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception if there is a problem</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ResourceServerConfigurerAdapter"><a href="#ResourceServerConfigurerAdapter" class="headerlink" title="ResourceServerConfigurerAdapter"></a>ResourceServerConfigurerAdapter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResourceServerConfigurer</span> &#123;<br><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>   &#125;<br><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      http.authorizeRequests().anyRequest().authenticated();<br>   &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225845688.png" srcset="/img/loading.gif" lazyload alt="image-20230415225845688"></p>
<h4 id="ResourceSecurityConfigurer"><a href="#ResourceSecurityConfigurer" class="headerlink" title="ResourceSecurityConfigurer"></a>ResourceSecurityConfigurer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 也是用于自动注入 org.springframework.boot.autoconfigure</span><br><span class="hljs-keyword">package</span> org.springframework.boot.autoconfigure.security.oauth2.resource;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Conditional(&#123;OAuth2ResourceServerConfiguration.ResourceServerCondition.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnClass(&#123;EnableResourceServer.class, SecurityProperties.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnWebApplication</span><br><span class="hljs-meta">@ConditionalOnBean(&#123;ResourceServerConfiguration.class&#125;)</span><br><span class="hljs-comment">// </span><br><span class="hljs-meta">@Import(&#123;ResourceServerTokenServicesConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2ResourceServerConfiguration</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceServerProperties resource;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> &#123;<br>        <span class="hljs-keyword">private</span> ResourceServerProperties resource;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResourceSecurityConfigurer</span><span class="hljs-params">(ResourceServerProperties resource)</span> &#123;<br>            <span class="hljs-built_in">this</span>.resource = resource;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            resources.resourceId(<span class="hljs-built_in">this</span>.resource.getResourceId());<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            ((AuthorizedUrl)http.authorizeRequests().anyRequest()).authenticated();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416103930151.png" srcset="/img/loading.gif" lazyload alt="image-20230416103930151"></p>
<h3 id="AuthorizationServerConfigurer"><a href="#AuthorizationServerConfigurer" class="headerlink" title="AuthorizationServerConfigurer"></a>AuthorizationServerConfigurer</h3><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416104056853.png" srcset="/img/loading.gif" lazyload alt="image-20230416104056853"></p>
<p>AuthorizationServerSecurityConfigurer</p>
<p>ClientDetailsServiceConfigurer</p>
<p>AuthorizationServerEndpointsConfigurer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*an OAUth2 Authorization Server配置. 通过 @EnableAuthorizationServer.注入*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthorizationServerConfigurer</span> &#123;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * /oauth/token endpoint. The</span><br><span class="hljs-comment">    * /oauth/authorize endpoint also needs to be secure, but that is a normal user-facing endpoint and should be</span><br><span class="hljs-comment">    * secured the same way as the rest of your UI, so is not covered here. </span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerSecurityConfigurer security)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Configure the &#123;<span class="hljs-doctag">@link</span> ClientDetailsService&#125;, e.g. declaring individual clients and their properties. Note that</span><br><span class="hljs-comment">    * password grant is not enabled (even if some clients are allowed it) unless an &#123;<span class="hljs-doctag">@link</span> AuthenticationManager&#125; is</span><br><span class="hljs-comment">    * supplied to the &#123;<span class="hljs-doctag">@link</span> #configure(AuthorizationServerEndpointsConfigurer)&#125;. At least one client, or a fully</span><br><span class="hljs-comment">    * formed custom &#123;<span class="hljs-doctag">@link</span> ClientDetailsService&#125; must be declared or the server will not start.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> clients the client details configurer</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Configure the non-security features of the Authorization Server endpoints, like token store, token</span><br><span class="hljs-comment">    * customizations, user approvals and grant types. You shouldn&#x27;t need to do anything by default, unless you need</span><br><span class="hljs-comment">    * password grants, in which case you need to provide an &#123;<span class="hljs-doctag">@link</span> AuthenticationManager&#125;.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> endpoints the endpoints configurer</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AuthorizationServerConfigurerAdapter"><a href="#AuthorizationServerConfigurerAdapter" class="headerlink" title="AuthorizationServerConfigurerAdapter"></a>AuthorizationServerConfigurerAdapter</h4><p>适配器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthorizationServerConfigurer</span> &#123;<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerSecurityConfigurer security)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	&#125;<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	&#125;<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>AuthorizationServerConfigurerAdapter</p>
<h4 id="OAuth2AuthorizationServerConfiguration"><a href="#OAuth2AuthorizationServerConfiguration" class="headerlink" title="OAuth2AuthorizationServerConfiguration"></a>OAuth2AuthorizationServerConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Spring Boot整合security.oauth2</span><br><span class="hljs-keyword">package</span> org.springframework.boot.autoconfigure.security.oauth2.authserver;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnClass(&#123;EnableAuthorizationServer.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnMissingBean(&#123;AuthorizationServerConfigurer.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnBean(&#123;AuthorizationServerEndpointsConfiguration.class&#125;)</span><br><span class="hljs-comment">// 引入配置类 ---spring boot auto-configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123;AuthorizationServerProperties.class&#125;)</span><br><span class="hljs-comment">// JWT xx</span><br><span class="hljs-meta">@Import(&#123;AuthorizationServerTokenServicesConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2AuthorizationServerConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(OAuth2AuthorizationServerConfiguration.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BaseClientDetails details;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TokenStore tokenStore;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AccessTokenConverter tokenConverter;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthorizationServerProperties properties;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225945367.png" srcset="/img/loading.gif" lazyload alt="image-20230415225945367"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230415225321835.png" srcset="/img/loading.gif" lazyload alt="image-20230415225321835"></p>
<h2 id="注解引入配置类-入口"><a href="#注解引入配置类-入口" class="headerlink" title="注解引入配置类  - 入口"></a>注解引入配置类  - 入口</h2><h4 id="EnableWebSecurity-1"><a href="#EnableWebSecurity-1" class="headerlink" title="@EnableWebSecurity"></a>@EnableWebSecurity</h4><p>引入<strong>WebSecurityConfiguration</strong> 和 <strong>SpringWebMvcImportSelector</strong>配置类</p>
<p>打开Spring Security配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;WebSecurityConfiguration.class, SpringWebMvcImportSelector.class&#125;)</span><br><span class="hljs-meta">@EnableGlobalAuthentication</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableWebSecurity &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">/*@EnableGlobalAuthentication*/</span><br><span class="hljs-meta">@Retention(value = java.lang.annotation.RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(value = &#123; java.lang.annotation.ElementType.TYPE &#125;)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(AuthenticationConfiguration.class)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableGlobalAuthentication &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="WebSecurityConfiguration"><a href="#WebSecurityConfiguration" class="headerlink" title="WebSecurityConfiguration"></a>WebSecurityConfiguration</h5><p>持有SecurityConfigurer –》 webSecurityConfigurers 用于构建WebSecurity </p>
<p>SecurityConfigurer（关键） 用于串联 – SecurityBuilder（关键）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportAware</span>, BeanClassLoaderAware &#123;<br>    <span class="hljs-comment">// 构建 WebSecurity</span><br>   <span class="hljs-keyword">private</span> WebSecurity webSecurity;<br><br>   <span class="hljs-keyword">private</span> Boolean debugEnabled;<br>	<span class="hljs-comment">// webSecurityConfigurers 用于构建</span><br>   <span class="hljs-keyword">private</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers;<br><br>   <span class="hljs-keyword">private</span> ClassLoader beanClassLoader;<br><br>   <span class="hljs-meta">@Autowired(required = false)</span><br>   <span class="hljs-keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectObjectPostProcessor;<br></code></pre></td></tr></table></figure>



<h5 id="SpringWebMvcImportSelector"><a href="#SpringWebMvcImportSelector" class="headerlink" title="SpringWebMvcImportSelector"></a>SpringWebMvcImportSelector</h5><p>用于获取WebMvcSecurityConfiguration，将其注入BeanFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringWebMvcImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>    SpringWebMvcImportSelector() &#123;<br>    &#125;<br><br>    <span class="hljs-comment">// 判断能否DispatcherServlet是否已经记载（MVC的分配类）</span><br>    <span class="hljs-comment">// 不能就返回 WebMvcSecurityConfiguration的全路径</span><br>    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">webmvcPresent</span> <span class="hljs-operator">=</span> ClassUtils.isPresent(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>        <span class="hljs-keyword">return</span> webmvcPresent ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration&quot;</span>&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="EnableResourceServer-1"><a href="#EnableResourceServer-1" class="headerlink" title="@EnableResourceServer"></a>@EnableResourceServer</h4><p>继承自WebSecurityConfigurerAdapter</p>
<p>引入配置类<strong>ResourceServerConfiguration</strong> – Oauth2的资源服务器</p>
<p><strong>开启资源服务器配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;ResourceServerConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableResourceServer &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="ResourceServerConfiguration-1"><a href="#ResourceServerConfiguration-1" class="headerlink" title="ResourceServerConfiguration"></a>ResourceServerConfiguration</h5><p>资源服务器配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceServerConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-meta">@Autowired(</span><br><span class="hljs-meta">        required = false</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-keyword">private</span> TokenStore tokenStore;<br>    <span class="hljs-meta">@Autowired(</span><br><span class="hljs-meta">        required = false</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-keyword">private</span> AuthenticationEventPublisher eventPublisher;<br>    <span class="hljs-meta">@Autowired(</span><br><span class="hljs-meta">        required = false</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-comment">// ResourceServerTokenServices 远程调用代理实现类 --</span><br>    <span class="hljs-comment">// 接口，用于（代理）获取Authentication 鉴权</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, ResourceServerTokenServices&gt; tokenServices;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext context;<br>    <span class="hljs-comment">// 持有 ResourceServerConfigurer ----实现类为XXXAdapter</span><br>    <span class="hljs-keyword">private</span> List&lt;ResourceServerConfigurer&gt; configurers = Collections.emptyList();<br>    <span class="hljs-meta">@Autowired(</span><br><span class="hljs-meta">        required = false</span><br><span class="hljs-meta">    )</span> <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> AuthorizationServerEndpointsConfiguration endpoints;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411203927984.png" srcset="/img/loading.gif" lazyload alt="image-20230411203927984"></p>
<h4 id="EnableAuthorizationServer-1"><a href="#EnableAuthorizationServer-1" class="headerlink" title="@EnableAuthorizationServer"></a>@EnableAuthorizationServer</h4><p>&lt;span id &#x3D; “@EnableAuthorizationServer2”&gt;@EnableAuthorizationServer </span></p>
<p>WebSecurityConfigurerAdapter管理这两个类</p>
<p>引入<strong>AuthorizationServerSecurityConfiguration</strong> 和 <strong>AuthorizationServerEndpointsConfiguration</strong>配置类 </p>
<p>​			– Oauth2的认证服务器配置</p>
<p><strong>开启授权服务器配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;AuthorizationServerEndpointsConfiguration.class, AuthorizationServerSecurityConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAuthorizationServer &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="AuthorizationServerSecurityConfiguration-1"><a href="#AuthorizationServerSecurityConfiguration-1" class="headerlink" title="AuthorizationServerSecurityConfiguration"></a>AuthorizationServerSecurityConfiguration</h5><p>配置认证服务器配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerSecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> List&lt;AuthorizationServerConfigurer&gt; configurers = Collections.emptyList();<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthorizationServerEndpointsConfiguration endpoints;<br><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">AuthorizationServerSecurityConfigurer</span> <span class="hljs-variable">configurer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationServerSecurityConfigurer</span>();<br>        <span class="hljs-type">FrameworkEndpointHandlerMapping</span> <span class="hljs-variable">handlerMapping</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.endpoints.oauth2EndpointHandlerMapping();<br>        http.setSharedObject(FrameworkEndpointHandlerMapping.class, handlerMapping);<br>        <span class="hljs-built_in">this</span>.configure(configurer);<br>        http.apply(configurer);<br>        <span class="hljs-comment">// 配置默认 不需要拦截的路径</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">tokenEndpointPath</span> <span class="hljs-operator">=</span> handlerMapping.getServletPath(<span class="hljs-string">&quot;/oauth/token&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tokenKeyPath</span> <span class="hljs-operator">=</span> handlerMapping.getServletPath(<span class="hljs-string">&quot;/oauth/token_key&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">checkTokenPath</span> <span class="hljs-operator">=</span> handlerMapping.getServletPath(<span class="hljs-string">&quot;/oauth/check_token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.endpoints.getEndpointsConfigurer().isUserDetailsServiceOverride()) &#123;<br>            <span class="hljs-type">UserDetailsService</span> <span class="hljs-variable">userDetailsService</span> <span class="hljs-operator">=</span> (UserDetailsService)http.getSharedObject(UserDetailsService.class);<br>            <span class="hljs-built_in">this</span>.endpoints.getEndpointsConfigurer().userDetailsService(userDetailsService);<br>        &#125;<br><br>        ((RequestMatcherConfigurer)((HttpSecurity)((AuthorizedUrl)((AuthorizedUrl)((AuthorizedUrl)http.authorizeRequests().antMatchers(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;tokenEndpointPath&#125;)).fullyAuthenticated().antMatchers(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;tokenKeyPath&#125;)).access(configurer.getTokenKeyAccess()).antMatchers(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;checkTokenPath&#125;)).access(configurer.getCheckTokenAccess()).and()).requestMatchers().antMatchers(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;tokenEndpointPath, tokenKeyPath, checkTokenPath&#125;)).and().sessionManagement().sessionCreationPolicy(SessionCreationPolicy.NEVER);<br>        http.setSharedObject(ClientDetailsService.class, <span class="hljs-built_in">this</span>.clientDetailsService);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416082643200.png" srcset="/img/loading.gif" lazyload alt="image-20230416082643200"></p>
<h5 id="AuthorizationServerEndpointsConfiguration"><a href="#AuthorizationServerEndpointsConfiguration" class="headerlink" title="AuthorizationServerEndpointsConfiguration"></a>AuthorizationServerEndpointsConfiguration</h5><p>1用于注册TokenKeyEndpointRegistrar内部类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(&#123;AuthorizationServerEndpointsConfiguration.TokenKeyEndpointRegistrar.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerEndpointsConfiguration</span> &#123;<br>    <span class="hljs-comment">// 配置授权服务器端点的属性和增强的功能</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AuthorizationServerEndpointsConfigurer</span> <span class="hljs-variable">endpoints</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationServerEndpointsConfigurer</span>();<br>    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;<br>    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// AuthorizationServerConfigurer 用于配置 认证服务器</span><br>    <span class="hljs-keyword">private</span> List&lt;AuthorizationServerConfigurer&gt; configurers = Collections.emptyList();<br>&#125;<br><br><span class="hljs-comment">// TokenKeyEndpointRegistrar ----内部类，通过BeanDefinitionRegisterPostProcessor 注册JwtAccessTokenConverter 对象</span><br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411204322994.png" srcset="/img/loading.gif" lazyload alt="image-20230411204322994"></p>
<h2 id="Token转化"><a href="#Token转化" class="headerlink" title="Token转化"></a>Token转化</h2><p>Json，OAuth2Authentication (Authentication), OAuth2AccessToken (封装后的Token对象)</p>
<h3 id="信息保存"><a href="#信息保存" class="headerlink" title="信息保存"></a>信息保存</h3><h4 id="OAuth2AccessToken"><a href="#OAuth2AccessToken" class="headerlink" title="OAuth2AccessToken"></a>OAuth2AccessToken</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OAuth2AccessToken</span> &#123;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">BEARER_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Bearer&quot;</span>;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">OAUTH2_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;OAuth2&quot;</span>;<br>	<span class="hljs-comment">// 授权服务器颁发的访问令牌。这个值是REQUIRED。 </span><br>    <span class="hljs-comment">// 就是token</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACCESS_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;access_token&quot;</span>;<br>	<span class="hljs-comment">// </span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;token_type&quot;</span>;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXPIRES_IN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;expires_in&quot;</span>;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">REFRESH_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;refresh_token&quot;</span>;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">SCOPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;scope&quot;</span>;<br><br>	 <span class="hljs-comment">// 转</span><br>   Map&lt;String, Object&gt; <span class="hljs-title function_">getAdditionalInformation</span><span class="hljs-params">()</span>;<br>   OAuth2RefreshToken <span class="hljs-title function_">getRefreshToken</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultOAuth2AccessToken</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>, OAuth2AccessToken &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">914967629530462926L</span>;<br><br>	<span class="hljs-keyword">private</span> String value;<br><br>	<span class="hljs-keyword">private</span> Date expiration;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">tokenType</span> <span class="hljs-operator">=</span> BEARER_TYPE.toLowerCase();<br><br>	<span class="hljs-keyword">private</span> OAuth2RefreshToken refreshToken;<br><br>	<span class="hljs-keyword">private</span> Set&lt;String&gt; scope;<br>	<span class="hljs-comment">// 额外信息Map</span><br>	<span class="hljs-keyword">private</span> Map&lt;String, Object&gt; additionalInformation = Collections.emptyMap();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="OAuth2Authentication"><a href="#OAuth2Authentication" class="headerlink" title="OAuth2Authentication"></a>OAuth2Authentication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// An OAuth 2 authentication token can contain two authentications: one for the client and one for the user</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> &#123;<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">4809832298438307309L</span>;<br>    <span class="hljs-comment">// OAuth2Request请求信息封装 </span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OAuth2Request storedRequest;<br>    <span class="hljs-comment">// 验证前后信息</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Authentication userAuthentication;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416144137597.png" srcset="/img/loading.gif" lazyload alt="image-20230416144137597"></p>
<h4 id="TokenStore"><a href="#TokenStore" class="headerlink" title="TokenStore"></a>TokenStore</h4><p>持久化token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Persistence interface for OAuth2 tokens.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TokenStore</span> &#123;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Read the authentication stored under the specified token value.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> token The token value under which the authentication is stored.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> The authentication, or null if none.</span><br><span class="hljs-comment">    */</span><br>   OAuth2Authentication <span class="hljs-title function_">readAuthentication</span><span class="hljs-params">(OAuth2AccessToken token)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Read the authentication stored under the specified token value.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> token The token value under which the authentication is stored.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> The authentication, or null if none.</span><br><span class="hljs-comment">    */</span><br>   OAuth2Authentication <span class="hljs-title function_">readAuthentication</span><span class="hljs-params">(String token)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Store an access token.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> token The token to store.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> authentication The authentication associated with the token.</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeAccessToken</span><span class="hljs-params">(OAuth2AccessToken token, OAuth2Authentication authentication)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Read an access token from the store.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> tokenValue The token value.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> The access token to read.</span><br><span class="hljs-comment">    */</span><br>   OAuth2AccessToken <span class="hljs-title function_">readAccessToken</span><span class="hljs-params">(String tokenValue)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Remove an access token from the store.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> token The token to remove from the store.</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAccessToken</span><span class="hljs-params">(OAuth2AccessToken token)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Store the specified refresh token in the store.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> refreshToken The refresh token to store.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> authentication The authentication associated with the refresh token.</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeRefreshToken</span><span class="hljs-params">(OAuth2RefreshToken refreshToken, OAuth2Authentication authentication)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Read a refresh token from the store.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> tokenValue The value of the token to read.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> The token.</span><br><span class="hljs-comment">    */</span><br>   OAuth2RefreshToken <span class="hljs-title function_">readRefreshToken</span><span class="hljs-params">(String tokenValue)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> token a refresh token</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> the authentication originally used to grant the refresh token</span><br><span class="hljs-comment">    */</span><br>   OAuth2Authentication <span class="hljs-title function_">readAuthenticationForRefreshToken</span><span class="hljs-params">(OAuth2RefreshToken token)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Remove a refresh token from the store.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> token The token to remove from the store.</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeRefreshToken</span><span class="hljs-params">(OAuth2RefreshToken token)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Remove an access token using a refresh token. This functionality is necessary so refresh tokens can&#x27;t be used to</span><br><span class="hljs-comment">    * create an unlimited number of access tokens.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> refreshToken The refresh token.</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAccessTokenUsingRefreshToken</span><span class="hljs-params">(OAuth2RefreshToken refreshToken)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Retrieve an access token stored against the provided authentication key, if it exists.</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> authentication the authentication key for the access token</span><br><span class="hljs-comment">    * </span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> the access token or null if there was none</span><br><span class="hljs-comment">    */</span><br>   OAuth2AccessToken <span class="hljs-title function_">getAccessToken</span><span class="hljs-params">(OAuth2Authentication authentication)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> clientId the client id to search</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> userName the user name to search</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> a collection of access tokens</span><br><span class="hljs-comment">    */</span><br>   Collection&lt;OAuth2AccessToken&gt; <span class="hljs-title function_">findTokensByClientIdAndUserName</span><span class="hljs-params">(String clientId, String userName)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> clientId the client id to search</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> a collection of access tokens</span><br><span class="hljs-comment">    */</span><br>   Collection&lt;OAuth2AccessToken&gt; <span class="hljs-title function_">findTokensByClientId</span><span class="hljs-params">(String clientId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416233446586.png" srcset="/img/loading.gif" lazyload alt="image-20230416233446586"></p>
<h3 id="TokenEnhancer"><a href="#TokenEnhancer" class="headerlink" title="TokenEnhancer"></a>TokenEnhancer</h3><p>生成token时用于增强token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TokenEnhancer</span> &#123;<br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Provides an opportunity for customization of an access token (e.g. through its additional information map) during</span><br><span class="hljs-comment">    * the process of creating a new token for use by a client.</span><br><span class="hljs-comment">		// 返回一携带额外信息的 OAuth2AccessToken</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> a new token enhanced with additional information</span><br><span class="hljs-comment">    */</span><br>   OAuth2AccessToken <span class="hljs-title function_">enhance</span><span class="hljs-params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AccessTokenConverter"><a href="#AccessTokenConverter" class="headerlink" title="AccessTokenConverter"></a>AccessTokenConverter</h3><p>在OAuth2AccessToken 、 OAuth2Authorization 和 Json（）之间的想换转化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccessTokenConverter</span> &#123;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aud&quot;</span>;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLIENT_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;client_id&quot;</span>;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exp&quot;</span>;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">JTI</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jti&quot;</span>;<br>   <br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">GRANT_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;grant_type&quot;</span>;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ATI</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ati&quot;</span>;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SCOPE</span> <span class="hljs-operator">=</span> OAuth2AccessToken.SCOPE;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUTHORITIES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;authorities&quot;</span>;<br>	<span class="hljs-comment">// 将 OAuth2AccessToken， OAuth2Authentication转化为 Json信息（Map）</span><br>    <span class="hljs-comment">// token未加密前</span><br>   Map&lt;String, ?&gt; convertAccessToken(OAuth2AccessToken token, OAuth2Authentication authentication);<br>	<span class="hljs-comment">// 提取OAuth2AccessToken</span><br>   OAuth2AccessToken <span class="hljs-title function_">extractAccessToken</span><span class="hljs-params">(String value, Map&lt;String, ?&gt; map)</span>;<br>	<span class="hljs-comment">// 提取Authentication信息</span><br>   OAuth2Authentication <span class="hljs-title function_">extractAuthentication</span><span class="hljs-params">(Map&lt;String, ?&gt; map)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="JwtAccessTokenConverter"><a href="#JwtAccessTokenConverter" class="headerlink" title="JwtAccessTokenConverter"></a>JwtAccessTokenConverter</h3><p>继承两个接口TokenEnhancer AccessTokenConverter，实习那两个接口的所有功能</p>
<p>通过设置secrete （jwt 第三部分进行加密，将OAuth2AccessToken 转为 JWT）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Helper that translates between JWT encoded token values and OAuth authentication information (in both directions).  Also acts as a TokenEnhancer when tokens are granted.</span><br><span class="hljs-comment">// 继承两个接口，实习那两个接口的所有功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAccessTokenConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TokenEnhancer</span>, AccessTokenConverter, InitializingBean &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Field name for token id.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_ID</span> <span class="hljs-operator">=</span> AccessTokenConverter.JTI;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Field name for access token id.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACCESS_TOKEN_ID</span> <span class="hljs-operator">=</span> AccessTokenConverter.ATI;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(JwtAccessTokenConverter.class);<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">AccessTokenConverter</span> <span class="hljs-variable">tokenConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAccessTokenConverter</span>();<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">JwtClaimsSetVerifier</span> <span class="hljs-variable">jwtClaimsSetVerifier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoOpJwtClaimsSetVerifier</span>();<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">JsonParser</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> JsonParserFactory.create();<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">verifierKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomValueStringGenerator</span>().generate();<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">Signer</span> <span class="hljs-variable">signer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MacSigner</span>(verifierKey);<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">signingKey</span> <span class="hljs-operator">=</span> verifierKey;<br><br>	<span class="hljs-keyword">private</span> SignatureVerifier verifier;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416084046723.png" srcset="/img/loading.gif" lazyload alt="image-20230416084046723"></p>
<p>实现OAuth2协议的API接口，可以用于微服务之间的权限验证</p>
<p>Spring Security 部分</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less">既可以应用到鉴权服务器 又可以 应用 到 资源服务器<br>全局配置注解服务器<br><span class="hljs-variable">@EnableWebSecurity</span><br>资源服务器<br><span class="hljs-variable">@EnableResourceServer</span><br>认证服务器<br><span class="hljs-variable">@EnableAuthorizationServer</span><br></code></pre></td></tr></table></figure>

<h2 id="管理过滤器"><a href="#管理过滤器" class="headerlink" title="管理过滤器"></a>管理过滤器</h2><h3 id="FilterChainProxy-1"><a href="#FilterChainProxy-1" class="headerlink" title="FilterChainProxy"></a>FilterChainProxy</h3><p>管理多个过滤器链集合 — webSecurity – Filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterChainProxy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(FilterChainProxy.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILTER_APPLIED</span> <span class="hljs-operator">=</span> FilterChainProxy.class.getName().concat(<span class="hljs-string">&quot;.APPLIED&quot;</span>);<br>    <span class="hljs-comment">// 多个过滤器链的集合</span><br>    <span class="hljs-keyword">private</span> List&lt;SecurityFilterChain&gt; filterChains;<br>    <span class="hljs-keyword">private</span> FilterChainProxy.FilterChainValidator filterChainValidator;<br>    <span class="hljs-keyword">private</span> HttpFirewall firewall;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>拥有一系列配置的过滤器（单个） – HttpSecurity — DefaultSecurityFilterChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityFilterChain</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br>    List&lt;Filter&gt; <span class="hljs-title function_">getFilters</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSecurityFilterChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityFilterChain</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(DefaultSecurityFilterChain.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RequestMatcher requestMatcher;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Filter&gt; filters;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="被管理过滤器"><a href="#被管理过滤器" class="headerlink" title="被管理过滤器"></a>被管理过滤器</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7176803095525982269">Spring Security结合JWT实现认证与授权 - 掘金 (juejin.cn)</a></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23a944f928644727a74de80d42c8dd2c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="过滤器执行顺序"></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">OAuth2ClientContextFilter</span> <span class="hljs-symbol">implements</span> <span class="hljs-symbol">Filter, <span class="hljs-symbol">InitializingBean</span></span> &#123;<br></code></pre></td></tr></table></figure>



<h3 id="OAuth2AuthenticationProcessingFilter"><a href="#OAuth2AuthenticationProcessingFilter" class="headerlink" title="OAuth2AuthenticationProcessingFilter"></a>OAuth2AuthenticationProcessingFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2AuthenticationProcessingFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span>, InitializingBean &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(OAuth2AuthenticationProcessingFilter.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AuthenticationEntryPoint</span> <span class="hljs-variable">authenticationEntryPoint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2AuthenticationEntryPoint</span>();<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-comment">// 详细信息</span><br>    <span class="hljs-keyword">private</span> AuthenticationDetailsSource&lt;HttpServletRequest, ?&gt; authenticationDetailsSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2AuthenticationDetailsSource</span>();<br>    <span class="hljs-comment">// token提取器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">TokenExtractor</span> <span class="hljs-variable">tokenExtractor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BearerTokenExtractor</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AuthenticationEventPublisher</span> <span class="hljs-variable">eventPublisher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2AuthenticationProcessingFilter</span>.NullEventPublisher();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stateless</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// 提取请求中的token信息,封装到 PreAuthenticatedAuthenticationToken</span><br><span class="hljs-comment">// head: Authorization</span><br><span class="hljs-comment">// body: access_token</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TokenExtractor</span> &#123;<br>    Authentication <span class="hljs-title function_">extract</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="TokenEndpointAuthenticationFilter"><a href="#TokenEndpointAuthenticationFilter" class="headerlink" title="TokenEndpointAuthenticationFilter"></a>TokenEndpointAuthenticationFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenEndpointAuthenticationFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(TokenEndpointAuthenticationFilter.class);<br>    <span class="hljs-keyword">private</span> AuthenticationDetailsSource&lt;HttpServletRequest, ?&gt; authenticationDetailsSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAuthenticationDetailsSource</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AuthenticationEntryPoint</span> <span class="hljs-variable">authenticationEntryPoint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2AuthenticationEntryPoint</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OAuth2RequestFactory oAuth2RequestFactory;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="OAuth2ClientContextFilter"><a href="#OAuth2ClientContextFilter" class="headerlink" title="OAuth2ClientContextFilter"></a>OAuth2ClientContextFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2ClientContextFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span>, InitializingBean &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CURRENT_URI</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;currentUri&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ThrowableAnalyzer</span> <span class="hljs-variable">throwableAnalyzer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultThrowableAnalyzer</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">RedirectStrategy</span> <span class="hljs-variable">redirectStrategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedirectStrategy</span>();<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h2><h3 id="OAuth2AuthenticationManager"><a href="#OAuth2AuthenticationManager" class="headerlink" title="OAuth2AuthenticationManager"></a>OAuth2AuthenticationManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2AuthenticationManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationManager</span>, InitializingBean &#123;<br>    <span class="hljs-keyword">private</span> ResourceServerTokenServices tokenServices;<br>    <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;<br>    <span class="hljs-keyword">private</span> String resourceId;<br>&#125;   <br></code></pre></td></tr></table></figure>





<h2 id="端点-Endpoint-API"><a href="#端点-Endpoint-API" class="headerlink" title="端点-Endpoint - API"></a>端点-Endpoint - API</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><ul>
<li><strong>AuthorizationEndpoint</strong> 用于服务于授权请求。预设地址：&#x2F;oauth&#x2F;authorize。</li>
<li><strong>TokenEndpoint</strong> 用于服务访问令牌的请求。预设地址：&#x2F;oauth&#x2F;token。</li>
<li></li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/oauth/</span>token -- TokenEndpoint 请求token<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/oauth/</span>token_key -- TokenKeyEndpoint token的关键信息（算法，验证器key）<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/oauth/</span>authorize -- AuthorizationEndpoint 授权token（分发code）<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/oauth/</span>check_token -- CheckTokenEndpoint token检查<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/oauth/</span>confirm_access -- WhitelabelApprovalEndpoint 确认访问<br></code></pre></td></tr></table></figure>

<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">/oauth/<span class="hljs-keyword">error</span> <span class="hljs-comment">-- WhitelabelErrorEndpoint 错误请求</span><br></code></pre></td></tr></table></figure>



<h3 id="AbstractEndpoint"><a href="#AbstractEndpoint" class="headerlink" title="AbstractEndpoint"></a>AbstractEndpoint</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractEndpoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-keyword">private</span> WebResponseExceptionTranslator&lt;OAuth2Exception&gt; providerExceptionHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebResponseExceptionTranslator</span>();<br>    <span class="hljs-comment">// token授予的模式 -- 四种</span><br>    <span class="hljs-keyword">private</span> TokenGranter tokenGranter;<br>    <span class="hljs-comment">// 用于获取ClientDetail信息</span><br>    <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;<br>    <span class="hljs-comment">// Request请求封装的工厂 </span><br>    <span class="hljs-keyword">private</span> OAuth2RequestFactory oAuth2RequestFactory;<br>    <span class="hljs-keyword">private</span> OAuth2RequestFactory defaultOAuth2RequestFactory;<br> 	<br>    <span class="hljs-comment">// 实现InitializingBean接口，会在属性填充后进行调用</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Assert.state(<span class="hljs-built_in">this</span>.tokenGranter != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;TokenGranter must be provided&quot;</span>);<br>        Assert.state(<span class="hljs-built_in">this</span>.clientDetailsService != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;ClientDetailsService must be provided&quot;</span>);<br>        <span class="hljs-built_in">this</span>.defaultOAuth2RequestFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultOAuth2RequestFactory</span>(<span class="hljs-built_in">this</span>.getClientDetailsService());<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.oAuth2RequestFactory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.oAuth2RequestFactory = <span class="hljs-built_in">this</span>.defaultOAuth2RequestFactory;<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// 两个实现类，类似于UserDetailsService</span><br><span class="hljs-comment">// InMemoryClientDetailsService 在内存中寻找</span><br><span class="hljs-comment">// JdbcClientDetailsService   在数据库中寻找</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClientDetailsService</span> &#123;<br>    <span class="hljs-comment">// 通过ClientId获取当前client客户端的信息</span><br>    ClientDetails <span class="hljs-title function_">loadClientByClientId</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> ClientRegistrationException;<br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411182043644.png" srcset="/img/loading.gif" lazyload alt="image-20230411182043644"></p>
<h4 id="ClientDetials"><a href="#ClientDetials" class="headerlink" title="ClientDetials"></a>ClientDetials</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClientDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    String <span class="hljs-title function_">getClientId</span><span class="hljs-params">()</span>;<br><br>    Set&lt;String&gt; <span class="hljs-title function_">getResourceIds</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSecretRequired</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getClientSecret</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isScoped</span><span class="hljs-params">()</span>;<br><br>    Set&lt;String&gt; <span class="hljs-title function_">getScope</span><span class="hljs-params">()</span>;<br><br>    Set&lt;String&gt; <span class="hljs-title function_">getAuthorizedGrantTypes</span><span class="hljs-params">()</span>;<br><br>    Set&lt;String&gt; <span class="hljs-title function_">getRegisteredRedirectUri</span><span class="hljs-params">()</span>;<br><br>    Collection&lt;GrantedAuthority&gt; <span class="hljs-title function_">getAuthorities</span><span class="hljs-params">()</span>;<br><br>    Integer <span class="hljs-title function_">getAccessTokenValiditySeconds</span><span class="hljs-params">()</span>;<br><br>    Integer <span class="hljs-title function_">getRefreshTokenValiditySeconds</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAutoApprove</span><span class="hljs-params">(String var1)</span>;<br><br>    Map&lt;String, Object&gt; <span class="hljs-title function_">getAdditionalInformation</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="BaseClientDetails"><a href="#BaseClientDetails" class="headerlink" title="BaseClientDetails"></a>BaseClientDetails</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseClientDetails</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClientDetails</span> &#123;<br>    <span class="hljs-meta">@JsonProperty(&quot;client_id&quot;)</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;client_id&quot;</span>)<br>    <span class="hljs-keyword">private</span> String clientId;<br>    <span class="hljs-meta">@JsonProperty(&quot;client_secret&quot;)</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;client_secret&quot;</span>)<br>    <span class="hljs-keyword">private</span> String clientSecret;<br>    <span class="hljs-meta">@JsonDeserialize(</span><br><span class="hljs-meta">        using = JacksonArrayOrStringDeserializer.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.databind.annotation.JsonDeserialize(<br>        using = Jackson2ArrayOrStringDeserializer.class<br>    )<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; scope;<br>    <span class="hljs-meta">@JsonProperty(&quot;resource_ids&quot;)</span><br>    <span class="hljs-meta">@JsonDeserialize(</span><br><span class="hljs-meta">        using = JacksonArrayOrStringDeserializer.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;resource_ids&quot;</span>)<br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.databind.annotation.JsonDeserialize(<br>        using = Jackson2ArrayOrStringDeserializer.class<br>    )<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; resourceIds;<br>    <span class="hljs-meta">@JsonProperty(&quot;authorized_grant_types&quot;)</span><br>    <span class="hljs-meta">@JsonDeserialize(</span><br><span class="hljs-meta">        using = JacksonArrayOrStringDeserializer.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;authorized_grant_types&quot;</span>)<br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.databind.annotation.JsonDeserialize(<br>        using = Jackson2ArrayOrStringDeserializer.class<br>    )<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; authorizedGrantTypes;<br>    <span class="hljs-meta">@JsonProperty(&quot;redirect_uri&quot;)</span><br>    <span class="hljs-meta">@JsonDeserialize(</span><br><span class="hljs-meta">        using = JacksonArrayOrStringDeserializer.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;redirect_uri&quot;</span>)<br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.databind.annotation.JsonDeserialize(<br>        using = Jackson2ArrayOrStringDeserializer.class<br>    )<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; registeredRedirectUris;<br>    <span class="hljs-meta">@JsonProperty(&quot;autoapprove&quot;)</span><br>    <span class="hljs-meta">@JsonDeserialize(</span><br><span class="hljs-meta">        using = JacksonArrayOrStringDeserializer.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;autoapprove&quot;</span>)<br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.databind.annotation.JsonDeserialize(<br>        using = Jackson2ArrayOrStringDeserializer.class<br>    )<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; autoApproveScopes;<br>    <span class="hljs-keyword">private</span> List&lt;GrantedAuthority&gt; authorities;<br>    <span class="hljs-meta">@JsonProperty(&quot;access_token_validity&quot;)</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;access_token_validity&quot;</span>)<br>    <span class="hljs-keyword">private</span> Integer accessTokenValiditySeconds;<br>    <span class="hljs-meta">@JsonProperty(&quot;refresh_token_validity&quot;)</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonProperty(<span class="hljs-string">&quot;refresh_token_validity&quot;</span>)<br>    <span class="hljs-keyword">private</span> Integer refreshTokenValiditySeconds;<br>    <span class="hljs-meta">@JsonIgnore</span><br>    <span class="hljs-meta">@com</span>.fasterxml.jackson.annotation.JsonIgnore<br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; additionalInformation;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AuthorizationEndpoint"><a href="#AuthorizationEndpoint" class="headerlink" title="AuthorizationEndpoint"></a>AuthorizationEndpoint</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SessionAttributes(&#123;AuthorizationEndpoint.AUTHORIZATION_REQUEST_ATTR_NAME, AuthorizationEndpoint.ORIGINAL_AUTHORIZATION_REQUEST_ATTR_NAME&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationEndpoint</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractEndpoint</span> &#123;<br>   <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUTHORIZATION_REQUEST_ATTR_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;authorizationRequest&quot;</span>;<br><br>   <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ORIGINAL_AUTHORIZATION_REQUEST_ATTR_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.springframework.security.oauth2.provider.endpoint.AuthorizationEndpoint.ORIGINAL_AUTHORIZATION_REQUEST&quot;</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">AuthorizationCodeServices</span> <span class="hljs-variable">authorizationCodeServices</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryAuthorizationCodeServices</span>();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">RedirectResolver</span> <span class="hljs-variable">redirectResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedirectResolver</span>();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">UserApprovalHandler</span> <span class="hljs-variable">userApprovalHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultUserApprovalHandler</span>();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">SessionAttributeStore</span> <span class="hljs-variable">sessionAttributeStore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSessionAttributeStore</span>();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">OAuth2RequestValidator</span> <span class="hljs-variable">oauth2RequestValidator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultOAuth2RequestValidator</span>();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">userApprovalPage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;forward:/oauth/confirm_access&quot;</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorPage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;forward:/oauth/error&quot;</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">implicitLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSessionAttributeStore</span><span class="hljs-params">(SessionAttributeStore sessionAttributeStore)</span> &#123;<br>      <span class="hljs-built_in">this</span>.sessionAttributeStore = sessionAttributeStore;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setErrorPage</span><span class="hljs-params">(String errorPage)</span> &#123;<br>      <span class="hljs-built_in">this</span>.errorPage = errorPage;<br>   &#125;<br><br>   <span class="hljs-meta">@RequestMapping(value = &quot;/oauth/authorize&quot;)</span><br>   <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">authorize</span><span class="hljs-params">(Map&lt;String, Object&gt; model, <span class="hljs-meta">@RequestParam</span> Map&lt;String, String&gt; parameters,</span><br><span class="hljs-params">         SessionStatus sessionStatus, Principal principal)</span> &#123;<br><br>      <span class="hljs-comment">// Pull out the authorization request first, using the OAuth2RequestFactory. All further logic should</span><br>      <span class="hljs-comment">// query off of the authorization request instead of referring back to the parameters map. The contents of the</span><br>      <span class="hljs-comment">// parameters map will be stored without change in the AuthorizationRequest object once it is created.</span><br>      <span class="hljs-type">AuthorizationRequest</span> <span class="hljs-variable">authorizationRequest</span> <span class="hljs-operator">=</span> getOAuth2RequestFactory().createAuthorizationRequest(parameters);<br><br>      Set&lt;String&gt; responseTypes = authorizationRequest.getResponseTypes();<br><br>      <span class="hljs-keyword">if</span> (!responseTypes.contains(<span class="hljs-string">&quot;token&quot;</span>) &amp;&amp; !responseTypes.contains(<span class="hljs-string">&quot;code&quot;</span>)) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedResponseTypeException</span>(<span class="hljs-string">&quot;Unsupported response types: &quot;</span> + responseTypes);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (authorizationRequest.getClientId() == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClientException</span>(<span class="hljs-string">&quot;A client id must be provided&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-keyword">try</span> &#123;<br><br>         <span class="hljs-keyword">if</span> (!(principal <span class="hljs-keyword">instanceof</span> Authentication) || !((Authentication) principal).isAuthenticated()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientAuthenticationException</span>(<br>                  <span class="hljs-string">&quot;User must be authenticated with Spring Security before authorization can be completed.&quot;</span>);<br>         &#125;<br><br>         <span class="hljs-type">ClientDetails</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> getClientDetailsService().loadClientByClientId(authorizationRequest.getClientId());<br><br>         <span class="hljs-comment">// The resolved redirect URI is either the redirect_uri from the parameters or the one from</span><br>         <span class="hljs-comment">// clientDetails. Either way we need to store it on the AuthorizationRequest.</span><br>         <span class="hljs-type">String</span> <span class="hljs-variable">redirectUriParameter</span> <span class="hljs-operator">=</span> authorizationRequest.getRequestParameters().get(OAuth2Utils.REDIRECT_URI);<br>         <span class="hljs-type">String</span> <span class="hljs-variable">resolvedRedirect</span> <span class="hljs-operator">=</span> redirectResolver.resolveRedirect(redirectUriParameter, client);<br>         <span class="hljs-keyword">if</span> (!StringUtils.hasText(resolvedRedirect)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedirectMismatchException</span>(<br>                  <span class="hljs-string">&quot;A redirectUri must be either supplied or preconfigured in the ClientDetails&quot;</span>);<br>         &#125;<br>         authorizationRequest.setRedirectUri(resolvedRedirect);<br><br>         <span class="hljs-comment">// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span><br>         <span class="hljs-comment">// been added to the request by the manager).</span><br>         oauth2RequestValidator.validateScope(authorizationRequest, client);<br><br>         <span class="hljs-comment">// Some systems may allow for approval decisions to be remembered or approved by default. Check for</span><br>         <span class="hljs-comment">// such logic here, and set the approved flag on the authorization request accordingly.</span><br>         authorizationRequest = userApprovalHandler.checkForPreApproval(authorizationRequest,<br>               (Authentication) principal);<br>         <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> is this call necessary?</span><br>         <span class="hljs-type">boolean</span> <span class="hljs-variable">approved</span> <span class="hljs-operator">=</span> userApprovalHandler.isApproved(authorizationRequest, (Authentication) principal);<br>         authorizationRequest.setApproved(approved);<br><br>         <span class="hljs-comment">// Validation is all done, so we can check for auto approval...</span><br>         <span class="hljs-keyword">if</span> (authorizationRequest.isApproved()) &#123;<br>            <span class="hljs-keyword">if</span> (responseTypes.contains(<span class="hljs-string">&quot;token&quot;</span>)) &#123;<br>               <span class="hljs-keyword">return</span> getImplicitGrantResponse(authorizationRequest);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (responseTypes.contains(<span class="hljs-string">&quot;code&quot;</span>)) &#123;<br>               <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(getAuthorizationCodeResponse(authorizationRequest,<br>                     (Authentication) principal));<br>            &#125;<br>         &#125;<br><br>         <span class="hljs-comment">// Store authorizationRequest AND an immutable Map of authorizationRequest in session</span><br>         <span class="hljs-comment">// which will be used to validate against in approveOrDeny()</span><br>          <span class="hljs-comment">// 存储 - authorizationRequest</span><br>         model.put(AUTHORIZATION_REQUEST_ATTR_NAME, authorizationRequest);<br>         model.put(ORIGINAL_AUTHORIZATION_REQUEST_ATTR_NAME, unmodifiableMap(authorizationRequest));<br><br>         <span class="hljs-keyword">return</span> getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);<br><br>      &#125;<br>      <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>         sessionStatus.setComplete();<br>         <span class="hljs-keyword">throw</span> e;<br>      &#125;<br><br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p> 我们来大致解析下这段逻辑：</p>
<ul>
<li>1、 通过 OAuth2RequestFactory 从 参数中获取信息创建 AuthorizationRequest 授权请求对象</li>
<li>2、 判断  principal 是否 已授权 ： &#x2F;oauth&#x2F;authorize 设置为无权限访问 ，所以要判断，如果 判断失败则抛出 InsufficientAuthenticationException （AuthenticationException 子类），其异常会被 ExceptionTranslationFilter 处理 ，最终跳转到 登录页面，这也是为什么我们第一次去请求获取 授权码时会跳转到登陆界面的原因</li>
<li>3、 通过 ClientDetailsService.loadClientByClientId() 获取到 ClientDetails 客户端信息</li>
<li>4、 获取参数中的回调地址并且与系统配置的回调地址（步骤3获取到的client信息）对比</li>
<li>5、 与步骤4一样 验证 scope</li>
<li>6、 检测该客户端是否设置自动 授权（即 我们配置客户端时配置的 autoApprove(true)）</li>
<li>7、 由于我们设置  autoApprove(true) 则 调用 getAuthorizationCodeResponse() 方法生成code码并回调到设置的回调地址</li>
<li>8、 真实生成Code 的方法时 generateCode(AuthorizationRequest authorizationRequest, Authentication authentication) 方法： 其内部是调用 authorizationCodeServices.createAuthorizationCode()方法生成code的</li>
</ul>
<p>  生成授权码的整个逻辑其实是相对简单的，真正复杂的是token的生成逻辑，那么接下来我们就看看token的生成。</p>
<h4 id="AuthorizationCodeServices"><a href="#AuthorizationCodeServices" class="headerlink" title="AuthorizationCodeServices"></a>AuthorizationCodeServices</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthorizationCodeServices</span> &#123;<br>    <span class="hljs-comment">// 根据信息生成特殊 code</span><br>   String <span class="hljs-title function_">createAuthorizationCode</span><span class="hljs-params">(OAuth2Authentication authentication)</span>;<br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Consume a authorization code. */</span><br>    <span class="hljs-comment">// 消费 code</span><br>   OAuth2Authentication <span class="hljs-title function_">consumeAuthorizationCode</span><span class="hljs-params">(String code)</span><br>         <span class="hljs-keyword">throws</span> InvalidGrantException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230417175859959.png" srcset="/img/loading.gif" lazyload alt="image-20230417175859959"></p>
<h3 id="TokenEndpoint"><a href="#TokenEndpoint" class="headerlink" title="TokenEndpoint"></a>TokenEndpoint</h3><p> 简单概括下来，整个生成token 的逻辑如下：</p>
<ul>
<li>1、 验证 用户信息 （正常情况下会经过 ClientCredentialsTokenEndpointFilter 过滤器认证后获取到用户信息 ）</li>
<li>2、 通过 ClientDetailsService().loadClientByClientId() 获取系统配置的客户端信息</li>
<li>3、 通过客户端信息生成 <strong>TokenRequest</strong> 对象</li>
<li><strong>4、 将步骤3获取到的 TokenRequest 作为TokenGranter.grant() 方法参照 生成 OAuth2AccessToken 对象（即token）</strong></li>
<li>5、 返回 token</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/fadsfewrqwredsfq3r.png" srcset="/img/loading.gif" lazyload alt="aa"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/watermark%252Ctype_ZmFuZ3poZW5naGVpdGk%252Cshadow_10%252Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NubTEwMDUw%252Csize_16%252Ccolor_FFFFFF%252Ct_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h3 id="CheckTokenEndpoint"><a href="#CheckTokenEndpoint" class="headerlink" title="CheckTokenEndpoint"></a>CheckTokenEndpoint</h3><p>用于检查token是否有效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckTokenEndpoint</span> &#123;<br>	<span class="hljs-comment">// 主要的service</span><br>   <span class="hljs-keyword">private</span> ResourceServerTokenServices resourceServerTokenServices;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">AccessTokenConverter</span> <span class="hljs-variable">accessTokenConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CheckTokenAccessTokenConverter</span>();<br><br>   <span class="hljs-meta">@RequestMapping(value = &quot;/oauth/check_token&quot;)</span><br>   <span class="hljs-meta">@ResponseBody</span><br>   <span class="hljs-keyword">public</span> Map&lt;String, ?&gt; checkToken(<span class="hljs-meta">@RequestParam(&quot;token&quot;)</span> String value) &#123;<br>	<span class="hljs-comment">// 读取string token 转为 OAuth2AccessToken</span><br>      <span class="hljs-type">OAuth2AccessToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> resourceServerTokenServices.readAccessToken(value);<br>      <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidTokenException</span>(<span class="hljs-string">&quot;Token was not recognised&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (token.isExpired()) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidTokenException</span>(<span class="hljs-string">&quot;Token has expired&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-type">OAuth2Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> resourceServerTokenServices.loadAuthentication(token.getValue());<br><br>      <span class="hljs-keyword">return</span> accessTokenConverter.convertAccessToken(token, authentication);<br>   &#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResourceServerTokenServices"><a href="#ResourceServerTokenServices" class="headerlink" title="ResourceServerTokenServices"></a>ResourceServerTokenServices</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceServerTokenServices</span> &#123;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Load the credentials for the specified access token.</span><br><span class="hljs-comment">    */</span><br>   OAuth2Authentication <span class="hljs-title function_">loadAuthentication</span><span class="hljs-params">(String accessToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException, InvalidTokenException;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Retrieve the full access token details from just the value.</span><br><span class="hljs-comment">    */</span><br>   OAuth2AccessToken <span class="hljs-title function_">readAccessToken</span><span class="hljs-params">(String accessToken)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230417180224185.png" srcset="/img/loading.gif" lazyload alt="image-20230417180224185"></p>
<h2 id="授权模式"><a href="#授权模式" class="headerlink" title="授权模式"></a>授权模式</h2><h3 id="TokenGranter"><a href="#TokenGranter" class="headerlink" title="TokenGranter"></a>TokenGranter</h3><ul>
<li>authorization_code 授权码认证</li>
<li>client_credentials 客户端认证</li>
<li>password 密码认证</li>
<li>implicit 隐式授权认证</li>
<li>refresh_token 刷新密钥</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TokenGranter</span> &#123;<br>    <span class="hljs-comment">// 根据 封装好的 TokenRequest 获取 OAuth2AccessToken</span><br>    OAuth2AccessToken <span class="hljs-title function_">grant</span><span class="hljs-params">(String var1, TokenRequest var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">RefreshTokenGranter : 更新token模式<br><br>AuthorizationCodeTokenGranter ：授权码模式<br><br>ImplicitTokenGranter ： 简化模式<br><span class="hljs-regexp">//</span> 调用 UsernamePasswordAuthenticationProvider的执行流程<br>ResourceOwnerPasswordTokenGranter ：密码模式<br><br>ClientCredentialsTokenGranter ：客户端凭证模式<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411173833116.png" srcset="/img/loading.gif" lazyload alt="image-20230411173833116"></p>
<p>执行链</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">```<br><br><br><br>#### AbstractTokenGranter<br><br>```java<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractTokenGranter</span> <span class="hljs-title">implements</span> <span class="hljs-title">TokenGranter</span> &#123;<br>    <span class="hljs-comment">// 获取OAuth2Token的三种方式 （创建，刷新，获取）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthorizationServerTokenServices tokenServices;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClientDetailsService clientDetailsService;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OAuth2RequestFactory requestFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String grantType;<br>    <br>    <span class="hljs-comment">// 被ClientCredentialsTokenGranter直接调用</span><br>    <span class="hljs-keyword">public</span> OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.grantType.equals(grantType)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            String clientId = tokenRequest.getClientId();<br>            <span class="hljs-comment">// 默认为客户端凭证模式进行验证 -- </span><br>            ClientDetails client = <span class="hljs-keyword">this</span>.clientDetailsService.loadClientByClientId(clientId);<br>            <span class="hljs-keyword">this</span>.validateGrantType(grantType, client);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logger.isDebugEnabled()) &#123;<br>                <span class="hljs-keyword">this</span>.logger.debug(<span class="hljs-string">&quot;Getting access token for: &quot;</span> + clientId);<br>            &#125;<br>			<span class="hljs-comment">// 11 ---获取AccessToken</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getAccessToken(client, tokenRequest);<br>        &#125;<br>    &#125;<br>	<br>    <span class="hljs-comment">// 11  -- 被子类 ： RefreshTokenGranter重写</span><br>    <span class="hljs-keyword">protected</span> OAuth2AccessToken getAccessToken(ClientDetails client, TokenRequest tokenRequest) &#123;<br>        										<span class="hljs-comment">// 222</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tokenServices.createAccessToken(<span class="hljs-keyword">this</span>.getOAuth2Authentication(client, tokenRequest));<br>    &#125;<br>    <span class="hljs-comment">// </span><br>	<span class="hljs-comment">/// 222 -- 被子类： AuthorizationCodeTokenGratrer / ResourceOwnerPasswordTokenGranter重写</span><br>    <span class="hljs-keyword">protected</span> OAuth2Authentication getOAuth2Authentication(ClientDetails client, TokenRequest tokenRequest) &#123;<br>        OAuth2Request storedOAuth2Request = <span class="hljs-keyword">this</span>.requestFactory.createOAuth2Request(client, tokenRequest);<br>        <span class="hljs-keyword">return</span> new OAuth2Authentication(storedOAuth2Request, (Authentication)<span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br>````<br><br>#### RefreshTokenGranter<br><br>```java<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefreshTokenGranter</span> <span class="hljs-title">extends</span> <span class="hljs-title">AbstractTokenGranter</span> &#123;<br>    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> String GRANT_TYPE = <span class="hljs-string">&quot;refresh_token&quot;</span>;<br>    <span class="hljs-comment">// 重点再Service</span><br>	<span class="hljs-comment">// 调用父类的AuthorizationServerTokenServices ## refreshAccessToken()方法，获取OAuth2AccessToken</span><br>    <span class="hljs-keyword">protected</span> OAuth2AccessToken getAccessToken(ClientDetails client, TokenRequest tokenRequest) &#123;<br>        String refreshToken = (String)tokenRequest.getRequestParameters().<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;refresh_token&quot;</span>);<br>        <span class="hljs-comment">///AbstractTokenGranter ## AuthorizationServerTokenServices ## refreshAccessToken()</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getTokenServices().refreshAccessToken(refreshToken, tokenRequest);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h4 id="AuthorizationCodeTokenGranter"><a href="#AuthorizationCodeTokenGranter" class="headerlink" title="AuthorizationCodeTokenGranter"></a>AuthorizationCodeTokenGranter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationCodeTokenGranter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTokenGranter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">GRANT_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;authorization_code&quot;</span>;<br>    <span class="hljs-comment">// 重点Service</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthorizationCodeServices authorizationCodeServices;<br>    <span class="hljs-comment">// 重点再Service如何生成的code</span><br>    <span class="hljs-comment">// AbstractTokenGranter调用 getOAuth2Authentication()进入</span><br>    <span class="hljs-keyword">protected</span> OAuth2Authentication <span class="hljs-title function_">getOAuth2Authentication</span><span class="hljs-params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;<br>        Map&lt;String, String&gt; parameters = tokenRequest.getRequestParameters();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">authorizationCode</span> <span class="hljs-operator">=</span> (String)parameters.get(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">redirectUri</span> <span class="hljs-operator">=</span> (String)parameters.get(<span class="hljs-string">&quot;redirect_uri&quot;</span>);<br>        <span class="hljs-keyword">if</span> (authorizationCode == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidRequestException</span>(<span class="hljs-string">&quot;An authorization code must be supplied.&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">OAuth2Authentication</span> <span class="hljs-variable">storedAuth</span> <span class="hljs-operator">=</span> <br>                <span class="hljs-comment">// </span><br>                <span class="hljs-built_in">this</span>.authorizationCodeServices.consumeAuthorizationCode(authorizationCode);<br>            <span class="hljs-keyword">if</span> (storedAuth == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidGrantException</span>(<span class="hljs-string">&quot;Invalid authorization code: &quot;</span> + authorizationCode);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">OAuth2Request</span> <span class="hljs-variable">pendingOAuth2Request</span> <span class="hljs-operator">=</span> storedAuth.getOAuth2Request();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">redirectUriApprovalParameter</span> <span class="hljs-operator">=</span> (String)pendingOAuth2Request.getRequestParameters().get(<span class="hljs-string">&quot;redirect_uri&quot;</span>);<br>                <span class="hljs-keyword">if</span> ((redirectUri != <span class="hljs-literal">null</span> || redirectUriApprovalParameter != <span class="hljs-literal">null</span>) &amp;&amp; !pendingOAuth2Request.getRedirectUri().equals(redirectUri)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedirectMismatchException</span>(<span class="hljs-string">&quot;Redirect URI mismatch.&quot;</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">pendingClientId</span> <span class="hljs-operator">=</span> pendingOAuth2Request.getClientId();<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">clientId</span> <span class="hljs-operator">=</span> tokenRequest.getClientId();<br>                    <span class="hljs-keyword">if</span> (clientId != <span class="hljs-literal">null</span> &amp;&amp; !clientId.equals(pendingClientId)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClientException</span>(<span class="hljs-string">&quot;Client ID mismatch&quot;</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        Map&lt;String, String&gt; combinedParameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(pendingOAuth2Request.getRequestParameters());<br>                        combinedParameters.putAll(parameters);<br>                        <span class="hljs-type">OAuth2Request</span> <span class="hljs-variable">finalStoredOAuth2Request</span> <span class="hljs-operator">=</span> pendingOAuth2Request.createOAuth2Request(combinedParameters);<br>                        <span class="hljs-type">Authentication</span> <span class="hljs-variable">userAuth</span> <span class="hljs-operator">=</span> storedAuth.getUserAuthentication();<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2Authentication</span>(finalStoredOAuth2Request, userAuth);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthorizationCodeServices</span> &#123;<br>    String <span class="hljs-title function_">createAuthorizationCode</span><span class="hljs-params">(OAuth2Authentication var1)</span>;<br><br>    OAuth2Authentication <span class="hljs-title function_">consumeAuthorizationCode</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> InvalidGrantException;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ClientCredentialsTokenGranter"><a href="#ClientCredentialsTokenGranter" class="headerlink" title="ClientCredentialsTokenGranter"></a>ClientCredentialsTokenGranter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientCredentialsTokenGranter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTokenGranter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">GRANT_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;client_credentials&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> allowRefresh;<br>	<br>     <span class="hljs-keyword">public</span> OAuth2AccessToken <span class="hljs-title function_">grant</span><span class="hljs-params">(String grantType, TokenRequest tokenRequest)</span> &#123;<br>         <span class="hljs-comment">// 转发请求到父类执行，只是判断是否能够获取 刷新token</span><br>        <span class="hljs-type">OAuth2AccessToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.grant(grantType, tokenRequest);<br>        <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 根据请求头的token</span><br>            <span class="hljs-type">DefaultOAuth2AccessToken</span> <span class="hljs-variable">norefresh</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultOAuth2AccessToken</span>((OAuth2AccessToken)token);<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRefresh) &#123;<br>                norefresh.setRefreshToken((OAuth2RefreshToken)<span class="hljs-literal">null</span>);<br>            &#125;<br>            token = norefresh;<br>        &#125;<br>        <span class="hljs-keyword">return</span> (OAuth2AccessToken)token;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResourceOwnerPasswordTokenGranter"><a href="#ResourceOwnerPasswordTokenGranter" class="headerlink" title="ResourceOwnerPasswordTokenGranter"></a>ResourceOwnerPasswordTokenGranter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceOwnerPasswordTokenGranter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTokenGranter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">GRANT_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthenticationManager authenticationManager;<br>    <span class="hljs-comment">// 密码模式：直接调用密码模式进行验证，封装OAuth2Authentication</span><br>    <span class="hljs-keyword">protected</span> OAuth2Authentication <span class="hljs-title function_">getOAuth2Authentication</span><span class="hljs-params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;<br>        Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>(tokenRequest.getRequestParameters());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> (String)parameters.get(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> (String)parameters.get(<span class="hljs-string">&quot;password&quot;</span>);<br>        parameters.remove(<span class="hljs-string">&quot;password&quot;</span>);<br>        <span class="hljs-type">Authentication</span> <span class="hljs-variable">userAuth</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);<br>        ((AbstractAuthenticationToken)userAuth).setDetails(parameters);<br>       Authentication userAuth;<br>        <span class="hljs-comment">// 通过未验证 Authentication 获取 验证后的Authentication</span><br>        userAuth = <span class="hljs-built_in">this</span>.authenticationManager.authenticate(userAuth);<br>        <br>        <span class="hljs-keyword">if</span> (userAuth != <span class="hljs-literal">null</span> &amp;&amp; userAuth.isAuthenticated()) &#123;<br>            <span class="hljs-comment">// 通过Facotry，将Client信息和Request信息封装为 OAuthReqeust</span><br>            <span class="hljs-type">OAuth2Request</span> <span class="hljs-variable">storedOAuth2Request</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getRequestFactory().createOAuth2Request(client, tokenRequest);<br>            <span class="hljs-comment">// 床架OAuth2Authentication 返回</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OAuth2Authentication</span>(storedOAuth2Request, userAuth);<br>        &#125; <br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><h4 id="DefaultTokenServices"><a href="#DefaultTokenServices" class="headerlink" title="DefaultTokenServices"></a>DefaultTokenServices</h4><p>多种Service的实现和复合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultTokenServices</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthorizationServerTokenServices</span>, <br>ResourceServerTokenServices, ConsumerTokenServices, InitializingBean &#123;<br>    <span class="hljs-comment">// 设置refreshToken的有效时间</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">refreshTokenValiditySeconds</span> <span class="hljs-operator">=</span> <span class="hljs-number">2592000</span>;<br>    <span class="hljs-comment">// 设置accessToken的有效时间</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">accessTokenValiditySeconds</span> <span class="hljs-operator">=</span> <span class="hljs-number">43200</span>;<br>    <span class="hljs-comment">// 是否支持refreshToken模式</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">supportRefreshToken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// refreshToken是否可重用</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">reuseRefreshToken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">// 用于token持久化保存措施 （内存，数据库，缓存）</span><br>    <span class="hljs-keyword">private</span> TokenStore tokenStore;<br>    <span class="hljs-comment">// 用于获取ClientDetail通过 id ## loadClientByClientId()</span><br>    <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;<br>    <span class="hljs-comment">// token增强处理 -- （设置参数，加密方式等）</span><br>    <span class="hljs-keyword">private</span> TokenEnhancer accessTokenEnhancer;<br>    <span class="hljs-comment">// 验证流程的调用  （用户名密码。短信）</span><br>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411181723899.png" srcset="/img/loading.gif" lazyload alt="image-20230411181723899"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230414085922878.png" srcset="/img/loading.gif" lazyload alt="image-20230414085922878"></p>
<h5 id="AuthorizationServerTokenServices"><a href="#AuthorizationServerTokenServices" class="headerlink" title="AuthorizationServerTokenServices"></a>AuthorizationServerTokenServices</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 授权token -- 需要 OAuth2Authentication作为参数（封装好的信息）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthorizationServerTokenServices</span> &#123;<br>    <span class="hljs-comment">// 创建访问token</span><br>    OAuth2AccessToken <span class="hljs-title function_">createAccessToken</span><span class="hljs-params">(OAuth2Authentication var1)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br>	<span class="hljs-comment">// 更新访问token</span><br>    OAuth2AccessToken <span class="hljs-title function_">refreshAccessToken</span><span class="hljs-params">(String var1, TokenRequest var2)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br>	<span class="hljs-comment">// 获取访问token</span><br>    OAuth2AccessToken <span class="hljs-title function_">getAccessToken</span><span class="hljs-params">(OAuth2Authentication var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="ResourceServerTokenServices-1"><a href="#ResourceServerTokenServices-1" class="headerlink" title="ResourceServerTokenServices"></a>ResourceServerTokenServices</h5><h5 id="ConsumerTokenServices"><a href="#ConsumerTokenServices" class="headerlink" title="ConsumerTokenServices"></a>ConsumerTokenServices</h5><h4 id="AuthorizationCodeTokenServices"><a href="#AuthorizationCodeTokenServices" class="headerlink" title="AuthorizationCodeTokenServices"></a>AuthorizationCodeTokenServices</h4><h3 id="OAuth2RequestFactory"><a href="#OAuth2RequestFactory" class="headerlink" title="OAuth2RequestFactory"></a>OAuth2RequestFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 请求工厂-- 包装请求，访问API接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OAuth2RequestFactory</span> &#123;<br>    AuthorizationRequest <span class="hljs-title function_">createAuthorizationRequest</span><span class="hljs-params">(Map&lt;String, String&gt; var1)</span>;<br><br>    OAuth2Request <span class="hljs-title function_">createOAuth2Request</span><span class="hljs-params">(AuthorizationRequest var1)</span>;<br><br>    OAuth2Request <span class="hljs-title function_">createOAuth2Request</span><span class="hljs-params">(ClientDetails var1, TokenRequest var2)</span>;<br><br>    TokenRequest <span class="hljs-title function_">createTokenRequest</span><span class="hljs-params">(Map&lt;String, String&gt; var1, ClientDetails var2)</span>;<br><br>    TokenRequest <span class="hljs-title function_">createTokenRequest</span><span class="hljs-params">(AuthorizationRequest var1, String var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="信息封装"><a href="#信息封装" class="headerlink" title="信息封装"></a>信息封装</h2><h3 id="Authentication-1"><a href="#Authentication-1" class="headerlink" title="Authentication"></a>Authentication</h3><h4 id="OAuth2Authentication-1"><a href="#OAuth2Authentication-1" class="headerlink" title="OAuth2Authentication"></a>OAuth2Authentication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">4809832298438307309L</span>;<br>	<span class="hljs-comment">// 请求信息</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OAuth2Request storedRequest;<br>	<span class="hljs-comment">// 用户信息</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Authentication userAuthentication;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PreAuthenticatedAuthenticationToken"><a href="#PreAuthenticatedAuthenticationToken" class="headerlink" title="PreAuthenticatedAuthenticationToken"></a>PreAuthenticatedAuthenticationToken</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreAuthenticatedAuthenticationToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">500L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object credentials;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="BeaseRequest-封装请求"><a href="#BeaseRequest-封装请求" class="headerlink" title="BeaseRequest - 封装请求"></a>BeaseRequest - 封装请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">// 客户端id</span><br>    <span class="hljs-keyword">private</span> String clientId;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; scope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-comment">// 请求参数 （请求头 + 请求体）</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; requestParameters = Collections.unmodifiableMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230411174705602.png" srcset="/img/loading.gif" lazyload alt="image-20230411174705602"></p>
<h4 id="TokenRequest"><a href="#TokenRequest" class="headerlink" title="TokenRequest"></a>TokenRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseRequest</span> &#123;<br> 	<span class="hljs-comment">// 模式 </span><br>    <span class="hljs-keyword">private</span> String grantType;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImplicitTokenRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TokenRequest</span> &#123;<br>    <span class="hljs-keyword">private</span> OAuth2Request oauth2Request;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AuthorizationRequest"><a href="#AuthorizationRequest" class="headerlink" title="AuthorizationRequest"></a>AuthorizationRequest</h4><p>认证请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; approvalParameters = Collections.unmodifiableMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br>    <span class="hljs-keyword">private</span> String state;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; responseTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; resourceIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-keyword">private</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">approved</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> String redirectUri;<br>    <span class="hljs-keyword">private</span> Map&lt;String, Serializable&gt; extensions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="OAuth2Request"><a href="#OAuth2Request" class="headerlink" title="OAuth2Request"></a>OAuth2Request</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2Request</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; resourceIds;<br>    <span class="hljs-comment">// 权限集合</span><br>    <span class="hljs-keyword">private</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; authorities;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> approved;<br>    <span class="hljs-keyword">private</span> TokenRequest refresh;<br>    <span class="hljs-keyword">private</span> String redirectUri;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; responseTypes;<br>    <span class="hljs-keyword">private</span> Map&lt;String, Serializable&gt; extensions;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="Token信息封装-（返回值）"><a href="#Token信息封装-（返回值）" class="headerlink" title="Token信息封装 （返回值）"></a>Token信息封装 （返回值）</h2><h3 id="OAuth2AccessToken-1"><a href="#OAuth2AccessToken-1" class="headerlink" title="OAuth2AccessToken"></a>OAuth2AccessToken</h3><p>&#x2F;oauth&#x2F;token </p>
<p>1、refresh_token 模式</p>
<p>2、</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 管理</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OAuth2AccessToken</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">BEARER_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Bearer&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">OAUTH2_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;OAuth2&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">ACCESS_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;access_token&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;token_type&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">EXPIRES_IN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;expires_in&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">REFRESH_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;refresh_token&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">SCOPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;scope&quot;</span>;<br><br>    Map&lt;String, Object&gt; <span class="hljs-title function_">getAdditionalInformation</span><span class="hljs-params">()</span>;<br><br>    Set&lt;String&gt; <span class="hljs-title function_">getScope</span><span class="hljs-params">()</span>;<br><br>    OAuth2RefreshToken <span class="hljs-title function_">getRefreshToken</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getTokenType</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">()</span>;<br><br>    Date <span class="hljs-title function_">getExpiration</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getExpiresIn</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="DefaultOAuth2AccessToken"><a href="#DefaultOAuth2AccessToken" class="headerlink" title="DefaultOAuth2AccessToken"></a>DefaultOAuth2AccessToken</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultOAuth2AccessToken</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>, OAuth2AccessToken &#123;<br>    <span class="hljs-keyword">private</span> String value;<br>    <span class="hljs-comment">// 过期实践</span><br>    <span class="hljs-keyword">private</span> Date expiration;<br>    <span class="hljs-comment">// 类型</span><br>    <span class="hljs-keyword">private</span> String tokenType;<br>    <span class="hljs-keyword">private</span> OAuth2RefreshToken refreshToken;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; scope;<br>    <span class="hljs-comment">// 额外的信息</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; additionalInformation;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="OAuth2Authentication-2"><a href="#OAuth2Authentication-2" class="headerlink" title="OAuth2Authentication"></a>OAuth2Authentication</h3><p>模式：</p>
<p>authorization_code 、 implicit、password（ResourceOwnerPasswordTokenGranter）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OAuth2Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationToken</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">4809832298438307309L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OAuth2Request storedRequest;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Authentication userAuthentication;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="AccessDeniedHandler"><a href="#AccessDeniedHandler" class="headerlink" title="AccessDeniedHandler"></a>AccessDeniedHandler</h3><p>拒绝访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccessDeniedHandler</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2, AccessDeniedException var3)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416143518588.png" srcset="/img/loading.gif" lazyload alt="image-20230416143518588"></p>
<h3 id="AuthenticationFailureHandler"><a href="#AuthenticationFailureHandler" class="headerlink" title="AuthenticationFailureHandler"></a>AuthenticationFailureHandler</h3><p>校验失败</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationFailureHandler</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2, AuthenticationException var3)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416143708979.png" srcset="/img/loading.gif" lazyload alt="image-20230416143708979"></p>
<h1 id="SSO-Sigle-Sign-On"><a href="#SSO-Sigle-Sign-On" class="headerlink" title="SSO - Sigle Sign On"></a>SSO - Sigle Sign On</h1><p>问：如何实现同域单点登录和跨域单点登录 session，jwt，cookie</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">同域单点登录和跨域单点登录可以通过如下技术实现：<br><br><span class="hljs-keyword">Session</span>：同域单点登录可以使用<span class="hljs-keyword">Session</span>实现，即将用户的身份信息存放在服务器端的<span class="hljs-keyword">session</span>中。当用户第一次访问系统时，系统会为其创建一个<span class="hljs-keyword">session</span>，并在<span class="hljs-keyword">session</span>中保存用户的身份信息。之后如果再访问其他同域的子系统，就可以直接使用该<span class="hljs-keyword">session</span>来判断用户是否已经登录。<br>(对于单机，<span class="hljs-keyword">session</span>可以；对于分布式，需要采用分布式<span class="hljs-keyword">session</span> + Redis实现信息共享和传递)<br><br>Cookie：同域单点登录也可以使用Cookie实现，将用户的身份信息存储在cookie中，而不是服务器端的<span class="hljs-keyword">session</span>中。可以将cookie设置为<span class="hljs-keyword">domain</span>属性为主域名，在同一主域名下的所有子系统均可进行访问获取cookie中的用户信息，然后判断用户是否已经登录。<br><br>JWT：跨域单点登录可以使用JWT（<span class="hljs-type">JSON</span> Web Token）实现，它是一种安全的、自包含的令牌，可以在不同的系统之间传递和验证用户信息。用户在登录认证成功后，将会生成一个JWT，然后将此令牌发送到其他系统中请求资源。其他系统从JWT中解码并验证签名，从而知道这个请求是由已认证的用户发出的，并且可以查看令牌中携带的用户信息。<br><br>总结来说，使用<span class="hljs-keyword">Session</span>和Cookie等技术实现同域单点登录，使用JWT则更加适合实现跨域单点登录。同时，这些技术各有优劣，具体方案的选择要根据实际业务场景需求、安全性要求等综合考虑。<br></code></pre></td></tr></table></figure>



<p>问：分布式系统实现同域和跨域单点登录的方式</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">在分布式系统中，由于多个系统之间可能位于不同的域名下，同域和跨域单点登录实现方式会有所不同。<br><br>同域单点登录：在分布式系统中，同一个主域名下的所有子系统可以通过共享<span class="hljs-keyword">Session</span>或Cookie来实现同域单点登录。具体而言，主域名下的某一系统认证成功后，将用户信息保存到共享<span class="hljs-keyword">Session</span>或Cookie中，并设置为主域名，其他子系统就可以从<span class="hljs-keyword">Session</span>或Cookie中获取用户信息，从而实现同域单点登录。<br><br>跨域单点登录：在分布式系统中，跨域单点登录可以通过OAuth2或OpenID <span class="hljs-keyword">Connect</span>等协议来实现。这些协议都采用了JWT（<span class="hljs-type">JSON</span> Web Token）令牌，使得各个系统之间能够安全、可靠地传递身份信息。具体而言，在使用OAuth2或OpenID <span class="hljs-keyword">Connect</span>时，用户在进行身份认证时，授权服务器会生成一个JWT，包含了经过加密的用户信息和授权信息，然后将该令牌返回给客户端。客户端再将该令牌带到其他系统中，其他系统就可以根据JWT中的信息判断该用户是否已认证。<br><br>需要注意的是，跨域单点登录的实现过程需要确保令牌的安全性，例如加密、签名等措施的保护。同时，也需要保证各个系统之间的协议兼容性，确保系统之间能够顺畅地交换信息。<br></code></pre></td></tr></table></figure>



<h2 id="CAS实现单点登录"><a href="#CAS实现单点登录" class="headerlink" title="CAS实现单点登录"></a>CAS实现单点登录</h2><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/871716">基于CAS实现SSO单点登录-阿里云开发者社区 (aliyun.com)</a></p>
<p>问：sso框架CAS实现单点登录的具体实现逻辑，附加代码，原理</p>
<p>CAS（Central Authentication Service）是一种支持单点登录的开源框架，它的实现原理是基于代理机制实现的。</p>
<p>具体的实现逻辑如下：</p>
<ol>
<li>用户首次访问需要认证的应用系统A，系统A检测到用户未登录，跳转至CAS服务器进行用户认证请求。</li>
<li>CAS服务器接收到认证请求后，判断当前会话中是否存在认证凭证。如果不存在，则显示登录页面供用户输入用户名和密码进行认证；否则使用已存在的凭证信息认证用户身份。</li>
<li>用户在CAS服务器上成功认证后，CAS服务器返回一个加密的ticket给应用系统A。</li>
<li>应用系统A通过ticket向CAS服务器发起验证请求，用以确认ticket的有效性。用户访问其他应用系统B，同样需要进行上述流程。</li>
<li>如果所有的应用系统都验证通过，用户就可以在整个系统内无需重复登录，即实现了单点登录。</li>
</ol>
<p>代码实现：</p>
<p>对于Java Web应用来说，可通过引入<code>cas-client-core</code>和<code>cas-client-integration-filter</code>两个依赖，再配置web.xml文件来实现CAS客户端的集成。</p>
<p>对于Spring Boot应用，可以通过<code>spring-boot-starter-security</code>和<code>spring-security-cas</code>两个依赖进行集成，同时配置相应的yml或properties文件即可。</p>
<p>原理：</p>
<p>CAS框架的实现原理主要基于以下核心机制：Ticket、Service和Validation。</p>
<ul>
<li>Ticket：表示凭证，用来标识已经认证的用户身份。</li>
<li>Service：表示需要受到保护的服务，例如web应用程序、WebService等。</li>
<li>Validation：验证机制，主要用于验证ticket是否有效。</li>
</ul>
<p>CAS客户端只需在需要协议支持的请求中附加ticket参数，并向CAS服务器发起验证请求，从而实现服务与认证分离，使系统整体更加灵活</p>
<p>问：CAS和JWT实现单点登录的优势和区别</p>
<p>CAS和JWT都是用于实现单点登录的技术，它们各自有不同的优势和特点。</p>
<ol>
<li>CAS的优势：</li>
</ol>
<ul>
<li>CAS实现单点登录时采用了代理机制，可以支持多种协议（如CAS、OAuth、SAML等）。因此，CAS比较适合大型系统或者需要与其他系统集成的场景。</li>
<li>CAS支持用户退出功能，可以使得用户退出所有已登录的应用系统，提高用户体验和安全性。</li>
<li>CAS具有很好的扩展性，便于二次开发和定制化改造。</li>
</ul>
<ol>
<li>JWT的优势：</li>
</ol>
<ul>
<li>JWT使用JSON数据结构作为认证凭据，相对于Token，它更加轻量级和灵活，可以轻松携带一些个性化的信息（如用户角色、权限等）。</li>
<li>JWT的运行速度快，验证简单，在微服务和API网关中非常实用。</li>
<li>JWT可以避免对CAS服务器的依赖，避免了单点故障等问题。</li>
</ul>
<p>区别：</p>
<ul>
<li>实现方面：CAS基于代理机制，而JWT主要是通过Token机制来实现。两者略有不同的认证流程。</li>
<li>认证凭据：CAS的认证凭据是Ticket，而JWT的认证凭据是Token。</li>
<li>安全性：CAS采用了一系列的安全机制和预防措施；而JWT因为Token数据存储在客户端，一旦被篡改或者泄露，会导致较大的风险。</li>
<li>扩展性：CAS可以定制化改造和扩展，更适用于大型系统；而JWT则更适用于轻量级应用和API网关。</li>
</ul>
<h1 id="第三方登录"><a href="#第三方登录" class="headerlink" title="第三方登录"></a>第三方登录</h1><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1447723">第三方登录：微信扫码登录（OAuth2.0 - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<p>步骤：</p>
<p>创建开发者，绑定应用，获取ClientId和ClientSecret</p>
<p>关键参数：</p>
<p>1、请求code：ClientId, redirect_uri, response_type &#x3D; code state&#x3D;xx</p>
<p>返回code：code, state</p>
<p>2、请求access_token ： ClientId, ClientSecret, grant_tpye &#x3D; “authorization_code” , state, code </p>
<p>返回：access_token, refresh_token， openid,</p>
<p>3、请求用户信息：access_token, openid</p>
<h2 id="请求url说明"><a href="#请求url说明" class="headerlink" title="请求url说明"></a>请求url说明</h2><p>　　第三方使用网站应用授权登录前请注意已获取相应网页授权作用域（scope&#x3D;snsapi_login），则可以通过在PC端打开以下链接：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">https</span>:<span class="hljs-comment">//open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</span><br></code></pre></td></tr></table></figure>



<p> <strong>参数说明</strong> </p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">appid</td>
<td align="left">是</td>
<td align="left">应用唯一标识（前面认证网页应用中获得）</td>
</tr>
<tr>
<td align="left">redirect_uri</td>
<td align="left">是</td>
<td align="left">重定向地址，需要进行UrlEncode（前面认证网页应用中获得）</td>
</tr>
<tr>
<td align="left">response_type</td>
<td align="left">是</td>
<td align="left">填code</td>
</tr>
<tr>
<td align="left">scope</td>
<td align="left">是</td>
<td align="left">应用授权作用域，拥有多个作用域用逗号（,）分隔，网页应用目前仅填写snsapi_login即可</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">否</td>
<td align="left">用于保持请求和回调的状态，授权请求后原样带回给第三方。该参数可用于防止csrf攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数加session进行校验</td>
</tr>
</tbody></table>
<p> <strong>返回说明</strong></p>
<p> 　用户允许授权后，将会重定向到redirect_uri的网址上，并且带上code和state参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">redirect_uri?code=<span class="hljs-variable constant_">CODE</span>&amp;state=<span class="hljs-variable constant_">STATE</span><br></code></pre></td></tr></table></figure>

<p>复制</p>
<p> 　若用户禁止授权，则重定向后不会带上code参数，仅会带上state参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">redirect_uri?state=<span class="hljs-variable constant_">STATE</span><br></code></pre></td></tr></table></figure>



<p><img src="https://ask.qcloudimg.com/http-save/4069933/m9kd4b9pdm.png?imageView2/2/w/2560/h/7000" srcset="/img/loading.gif" lazyload alt="img"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Spring/" class="category-chain-item">Spring</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spring/">#Spring</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring Security Oauth2</div>
      <div>http://example.com/2023/06/01/Spring家族/Spring Security Oauth2/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>where</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/06/01/Spring%E5%AE%B6%E6%97%8F/Spring-Project-ChatGPT/" title="Spring-Project-ChatGTP">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring-Project-ChatGTP</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/01/ECS/%E8%BF%90%E7%BB%B4/" title="运维">
                        <span class="hidden-mobile">运维</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
