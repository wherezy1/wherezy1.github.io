

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="where">
  <meta name="keywords" content="">
  
    <meta name="description" content="Spring Boot         启动流程SpringApplication 初始化 – 通过springFactoryLoader加载ApplicationLisener 和 ApplicationInitailize SpringApplication run方法，进行上下文初始化，主要是对context的准备工作 ​	包括：配置文件ymal，properties的加载，Environm">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot">
<meta property="og:url" content="http://example.com/2023/06/01/Spring%E5%AE%B6%E6%97%8F/Spring%20Boot/index.html">
<meta property="og:site_name" content="where&#39;s blog">
<meta property="og:description" content="Spring Boot         启动流程SpringApplication 初始化 – 通过springFactoryLoader加载ApplicationLisener 和 ApplicationInitailize SpringApplication run方法，进行上下文初始化，主要是对context的准备工作 ​	包括：配置文件ymal，properties的加载，Environm">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_294379_J5c9PiLtLL63lXzG_1692923206?w=960&h=436&type=image/jpeg">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_735593_FCFjC_OZBH8zVYQI_1692923206?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_948702_VxRXMzlD7Khtu223_1692923206?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_12594_vllu4CfZdcSqNVRq_1692923207?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_202402_Op8TiC40FPim7wp6_1692923207?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_345922_Bzs4A8D9Kr2YbOZF_1692923207?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_536115_1ce-4mfIVKw20xMl_1692923207?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_764709_w1ByiEq3Su612q8d_1692923207?w=960&h=436&type=image/png">
<meta property="og:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_852722_eExDY0oOTE8NzSVN_1692923207?w=960&h=436&type=image/png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403140959807.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403141946420.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403142450132.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/05c95482d3344cb5acaf14b7aea3da0a%7Etplv-k3u1fbpfcp-zoom-in-crop-mark%3A4536%3A0%3A0%3A0.awebp">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416183108300.png">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/842e517b49c348788007c6153b74cf89~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f61b6029ddd47e5a454e8ecaa154979~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c30936c75a14d0987ebbbdda4ea1318~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1607e4dc5bb74e25a4747ab4916dfccc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a9635e5076f4846b87873cc0985fab1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e47bec73004f49c19ac4676ac7d0c705~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230723171852456.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416180842001.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416173223790.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416173515198.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403221322756.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403145408653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403145219276.png">
<meta property="og:image" content="http://example.com/1:%5CUsers%5CLENOVO%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230403143713985.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403143445794.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403143531413.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403112543262.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230401155405556.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403105752794.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403110101738.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403110124284.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403203854079.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403204454935.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403204359601.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403203655701.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403141331634.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403140342476.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403112739812.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403150305959.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403200131249.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195553426.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195333627.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406213250432.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406222830105.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195527591.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195419065.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403193159013.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403193342924.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403194257013.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/c7c3324f280cd2a92cb57d72768b426e.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403224847280.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403233526671.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404145015644.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422095010110.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422095029546.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422100239271.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422100745459.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416201130823.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404141739106.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404141636814.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405164119306.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405165929687.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405180654563.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405165729107.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405175501722.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406200155882.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405161939755.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405221715635.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222028275.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222137380.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222505694.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222931657.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222946836.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222835592.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405231025354.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405231238795.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405231331607.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406104600568.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405233548524.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406092414132.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406112053207.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406113728786.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406085006730.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406115216050.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406115306753.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120704728.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120420212.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404172920442.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404173001921.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404173027368.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120616038.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120823535.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406121146203.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120835618.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230712082954049.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230712083639599.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416162221630.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416162125168.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230723172702175.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230412112047479.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200320214625506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dhbmd3ZWkxOTg3MTEwMw==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230410152227214.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230410171445188.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406233747409.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406234800354.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406235010626.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406234346965.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230407235054392.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/aaaa.png">
<meta property="article:published_time" content="2023-05-31T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-12T01:06:53.067Z">
<meta property="article:author" content="where">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_294379_J5c9PiLtLL63lXzG_1692923206?w=960&h=436&type=image/jpeg">
  
  
  
  <title>Spring Boot - where&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring Boot"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-01 00:00" pubdate>
          2023年6月1日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          193k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1611 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Spring Boot</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h1><p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_294379_J5c9PiLtLL63lXzG_1692923206?w=960&h=436&type=image/jpeg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_735593_FCFjC_OZBH8zVYQI_1692923206?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_948702_VxRXMzlD7Khtu223_1692923206?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_12594_vllu4CfZdcSqNVRq_1692923207?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_202402_Op8TiC40FPim7wp6_1692923207?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_345922_Bzs4A8D9Kr2YbOZF_1692923207?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_536115_1ce-4mfIVKw20xMl_1692923207?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_764709_w1ByiEq3Su612q8d_1692923207?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://wdoc-76491.picgzc.qpic.cn/MTY4ODg1NTAwMDQ1OTQwMg_852722_eExDY0oOTE8NzSVN_1692923207?w=960&h=436&type=image/png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h1 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h1><p>SpringApplication 初始化 – 通过springFactoryLoader加载ApplicationLisener 和 ApplicationInitailize</p>
<p>SpringApplication run方法，进行上下文初始化，主要是对context的准备工作</p>
<p>​	包括：配置文件ymal，properties的加载，Environment环境变量的获取和设置，</p>
<p>​			初始化Context，并实例化AnnotationBeanDefinitionReader等用于读取Resource,注册为BeanDefinitoin的读取器，将Component注解的类注册为BeanDefinition（主要为Configuraiton），会在InvokeBeanFactoryPostProcessor()方法中进行各种 配置类的解析，注入（@Import注解，@Bean，Component，ComponentScan，Import，ImportResource）</p>
<p>AbstractApplicationContext的refresh()</p>
<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><h3 id="SpringApplication"><a href="#SpringApplication" class="headerlink" title="SpringApplication()"></a>SpringApplication()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">SpringApplication</span><span class="hljs-params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;<br>        <span class="hljs-built_in">this</span>.primarySources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(Arrays.asList(primarySources));<br>        <span class="hljs-built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();<br>    	<span class="hljs-comment">// 实现ApplicationContextInitializer 可以实现initialize()将Bean注册到SingletonMap</span><br>         <span class="hljs-comment">// 实现接口进行初始化，再SpringApplication中设置属性</span><br>        <span class="hljs-comment">// 在SpringApplication##run() ### prepareContext()方法中调用</span><br>        <span class="hljs-built_in">this</span>.setInitializers(<span class="hljs-built_in">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer.class));<br>    	<span class="hljs-comment">// META-INF/spring.factories</span><br>        <span class="hljs-built_in">this</span>.setListeners(<span class="hljs-built_in">this</span>.getSpringFactoriesInstances(ApplicationListener.class));<br>        <span class="hljs-built_in">this</span>.mainApplicationClass = <span class="hljs-built_in">this</span>.deduceMainApplicationClass();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="SpringApplication-run"><a href="#SpringApplication-run" class="headerlink" title="SpringApplication ## run()"></a>SpringApplication ## run()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ConfigurableApplicationContext <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> &#123;<br>        <span class="hljs-type">StopWatch</span> <span class="hljs-variable">stopWatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StopWatch</span>();<br>        stopWatch.start();<br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-built_in">this</span>.configureHeadlessProperty();<br>        <span class="hljs-type">SpringApplicationRunListeners</span> <span class="hljs-variable">listeners</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getRunListeners(args);<br>    	<span class="hljs-comment">// 发布容器启动事件</span><br>        listeners.starting();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 封装args 为 ApplicationArguments</span><br>            <span class="hljs-type">ApplicationArguments</span> <span class="hljs-variable">applicationArguments</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultApplicationArguments</span>(args);<br>            <span class="hljs-comment">// 准备环境信息</span><br>            <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareEnvironment(listeners, applicationArguments);<br>            <span class="hljs-built_in">this</span>.configureIgnoreBeanInfo(environment);<br>            <span class="hljs-type">Banner</span> <span class="hljs-variable">printedBanner</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.printBanner(environment);<br>            <span class="hljs-comment">// 创建ApplicationCOntext </span><br>            context = <span class="hljs-built_in">this</span>.createApplicationContext();<br>            <span class="hljs-comment">// initialize方法调用</span><br>            <span class="hljs-built_in">this</span>.prepareContext(context, environment, listeners, applicationArguments, printedBanner);<br>            <span class="hljs-comment">// 调用 AbstractApplicationCOntext 的 refresh()方法创建容器</span><br>            <span class="hljs-built_in">this</span>.refreshContext(context);<br>            <span class="hljs-comment">// spring boot - refresh后的操作</span><br>            <span class="hljs-built_in">this</span>.afterRefresh(context, applicationArguments);<br>            stopWatch.stop();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logStartupInfo) &#123;<br>                (<span class="hljs-keyword">new</span> <span class="hljs-title class_">StartupInfoLogger</span>(<span class="hljs-built_in">this</span>.mainApplicationClass)).logStarted(<span class="hljs-built_in">this</span>.getApplicationLog(), stopWatch);<br>            &#125;<br>			<span class="hljs-comment">// 事件发布</span><br>            listeners.started(context);<br>            <span class="hljs-built_in">this</span>.callRunners(context, applicationArguments);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var9) &#123;<br>            <span class="hljs-built_in">this</span>.handleRunFailure(context, var9, listeners);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(var9);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            listeners.running(context);<br>            <span class="hljs-keyword">return</span> context;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var8) &#123;<br>            <span class="hljs-built_in">this</span>.handleRunFailure(context, var8, (SpringApplicationRunListeners)<span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(var8);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>



<h3 id="AbstractApplicationContext-refresh"><a href="#AbstractApplicationContext-refresh" class="headerlink" title="AbstractApplicationContext ## refresh()"></a>AbstractApplicationContext ## refresh()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>            <span class="hljs-built_in">this</span>.prepareRefresh();<br>            <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.obtainFreshBeanFactory();<br>            <span class="hljs-built_in">this</span>.prepareBeanFactory(beanFactory);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 初始化 BeanFactoryPostProcessor</span><br>                <span class="hljs-built_in">this</span>.postProcessBeanFactory(beanFactory);<br>          		<span class="hljs-comment">// 调用BeanFactoryPostProcessor的方法，初始化BeanDefinition</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                * 5：调用bean工厂的后置处理器</span><br><span class="hljs-comment">                * 这里将满足条件的Bean变成Bean定义（BeanDefinition）</span><br><span class="hljs-comment">                * 在这里才是真正的去解析类及类中的元素注解</span><br><span class="hljs-comment">                * 例如：@Configuration、@ComponentScan、@Bean等等最后将这些Bean定义放入到BeanDefinitionMap中</span><br><span class="hljs-comment">                * 有因必有果，这里调用了之前创建的创世纪处理器Bean定义（BeanDefinition）：ConfigurationClassPostProcessor；即单独调用一次getBean</span><br><span class="hljs-comment">                * 因为ConfigurationClassPostProcessor这个创世纪处理器对象拥有绝对的优先权，创世纪的处理器都没有被创建，那后面还玩个屁</span><br><span class="hljs-comment">                * */</span><br>                <span class="hljs-built_in">this</span>.invokeBeanFactoryPostProcessors(beanFactory);<br>                <span class="hljs-comment">// </span><br>                <span class="hljs-built_in">this</span>.registerBeanPostProcessors(beanFactory);<br>                <span class="hljs-built_in">this</span>.initMessageSource();<br>                <span class="hljs-built_in">this</span>.initApplicationEventMulticaster();<br>                <span class="hljs-built_in">this</span>.onRefresh();<br>                <span class="hljs-built_in">this</span>.registerListeners();<br>                <span class="hljs-comment">// 非懒加载Bean的创建</span><br>                <span class="hljs-built_in">this</span>.finishBeanFactoryInitialization(beanFactory);<br>                <span class="hljs-built_in">this</span>.finishRefresh();<br>            &#125; <span class="hljs-keyword">catch</span> (BeansException var9) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isWarnEnabled()) &#123;<br>                    <span class="hljs-built_in">this</span>.logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot;</span> + var9);<br>                &#125;<br><br>                <span class="hljs-built_in">this</span>.destroyBeans();<br>                <span class="hljs-built_in">this</span>.cancelRefresh(var9);<br>                <span class="hljs-keyword">throw</span> var9;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-built_in">this</span>.resetCommonCaches();<br>            &#125;<br><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>











<h2 id="SpringApplication-1"><a href="#SpringApplication-1" class="headerlink" title="SpringApplication()"></a>SpringApplication()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">SpringApplication</span><span class="hljs-params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;<br>    <span class="hljs-built_in">this</span>.primarySources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(Arrays.asList(primarySources));<br>    <span class="hljs-built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();<br>	<span class="hljs-comment">// 初始化器</span><br>    <span class="hljs-built_in">this</span>.setInitializers(<span class="hljs-built_in">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer.class));<br>    <span class="hljs-built_in">this</span>.setListeners(<span class="hljs-built_in">this</span>.getSpringFactoriesInstances(ApplicationListener.class));<br>    <span class="hljs-built_in">this</span>.mainApplicationClass = <span class="hljs-built_in">this</span>.deduceMainApplicationClass();<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ApplicationContextInitializer"><a href="#ApplicationContextInitializer" class="headerlink" title="ApplicationContextInitializer"></a>ApplicationContextInitializer</h3><p>调用实现了ApplicationContextInitializer接口的实现类的initialize方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.AbstractApplicationContext 类下防范</span><br>    ## run() ## <span class="hljs-built_in">this</span>.prepareContext(context, environment, listeners, applicationArguments, printedBanner);<br><span class="hljs-comment">// 2.  ## prepareContext() ### this.applyInitializers(context);</span><br><span class="hljs-comment">// 3.  ## applyInitializers() ## initializer.initialize(context);</span><br><span class="hljs-comment">// 4.  DelegatingApplicationContextInitializer ## initialize();</span><br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>        <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> context.getEnvironment();<br>        List&lt;Class&lt;?&gt;&gt; initializerClasses = <span class="hljs-built_in">this</span>.getInitializerClasses(environment);<br>        <span class="hljs-keyword">if</span> (!initializerClasses.isEmpty()) &#123;<br>            <span class="hljs-built_in">this</span>.applyInitializerClasses(context, initializerClasses);<br>        &#125;<br>    &#125;<br><span class="hljs-number">4.</span> <br></code></pre></td></tr></table></figure>



<h1 id="Context模块"><a href="#Context模块" class="headerlink" title="Context模块"></a>Context模块</h1><h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a><strong>ApplicationContext</strong></h2><p>汇总 - BeanFactory, Resourceloader, Publisher, Environment</p>
<p>即包含 获取Bean，加载spring.factory等文件，BeanDefinition，事件的发布和监听，系统环境变量</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403140959807.png" srcset="/img/loading.gif" lazyload alt="image-20230403140959807"></p>
<h3 id="AbstractApplicationContext"><a href="#AbstractApplicationContext" class="headerlink" title="AbstractApplicationContext"></a>AbstractApplicationContext</h3><p>重点实现类：<strong>AbstractApplicationContext</strong></p>
<p><strong>包含Refresh() 等一系列方法的实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MESSAGE_SOURCE_BEAN_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;messageSource&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LIFECYCLE_PROCESSOR_BEAN_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lifecycleProcessor&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;applicationEventMulticaster&quot;</span>;<br>    <span class="hljs-keyword">private</span> String id;<br>    <span class="hljs-keyword">private</span> String displayName;<br>    <span class="hljs-comment">// 用于定义父容器</span><br>    <span class="hljs-keyword">private</span> ApplicationContext parent;<br>    <span class="hljs-comment">// 当前容器运行的环境变量 -- 获取配置文件</span><br>    <span class="hljs-keyword">private</span> ConfigurableEnvironment environment;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> startupDate;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicBoolean active;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicBoolean closed;<br>    <span class="hljs-comment">// 容器关闭的线程钩子 - 包含容器关闭的方法 AbstractApplicationContext.this.doClose();</span><br>    <span class="hljs-keyword">private</span> Thread shutdownHook;<br>    <span class="hljs-comment">// 注册shutdownHook的锁</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object startupShutdownMonitor;<br>    <br>    <span class="hljs-keyword">private</span> ResourcePatternResolver resourcePatternResolver;<br>    <span class="hljs-comment">// 包含的BeanFactory的生命周期</span><br>    <span class="hljs-keyword">private</span> LifecycleProcessor lifecycleProcessor;<br>    <span class="hljs-comment">// this.initMessageSource(); -&gt; 初始化国际化信息 （Locale）</span><br>    <span class="hljs-keyword">private</span> MessageSource messageSource;<br>    <span class="hljs-comment">// 事件广播器，用于发布事件</span><br>    <span class="hljs-keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;<br>    <span class="hljs-comment">// 事件监听者，遍历发布事件通知</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;ApplicationListener&lt;?&gt;&gt; applicationListeners;<br>    <span class="hljs-keyword">private</span> Set&lt;ApplicationListener&lt;?&gt;&gt; earlyApplicationListeners;<br>    <span class="hljs-comment">// 事件集合</span><br>    <span class="hljs-keyword">private</span> Set&lt;ApplicationEvent&gt; earlyApplicationEvents;<br></code></pre></td></tr></table></figure>



<img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403141946420.png" srcset="/img/loading.gif" lazyload alt="image-20230403141946420"  />



<h4 id="LifecycleProcessor"><a href="#LifecycleProcessor" class="headerlink" title="LifecycleProcessor"></a>LifecycleProcessor</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403142450132.png" srcset="/img/loading.gif" lazyload alt="image-20230403142450132"></p>
<h4 id="AbstractEnvironment"><a href="#AbstractEnvironment" class="headerlink" title="AbstractEnvironment"></a>AbstractEnvironment</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractEnvironment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableEnvironment</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IGNORE_GETENV_PROPERTY_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.getenv.ignore&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTIVE_PROFILES_PROPERTY_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.profiles.active&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PROFILES_PROPERTY_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.profiles.default&quot;</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RESERVED_DEFAULT_PROFILE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; activeProfiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; defaultProfiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(<span class="hljs-built_in">this</span>.getReservedDefaultProfiles());<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MutablePropertySources</span> <span class="hljs-variable">propertySources</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutablePropertySources</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConfigurablePropertyResolver propertyResolver;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="信息获取"><a href="#信息获取" class="headerlink" title="信息获取"></a>信息获取</h1><p>两种：以前和现在</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b307d1a5c1bb">SpringBoot外部化配置相关源码API剖析和扩展 - 简书 (jianshu.com)</a></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/05c95482d3344cb5acaf14b7aea3da0a%7Etplv-k3u1fbpfcp-zoom-in-crop-mark%3A4536%3A0%3A0%3A0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h2><h3 id="SpringApplication-2"><a href="#SpringApplication-2" class="headerlink" title="SpringApplication"></a>SpringApplication</h3><p>1、run() ## ConfigurableEnvironment environment &#x3D; this.prepareEnvironment(listeners, applicationArguments);</p>
<p>2、prepareEnvironment()  ## listeners.environmentPrepared((ConfigurableEnvironment)environment);</p>
<p>SpringApplicationRunListeners ## </p>
<p>3、environmentPrepared()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">environmentPrepared</span><span class="hljs-params">(ConfigurableEnvironment environment)</span> &#123;<br>       <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.listeners.iterator();<br><br>       <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>           <span class="hljs-type">SpringApplicationRunListener</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> (SpringApplicationRunListener)var2.next();<br>           listener.environmentPrepared(environment);<br>       &#125;<br><br>   &#125;<br></code></pre></td></tr></table></figure>

<h3 id="EvenPublishingRunListeners"><a href="#EvenPublishingRunListeners" class="headerlink" title="EvenPublishingRunListeners"></a>EvenPublishingRunListeners</h3><p>4、environmentPrepared() ## </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">environmentPrepared</span><span class="hljs-params">(ConfigurableEnvironment environment)</span> &#123;<br>    <span class="hljs-built_in">this</span>.initialMulticaster.multicastEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationEnvironmentPreparedEvent</span>(<span class="hljs-built_in">this</span>.application, <span class="hljs-built_in">this</span>.args, environment));<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="SimpleApplicationMulticaster"><a href="#SimpleApplicationMulticaster" class="headerlink" title="SimpleApplicationMulticaster"></a>SimpleApplicationMulticaster</h3><p>5、multicastEvent() ## multicastEvent()  ## invokeListener()  ## doInvokeListener() </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">multicastEvent</span><span class="hljs-params">(ApplicationEvent event)</span> &#123;<br>    <span class="hljs-built_in">this</span>.multicastEvent(event, <span class="hljs-built_in">this</span>.resolveDefaultEventType(event));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">multicastEvent</span><span class="hljs-params">(ApplicationEvent event, <span class="hljs-meta">@Nullable</span> ResolvableType eventType)</span> &#123;<br>    <span class="hljs-type">ResolvableType</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> eventType != <span class="hljs-literal">null</span> ? eventType : <span class="hljs-built_in">this</span>.resolveDefaultEventType(event);<br>    <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getTaskExecutor();<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getApplicationListeners(event, type).iterator();<br><br>    <span class="hljs-keyword">while</span>(var5.hasNext()) &#123;<br>        ApplicationListener&lt;?&gt; listener = (ApplicationListener)var5.next();<br>        <span class="hljs-keyword">if</span> (executor != <span class="hljs-literal">null</span>) &#123;<br>            executor.execute(() -&gt; &#123;<br>                <span class="hljs-built_in">this</span>.invokeListener(listener, event);<br>            &#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.invokeListener(listener, event);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeListener</span><span class="hljs-params">(ApplicationListener&lt;?&gt; listener, ApplicationEvent event)</span> &#123;<br>    <span class="hljs-type">ErrorHandler</span> <span class="hljs-variable">errorHandler</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getErrorHandler();<br>    <span class="hljs-keyword">if</span> (errorHandler != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.doInvokeListener(listener, event);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var5) &#123;<br>            errorHandler.handleError(var5);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.doInvokeListener(listener, event);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doInvokeListener</span><span class="hljs-params">(ApplicationListener listener, ApplicationEvent event)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            listener.onApplicationEvent(event);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassCastException var6) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> var6.getMessage();<br>            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.matchesClassCastMessage(msg, event.getClass())) &#123;<br>                <span class="hljs-keyword">throw</span> var6;<br>            &#125;<br><br>            <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-string">&quot;Non-matching event type for listener: &quot;</span> + listener, var6);<br>            &#125;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="ApplicationListener"><a href="#ApplicationListener" class="headerlink" title="ApplicationListener"></a>ApplicationListener</h3><p>6、onApplicationEvent() </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationListener</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EventListener</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(E var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ConfigFileApplicationListener"><a href="#ConfigFileApplicationListener" class="headerlink" title="ConfigFileApplicationListener"></a>ConfigFileApplicationListener</h3><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416183108300.png" srcset="/img/loading.gif" lazyload alt="image-20230416183108300"></p>
<p>7、onApplicationEvent()  ### onApplicationEnvironmentPreparedEvent() ##  ## loadPostProcessors()</p>
<p>#####postProcessEnvironment()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ApplicationEvent event)</span> &#123;<br>    <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) &#123;<br>        <span class="hljs-built_in">this</span>.onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent)event);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ApplicationPreparedEvent) &#123;<br>        <span class="hljs-built_in">this</span>.onApplicationPreparedEvent(event);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// onApplicationEnvironmentPreparedEvent()</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEnvironmentPreparedEvent</span><span class="hljs-params">(ApplicationEnvironmentPreparedEvent event)</span> &#123;<br>     List&lt;EnvironmentPostProcessor&gt; postProcessors = <span class="hljs-built_in">this</span>.loadPostProcessors();<br>     postProcessors.add(<span class="hljs-built_in">this</span>);<br>     AnnotationAwareOrderComparator.sort(postProcessors);<br>     <span class="hljs-type">Iterator</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> postProcessors.iterator();<br><br>     <span class="hljs-keyword">while</span>(var3.hasNext()) &#123;<br>         <span class="hljs-type">EnvironmentPostProcessor</span> <span class="hljs-variable">postProcessor</span> <span class="hljs-operator">=</span> (EnvironmentPostProcessor)var3.next();<br>         postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());<br>     &#125;<br><br> &#125;<br><span class="hljs-comment">/// 加载 EnvironmentPostProcessor的 key -- value</span><br><span class="hljs-comment">// loadPostProcessors()</span><br>List&lt;EnvironmentPostProcessor&gt; <span class="hljs-title function_">loadPostProcessors</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>&#125;<br><span class="hljs-comment">// postProcessEnvironment()</span><br><span class="hljs-comment">// 添加 PropertySources</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessEnvironment</span><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span> &#123;<br>    <span class="hljs-built_in">this</span>.addPropertySources(environment, application.getResourceLoader());<br>&#125;<br><br><span class="hljs-comment">// addPropertySources()</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPropertySources</span><span class="hljs-params">(ConfigurableEnvironment environment, ResourceLoader resourceLoader)</span> &#123;<br>        RandomValuePropertySource.addToEnvironment(environment);<br>    	<span class="hljs-comment">// 加载 ProperySourceLoader -- Yaml / Properties</span><br>        (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigFileApplicationListener</span>.Loader(environment, resourceLoader)).load();<br>    &#125;<br>	<span class="hljs-comment">// Loader()</span><br>Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) &#123;<br>    <span class="hljs-built_in">this</span>.logger = ConfigFileApplicationListener.<span class="hljs-built_in">this</span>.logger;<br>    <span class="hljs-built_in">this</span>.loadDocumentsCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-built_in">this</span>.environment = environment;<br>    <span class="hljs-built_in">this</span>.placeholdersResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertySourcesPlaceholdersResolver</span>(<span class="hljs-built_in">this</span>.environment);<br>    <span class="hljs-built_in">this</span>.resourceLoader = (ResourceLoader)(resourceLoader != <span class="hljs-literal">null</span> ? resourceLoader : <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>((ClassLoader)<span class="hljs-literal">null</span>));<br>    <span class="hljs-comment">// // 加载 ProperySourceLoader -- Yaml / Properties</span><br>    <span class="hljs-built_in">this</span>.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader.class, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>&#125;<br><br><span class="hljs-comment">// load()</span><br><span class="hljs-comment">// load()方法调用 - 直到 loader.load()方法</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> &#123;<br>    FilteredPropertySource.apply(<span class="hljs-built_in">this</span>.environment, <span class="hljs-string">&quot;defaultProperties&quot;</span>, ConfigFileApplicationListener.LOAD_FILTERED_PROPERTY, (defaultProperties) -&gt; &#123;<br>        <span class="hljs-built_in">this</span>.profiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>();<br>        <span class="hljs-built_in">this</span>.processedProfiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>();<br>        <span class="hljs-built_in">this</span>.activatedProfiles = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">this</span>.loaded = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>();<br>        <span class="hljs-built_in">this</span>.initializeProfiles();<br><br>        <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">this</span>.profiles.isEmpty()) &#123;<br>            ConfigFileApplicationListener.<span class="hljs-type">Profile</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> (ConfigFileApplicationListener.Profile)<span class="hljs-built_in">this</span>.profiles.poll();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isDefaultProfile(profile)) &#123;<br>                <span class="hljs-built_in">this</span>.addProfileToEnvironment(profile.getName());<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.load(profile, <span class="hljs-built_in">this</span>::getPositiveProfileFilter, <span class="hljs-built_in">this</span>.addToLoaded(MutablePropertySources::addLast, <span class="hljs-literal">false</span>));<br>            <span class="hljs-built_in">this</span>.processedProfiles.add(profile);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.load((ConfigFileApplicationListener.Profile)<span class="hljs-literal">null</span>, <span class="hljs-built_in">this</span>::getNegativeProfileFilter, <span class="hljs-built_in">this</span>.addToLoaded(MutablePropertySources::addFirst, <span class="hljs-literal">true</span>));<br>        <span class="hljs-built_in">this</span>.addLoadedPropertySources();<br>        <span class="hljs-built_in">this</span>.applyActiveProfiles(defaultProperties);<br>    &#125;);<br>&#125;<br><span class="hljs-comment">// 。。。。。。。。。。。。。。。。。</span><br></code></pre></td></tr></table></figure>

<h3 id="PropertySourceLoader"><a href="#PropertySourceLoader" class="headerlink" title="PropertySourceLoader"></a>PropertySourceLoader</h3><p>8、List&lt;PropertySource&lt;?&gt;&gt; loaded &#x3D; loader.load(name, resource);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PropertySourceLoader</span> &#123;<br>    String[] getFileExtensions();<br><br>    List&lt;PropertySource&lt;?&gt;&gt; load(String name, Resource resource) <span class="hljs-keyword">throws</span> IOException;<br>&#125;<br><br><br><br><span class="hljs-keyword">private</span> List&lt;ConfigFileApplicationListener.Document&gt; loadDocuments(PropertySourceLoader loader, String name, Resource resource) <span class="hljs-keyword">throws</span> IOException &#123;<br>            ConfigFileApplicationListener.<span class="hljs-type">DocumentsCacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigFileApplicationListener</span>.DocumentsCacheKey(loader, resource);<br>            List&lt;ConfigFileApplicationListener.Document&gt; documents = (List)<span class="hljs-built_in">this</span>.loadDocumentsCache.get(cacheKey);<br>            <span class="hljs-keyword">if</span> (documents == <span class="hljs-literal">null</span>) &#123;<br>                List&lt;PropertySource&lt;?&gt;&gt; loaded = loader.load(name, resource);<br>                documents = <span class="hljs-built_in">this</span>.asDocuments(loaded);<br>                <span class="hljs-built_in">this</span>.loadDocumentsCache.put(cacheKey, documents);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> documents;<br>        &#125;<br></code></pre></td></tr></table></figure>



<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigFileApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span>, SmartApplicationListener, Ordered &#123;<br>   	<span class="hljs-comment">// 封装 List&lt;PropertySource&lt;?&gt;&gt; </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PropertySource&lt;?&gt; propertySource;<br>        <span class="hljs-keyword">private</span> String[] profiles;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;ConfigFileApplicationListener.Profile&gt; activeProfiles;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;ConfigFileApplicationListener.Profile&gt; includeProfiles;<br>    &#125;<br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Profile</span> &#123;<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> defaultProfile;<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/842e517b49c348788007c6153b74cf89~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f61b6029ddd47e5a454e8ecaa154979~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c30936c75a14d0987ebbbdda4ea1318~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1607e4dc5bb74e25a4747ab4916dfccc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a9635e5076f4846b87873cc0985fab1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e47bec73004f49c19ac4676ac7d0c705~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>spring boot </p>
<h2 id="EnvironmentPostProcessor"><a href="#EnvironmentPostProcessor" class="headerlink" title="EnvironmentPostProcessor"></a>EnvironmentPostProcessor</h2><p>加载 对应的 环境加载机制到类 到 Spring 容器</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230723171852456.png" srcset="/img/loading.gif" lazyload alt="image-20230723171852456"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EnvironmentPostProcessor</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessEnvironment</span><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ConfigFileApplicationListener-1"><a href="#ConfigFileApplicationListener-1" class="headerlink" title="ConfigFileApplicationListener"></a>ConfigFileApplicationListener</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigFileApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span>, SmartApplicationListener, Ordered &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PROPERTIES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;defaultProperties&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SEARCH_LOCATIONS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;classpath:/,classpath:/config/,file:./,file:./config/*/,file:./config/&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;application&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; NO_SEARCH_NAMES = Collections.singleton((Object)<span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Bindable&lt;String[]&gt; STRING_ARRAY = Bindable.of(String[].class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Bindable&lt;List&lt;String&gt;&gt; STRING_LIST = Bindable.listOf(String.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; LOAD_FILTERED_PROPERTY;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTIVE_PROFILES_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.profiles.active&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INCLUDE_PROFILES_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.profiles.include&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIG_NAME_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.config.name&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIG_LOCATION_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.config.location&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIG_ADDITIONAL_LOCATION_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.config.additional-location&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_ORDER</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2147483638</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DeferredLog</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredLog</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Resource[] EMPTY_RESOURCES;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Comparator&lt;File&gt; FILE_COMPARATOR;<br>    <span class="hljs-keyword">private</span> String searchLocations;<br>    <span class="hljs-keyword">private</span> String names;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2147483638</span>;<br>    <br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Loader</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Log logger;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConfigurableEnvironment environment;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PropertySourcesPlaceholdersResolver placeholdersResolver;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;<br>        <span class="hljs-comment">// PropertySourceLoader</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;PropertySourceLoader&gt; propertySourceLoaders;<br>        <span class="hljs-keyword">private</span> Deque&lt;ConfigFileApplicationListener.Profile&gt; profiles;<br>        <span class="hljs-keyword">private</span> List&lt;ConfigFileApplicationListener.Profile&gt; processedProfiles;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> activatedProfiles;<br>        <span class="hljs-keyword">private</span> Map&lt;ConfigFileApplicationListener.Profile, MutablePropertySources&gt; loaded;<br>        <span class="hljs-keyword">private</span> Map&lt;ConfigFileApplicationListener.DocumentsCacheKey, 	List&lt;ConfigFileApplicationListener.Document&gt;&gt; loadDocumentsCache;<br><br>        Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) &#123;<br>            <span class="hljs-built_in">this</span>.logger = ConfigFileApplicationListener.<span class="hljs-built_in">this</span>.logger;<br>            <span class="hljs-built_in">this</span>.loadDocumentsCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            <span class="hljs-built_in">this</span>.environment = environment;<br>            <span class="hljs-built_in">this</span>.placeholdersResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertySourcesPlaceholdersResolver</span>(<span class="hljs-built_in">this</span>.environment);<br>            <span class="hljs-built_in">this</span>.resourceLoader = (ResourceLoader)(resourceLoader != <span class="hljs-literal">null</span> ? resourceLoader : <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>((ClassLoader)<span class="hljs-literal">null</span>));<br>         	<span class="hljs-comment">// SPI 通过SpringFactoriesLoader加载 PropertySourceLoader.class的类</span><br>         	<span class="hljs-comment">// PropertiesPropertySourceLoader / YamlPropertySourceLoader</span><br>            <span class="hljs-built_in">this</span>.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader.class, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416180842001.png" srcset="/img/loading.gif" lazyload alt="image-20230416180842001"></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ConfigurableEnvironment</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416173223790.png" srcset="/img/loading.gif" lazyload alt="image-20230416173223790"></p>
<p>Spring Boot</p>
<p>RandomValuePropertySource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomValuePropertySource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertySource</span>&lt;Random&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RANDOM_PROPERTY_SOURCE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;random&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;random.&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(RandomValuePropertySource.class);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Spring Boot 的 PropertySource</p>
<p>FilteredPropertySource</p>
<p>RandomValuePropertySource</p>
<p>ConfigurationPropertySourcesPropertySource</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416173515198.png" srcset="/img/loading.gif" lazyload alt="image-20230416173515198"></p>
<h2 id="PropertySourceLoader-1"><a href="#PropertySourceLoader-1" class="headerlink" title="PropertySourceLoader"></a>PropertySourceLoader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) &#123;<br>    <span class="hljs-built_in">this</span>.logger = ConfigFileApplicationListener.<span class="hljs-built_in">this</span>.logger;<br>    <span class="hljs-built_in">this</span>.loadDocumentsCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-built_in">this</span>.environment = environment;<br>    <span class="hljs-built_in">this</span>.placeholdersResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertySourcesPlaceholdersResolver</span>(<span class="hljs-built_in">this</span>.environment);<br>    <span class="hljs-built_in">this</span>.resourceLoader = (ResourceLoader)(resourceLoader != <span class="hljs-literal">null</span> ? resourceLoader : <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>((ClassLoader)<span class="hljs-literal">null</span>));<br>    <span class="hljs-comment">//  通过SPI机制加载 PropertySourceLoader的实现类</span><br>    <span class="hljs-built_in">this</span>.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader.class, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;ConfigFileApplicationListener.Document&gt; loadDocuments(PropertySourceLoader loader, String name, Resource resource) <span class="hljs-keyword">throws</span> IOException &#123;<br>    ConfigFileApplicationListener.<span class="hljs-type">DocumentsCacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigFileApplicationListener</span>.DocumentsCacheKey(loader, resource);<br>    List&lt;ConfigFileApplicationListener.Document&gt; documents = (List)<span class="hljs-built_in">this</span>.loadDocumentsCache.get(cacheKey);<br>    <span class="hljs-keyword">if</span> (documents == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 方法调用入库</span><br>        List&lt;PropertySource&lt;?&gt;&gt; loaded = loader.load(name, resource);<br>        documents = <span class="hljs-built_in">this</span>.asDocuments(loaded);<br>        <span class="hljs-built_in">this</span>.loadDocumentsCache.put(cacheKey, documents);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> documents;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>加载配置文件信息 Ymal， Properties</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403221322756.png" srcset="/img/loading.gif" lazyload alt="image-20230403221322756"></p>
<h2 id="Resource-和-ResourceLoader"><a href="#Resource-和-ResourceLoader" class="headerlink" title="Resource 和 ResourceLoader"></a>Resource 和 ResourceLoader</h2><p>Resource 将硬盘中的资源加载为Resource 流对象，便于容器的使用</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nsis">Spring中提供了很多Resource接口的实现类。主要有ByteArrayResource, ClassPathResource, DescriptiveResource, <span class="hljs-keyword">File</span><span class="hljs-params">System</span>Resource, InputStreamResource, PortletContextResource, ServletContextResource和UrlResource。常用的有：<br><br>ClassPathResource：通过 ClassPathResource 以类路径的方式进行访问；<br><span class="hljs-keyword">File</span><span class="hljs-params">System</span>Resource：通过 <span class="hljs-keyword">File</span><span class="hljs-params">System</span>Resource 以文件系统绝对路径的方式进行访问；<br>ServletContextResource：通过 ServletContextResource 以相对于Web应用根目录的方式进行访问。<br>UrlResource ：通过java.net.URL来访问资源，当然它也支持<span class="hljs-keyword">File</span>格式，如“<span class="hljs-keyword">file</span>:”、“http:”<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403145408653.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403145219276.png" srcset="/img/loading.gif" lazyload alt="image-20230403145219276"></p>
<p>ResourceLoader接口用来加载Resource资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceLoader</span> &#123;<br>    Resource <span class="hljs-title function_">getResource</span><span class="hljs-params">(String location)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="PropertyResolve和PropertySource"><a href="#PropertyResolve和PropertySource" class="headerlink" title="PropertyResolve和PropertySource"></a><strong>PropertyResolve和PropertySource</strong></h4><p><img src="/1:%5CUsers%5CLENOVO%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230403143713985.png" srcset="/img/loading.gif" lazyload alt="image-20230403143713985"></p>
<h4 id="ConfigurableEnvironment"><a href="#ConfigurableEnvironment" class="headerlink" title="ConfigurableEnvironment"></a>ConfigurableEnvironment</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403143445794.png" srcset="/img/loading.gif" lazyload alt="image-20230403143445794"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403143531413.png" srcset="/img/loading.gif" lazyload alt="image-20230403143531413"></p>
<h3 id="GenericApplicationContext"><a href="#GenericApplicationContext" class="headerlink" title="GenericApplicationContext"></a>GenericApplicationContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistry</span> &#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultListableBeanFactory beanFactory;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403112543262.png" srcset="/img/loading.gif" lazyload alt="image-20230403112543262"></p>
<p><strong>xml Reader</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericXmlApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericApplicationContext</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">XmlBeanDefinitionReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionReader</span>(<span class="hljs-built_in">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注解 Reader</strong></p>
<h4 id="AnnotationConfigApplicationContext"><a href="#AnnotationConfigApplicationContext" class="headerlink" title="AnnotationConfigApplicationContext"></a>AnnotationConfigApplicationContext</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AnnotationConfigRegistry</span> &#123;<br>	    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotatedBeanDefinitionReader reader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassPathBeanDefinitionScanner scanner;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230401155405556.png" srcset="/img/loading.gif" lazyload alt="image-20230401155405556"></p>
<p>ResourceLoader</p>
<p>AnnotationConfigApplicationContext</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403105752794.png" srcset="/img/loading.gif" lazyload alt="image-20230403105752794"></p>
<h4 id="FileSystemXmlApplicationContext"><a href="#FileSystemXmlApplicationContext" class="headerlink" title="FileSystemXmlApplicationContext"></a>FileSystemXmlApplicationContext</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403110101738.png" srcset="/img/loading.gif" lazyload alt="image-20230403110101738"></p>
<h4 id="ClassPathXmlApplicationContext"><a href="#ClassPathXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext"></a>ClassPathXmlApplicationContext</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403110124284.png" srcset="/img/loading.gif" lazyload alt="image-20230403110124284"></p>
<h2 id="注册BeanDefinition"><a href="#注册BeanDefinition" class="headerlink" title="注册BeanDefinition"></a>注册BeanDefinition</h2><h3 id="BeanDefinitionRegistry"><a href="#BeanDefinitionRegistry" class="headerlink" title="BeanDefinitionRegistry"></a>BeanDefinitionRegistry</h3><p>注册表，用于注册BeanDefinition</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403203854079.png" srcset="/img/loading.gif" lazyload alt="image-20230403203854079"></p>
<h3 id="BeanDefinitionReader"><a href="#BeanDefinitionReader" class="headerlink" title="BeanDefinitionReader"></a>BeanDefinitionReader</h3><p>接口 - 通过读取XML 和 配置文件Properties</p>
<p>通过类路径获取Resource对象 生成BeanDefinition对象</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403204454935.png" srcset="/img/loading.gif" lazyload alt="image-20230403204454935"></p>
<h4 id="AbstractBeanDefinitionReader"><a href="#AbstractBeanDefinitionReader" class="headerlink" title="AbstractBeanDefinitionReader"></a>AbstractBeanDefinitionReader</h4><h4 id="PropertiesBeanDefinitionReader"><a href="#PropertiesBeanDefinitionReader" class="headerlink" title="PropertiesBeanDefinitionReader"></a>PropertiesBeanDefinitionReader</h4><h4 id="XmlBeanDefinitionReader"><a href="#XmlBeanDefinitionReader" class="headerlink" title="XmlBeanDefinitionReader"></a>XmlBeanDefinitionReader</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403204359601.png" srcset="/img/loading.gif" lazyload alt="image-20230403204359601"></p>
<h3 id="Reader-x2F-Scanner"><a href="#Reader-x2F-Scanner" class="headerlink" title="Reader &#x2F; Scanner"></a>Reader &#x2F; Scanner</h3><h4 id="AnnotatedBeanDefinitionReader"><a href="#AnnotatedBeanDefinitionReader" class="headerlink" title="AnnotatedBeanDefinitionReader"></a>AnnotatedBeanDefinitionReader</h4><p>向注册表中注入自动注入所需要的 BeanPostProcessor的BeanDefinition</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotatedBeanDefinitionReader</span> &#123;<br>    <span class="hljs-comment">// 注册表</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanDefinitionRegistry registry;<br>    <span class="hljs-keyword">private</span> BeanNameGenerator beanNameGenerator;<br>    <span class="hljs-keyword">private</span> ScopeMetadataResolver scopeMetadataResolver;<br>    <span class="hljs-keyword">private</span> ConditionEvaluator conditionEvaluator;<br>    <br>    <span class="hljs-comment">// 该方法会注册很多的RootBeanDefinition进入register注册表</span><br>    <span class="hljs-comment">// ConfigurationClassPostProcessor	---import</span><br>    <span class="hljs-comment">// AutowiredAnnotationBeanPostProcessor ---autowired</span><br>    <span class="hljs-comment">// CommonAnnotationBeanPostProcessor 	---resource</span><br>    <span class="hljs-comment">// EventListenerMethodProcessor		---事件监听方法</span><br>    <span class="hljs-comment">// DefaultEventListenerFactory	---</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry, Environment environment)</span> &#123;<br>        AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="hljs-built_in">this</span>.registry);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>备注：ConfigurationClassPostProcessor的注册过程</p>
<h4 id="ClassPathBeanDefinitionScanner"><a href="#ClassPathBeanDefinitionScanner" class="headerlink" title="ClassPathBeanDefinitionScanner"></a>ClassPathBeanDefinitionScanner</h4><p>加载主类所在的包以及子包下的Bean，分装为BeanDefinitionHolder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassPathScanningCandidateComponentProvider</span> &#123;<br>    <span class="hljs-comment">// 注册表</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanDefinitionRegistry registry;<br>    <span class="hljs-keyword">private</span> BeanDefinitionDefaults beanDefinitionDefaults;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> String[] autowireCandidatePatterns;<br>    <span class="hljs-keyword">private</span> BeanNameGenerator beanNameGenerator;<br>    <span class="hljs-keyword">private</span> ScopeMetadataResolver scopeMetadataResolver;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> includeAnnotationConfig;<br>    <br>    <span class="hljs-comment">// scan方法调用doscan方法，进行类路径的扫描</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">scan</span><span class="hljs-params">(String... basePackages)</span>;<br>    <span class="hljs-keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403203655701.png" srcset="/img/loading.gif" lazyload alt="image-20230403203655701"></p>
<h4 id="ConfigurationClassBeanDefinitionReader"><a href="#ConfigurationClassBeanDefinitionReader" class="headerlink" title="ConfigurationClassBeanDefinitionReader"></a>ConfigurationClassBeanDefinitionReader</h4><p>加载Configuration类的BeanDefinition</p>
<p>@Enablexxxx内的@Import(xxx.class)注解， 通过xxx的类路径，进行BeanDefinition的注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScopeMetadataResolver</span> <span class="hljs-variable">scopeMetadataResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationScopeMetadataResolver</span>();<br>    <span class="hljs-comment">// 注册BeanDefinition</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanDefinitionRegistry registry;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SourceExtractor sourceExtractor;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Environment environment;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanNameGenerator importBeanNameGenerator;<br>    <span class="hljs-comment">// Import注解的注册</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ImportRegistry importRegistry;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConditionEvaluator conditionEvaluator;<br>    <br>    <span class="hljs-comment">// ImportedConfigurationClass</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitionForImportedConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass)</span>;<br>    <span class="hljs-comment">// ImportedResources  ---</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsFromImportedResources</span><span class="hljs-params">(Map&lt;String, Class&lt;? extends BeanDefinitionReader&gt;&gt; importedResources)</span>;<br>   	<span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsFromRegistrars</span><span class="hljs-params">(Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; registrars)</span>;<br>    <br>    <span class="hljs-comment">// BeanMethod</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsForBeanMethod</span><span class="hljs-params">(BeanMethod beanMethod)</span>;<br>    <span class="hljs-comment">// ConfigurationClass</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsForConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass, ConfigurationClassBeanDefinitionReader.TrackedConditionEvaluator trackedConditionEvaluator)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>







<h1 id="Bean模块-BeanFactory"><a href="#Bean模块-BeanFactory" class="headerlink" title="Bean模块 BeanFactory"></a>Bean模块 BeanFactory</h1><h2 id="AbstractBeanFactory"><a href="#AbstractBeanFactory" class="headerlink" title="AbstractBeanFactory"></a><strong>AbstractBeanFactory</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FactoryBeanRegistrySupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableBeanFactory</span> &#123;<br>    <span class="hljs-comment">// 父容器</span><br>    <span class="hljs-keyword">private</span> BeanFactory parentBeanFactory;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">beanClassLoader</span> <span class="hljs-operator">=</span> ClassUtils.getDefaultClassLoader();<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> ClassLoader tempClassLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheBeanMetadata</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> BeanExpressionResolver beanExpressionResolver;<br>   	<span class="hljs-comment">// 类型转换</span><br>    <span class="hljs-keyword">private</span> ConversionService conversionService;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;PropertyEditorRegistrar&gt; propertyEditorRegistrars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertyEditor</span>&gt;&gt; customEditors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> TypeConverter typeConverter;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;StringValueResolver&gt; embeddedValueResolvers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BeanPostProcessor&gt; beanPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> hasInstantiationAwareBeanPostProcessors;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> hasDestructionAwareBeanPostProcessors;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Scope&gt; scopes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>(<span class="hljs-number">8</span>);<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> SecurityContextProvider securityContextProvider;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, RootBeanDefinition&gt; mergedBeanDefinitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; alreadyCreated = Collections.newSetFromMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>));<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>(<span class="hljs-string">&quot;Prototype beans currently in creation&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403141331634.png" srcset="/img/loading.gif" lazyload alt="image-20230403141331634"></p>
<h3 id="AbstractAutowireCapableBeanFactory"><a href="#AbstractAutowireCapableBeanFactory" class="headerlink" title="AbstractAutowireCapableBeanFactory"></a><strong>AbstractAutowireCapableBeanFactory</strong></h3><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403140342476.png" srcset="/img/loading.gif" lazyload alt="image-20230403140342476"></p>
<p>实例化Bean的方法调用入口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FactoryBeanRegistrySupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableBeanFactory</span> &#123;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> BeanFactory parentBeanFactory;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">beanClassLoader</span> <span class="hljs-operator">=</span> ClassUtils.getDefaultClassLoader();<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> ClassLoader tempClassLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheBeanMetadata</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> BeanExpressionResolver beanExpressionResolver;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> ConversionService conversionService;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;PropertyEditorRegistrar&gt; propertyEditorRegistrars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertyEditor</span>&gt;&gt; customEditors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> TypeConverter typeConverter;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;StringValueResolver&gt; embeddedValueResolvers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BeanPostProcessor&gt; beanPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractBeanFactory</span>.BeanPostProcessorCacheAwareList();<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> AbstractBeanFactory.BeanPostProcessorCache beanPostProcessorCache;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Scope&gt; scopes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>(<span class="hljs-number">8</span>);<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> SecurityContextProvider securityContextProvider;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, RootBeanDefinition&gt; mergedBeanDefinitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; alreadyCreated = Collections.newSetFromMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>));<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>(<span class="hljs-string">&quot;Prototype beans currently in creation&quot;</span>);<br>    <span class="hljs-keyword">private</span> ApplicationStartup applicationStartup;<br>    <br>    <span class="hljs-comment">// 创建Bean的实际流程 -- 即Bean的生命周期</span><br>    <span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException &#123;&#125;<br>    <br>    <span class="hljs-comment">// 内部类持有BeanPostProcessor</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanPostProcessorCache</span> &#123;<br>        <span class="hljs-keyword">final</span> List&lt;InstantiationAwareBeanPostProcessor&gt; instantiationAware = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-keyword">final</span> List&lt;SmartInstantiationAwareBeanPostProcessor&gt; smartInstantiationAware = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-keyword">final</span> List&lt;DestructionAwareBeanPostProcessor&gt; destructionAware = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-keyword">final</span> List&lt;MergedBeanDefinitionPostProcessor&gt; mergedDefinition = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>        BeanPostProcessorCache() &#123;<br>        &#125;<br>    &#125;<br>&#125;s<br></code></pre></td></tr></table></figure>



<h3 id="DefaultListableBeanFactory-—-持有"><a href="#DefaultListableBeanFactory-—-持有" class="headerlink" title="DefaultListableBeanFactory —  持有"></a><strong>DefaultListableBeanFactory</strong> —  持有</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultListableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAutowireCapableBeanFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableListableBeanFactory</span>, BeanDefinitionRegistry, Serializable &#123;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; javaxInjectProviderClass;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Reference&lt;DefaultListableBeanFactory&gt;&gt; serializableFactories;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> String serializationId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">allowBeanDefinitionOverriding</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">allowEagerClassLoading</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Comparator&lt;Object&gt; dependencyComparator;<br>    <span class="hljs-keyword">private</span> AutowireCandidateResolver autowireCandidateResolver;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; resolvableDependencies;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, BeanDefinitionHolder&gt; mergedBeanDefinitionHolders;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, String[]&gt; allBeanNamesByType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, String[]&gt; singletonBeanNamesByType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> List&lt;String&gt; beanDefinitionNames;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Set&lt;String&gt; manualSingletonNames;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> String[] frozenBeanDefinitionNames;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> configurationFrozen;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403112739812.png" srcset="/img/loading.gif" lazyload alt="image-20230403112739812"></p>
<h2 id="refresh"><a href="#refresh" class="headerlink" title="refresh()"></a>refresh()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>		<span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>			<span class="hljs-type">StartupStep</span> <span class="hljs-variable">contextRefresh</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.refresh&quot;</span>);<br><br>			<span class="hljs-comment">// Prepare this context for refreshing.</span><br>			prepareRefresh();<br><br>			<span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span><br>            <span class="hljs-comment">// 通过各种Context（xml,annotation，groovy） ## loadBeanDefinitions（）加载BeanDefinition到当前的</span><br>            <span class="hljs-comment">//用于记载BeanDefinition</span><br>			<span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br>			<span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br>			prepareBeanFactory(beanFactory);<br><br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br>				postProcessBeanFactory(beanFactory);<br><br>				<span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanPostProcess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.beans.post-process&quot;</span>);<br>				<span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br>				invokeBeanFactoryPostProcessors(beanFactory);<br><br>				<span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>				registerBeanPostProcessors(beanFactory);<br>				beanPostProcess.end();<br><br>				<span class="hljs-comment">// Initialize message source for this context.</span><br>				initMessageSource();<br><br>				<span class="hljs-comment">// Initialize event multicaster for this context.</span><br>				initApplicationEventMulticaster();<br><br>				<span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br>				onRefresh();<br><br>				<span class="hljs-comment">// Check for listener beans and register them.</span><br>				registerListeners();<br><br>				<span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>				finishBeanFactoryInitialization(beanFactory);<br><br>				<span class="hljs-comment">// Last step: publish corresponding event.</span><br>				finishRefresh();<br>			&#125;<br><br>			<span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>				<span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>					logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br>							<span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>				&#125;<br><br>				<span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>				destroyBeans();<br><br>				<span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>				cancelRefresh(ex);<br><br>				<span class="hljs-comment">// Propagate exception to caller.</span><br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br><br>			<span class="hljs-keyword">finally</span> &#123;<br>				<span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br>				<span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>				resetCommonCaches();<br>				contextRefresh.end();<br>			&#125;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>



<h1 id="Bean模块-Bean"><a href="#Bean模块-Bean" class="headerlink" title="Bean模块 Bean"></a>Bean模块 Bean</h1><h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory var1)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry var1)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ConfigurationClassPostProcessor"><a href="#ConfigurationClassPostProcessor" class="headerlink" title="ConfigurationClassPostProcessor"></a>ConfigurationClassPostProcessor</h3><p><strong>ConfigurationClassPostProcessor实例化：</strong></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1928593">ConfigurationClassPostProcessor原理详解 - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 会进行ConfigurationClassPostProcessor的实例化</span><br>refresh() ## invokeBeanFactoryPostProcessors(beanFactory);  <br><span class="hljs-comment">// 然后进行调用增强</span><br></code></pre></td></tr></table></figure>



<p>用于BeanDefinition的注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>, PriorityOrdered, ResourceLoaderAware, BeanClassLoaderAware, EnvironmentAware &#123;<br>    <span class="hljs-comment">// 用于注册Import，ConfigurationClass等类的BeanDefinition</span><br>    <span class="hljs-keyword">private</span> ConfigurationClassBeanDefinitionReader reader;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AnnotationBeanNameGenerator</span> <span class="hljs-variable">IMPORT_BEAN_NAME_GENERATOR</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FullyQualifiedAnnotationBeanNameGenerator</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMPORT_REGISTRY_BEAN_NAME</span> <span class="hljs-operator">=</span> ConfigurationClassPostProcessor.class.getName() + <span class="hljs-string">&quot;.importRegistry&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">SourceExtractor</span> <span class="hljs-variable">sourceExtractor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PassThroughSourceExtractor</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ProblemReporter</span> <span class="hljs-variable">problemReporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FailFastProblemReporter</span>();<br>    <br>    <span class="hljs-keyword">private</span> Environment environment;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">beanClassLoader</span> <span class="hljs-operator">=</span> ClassUtils.getDefaultClassLoader();<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">MetadataReaderFactory</span> <span class="hljs-variable">metadataReaderFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingMetadataReaderFactory</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">setMetadataReaderFactoryCalled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Integer&gt; registriesPostProcessed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Integer&gt; factoriesPostProcessed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">localBeanNameGeneratorSet</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> BeanNameGenerator componentScanBeanNameGenerator;<br>    <span class="hljs-keyword">private</span> BeanNameGenerator importBeanNameGenerator;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>重点：类的初始化位置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">SpringBoot启动： <span class="hljs-comment">// 备注：在spring中的注册原理差不多，区别是创建 AnnotationConfigApplicationContext</span><br>    			<span class="hljs-comment">// 的位置在</span><br><span class="hljs-number">1.</span>SpringApplication##run()<br><span class="hljs-number">2.</span>run() ## context = <span class="hljs-built_in">this</span>.createApplicationContext();<br><span class="hljs-comment">// 加载AnnotationConfigApplicationContext的Class</span><br><span class="hljs-number">3.</span> createApplicationContext() ## Class.forName(<span class="hljs-string">&quot;org.springframework.context.annotation.AnnotationConfigApplicationContext&quot;</span>);<br><span class="hljs-comment">// 实例化Context</span><br><span class="hljs-number">4.</span>createApplicationContext() ## BeanUtils.instantiateClass(contextClass)<br><span class="hljs-comment">// 构造函数初始化</span><br><span class="hljs-number">5.</span>AnnotationConfigServletWebApplicationContext ## AnnotationConfigServletWebApplicationContext();<br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationConfigServletWebApplicationContext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.annotatedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>        <span class="hljs-built_in">this</span>.reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedBeanDefinitionReader</span>(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-built_in">this</span>.scanner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span>(<span class="hljs-built_in">this</span>);<br>    &#125;<br><span class="hljs-comment">// 重点 AnnotationConfigUtils </span><br><span class="hljs-number">6.</span>AnnotatedBeanDefinitionReader ## <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry, Environment environment)</span> &#123;<br>        <span class="hljs-comment">// XXXXXX</span><br>    	AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="hljs-built_in">this</span>.registry);<br>    &#125;<br><span class="hljs-comment">// 在这加入了 ConfigurationClassPostProcessor </span><br><span class="hljs-number">7.</span> AnnotationConfigUtils ## <br>    	registerAnnotationConfigProcessors(xxx) &#123;<br>    		 Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(<span class="hljs-number">8</span>);<br>    		def = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(ConfigurationClassPostProcessor.class);<br>    		beanDefs.add(registerPostProcessor());<br>		&#125;<br><span class="hljs-comment">// TODO 什么时候实例化</span><br><span class="hljs-number">8.</span><br><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>, PriorityOrdered, ResourceLoaderAware, BeanClassLoaderAware, EnvironmentAware &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMPORT_REGISTRY_BEAN_NAME</span> <span class="hljs-operator">=</span> ConfigurationClassPostProcessor.class.getName() + <span class="hljs-string">&quot;.importRegistry&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">SourceExtractor</span> <span class="hljs-variable">sourceExtractor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PassThroughSourceExtractor</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ProblemReporter</span> <span class="hljs-variable">problemReporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FailFastProblemReporter</span>();<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Environment environment;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResourceLoader</span>();<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">beanClassLoader</span> <span class="hljs-operator">=</span> ClassUtils.getDefaultClassLoader();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">MetadataReaderFactory</span> <span class="hljs-variable">metadataReaderFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingMetadataReaderFactory</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">setMetadataReaderFactoryCalled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Integer&gt; registriesPostProcessed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Integer&gt; factoriesPostProcessed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <br>    <span class="hljs-comment">// *** 加载</span><br>    <span class="hljs-keyword">private</span> ConfigurationClassBeanDefinitionReader reader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">localBeanNameGeneratorSet</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// 用于创建Bean的名字</span><br>    <span class="hljs-keyword">private</span> BeanNameGenerator componentScanBeanNameGenerator;<br>    <span class="hljs-keyword">private</span> BeanNameGenerator importBeanNameGenerator;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AnnotationBeanNameGenerator</span> <span class="hljs-variable">IMPORT_BEAN_NAME_GENERATOR</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FullyQualifiedAnnotationBeanNameGenerator</span>();<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403150305959.png" srcset="/img/loading.gif" lazyload alt="image-20230403150305959"></p>
<p>PropertySource</p>
<h2 id="Bean的属性"><a href="#Bean的属性" class="headerlink" title="Bean的属性"></a>Bean的属性</h2><p><strong>bean 的实例过程：</strong></p>
<ul>
<li>ResourceLoader 加载配置信息生成 Resource；</li>
<li>BeanDefinitionReader 读取并解析<bean>标签，并将<bean>标签的属性转换为 BeanDefinition 对应的属性，并注册到 BeanDefinitionRegistry 表中；</li>
<li>容器扫描 BeanDefinitionRegistry 注册表，通过反射机制(具体实现是在refresh方法中的invokeBeanFactoryPostProcessors方法)获取 BeanFactoryPostProcessor 类型的工厂后处理器，并用该处理器对 BeanDefinition 进行加工；</li>
<li>根据处理过的 BeanDefinition，实例化 bean。然后 BeanWrapper 结合 BeanDefinitionRegistry 和 PropertyEditorRegistry 对 bean 的属性赋值。</li>
</ul>
<h3 id="BeanMetadataElement"><a href="#BeanMetadataElement" class="headerlink" title="BeanMetadataElement"></a>BeanMetadataElement</h3><p>不懂嘞</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403200131249.png" srcset="/img/loading.gif" lazyload alt="image-20230403200131249"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanMetadataElement</span> &#123;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">default</span> Object <span class="hljs-title function_">getSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="BeanDefinitionHolder"><a href="#BeanDefinitionHolder" class="headerlink" title="BeanDefinitionHolder"></a>BeanDefinitionHolder</h4><p>持有BeanDefinition和他的别名，用于查找BeanDefinition</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanDefinitionHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanMetadataElement</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanDefinition beanDefinition;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String beanName;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] aliases;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.beanDefinition.getSource();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="PropertyAccessor"><a href="#PropertyAccessor" class="headerlink" title="PropertyAccessor"></a>PropertyAccessor</h3><p>提供对PropertyValue进行get和set的接口，主要由BeanWrapper进行暴露实现。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195553426.png" srcset="/img/loading.gif" lazyload alt="image-20230403195553426"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195333627.png" srcset="/img/loading.gif" lazyload alt="image-20230403195333627"></p>
<h4 id="BeanWrapper"><a href="#BeanWrapper" class="headerlink" title="BeanWrapper"></a>BeanWrapper</h4><p>通过操作Propertyvalue对属性进行复制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConfigurablePropertyAccessor</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAutoGrowCollectionLimit</span><span class="hljs-params">(<span class="hljs-type">int</span> var1)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getAutoGrowCollectionLimit</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getWrappedInstance</span><span class="hljs-params">()</span>;<br><br>    Class&lt;?&gt; getWrappedClass();<br>	<span class="hljs-comment">// 获取Property</span><br>    PropertyDescriptor[] getPropertyDescriptors();<br><br>    PropertyDescriptor <span class="hljs-title function_">getPropertyDescriptor</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> InvalidPropertyException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建Bean实例的时候，进行BeanWrapper的初始化和创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AbstractBeanFactory ## CreateBean() ##  createBeanInstance()</span><br><span class="hljs-comment">// 初始化 BeanWrapper</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBeanWrapper</span><span class="hljs-params">(BeanWrapper bw)</span> &#123;<br>    bw.setConversionService(<span class="hljs-built_in">this</span>.getConversionService());<br>    <span class="hljs-built_in">this</span>.registerCustomEditors(bw);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="ConversionService"><a href="#ConversionService" class="headerlink" title="ConversionService"></a>ConversionService</h5><p>转化对象类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConversionService</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">canConvert</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Class&lt;?&gt; var1, Class&lt;?&gt; var2)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">canConvert</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> TypeDescriptor var1, TypeDescriptor var2)</span>;<br><br>    <span class="hljs-meta">@Nullable</span><br>    &lt;T&gt; T <span class="hljs-title function_">convert</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object var1, Class&lt;T&gt; var2)</span>;<br><br>    <span class="hljs-meta">@Nullable</span><br>    Object <span class="hljs-title function_">convert</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object var1, <span class="hljs-meta">@Nullable</span> TypeDescriptor var2, TypeDescriptor var3)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="ConfigurablePropertyAccessor"><a href="#ConfigurablePropertyAccessor" class="headerlink" title="ConfigurablePropertyAccessor"></a>ConfigurablePropertyAccessor</h5><p>用于设置BeanWrapper的类型转化对象 ConversionService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConfigurablePropertyAccessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertyAccessor</span>, PropertyEditorRegistry, TypeConverter &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConversionService</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ConversionService var1)</span>;<br><br>    <span class="hljs-meta">@Nullable</span><br>    ConversionService <span class="hljs-title function_">getConversionService</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExtractOldValueForEditor</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExtractOldValueForEditor</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAutoGrowNestedPaths</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAutoGrowNestedPaths</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406213250432.png" srcset="/img/loading.gif" lazyload alt="image-20230406213250432"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406222830105.png" srcset="/img/loading.gif" lazyload alt="image-20230406222830105"></p>
<h3 id="AttributeAccessor"><a href="#AttributeAccessor" class="headerlink" title="AttributeAccessor"></a>AttributeAccessor</h3><p>关键类：PropertyValue，BeanDefinition</p>
<p>操作bean对象的各种属性</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195527591.png" srcset="/img/loading.gif" lazyload alt="image-20230403195527591"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403195419065.png" srcset="/img/loading.gif" lazyload alt="image-20230403195419065"></p>
<h4 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h4><h5 id="AbstarctBeanDefinition"><a href="#AbstarctBeanDefinition" class="headerlink" title="AbstarctBeanDefinition"></a>AbstarctBeanDefinition</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanDefinition</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanMetadataAttributeAccessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinition</span>, Cloneable &#123;<br>    <span class="hljs-comment">// 自动注入的方式 -- byName，byType, Constructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SCOPE_DEFAULT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_NO</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_BY_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_BY_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_CONSTRUCTOR</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-comment">// 通过依赖检查来查看 Bean 的每个属性是否都设置完成</span><br>    <span class="hljs-comment">// 以下常量分别对应：不检查、对依赖对象检查、对基本类型，字符串和集合进行检查、对全部属性进行检查</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEPENDENCY_CHECK_NONE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEPENDENCY_CHECK_OBJECTS</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEPENDENCY_CHECK_SIMPLE</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEPENDENCY_CHECK_ALL</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <br>    <span class="hljs-comment">// Class对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Object beanClass;<br>    <span class="hljs-comment">// 范围：单例，原型</span><br>    <span class="hljs-keyword">private</span> String scope;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> abstractFlag;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Boolean lazyInit;<br>    <span class="hljs-comment">// 自动注入类型</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> autowireMode;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> dependencyCheck;<br>    <span class="hljs-comment">// 依赖</span><br>    <span class="hljs-keyword">private</span> String[] dependsOn;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> autowireCandidate;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> primary;<br>    <span class="hljs-comment">// @Qualifier(&quot;beanName&quot;) -- 当有多个注入对象时，根据 注解指定的beanname进行细致化注解</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, AutowireCandidateQualifier&gt; qualifiers;<br><br>    <span class="hljs-keyword">private</span> Supplier&lt;?&gt; instanceSupplier;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> nonPublicAccessAllowed;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> lenientConstructorResolution;<br>    <span class="hljs-comment">// beanName</span><br>    <span class="hljs-keyword">private</span> String factoryBeanName;<br>    <span class="hljs-comment">// 参数列表</span><br>    <span class="hljs-keyword">private</span> MutablePropertyValues propertyValues;<br>	<span class="hljs-comment">// 方法属性/ 名称</span><br>    <span class="hljs-keyword">private</span> String factoryMethodName;<br>    <span class="hljs-keyword">private</span> ConstructorArgumentValues constructorArgumentValues;<br>    <span class="hljs-keyword">private</span> MethodOverrides methodOverrides;<br>    <span class="hljs-keyword">private</span> String initMethodName;<br>    <span class="hljs-keyword">private</span> String destroyMethodName;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enforceInitMethod;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enforceDestroyMethod;<br>    <br>    <span class="hljs-keyword">private</span> String description;<br>    <span class="hljs-keyword">private</span> Resource resource;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="RootBeanDefinition"><a href="#RootBeanDefinition" class="headerlink" title="RootBeanDefinition"></a>RootBeanDefinition</h5><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403193159013.png" srcset="/img/loading.gif" lazyload alt="image-20230403193159013"></p>
<h5 id="AnnotatedGenericBeanDefinition"><a href="#AnnotatedGenericBeanDefinition" class="headerlink" title="AnnotatedGenericBeanDefinition"></a>AnnotatedGenericBeanDefinition</h5><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403193342924.png" srcset="/img/loading.gif" lazyload alt="image-20230403193342924"></p>
<h3 id="PropertyValue"><a href="#PropertyValue" class="headerlink" title="PropertyValue"></a>PropertyValue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyValue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanMetadataAttributeAccessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object value;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">optional</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">converted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Object convertedValue;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">volatile</span> Boolean conversionNecessary;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403194257013.png" srcset="/img/loading.gif" lazyload alt="image-20230403194257013"></p>
<p>PropertySource</p>
<h2 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/c7c3324f280cd2a92cb57d72768b426e.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>createBean()</p>
<p>实例化前</p>
<p>doCreateBean()</p>
<p>实例化</p>
<p>包装类 BeanWrapper 设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">doCreateBean()##   <span class="hljs-built_in">this</span>.populateBean(beanName, mbd, instanceWrapper);<br></code></pre></td></tr></table></figure>

<p>populateBean()</p>
<p>实例化后</p>
<p>通过name，type属性填充，</p>
<p>通过postProcess进行PropertyValue属性填充</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">doCreateBean()##   exposedObject = <span class="hljs-built_in">this</span>.initializeBean(beanName, exposedObject, mbd);<br></code></pre></td></tr></table></figure>

<p>初始化前</p>
<p>初始化</p>
<p>初始化后</p>
<h3 id="doGetBean"><a href="#doGetBean" class="headerlink" title="doGetBean()"></a><strong>doGetBean()</strong></h3><p>Bean生命周期的整个流程 – 处理销毁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformedBeanName(name);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getSingleton(beanName);<br>    Object beanInstance;<br>    <span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 直接获取实例Bean</span><br>        beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(sharedInstance, name, beanName, (RootBeanDefinition)<span class="hljs-literal">null</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// 尝试父容器 获取Bean</span><br>        <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getParentBeanFactory();<br>        <span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.containsBeanDefinition(beanName)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.originalBeanName(name);<br>            <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br>                <span class="hljs-keyword">return</span> ((AbstractBeanFactory)parentBeanFactory).doGetBean(nameToLookup, requiredType, args, typeCheckOnly);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, args);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>            &#125;<br>            <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup);<br>        &#125;<br><br>        <span class="hljs-comment">// 标记创建状态</span><br>        <span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanCreation</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.beans.instantiate&quot;</span>).tag(<span class="hljs-string">&quot;beanName&quot;</span>, name);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                beanCreation.tag(<span class="hljs-string">&quot;beanType&quot;</span>, requiredType::toString);<br>            &#125;<br>			<span class="hljs-comment">// </span><br>            <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMergedLocalBeanDefinition(beanName);<br>            <span class="hljs-built_in">this</span>.checkMergedBeanDefinition(mbd, beanName, args);<br>            String[] dependsOn = mbd.getDependsOn();<br>            String[] var12;<br>            <span class="hljs-comment">// 依赖对象的注入和实例化</span><br>            <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br>                var12 = dependsOn;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> dependsOn.length;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var14</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var14 &lt; var13; ++var14) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dep</span> <span class="hljs-operator">=</span> var12[var14];<br>                    <span class="hljs-built_in">this</span>.registerDependentBean(dep, beanName);<br>                    <span class="hljs-comment">// 获取依赖的Bean对象</span><br>                    <span class="hljs-built_in">this</span>.getBean(dep);<br>            &#125;<br>            <span class="hljs-comment">// 通过scope来判断如何进行 创建bean createBean()</span><br>            <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>                <span class="hljs-comment">// 单例对象  </span><br>                <span class="hljs-comment">// 传入ObejctFactory，用于AOP的代理对象的生成</span><br>                sharedInstance = <span class="hljs-built_in">this</span>.getSingleton(beanName, () -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// createBean</span><br>                        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                    &#125; <span class="hljs-keyword">catch</span> (BeansException var5) &#123;<br>                        <span class="hljs-built_in">this</span>.destroySingleton(beanName);<br>                        <span class="hljs-keyword">throw</span> var5;<br>                    &#125;<br>                &#125;);<br>                <span class="hljs-comment">// 对于 FactoryBean**进行实例替换  -- getOject()</span><br>                beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br>                <span class="hljs-comment">// 原型对象创建Bean</span><br>                Object prototypeInstance;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// this.prototypesCurrentlyInCreation.set(beanNameSet);</span><br>                    <span class="hljs-built_in">this</span>.beforePrototypeCreation(beanName);<br>                    <span class="hljs-comment">//createBean</span><br>                    prototypeInstance = <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>            		<span class="hljs-comment">// this.prototypesCurrentlyInCreation.remove(beanNameSet);</span><br>                    <span class="hljs-built_in">this</span>.afterPrototypeCreation(beanName);<br>                &#125;<br><br>                beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 其他的scope -- request、session、global session， 的Ban的创建过程</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br><br>                <span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> (Scope)<span class="hljs-built_in">this</span>.scopes.get(scopeName);<br>                <span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br>                        <span class="hljs-built_in">this</span>.beforePrototypeCreation(beanName);<br><br>                        Object var4;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-comment">// 创建Bean</span><br>                            var4 = <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                        &#125; <span class="hljs-keyword">finally</span> &#123;<br>                            <span class="hljs-built_in">this</span>.afterPrototypeCreation(beanName);<br>                        &#125;<br><br>                        <span class="hljs-keyword">return</span> var4;<br>                    &#125;);<br>                    beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>                &#125;<br>            &#125;<br>        &#125;  <span class="hljs-keyword">finally</span> &#123;<br>            beanCreation.end();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.adaptBeanInstance(name, beanInstance, requiredType);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AbstractAutowireCapableBeanFactory-1"><a href="#AbstractAutowireCapableBeanFactory-1" class="headerlink" title="AbstractAutowireCapableBeanFactory"></a>AbstractAutowireCapableBeanFactory</h3><h4 id="createBean"><a href="#createBean" class="headerlink" title="createBean()"></a>createBean()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br>    <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbdToUse</span> <span class="hljs-operator">=</span> mbd;<br>    <span class="hljs-comment">// 加载Bean的class</span><br>    Class&lt;?&gt; resolvedClass = <span class="hljs-built_in">this</span>.resolveBeanClass(mbd, beanName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-literal">null</span>) &#123;<br>        mbdToUse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(mbd);<br>        mbdToUse.setBeanClass(resolvedClass);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 准备方法覆盖</span><br>        mbdToUse.prepareMethodOverrides();<br>    &#125; <br>    Object beanInstance;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 实例化之前 InstantiationAwareBeanPostProcessor ## postProcessBeforeInstantiation()</span><br>        beanInstance = <span class="hljs-built_in">this</span>.resolveBeforeInstantiation(beanName, mbdToUse);<br>        <span class="hljs-keyword">if</span> (beanInstance != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> beanInstance;<br>        &#125;<br>    &#125; <br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 实例化 以及之后的操作</span><br>        beanInstance = <span class="hljs-built_in">this</span>.doCreateBean(beanName, mbdToUse, args);<br>        <span class="hljs-keyword">return</span> beanInstance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="doCreateBean"><a href="#doCreateBean" class="headerlink" title="doCreateBean()"></a>doCreateBean()</h4><p>实例化以及之后操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br>    <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>        instanceWrapper = (BeanWrapper)<span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 创建实例 Wrapper实例 -- 会初始化 BeanWrapper的方法  ConversionService（转换）</span><br>        instanceWrapper = <span class="hljs-built_in">this</span>.createBeanInstance(beanName, mbd, args);<br>    &#125;<br>	<span class="hljs-comment">// wrapperd的包装属性</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>    <span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>        mbd.resolvedTargetType = beanType;<br>    &#125;<br>    <span class="hljs-keyword">synchronized</span>(mbd.postProcessingLock) &#123;<br>        <span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// MergedBeanDefinitionPostProcessors接口的方法调用</span><br>                <span class="hljs-built_in">this</span>.applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>            &#125; <br>            mbd.postProcessed = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 判断是否由循环依赖导致的 earlySingleton</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp; <span class="hljs-built_in">this</span>.isSingletonCurrentlyInCreation(beanName);<br>        <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>            <span class="hljs-comment">// 添加三级缓存的 ObjectFactory 用于aop生成代理对象</span><br>            <span class="hljs-built_in">this</span>.addSingletonFactory(beanName, () -&gt; &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getEarlyBeanReference(beanName, mbd, bean);<br>            &#125;);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 实例化之后 填充属性</span><br>            <span class="hljs-built_in">this</span>.populateBean(beanName, mbd, instanceWrapper);<br>            <span class="hljs-comment">// 初始化</span><br>            exposedObject = <span class="hljs-built_in">this</span>.initializeBean(beanName, exposedObject, mbd);<br>        &#125; <br>        <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">earlySingletonReference</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getSingleton(beanName, <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>                    exposedObject = earlySingletonReference;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; <span class="hljs-built_in">this</span>.hasDependentBean(beanName)) &#123;<br>                    String[] dependentBeans = <span class="hljs-built_in">this</span>.getDependentBeans(beanName);<br>                    Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(dependentBeans.length);<br>                    String[] var12 = dependentBeans;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> dependentBeans.length;<br><br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var14</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var14 &lt; var13; ++var14) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">dependentBean</span> <span class="hljs-operator">=</span> var12[var14];<br>                        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>                            actualDependentBeans.add(dependentBean);<br>                        &#125;<br>                    &#125;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>            <span class="hljs-keyword">return</span> exposedObject;<br>        &#125; <br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="doCreateBean-populateBean"><a href="#doCreateBean-populateBean" class="headerlink" title="doCreateBean()  ## populateBean()"></a>doCreateBean()  ## populateBean()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> BeanWrapper bw)</span> &#123;<br>    <span class="hljs-keyword">if</span> (bw == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (mbd.hasPropertyValues()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Cannot apply property values to null instance&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; <span class="hljs-built_in">this</span>.hasInstantiationAwareBeanPostProcessors()) &#123;<br>            <span class="hljs-type">Iterator</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getBeanPostProcessors().iterator();<br>            <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>                <span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">bp</span> <span class="hljs-operator">=</span> (BeanPostProcessor)var4.next();<br>                <span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;<br>                    <span class="hljs-type">InstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (InstantiationAwareBeanPostProcessor)bp;<br>                    <span class="hljs-comment">// InstantiationAwareBeanPostProcessor ## postProcessAfterInstantiation()</span><br>                    <span class="hljs-comment">// 实例化之后的postProcess</span><br>                    <span class="hljs-comment">// 自动注入AutowiredAnnotationBeanPostProcessor ## postProcessProperties()</span><br>                    <span class="hljs-keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvs</span> <span class="hljs-operator">=</span> mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">resolvedAutowireMode</span> <span class="hljs-operator">=</span> mbd.getResolvedAutowireMode();<br>        <span class="hljs-comment">// 自动注入</span><br>        <span class="hljs-keyword">if</span> (resolvedAutowireMode == <span class="hljs-number">1</span> || resolvedAutowireMode == <span class="hljs-number">2</span>) &#123;<br>            <span class="hljs-type">MutablePropertyValues</span> <span class="hljs-variable">newPvs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutablePropertyValues</span>((PropertyValues)pvs);<br>            <span class="hljs-keyword">if</span> (resolvedAutowireMode == <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-comment">// byname</span><br>                <span class="hljs-built_in">this</span>.autowireByName(beanName, mbd, bw, newPvs);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (resolvedAutowireMode == <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-comment">// bytype</span><br>                <span class="hljs-built_in">this</span>.autowireByType(beanName, mbd, bw, newPvs);<br>            &#125;<br><br>            pvs = newPvs;<br>        &#125;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasInstAwareBpps</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.hasInstantiationAwareBeanPostProcessors();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">needsDepCheck</span> <span class="hljs-operator">=</span> mbd.getDependencyCheck() != <span class="hljs-number">0</span>;<br>        PropertyDescriptor[] filteredPds = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;<br>            <span class="hljs-keyword">if</span> (pvs == <span class="hljs-literal">null</span>) &#123;<br>                pvs = mbd.getPropertyValues();<br>            &#125;<br><br>            <span class="hljs-type">Iterator</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getBeanPostProcessors().iterator();<br><br>            <span class="hljs-keyword">while</span>(var9.hasNext()) &#123;<br>                <span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">bp</span> <span class="hljs-operator">=</span> (BeanPostProcessor)var9.next();<br>                <span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;<br>                    <span class="hljs-type">InstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (InstantiationAwareBeanPostProcessor)bp;<br>                    <span class="hljs-comment">// 参数填充</span><br>                    <span class="hljs-comment">// InstantiationAwareBeanPostProcessor ## postProcessProperties()</span><br>                    <span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvsToUse</span> <span class="hljs-operator">=</span> ibp.postProcessProperties((PropertyValues)pvs, bw.getWrappedInstance(), beanName);<br>                    <span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-literal">null</span>) &#123;<br>                            filteredPds = <span class="hljs-built_in">this</span>.filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>                        &#125;<br>					<span class="hljs-comment">// InstantiationAwareBeanPostProcessor ## InstantiationAwareBeanPostProcessor()</span><br>                        pvsToUse = ibp.InstantiationAwareBeanPostProcessor((PropertyValues)pvs, filteredPds, bw.getWrappedInstance(), beanName);<br>                        <span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">return</span>;<br>                        &#125;<br>                    &#125;<br><br>                    pvs = pvsToUse;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (needsDepCheck) &#123;<br>            <span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-literal">null</span>) &#123;<br>                filteredPds = <span class="hljs-built_in">this</span>.filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>            &#125;<br>			<span class="hljs-comment">// </span><br>            <span class="hljs-built_in">this</span>.checkDependencies(beanName, mbd, filteredPds, (PropertyValues)pvs);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (pvs != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 如果需要注入的属性不为空</span><br>            <span class="hljs-comment">// 通过set方法注入的入口 （注入非注解方式注入的属性）</span><br>            <span class="hljs-comment">// https://www.cnblogs.com/fnlingnzb-learner/p/10694592.html</span><br>            <span class="hljs-built_in">this</span>.applyPropertyValues(beanName, mbd, bw, (PropertyValues)pvs);<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 注入setter</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyPropertyValues</span><span class="hljs-params">(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!pvs.isEmpty()) &#123;<br>            <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp; bw <span class="hljs-keyword">instanceof</span> BeanWrapperImpl) &#123;<br>                ((BeanWrapperImpl)bw).setSecurityContext(<span class="hljs-built_in">this</span>.getAccessControlContext());<br>            &#125;<br><br>            <span class="hljs-type">MutablePropertyValues</span> <span class="hljs-variable">mpvs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            List original;<br>            <span class="hljs-keyword">if</span> (pvs <span class="hljs-keyword">instanceof</span> MutablePropertyValues) &#123;<br>                mpvs = (MutablePropertyValues)pvs;<br>                <span class="hljs-keyword">if</span> (mpvs.isConverted()) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        bw.setPropertyValues(mpvs);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (BeansException var18) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Error setting property values&quot;</span>, var18);<br>                    &#125;<br>                &#125;<br>			<span class="hljs-comment">// </span><br>                original = mpvs.getPropertyValueList();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                original = Arrays.asList(pvs.getPropertyValues());<br>            &#125;<br>			<span class="hljs-comment">// 属性转化</span><br>            <span class="hljs-type">TypeConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCustomTypeConverter();<br>            <span class="hljs-keyword">if</span> (converter == <span class="hljs-literal">null</span>) &#123;<br>                converter = bw;<br>            &#125;<br><br>            <span class="hljs-type">BeanDefinitionValueResolver</span> <span class="hljs-variable">valueResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionValueResolver</span>(<span class="hljs-built_in">this</span>, beanName, mbd, (TypeConverter)converter);<br>            List&lt;PropertyValue&gt; deepCopy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(original.size());<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">resolveNecessary</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">Iterator</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> original.iterator();<br><br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">while</span>(var11.hasNext()) &#123;<br>                    <span class="hljs-type">PropertyValue</span> <span class="hljs-variable">pv</span> <span class="hljs-operator">=</span> (PropertyValue)var11.next();<br>                    <span class="hljs-keyword">if</span> (pv.isConverted()) &#123;<br>                        deepCopy.add(pv);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> pv.getName();<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">originalValue</span> <span class="hljs-operator">=</span> pv.getValue();<br>                        <span class="hljs-keyword">if</span> (originalValue == AutowiredPropertyMarker.INSTANCE) &#123;<br>                            <span class="hljs-type">Method</span> <span class="hljs-variable">writeMethod</span> <span class="hljs-operator">=</span> bw.getPropertyDescriptor(propertyName).getWriteMethod();<br>                            originalValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DependencyDescriptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodParameter</span>(writeMethod, <span class="hljs-number">0</span>), <span class="hljs-literal">true</span>);<br>                        &#125;<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">resolvedValue</span> <span class="hljs-operator">=</span> valueResolver.resolveValueIfNecessary(pv, originalValue);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">convertedValue</span> <span class="hljs-operator">=</span> resolvedValue;<br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">convertible</span> <span class="hljs-operator">=</span> bw.isWritableProperty(propertyName) &amp;&amp; !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);<br>                        <span class="hljs-keyword">if</span> (convertible) &#123;<br>                            convertedValue = <span class="hljs-built_in">this</span>.convertForProperty(resolvedValue, propertyName, bw, (TypeConverter)converter);<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (resolvedValue == originalValue) &#123;<br>                            <span class="hljs-keyword">if</span> (convertible) &#123;<br>                                pv.setConvertedValue(convertedValue);<br>                            &#125;<br><br>                            deepCopy.add(pv);<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (convertible &amp;&amp; originalValue <span class="hljs-keyword">instanceof</span> TypedStringValue &amp;&amp; !((TypedStringValue)originalValue).isDynamic() &amp;&amp; !(convertedValue <span class="hljs-keyword">instanceof</span> Collection) &amp;&amp; !ObjectUtils.isArray(convertedValue)) &#123;<br>                            pv.setConvertedValue(convertedValue);<br>                            deepCopy.add(pv);<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            resolveNecessary = <span class="hljs-literal">true</span>;<br>                            deepCopy.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValue</span>(pv, convertedValue));<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (mpvs != <span class="hljs-literal">null</span> &amp;&amp; !resolveNecessary) &#123;<br>                    mpvs.setConverted();<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">// Setter注入</span><br>                    bw.setPropertyValues(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MutablePropertyValues</span>(deepCopy));<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>





<h4 id="doCreateBean-initializeBean"><a href="#doCreateBean-initializeBean" class="headerlink" title="doCreateBean() ## initializeBean()"></a>doCreateBean() ## initializeBean()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">initializeBean</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;<br>    <span class="hljs-comment">// Aware 回调 设置属性</span><br>    <span class="hljs-comment">// 1.((BeanNameAware)bean).setBeanName(beanName);</span><br>    <span class="hljs-comment">// 2. ((BeanClassLoaderAware)bean).setBeanClassLoader(bcl);</span><br>    <span class="hljs-comment">// 3.((BeanFactoryAware)bean).setBeanFactory(this);</span><br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>        AccessController.doPrivileged(() -&gt; &#123;<br>        <span class="hljs-comment">// 设置Aware属性</span><br>            <span class="hljs-built_in">this</span>.invokeAwareMethods(beanName, bean);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;, <span class="hljs-built_in">this</span>.getAccessControlContext());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 设置Aware属性</span><br>        <span class="hljs-built_in">this</span>.invokeAwareMethods(beanName, bean);<br>    &#125;<br>	<span class="hljs-comment">// 初始化之前的方法</span><br>    <span class="hljs-comment">// BeanPostProcessor ## postProcessBeforeInitialization()</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">wrappedBean</span> <span class="hljs-operator">=</span> bean;()<br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>        wrappedBean = <span class="hljs-built_in">this</span>.applyBeanPostProcessorsBeforeInitialization(bean, beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 执行初始化方法</span><br>        <span class="hljs-comment">// ((InitializingBean)bean).afterPropertiesSet();</span><br>        <span class="hljs-built_in">this</span>.invokeInitMethods(beanName, wrappedBean, mbd);<br>    &#125; <br>	<span class="hljs-comment">// 初始化之后的方法</span><br>    <span class="hljs-comment">// BeanPostProcessor ## postProcessAfterInitialization()</span><br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>        wrappedBean = <span class="hljs-built_in">this</span>.applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br><br><span class="hljs-comment">// 第二种调用</span><br><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title function_">instantiateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Object beanInstance;<br>        <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>            beanInstance = AccessController.doPrivileged(() -&gt; &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getInstantiationStrategy().instantiate(mbd, beanName, <span class="hljs-built_in">this</span>);<br>            &#125;, <span class="hljs-built_in">this</span>.getAccessControlContext());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            beanInstance = <span class="hljs-built_in">this</span>.getInstantiationStrategy().instantiate(mbd, beanName, <span class="hljs-built_in">this</span>);<br>        &#125;<br>        <span class="hljs-comment">// 封装BeanWrapper</span><br>        <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">bw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(beanInstance);<br>        <span class="hljs-built_in">this</span>.initBeanWrapper(bw);<br>        <span class="hljs-keyword">return</span> bw;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="initializeBean-invokeInitMethods"><a href="#initializeBean-invokeInitMethods" class="headerlink" title="initializeBean() ## invokeInitMethods()"></a>initializeBean() ## invokeInitMethods()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeInitMethods</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isInitializingBean</span> <span class="hljs-operator">=</span> bean <span class="hljs-keyword">instanceof</span> InitializingBean;<br>    <span class="hljs-comment">// afterPropertiesSet</span><br>    <span class="hljs-keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="hljs-literal">null</span> || !mbd.isExternallyManagedInitMethod(<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>))) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>            <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>		<span class="hljs-comment">// InitializingBean ## afterPropertiesSet()</span><br>        <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                AccessController.doPrivileged(() -&gt; &#123;<br>					<span class="hljs-comment">// 调用InitializingBean ## afterPropertiesSet()方法</span><br>                    ((InitializingBean)bean).afterPropertiesSet();<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;, <span class="hljs-built_in">this</span>.getAccessControlContext());<br>            &#125; <span class="hljs-keyword">catch</span> (PrivilegedActionException var6) &#123;<br>                <span class="hljs-keyword">throw</span> var6.getException();<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ((InitializingBean)bean).afterPropertiesSet();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (mbd != <span class="hljs-literal">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">initMethodName</span> <span class="hljs-operator">=</span> mbd.getInitMethodName();<br>        <span class="hljs-keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp; (!isInitializingBean || !<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp; !mbd.isExternallyManagedInitMethod(initMethodName)) &#123;<br>            <span class="hljs-built_in">this</span>.invokeCustomInitMethod(beanName, bean, mbd);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="AutowiredAnnotationBeanPostProcessor"><a href="#AutowiredAnnotationBeanPostProcessor" class="headerlink" title="AutowiredAnnotationBeanPostProcessor"></a>AutowiredAnnotationBeanPostProcessor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br>    <span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.findAutowiringMetadata(beanName, bean.getClass(), pvs);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        metadata.inject(bean, beanName, pvs);<br>        <span class="hljs-keyword">return</span> pvs;<br>    &#125; <span class="hljs-keyword">catch</span> (BeanCreationException var6) &#123;<br>        <span class="hljs-keyword">throw</span> var6;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable var7) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, var7);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403224847280.png" srcset="/img/loading.gif" lazyload alt="image-20230403224847280"></p>
<h3 id="FacotryBean"><a href="#FacotryBean" class="headerlink" title="FacotryBean"></a>FacotryBean</h3><h3 id="Bean的初始化入口"><a href="#Bean的初始化入口" class="headerlink" title="Bean的初始化入口"></a>Bean的初始化入口</h3><p>AbstracApplicationContext ## refresh() ## finishBeanFactoryInitialization() ## beanFactory.preInstantiateSingletons();</p>
<p>DefaultListableBeanFactory ## preInstantiateSingletons() 		&#x2F;&#x2F; 实例化Bean和FacotryBean的重点方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>    		<span class="hljs-keyword">do</span> &#123;<br>               <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>                   <span class="hljs-comment">// 已经实例化的bean</span><br>         				<span class="hljs-type">Object</span> <span class="hljs-variable">singletonInstance</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getSingleton(beanName);<br>                   <span class="hljs-comment">// 如果没有， 创建bean</span><br>                  <br>            <span class="hljs-built_in">this</span>.getBean(beanName);<br>               &#125;<br>           &#125; <span class="hljs-keyword">while</span>(!(bean <span class="hljs-keyword">instanceof</span> FactoryBean));<br>	<br>    		<span class="hljs-comment">// FactoryBean</span><br>           FactoryBean&lt;?&gt; factory = (FactoryBean)bean;<br>           <span class="hljs-type">boolean</span> isEagerInit;<br>           <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>               <span class="hljs-type">SmartFactoryBean</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> (SmartFactoryBean)factory;<br>               ((SmartFactoryBean)factory).getClass();<br>               isEagerInit = (Boolean)AccessController.doPrivileged(var10000::isEagerInit, <span class="hljs-built_in">this</span>.getAccessControlContext());<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               isEagerInit = factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp; ((SmartFactoryBean)factory).isEagerInit();<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (isEagerInit) &#123;<br>               <span class="hljs-built_in">this</span>.getBean(beanName);<br>           &#125;<br>      &#125;<br></code></pre></td></tr></table></figure>



<p>DefaultSingletonBeanRegistry  ###  getSingleton(beanName) 	&#x2F;&#x2F; 该方法用于获取已经 实例化的 Bean</p>
<h4 id="DefaultSingletonBeanRegistry"><a href="#DefaultSingletonBeanRegistry" class="headerlink" title="DefaultSingletonBeanRegistry"></a>DefaultSingletonBeanRegistry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSingletonBeanRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleAliasRegistry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SingletonBeanRegistry</span> &#123;<br>    <span class="hljs-comment">// 三级缓存解决循环依赖问题</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(<span class="hljs-number">16</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">16</span>);<br>    <span class="hljs-comment">// 正在创建的Bean名字集合</span><br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; singletonsCurrentlyInCreation = Collections.newSetFromMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">16</span>));<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; inCreationCheckExclusions = Collections.newSetFromMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">16</span>));<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230403233526671.png" srcset="/img/loading.gif" lazyload alt="image-20230403233526671"></p>
<p>获取单例对象，并且解决循环依赖问题</p>
<h3 id="循环依赖问题"><a href="#循环依赖问题" class="headerlink" title="循环依赖问题"></a>循环依赖问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-type">boolean</span> allowEarlyReference)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>    	<span class="hljs-comment">//							判断是否正在 初始化参数</span><br>        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.isSingletonCurrentlyInCreation(beanName)) &#123;<br>            singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br>            <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) &#123;<br>                <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br>                    singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>                    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// 从 正在实例化中的Map取出 实例</span><br>                        singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br>                        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-comment">// ObjectFactory函数式方法调用 </span><br>                            <span class="hljs-comment">// ## 1.创建实例对象 2. AOP代理对象的创建 / 3.实例对象获取</span><br>                            ObjectFactory&lt;?&gt; singletonFactory = (ObjectFactory)<span class="hljs-built_in">this</span>.singletonFactories.get(beanName);<br>                            <span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) &#123;<br>                                singletonObject = singletonFactory.getObject();<br>                                <span class="hljs-built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);<br>                                <span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> singletonObject;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a>ObjectFactory</h4><p>三个作用：1.创建实例对象</p>
<p>​					 2. AOP代理对象的创建 3.实例对象获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectFactory</span>&lt;T&gt; &#123;<br>    T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// doGetBean() ## 	</span><br>	<span class="hljs-comment">// 实例化之前</span><br>	<span class="hljs-comment">// 1.创建实例对象</span><br>    sharedInstance = <span class="hljs-built_in">this</span>.getSingleton(beanName, () -&gt; &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-comment">// 如果SingletonObjects没有，调用方法创建Bean</span><br>                            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                        &#125; <span class="hljs-keyword">catch</span> (BeansException var5) &#123;<br>                            <span class="hljs-built_in">this</span>.destroySingleton(beanName);<br>                            <span class="hljs-keyword">throw</span> var5;<br>                        &#125;<br>                    &#125;);<br><span class="hljs-comment">// doCreateBean() ##</span><br>	<span class="hljs-comment">// 实例化之后</span><br>	<span class="hljs-comment">//  2. AOP代理对象的创建 3.实例对象获取</span><br>	<span class="hljs-built_in">this</span>.addSingletonFactory(beanName, () -&gt; &#123;<br>        		<span class="hljs-comment">// 如果没有，则进入getEarlyBeanReference()</span><br>        		<span class="hljs-comment">// SmartInstantiationAwareBeanPostProcessor ## getEarlyBeanReference()</span><br>        		<span class="hljs-comment">//  	如果需要Aop动态代理，则调用AbstractAutoProxyCreator ## wrapIfNecessary()返回							Porxy代理对象</span><br>        		<span class="hljs-comment">// 		否则， 直接返回bean</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getEarlyBeanReference(beanName, mbd, bean);<br>            &#125;);<br></code></pre></td></tr></table></figure>



<p>已经实例化的beanname</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404145015644.png" srcset="/img/loading.gif" lazyload alt="image-20230404145015644"></p>
<h2 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h2><h3 id="寻找注入点"><a href="#寻找注入点" class="headerlink" title="寻找注入点"></a>寻找注入点</h3><p>@Autowired注入点的寻找有两个地方 ： AnnotatedBeanDefinitionReader 的注册BeanDefinition时寻找；AutowiredAnnotationBeanPostProcessor的 findAutowiredAnnotation()方法进行寻找</p>
<p>生成 MergedAnnotations</p>
<h4 id="入口一"><a href="#入口一" class="headerlink" title="入口一"></a>入口一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotatedBeanDefinitionReader ## doRegisterBean()<br>    -&gt;  AnnotatedGenericBeanDefinition ## AnnotatedGenericBeanDefinition()<br>     -&gt; AnnotationMetadata ## introspect()<br>    	-&gt; StandardAnnotationMetadata ## from()<br>    		-&gt; TypeMappedAnnotations ## from()<br></code></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AnnotatedBeanDefinitionReader </span><br><span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">doRegisterBean</span><span class="hljs-params">(Class&lt;T&gt; beanClass, <span class="hljs-meta">@Nullable</span> String name, <span class="hljs-meta">@Nullable</span> Class&lt;? extends Annotation&gt;[] qualifiers, <span class="hljs-meta">@Nullable</span> Supplier&lt;T&gt; supplier, <span class="hljs-meta">@Nullable</span> BeanDefinitionCustomizer[] customizers)</span> &#123;<br>        <span class="hljs-type">AnnotatedGenericBeanDefinition</span> <span class="hljs-variable">abd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedGenericBeanDefinition</span>(beanClass);<br>&#125;<br><br><span class="hljs-comment">// AnnotatedGenericBeanDefinition</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotatedGenericBeanDefinition</span><span class="hljs-params">(Class&lt;?&gt; beanClass)</span> &#123;<br>    <span class="hljs-built_in">this</span>.setBeanClass(beanClass);<br>    <span class="hljs-built_in">this</span>.metadata = AnnotationMetadata.introspect(beanClass);<br>&#125;<br><br><span class="hljs-comment">//AnnotationMetadata</span><br> <span class="hljs-keyword">static</span> AnnotationMetadata <span class="hljs-title function_">introspect</span><span class="hljs-params">(Class&lt;?&gt; type)</span> &#123;<br>     <span class="hljs-keyword">return</span> StandardAnnotationMetadata.from(type);<br> &#125;<br><br><span class="hljs-comment">// StandardAnnotationMetadata</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">StandardAnnotationMetadata</span><span class="hljs-params">(Class&lt;?&gt; introspectedClass, <span class="hljs-type">boolean</span> nestedAnnotationsAsMap)</span> &#123;<br>    <span class="hljs-built_in">super</span>(introspectedClass);<br>    <span class="hljs-built_in">this</span>.mergedAnnotations = MergedAnnotations.from(introspectedClass, SearchStrategy.INHERITED_ANNOTATIONS, RepeatableContainers.none());<br>    <span class="hljs-built_in">this</span>.nestedAnnotationsAsMap = nestedAnnotationsAsMap;<br>&#125;<br><br><span class="hljs-comment">// MergedAnnotations</span><br><span class="hljs-keyword">static</span> MergedAnnotations <span class="hljs-title function_">from</span><span class="hljs-params">(AnnotatedElement element)</span> &#123;<br>    <span class="hljs-keyword">return</span> from(element, MergedAnnotations.SearchStrategy.DIRECT);<br>&#125;<br><span class="hljs-keyword">static</span> MergedAnnotations <span class="hljs-title function_">from</span><span class="hljs-params">(AnnotatedElement element, MergedAnnotations.SearchStrategy searchStrategy)</span> &#123;<br>    <span class="hljs-keyword">return</span> from(element, searchStrategy, RepeatableContainers.standardRepeatables());<br>&#125;<br><span class="hljs-keyword">static</span> MergedAnnotations <span class="hljs-title function_">from</span><span class="hljs-params">(AnnotatedElement element, MergedAnnotations.SearchStrategy searchStrategy, RepeatableContainers repeatableContainers)</span> &#123;<br>    <span class="hljs-keyword">return</span> from(element, searchStrategy, repeatableContainers, AnnotationFilter.PLAIN);<br>&#125;<br><span class="hljs-keyword">static</span> MergedAnnotations <span class="hljs-title function_">from</span><span class="hljs-params">(AnnotatedElement element, MergedAnnotations.SearchStrategy searchStrategy, RepeatableContainers repeatableContainers, AnnotationFilter annotationFilter)</span> &#123;<br>    Assert.notNull(repeatableContainers, <span class="hljs-string">&quot;RepeatableContainers must not be null&quot;</span>);<br>    Assert.notNull(annotationFilter, <span class="hljs-string">&quot;AnnotationFilter must not be null&quot;</span>);<br>    <span class="hljs-comment">// 下一个入口</span><br>    <span class="hljs-keyword">return</span> TypeMappedAnnotations.from(element, searchStrategy, repeatableContainers, annotationFilter);<br>&#125;<br><br><span class="hljs-comment">// TypeMappedAnnotations ## from()</span><br><span class="hljs-keyword">static</span> MergedAnnotations <span class="hljs-title function_">from</span><span class="hljs-params">(AnnotatedElement element, SearchStrategy searchStrategy, RepeatableContainers repeatableContainers, AnnotationFilter annotationFilter)</span> &#123;<br>    <span class="hljs-keyword">return</span> (MergedAnnotations)(AnnotationsScanner.isKnownEmpty(element, searchStrategy) ? NONE : <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeMappedAnnotations</span>(element, searchStrategy, repeatableContainers, annotationFilter));<br>&#125;<br><span class="hljs-comment">// AnnotationsScanner ## </span><br><br><span class="hljs-comment">// TypeMappedAnnotations ## 构造器</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">TypeMappedAnnotations</span><span class="hljs-params">(AnnotatedElement element, SearchStrategy searchStrategy, RepeatableContainers repeatableContainers, AnnotationFilter annotationFilter)</span> &#123;<br>    <span class="hljs-built_in">this</span>.source = element;<br>    <span class="hljs-built_in">this</span>.element = element;<br>    <span class="hljs-built_in">this</span>.searchStrategy = searchStrategy;<br>    <span class="hljs-built_in">this</span>.annotations = <span class="hljs-literal">null</span>;<br>    <span class="hljs-built_in">this</span>.repeatableContainers = repeatableContainers;<br>    <span class="hljs-built_in">this</span>.annotationFilter = annotationFilter;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422095010110.png" srcset="/img/loading.gif" lazyload alt="image-20230422095010110"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MergedAnnotations</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Iterable</span>&lt;MergedAnnotation&lt;Annotation&gt;&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SearchStrategy</span> &#123;<br>        DIRECT,<br>        INHERITED_ANNOTATIONS,<br>        SUPERCLASS,<br>        TYPE_HIERARCHY,<br>        TYPE_HIERARCHY_AND_ENCLOSING_CLASSES;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">SearchStrategy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeMappedAnnotations</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MergedAnnotations</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MergedAnnotations NONE;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object source;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotatedElement element;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SearchStrategy searchStrategy;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Annotation[] annotations;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RepeatableContainers repeatableContainers;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotationFilter annotationFilter;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> List&lt;TypeMappedAnnotations.Aggregate&gt; aggregates;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422095029546.png" srcset="/img/loading.gif" lazyload alt="image-20230422095029546"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MergedAnnotation</span>&lt;A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">VALUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;value&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422100239271.png" srcset="/img/loading.gif" lazyload alt="image-20230422100239271"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationsScanner</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Annotation[] NO_ANNOTATIONS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Annotation</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Method[] NO_METHODS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Method</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;AnnotatedElement, Annotation[]&gt; declaredAnnotationCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentReferenceHashMap</span>(<span class="hljs-number">256</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Method[]&gt; baseTypeMethodsCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentReferenceHashMap</span>(<span class="hljs-number">256</span>);<br>    <br>    <span class="hljs-comment">// SearchStrategy searchStrategy</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;C, R&gt; R <span class="hljs-title function_">processClass</span><span class="hljs-params">(C context, Class&lt;?&gt; source, SearchStrategy searchStrategy, AnnotationsProcessor&lt;C, R&gt; processor)</span> &#123;<br>        <span class="hljs-keyword">switch</span>(searchStrategy) &#123;<br>        <span class="hljs-keyword">case</span> DIRECT:<br>            <span class="hljs-keyword">return</span> processElement(context, source, processor);<br>        <span class="hljs-keyword">case</span> INHERITED_ANNOTATIONS:<br>            <span class="hljs-keyword">return</span> processClassInheritedAnnotations(context, source, searchStrategy, processor);<br>        <span class="hljs-keyword">case</span> SUPERCLASS:<br>            <span class="hljs-keyword">return</span> processClassHierarchy(context, source, processor, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">case</span> TYPE_HIERARCHY:<br>            <span class="hljs-keyword">return</span> processClassHierarchy(context, source, processor, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">case</span> TYPE_HIERARCHY_AND_ENCLOSING_CLASSES:<br>            <span class="hljs-keyword">return</span> processClassHierarchy(context, source, processor, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Unsupported search strategy &quot;</span> + searchStrategy);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isKnownEmpty</span><span class="hljs-params">(AnnotatedElement source, SearchStrategy searchStrategy)</span> &#123;<br>        <span class="hljs-keyword">if</span> (hasPlainJavaAnnotationsOnly((Object)source)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (searchStrategy != SearchStrategy.DIRECT &amp;&amp; !isWithoutHierarchy(source, searchStrategy)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> Method &amp;&amp; ((Method)source).isBridge()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> getDeclaredAnnotations(source, <span class="hljs-literal">false</span>).length == <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230422100745459.png" srcset="/img/loading.gif" lazyload alt="image-20230422100745459"></p>
<h4 id="入口二"><a href="#入口二" class="headerlink" title="入口二"></a>入口二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AutowiredAnnotationBeanPostProcessor ## postProcessProperties()</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br>    <span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.findAutowiringMetadata(beanName, bean.getClass(), pvs);<br>&#125;<br><span class="hljs-comment">// findAutowiringMetadata()</span><br><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title function_">findAutowiringMetadata</span><span class="hljs-params">(String beanName, Class&lt;?&gt; clazz, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> StringUtils.hasLength(beanName) ? beanName : clazz.getName();<br>    <span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> (InjectionMetadata)<span class="hljs-built_in">this</span>.injectionMetadataCache.get(cacheKey);<br>    <span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;<br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.injectionMetadataCache) &#123;<br>            metadata = (InjectionMetadata)<span class="hljs-built_in">this</span>.injectionMetadataCache.get(cacheKey);<br>            <span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;<br>                <span class="hljs-keyword">if</span> (metadata != <span class="hljs-literal">null</span>) &#123;<br>                    metadata.clear(pvs);<br>                &#125;<br>				<span class="hljs-comment">// 构建AutowriedMetadate </span><br>                metadata = <span class="hljs-built_in">this</span>.buildAutowiringMetadata(clazz);<br>                <span class="hljs-built_in">this</span>.injectionMetadataCache.put(cacheKey, metadata);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> metadata;<br>&#125;<br><span class="hljs-comment">// buildAutowiringMetadata()</span><br><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title function_">buildAutowiringMetadata</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>    ReflectionUtils.doWithLocalFields(targetClass, (field) -&gt; &#123;<br>        MergedAnnotation&lt;?&gt; ann = <span class="hljs-built_in">this</span>.findAutowiredAnnotation(field);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// findAutowiredAnnotation()</span><br><span class="hljs-keyword">private</span> MergedAnnotation&lt;?&gt; findAutowiredAnnotation(AccessibleObject ao) &#123;<br>    <span class="hljs-comment">// 同入口一的 MergedAnnotations的from方法</span><br>    <span class="hljs-type">MergedAnnotations</span> <span class="hljs-variable">annotations</span> <span class="hljs-operator">=</span> MergedAnnotations.from(ao);<br>&#125;<br><span class="hljs-comment">//MergedAnnotations ## from()</span><br>                                    <br></code></pre></td></tr></table></figure>







<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_31086797/article/details/124136140">(13条消息) Spring @Value注解解析源码_@value源码_CRUD的W的博客-CSDN博客</a></p>
<h3 id="AutowiredAnnotationBeanPostProcessor-1"><a href="#AutowiredAnnotationBeanPostProcessor-1" class="headerlink" title="AutowiredAnnotationBeanPostProcessor"></a>AutowiredAnnotationBeanPostProcessor</h3><p>依赖注入@Autowired， @Value，@Inject</p>
<p>@Value — 需要PropertySourcesPlaceholderConfigurer （自动注入） 解析 ${}，获取PropertySource的application的属性值，进行注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutowiredAnnotationBeanPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessorAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MergedBeanDefinitionPostProcessor</span>, PriorityOrdered, BeanFactoryAware &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; autowiredAnnotationTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">requiredParameterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;required&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">requiredParameterValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-number">2147483645</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> ConfigurableListableBeanFactory beanFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; lookupMethodsChecked = Collections.newSetFromMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>));<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Constructor&lt;?&gt;[]&gt; candidateConstructorsCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, InjectionMetadata&gt; injectionMetadataCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">256</span>);<br>    <span class="hljs-comment">// 添加可以自动注入的 annotationtype -- Autowired，Value，Inject</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AutowiredAnnotationBeanPostProcessor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(Autowired.class);<br>        <span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(Value.class);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(ClassUtils.forName(<span class="hljs-string">&quot;javax.inject.Inject&quot;</span>, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));<br>            <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;JSR-330 &#x27;javax.inject.Inject&#x27; annotation found and supported for autowiring&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var2) &#123;<br>        &#125;<br><br>    &#125;<br>    <br>    <br>    <span class="hljs-comment">// 内部类  InjectedElement ： 两个子类 </span><br>    <span class="hljs-comment">// AutowiredFieldElement（自动注入属性） AutowiredMethodElement（自动注入方法）</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectedElement</span> &#123;<br>        <span class="hljs-comment">// java.lang.reflect == a single member (a field or a method) or a constructor.</span><br>        <span class="hljs-comment">// 一个属性、一个方法或者一个构造方法</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Member member;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> isField;<br>        <br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isField) &#123;<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field)<span class="hljs-built_in">this</span>.member;<br>                ReflectionUtils.makeAccessible(field);<br>         		<span class="hljs-comment">// 属性注入</span><br>                field.set(target, <span class="hljs-built_in">this</span>.getResourceToInject(target, requestingBeanName));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.checkPropertySkipping(pvs)) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;	<span class="hljs-comment">// 方法 执行注入</span><br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method)<span class="hljs-built_in">this</span>.member;<br>                    ReflectionUtils.makeAccessible(method);<br>                    method.invoke(target, <span class="hljs-built_in">this</span>.getResourceToInject(target, requestingBeanName));<br>                &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException var5) &#123;<br>                    <span class="hljs-keyword">throw</span> var5.getTargetException();<br>                &#125;<br>            &#125;<br><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// </span><br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutowiredMethodElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InjectedElement</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> required;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> cached;<br>        <span class="hljs-meta">@Nullable</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Object[] cachedMethodArguments;<br>         <span class="hljs-comment">/// </span><br>         <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object bean, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.checkPropertySkipping(pvs)) &#123;<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method)<span class="hljs-built_in">this</span>.member;<br>                Object[] arguments;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cached) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        arguments = <span class="hljs-built_in">this</span>.resolveCachedArguments(beanName);<br>                    &#125; <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException var8) &#123;<br>                        arguments = <span class="hljs-built_in">this</span>.resolveMethodArguments(method, bean, beanName);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    arguments = <span class="hljs-built_in">this</span>.resolveMethodArguments(method, bean, beanName);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (arguments != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// 设置反射权限 method.setAccessible(true);</span><br>                        ReflectionUtils.makeAccessible(method);<br>                        method.invoke(bean, arguments);<br>                    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException var7) &#123;<br>                        <span class="hljs-keyword">throw</span> var7.getTargetException();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>     &#125;<br>    <span class="hljs-comment">// 自动注入属性 ----@Autowired， @Value， @Inject</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutowiredFieldElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InjectedElement</span> &#123;<br>        <span class="hljs-comment">// 是否必须</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> required;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> cached;<br>        <span class="hljs-meta">@Nullable</span> <span class="hljs-comment">// 缓存值</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Object cachedFieldValue;<br>        <span class="hljs-comment">// 属性的自动注入 </span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object bean, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field)<span class="hljs-built_in">this</span>.member;<br>            Object value; <span class="hljs-comment">// 获取需要注入的属性的值</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cached) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    value = AutowiredAnnotationBeanPostProcessor.<span class="hljs-built_in">this</span>.resolvedCachedArgument(beanName, <span class="hljs-built_in">this</span>.cachedFieldValue);<br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException var7) &#123;<br>                    value = <span class="hljs-built_in">this</span>.resolveFieldValue(field, bean, beanName);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                value = <span class="hljs-built_in">this</span>.resolveFieldValue(field, bean, beanName);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 权限啊设置</span><br>                ReflectionUtils.makeAccessible(field);<br>                <span class="hljs-comment">// 属性设置</span><br>                field.set(bean, value);<br>            &#125;<br><br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416201130823.png" srcset="/img/loading.gif" lazyload alt="image-20230416201130823"></p>
<h3 id="DependencyDescriptor"><a href="#DependencyDescriptor" class="headerlink" title="DependencyDescriptor"></a>DependencyDescriptor</h3><p>保存注入点的信息 — </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory.config;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;serial&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyDescriptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InjectionPoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">// 保存所包装依赖(成员属性或者成员方法的某个参数)所在的声明类，</span><br>    <span class="hljs-comment">// 其实该信息在 field/methodParameter 中已经隐含</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; declaringClass;<br><br>    <span class="hljs-comment">// 如果所包装依赖是成员方法的某个参数，则这里记录该成员方法的名称</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> String methodName;<br><br>    <span class="hljs-comment">// 如果所包装的是成员方法的某个参数，则这里记录该参数的类型</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> Class&lt;?&gt;[] parameterTypes;<br><br>    <span class="hljs-comment">// 如果所包装的是成员方法的某个参数，则这里记录该参数在该函数参数列表中的索引</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> parameterIndex;<br><br>    <span class="hljs-comment">//如果所包装的是成员属性，则这里记录该成员属性的名称</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> String fieldName;<br><br>    <span class="hljs-comment">// 标识所包装依赖是否必要依赖</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> required;<br><br>    <span class="hljs-comment">// 标识所包装依赖是否需要饥饿加载</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> eager;<br><br>    <span class="hljs-comment">// 标识所包装依赖的嵌套级别</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">nestingLevel</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// 标识所包装依赖的包含者类，通常和声明类是同一个</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> Class&lt;?&gt; containingClass;<br><br>    <span class="hljs-comment">// 所包装依赖 ResolvableType 的缓存</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> ResolvableType resolvableType;<br><br>    <span class="hljs-comment">// 所包装依赖 TypeDescriptor 的缓存</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> TypeDescriptor typeDescriptor;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="spring，spring-boot注入属性的所有方式"><a href="#spring，spring-boot注入属性的所有方式" class="headerlink" title="spring，spring boot注入属性的所有方式"></a>spring，spring boot注入属性的所有方式</h3><p>在Spring和Spring Boot中，有多种方式可以注入属性。以下是常用的几种方式：</p>
<ol>
<li><p>使用@Value注解：@Value注解可以在类成员变量上使用，用于将属性值注入到该变量中。这个值可以从application.properties或application.yml配置文件中读取，也可以通过SpEL表达式来计算。</p>
<p>​		 – AutowiredAnnotatedBeanPostProcessor</p>
</li>
<li><p>使用@ConfigurationProperties注解：@ConfigurationProperties注解可以在@Configuration类或@Component类上使用，用于将一个或多个属性值注入到对象中。该注解可以自定义前缀，以匹配多个属性。</p>
</li>
<li><p>使用@PropertySource：@PropertySource注解可以引入其他的属性文件，从而扩展属性的来源。同时还需要结合@Value或@ConfigurationProperties注解使用，以将属性值注入到程序中。</p>
</li>
<li><p>使用Environment：Environment接口可用于获取应用程序的属性（例如，System属性、环境变量、命令行参数等）并使用这些属性进行配置。</p>
</li>
<li><p>使用Spring Expression Language（SpEL）：SpEL是一种用于访问对象图表达式语言，可用于计算@Value注解中的属性值或@ConfigurationProperties注解中的默认值。</p>
</li>
<li><p>使用@Autowired注解：@Autowired注解可用于将属性注入到bean中。当属性处于单例范围内时，它们将在容器启动时被自动装配。  – AutowiredAnnotatedBeanPostProcessor</p>
</li>
</ol>
<p>这些是最常用的一些方式，但不限于这些。在复杂的情况下，可以结合使用这些注入方式来实现属性的注入。</p>
<p>除了上述提到的几种常用的属性注入方式，还有以下注入方式：</p>
<ol>
<li>使用@Resource注解：@Resource注解与@Autowired注解类似，在将属性注入到bean中时使用。它可以指定属性名称或类型，并且支持JSR-250标准。 – CommonBeanPostProcessor</li>
<li>使用@Inject注解：@Inject注解是Java依赖注入规范（JSR-330）中定义的，与@Autowired注解类似。通过使用@Inject注解，可以将依赖项注入到应用程序中。 – AutowiredAnnotatedBeanPostProcessor</li>
<li>使用构造函数注入：构造函数注入是另一种将属性值注入到bean中的方式。使用构造函数注入可以使代码更加清晰和易于测试，因为所有必需的依赖项都可以在构造函数中声明。</li>
<li>使用工厂方法注入：工厂方法注入类似构造函数注入，但是允许属性值被注入到一个静态工厂方法中并返回具有这些属性的实例。</li>
<li>使用@Bean注解：@Bean注解可以用于将属性注入到Spring的IoC容器中。此外，@Bean注解还可以用于创建一个新的bean，作为其他bean的依赖项注入。  — ConfigurationClasPostProcessor</li>
<li>使用Setter方法注入：Setter方法注入是另一种常用的方式，其基本思想是在setter方法上使用@Autowired注解来注入属性。   — populateBean()  ## applyPropertyValues()</li>
</ol>
<p>需要注意的是，不同的注入方式适用于不同的场景和需求，开发人员在使用时需要根据具体情况进行选择</p>
<p>aop，aware， BeanPostProcessor，</p>
<h2 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <span class="hljs-comment">// 初始化之前</span><br>    <span class="hljs-keyword">default</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化之后</span><br>    <span class="hljs-keyword">default</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="BeanPostProcessorCache"><a href="#BeanPostProcessorCache" class="headerlink" title="BeanPostProcessorCache"></a>BeanPostProcessorCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanPostProcessorCache</span> &#123;<br>    <span class="hljs-keyword">final</span> List&lt;InstantiationAwareBeanPostProcessor&gt; instantiationAware = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-keyword">final</span> List&lt;SmartInstantiationAwareBeanPostProcessor&gt; smartInstantiationAware = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-keyword">final</span> List&lt;DestructionAwareBeanPostProcessor&gt; destructionAware = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <span class="hljs-keyword">final</span> List&lt;MergedBeanDefinitionPostProcessor&gt; mergedDefinition = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>    BeanPostProcessorCache() &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="InstantiationAwareBeanPostProcessor"><a href="#InstantiationAwareBeanPostProcessor" class="headerlink" title="InstantiationAwareBeanPostProcessor"></a>InstantiationAwareBeanPostProcessor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <span class="hljs-comment">// 实例化之前</span><br>    <span class="hljs-keyword">default</span> Object <span class="hljs-title function_">postProcessBeforeInstantiation</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>	<span class="hljs-comment">// 实例化之后</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">postProcessAfterInstantiation</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>	<span class="hljs-comment">// 属性设置 PropertyValues ---设置属性后，对pvs进行增强</span><br>    <span class="hljs-comment">// AutowiredAnnotationBeanPostProcessor 实现自动注入功能</span><br>    <span class="hljs-keyword">default</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="SmartInstantiationAwareBeanPostProcessor"><a href="#SmartInstantiationAwareBeanPostProcessor" class="headerlink" title="SmartInstantiationAwareBeanPostProcessor"></a>SmartInstantiationAwareBeanPostProcessor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SmartInstantiationAwareBeanPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> &#123;<br>    <span class="hljs-comment">// 推断Bean的类型</span><br>    <span class="hljs-keyword">default</span> Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName) <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 推断 候选的构造函数</span><br>    <span class="hljs-keyword">default</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName) <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>	<span class="hljs-comment">// 获取实例化后，初始化前的对象实例</span><br>    <span class="hljs-comment">// 用于获取AopProxy对象，实现Aop增强和循环依赖的解决</span><br>    <span class="hljs-keyword">default</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="MergedBeanDefinitionPostProcessor"><a href="#MergedBeanDefinitionPostProcessor" class="headerlink" title="MergedBeanDefinitionPostProcessor"></a>MergedBeanDefinitionPostProcessor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MergedBeanDefinitionPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <span class="hljs-comment">// 合并BeanDefinition</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessMergedBeanDefinition</span><span class="hljs-params">(RootBeanDefinition var1, Class&lt;?&gt; var2, String var3)</span>;<br>	<span class="hljs-comment">// 重设BeanDefnition</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resetBeanDefinition</span><span class="hljs-params">(String beanName)</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="InitializingBean"><a href="#InitializingBean" class="headerlink" title="InitializingBean"></a>InitializingBean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-comment">// invokeInitMethods()方法调用</span><br>    <span class="hljs-comment">// 在populateBean()属性填充之后调用</span><br>    <span class="hljs-comment">// invokeCustomInitMethod() 初始化方法执行之前</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="AutowireCapableBeanFactory-注入方式"><a href="#AutowireCapableBeanFactory-注入方式" class="headerlink" title="AutowireCapableBeanFactory - 注入方式"></a>AutowireCapableBeanFactory - 注入方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AutowireCapableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_NO</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_BY_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_BY_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">AUTOWIRE_CONSTRUCTOR</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404141739106.png" srcset="/img/loading.gif" lazyload alt="image-20230404141739106"></p>
<h4 id="AbstractAutowireCapableBeanFactory-2"><a href="#AbstractAutowireCapableBeanFactory-2" class="headerlink" title="AbstractAutowireCapableBeanFactory"></a>AbstractAutowireCapableBeanFactory</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404141636814.png" srcset="/img/loading.gif" lazyload alt="image-20230404141636814"></p>
<h1 id="AOP-模块"><a href="#AOP-模块" class="headerlink" title="AOP 模块"></a>AOP 模块</h1><h2 id="Aop和AspectJ原理"><a href="#Aop和AspectJ原理" class="headerlink" title="Aop和AspectJ原理"></a>Aop和AspectJ原理</h2><p>AOP面向切面编程是一种<strong>编程思想</strong>；</p>
<p>而<strong>AspectJ也实现了AOP</strong>的功能，且其实现方式更为简捷，使用更为方便，而且还支持注解式开发。所以，Spring又将AspectJ对于AOP的实现也引入到了自己的框架中。</p>
<ul>
<li>Aspect，切面在实际的应用中，切面通常是指封装的用于横向插入系统功能，比如事务日志的类，该类被spring容器识别为切面，需要在配置文件中通过&lt;bean&gt;来指定。</li>
<li>Joinpiont，连接点，在程序执行过程中的某个阶段点。它实际上是对象的一个操作，例如方法的调用或异常的抛出。在spring AOP中连接点就是指方法的调用。</li>
<li>Pointcut，切入点，切入点是指切面与程序流程的交叉点，即那些需要处理的连接点，通常在程序中切入点是指。类或者是方法名，比如说某个通知要应用到所有的以add开头的方法中。那么所有满足这一规则的方法都是切入点。</li>
<li>Adivce，通知增强处理，AOP 框架在特定的切入点执行增强处理，即在定义好的切入点处理所需要执行的程序代码，你可以理解其为切面类中的方法，它是切面的具体实现。</li>
<li>Target Object ，目标对象，是指所有通知的对象。也称为北增强对象。如果AOP框架采用的是动态的AOP实现，那么该对象就是一个被代理对象。</li>
<li>Proxy ，代理，将通知应用到目标对象之后被动态创建的对象。</li>
<li>Weaving， 织入，将切面代码插入目标对象上，从而生成代理对象的过程。</li>
</ul>
<p><strong>Aop框架和springframework.aop</strong></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405164119306.png" srcset="/img/loading.gif" lazyload alt="image-20230405164119306"></p>
<p>重点类：</p>
<h3 id="AopProxy"><a href="#AopProxy" class="headerlink" title="AopProxy"></a>AopProxy</h3><p>spring将JDK动态代理和 Cglib动态代理全部封装为 AopProxy，用于aop时，进行增强操作</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405165929687.png" srcset="/img/loading.gif" lazyload alt="image-20230405165929687"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// CglibAopProxy 和 JDKDynamicAopProxy 实现通过两种方式获取代理对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AopProxy</span> &#123;<br>    Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ClassLoader var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="CglibAopProxy"><a href="#CglibAopProxy" class="headerlink" title="CglibAopProxy"></a>CglibAopProxy</h4><p>CallBack，MethodInterceptor接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, Serializable &#123;<br>	<span class="hljs-comment">// 定义了许多的 MethodInterceptor实现类，每个实现类不同的增强方式。</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405180654563.png" srcset="/img/loading.gif" lazyload alt="image-20230405180654563"></p>
<h5 id="CallBack"><a href="#CallBack" class="headerlink" title="CallBack"></a>CallBack</h5><p>CGLIB回调接口，通过实现该接口，用于处理回调事件</p>
<h4 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h4><p>效果和JDK动态代理差不多，为Spring自己封装的动态代理逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, InvocationHandler, Serializable &#123;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> org.springframework.cglib.proxy;<br><span class="hljs-comment">// 等同package java.lang.reflect;</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InvocationHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Callback</span> &#123;<br>    Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object var1, Method var2, Object[] var3)</span> <span class="hljs-keyword">throws</span> Throwable;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405165729107.png" srcset="/img/loading.gif" lazyload alt="image-20230405165729107"></p>
<h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><p>流程：</p>
<p>1.定义一个接口SellTickets，并有一个方法sell()  – （假设）；</p>
<p>2.被代理类实现接口方法</p>
<p>3.被代理类调用Proxy的static方法 newProxyInstance() 创建代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">$Proxy0</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(station.getClass().getClassLoader(),<br>                station.getClass().getInterfaces(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>() &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                        InvocationHandler中invoke方法参数说明：</span><br><span class="hljs-comment">                            proxy ： 代理对象</span><br><span class="hljs-comment">                            method ： 对应于在代理对象上调用的接口方法的 Method 实例</span><br><span class="hljs-comment">                            args ： 代理对象调用接口方法时传递的实际参数</span><br><span class="hljs-comment">                     */</span><br>                    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>                        System.out.println(<span class="hljs-string">&quot;代理点收取一些服务费用(JDK动态代理方式)&quot;</span>);<br>                        <span class="hljs-comment">//执行真实对象</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(station, args);<br>                        <span class="hljs-keyword">return</span> result;<br>                    &#125;<br>                &#125;);<br></code></pre></td></tr></table></figure>



<p>4.类加载时自动生成$Proxy0对象，<strong>继承Proxy对象</strong> 和 <strong>实现SellTickets的sell()方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$Proxy0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SellTickets</span> &#123;<br> <span class="hljs-comment">// 自动生成的接口的代理方法</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m3, <span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5.方法调用了传入的<strong>InvocationHandler</strong> 函数式接口 （增强方法）</p>
<h4 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取代理对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span><br><span class="hljs-params">                                      Class&lt;?&gt;[] interfaces,</span><br><span class="hljs-params">                                      // 重点，用它调用 代理类的方法执行</span><br><span class="hljs-params">                                      InvocationHandler h)</span>;<br><span class="hljs-comment">// 自动生成的接口的代理方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.h.invoke(<span class="hljs-built_in">this</span>, m3, <span class="hljs-literal">null</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="InvacationHandler"><a href="#InvacationHandler" class="headerlink" title="InvacationHandler"></a>InvacationHandler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 用户编写的增强方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    	<span class="hljs-comment">// proxy ： 代理对象</span><br>        <span class="hljs-comment">// method ： 对应于在代理对象上调用的接口方法的 Method 实例</span><br>        <span class="hljs-comment">// args ： 代理对象调用接口方法时传递的实际参数</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span><br>        <span class="hljs-keyword">throws</span> Throwable;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="CGLIB动态代理"><a href="#CGLIB动态代理" class="headerlink" title="CGLIB动态代理"></a>CGLIB动态代理</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shijinjins/article/details/124423859">(1条消息) spring中cglib动态代理_springcglib动态代理_唂雨云的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/106069224">源码详解系列(一)–cglib动态代理的使用和分析 - 知乎 (zhihu.com)</a></p>
<h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4><p>备注：可以增强被代理对象的所有方法，但是只能在intercept()方法中定义方法调用 前后增强逻辑；</p>
<h5 id="Enhancer"><a href="#Enhancer" class="headerlink" title="Enhancer"></a>Enhancer</h5><h5 id="MethodInterceptor"><a href="#MethodInterceptor" class="headerlink" title="MethodInterceptor"></a>MethodInterceptor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MethodInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Callback</span> &#123;<br>    Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object var1, Method var2, Object[] var3, MethodProxy var4)</span> <span class="hljs-keyword">throws</span> Throwable;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="MethodProxy"><a href="#MethodProxy" class="headerlink" title="MethodProxy"></a>MethodProxy</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodProxy</span> &#123;<br>	 <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastClassInfo</span> &#123;<br>        FastClass f1;<br>        FastClass f2;<br>        <span class="hljs-type">int</span> i1;<br>        <span class="hljs-type">int</span> i2;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">FastClassInfo</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.fastClassInfo == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.initLock) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.fastClassInfo == <span class="hljs-literal">null</span>) &#123;<br>                    MethodProxy.<span class="hljs-type">CreateInfo</span> <span class="hljs-variable">ci</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.createInfo;<br>                    MethodProxy.<span class="hljs-type">FastClassInfo</span> <span class="hljs-variable">fci</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodProxy</span>.FastClassInfo();<br>                    fci.f1 = helper(ci, ci.c1);<br>                    fci.f2 = helper(ci, ci.c2);<br>                    fci.i1 = fci.f1.getIndex(<span class="hljs-built_in">this</span>.sig1);<br>                    fci.i2 = fci.f2.getIndex(<span class="hljs-built_in">this</span>.sig2);<br>                    <span class="hljs-built_in">this</span>.fastClassInfo = fci;<br>                    <span class="hljs-built_in">this</span>.createInfo = <span class="hljs-literal">null</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <br>        <br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object obj, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.init();<br>            MethodProxy.<span class="hljs-type">FastClassInfo</span> <span class="hljs-variable">fci</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.fastClassInfo;<br>            <span class="hljs-keyword">return</span> fci.f1.invoke(fci.i1, obj, args);<br>        &#125; <br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="FastClass"><a href="#FastClass" class="headerlink" title="FastClass"></a>FastClass</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastClass</span> &#123;<br>    <span class="hljs-keyword">private</span> Class type;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(String name, Class[] parameterTypes, Object obj, Object[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException &#123;<br>        <span class="hljs-comment">// 所有的方法都是abstract方法，在生成具体的FastClass会创建具体的 代理类</span><br>        <span class="hljs-comment">// 代理类包含具体实现</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.invoke(<span class="hljs-built_in">this</span>.getIndex(name, parameterTypes), obj, args);<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    //传入参数：</span><br><span class="hljs-comment">    //n：方法索引</span><br><span class="hljs-comment">    //o：代理类实例</span><br><span class="hljs-comment">    //array：方法输入参数</span><br><span class="hljs-comment">    public Object invoke(final int n, final Object o, final Object[] array) throws InvocationTargetException &#123;</span><br><span class="hljs-comment">        final UserController$$EnhancerByCGLIB$$e6f193aa userController$$EnhancerByCGLIB$$e6f193aa = (UserController$$EnhancerByCGLIB$$e6f193aa)o;</span><br><span class="hljs-comment">        try &#123;</span><br><span class="hljs-comment">            switch (n) &#123;</span><br><span class="hljs-comment">                case 0: &#123;</span><br><span class="hljs-comment">                    return new Boolean(userController$$EnhancerByCGLIB$$e6f193aa.equals(array[0]));</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">                case 1: &#123;</span><br><span class="hljs-comment">                    return userController$$EnhancerByCGLIB$$e6f193aa.toString();</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">                case 2: &#123;</span><br><span class="hljs-comment">                    return new Integer(userController$$EnhancerByCGLIB$$e6f193aa.hashCode());</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">                case 3: &#123;</span><br><span class="hljs-comment">                    return userController$$EnhancerByCGLIB$$e6f193aa.clone();</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">                // ·······</span><br><span class="hljs-comment">                case 24: &#123;</span><br><span class="hljs-comment">                    // 通过匹配方法索引，直接调用该方法，这个方法里将直接调用目标类的方法</span><br><span class="hljs-comment">                    userController$$EnhancerByCGLIB$$e6f193aa.CGLIB$update$0();</span><br><span class="hljs-comment">                    return null;</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">                // ·······</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        catch (Throwable t) &#123;</span><br><span class="hljs-comment">            throw new InvocationTargetException(t);</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="hljs-comment">    &#125;*/</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>备注：调用抽象方法，具体实现需要动态生成代理对象时，创建</strong></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405175501722.png" srcset="/img/loading.gif" lazyload alt="image-20230405175501722"></p>
<h4 id="流程："><a href="#流程：" class="headerlink" title="流程："></a>流程：</h4><p> 不需要单独实现接口，让被代理类实现，通过继承被代理类 覆盖需要加强的方法，进行方法的增强操作。</p>
<p>1.实现<strong>MethodInterceptor</strong>接口，实现intercept() 方法，即增强方法</p>
<p>2.创建需要被代理类的<strong>Enhancer</strong> （代理类） — 会生成被代理对象的子类</p>
<p>3.代理类调用<strong>被增强方法</strong>会自动 找到子类实现的覆盖方法，然后调用 <strong>intercepted()方法</strong></p>
<p>4.在<strong>intercepted()方法</strong> 实现动态增强方法</p>
<p>备注：由于spring中很多时候无法通过继承同一个接口对象实现JDK动态代理，所以AOP的具体实现 主要是CGLIB动态代理。（@Transaction, @Aync等）</p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br>    <span class="hljs-comment">// 需要被代理的对象</span><br>   <span class="hljs-keyword">private</span> Object target;<br>    <br>    <span class="hljs-comment">// 自定义方法，创建代理对象</span><br>    <span class="hljs-keyword">public</span> TrainStation <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br> 	<span class="hljs-comment">//创建Enhancer对象，类似于JDK动态代理的Proxy类，下一步就是设置几个参数</span><br>       <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();<br>       <span class="hljs-comment">//设置父类的字节码对象</span><br>       enhancer.setSuperclass(target.getClass());<br>       <span class="hljs-comment">//设置回调函数</span><br>       enhancer.setCallback(<span class="hljs-built_in">this</span>);<br>       <span class="hljs-comment">//创建代理对象</span><br>       <span class="hljs-type">TrainStation</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (TrainStation) enhancer.create();<br>       <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 通过 method 引用实例    Object result = method.invoke(target, args); 形式反射调用被代理类方法，</span><br><span class="hljs-comment">    * target 实例代表被代理类对象引用, 初始化 CglibMethodInterceptor 时候被赋值 。但是Cglib不推荐使用这种方式</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> obj    代表Cglib 生成的动态代理类 对象本身</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> method 代理类中被拦截的接口方法 Method 实例</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> args   接口方法参数</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> methodProxy  用于调用父类真正的业务类方法。可以直接调用被代理类接口方法</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> Throwable</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">// 这是增强方法</span><br>     <span class="hljs-keyword">public</span> TrainStation <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>         <span class="hljs-comment">// 有两种调用方式</span><br>       System.out.println(<span class="hljs-string">&quot;代理点收取一些服务费用(CGLIB动态代理方式)&quot;</span>);<br>        <span class="hljs-comment">// 一：通过反射调用 被代理类方法</span><br>        <span class="hljs-comment">// method.invoke(target, args);</span><br>         <span class="hljs-comment">// 二： 调用父类（被代理类）的方法</span><br>       <span class="hljs-type">TrainStation</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (TrainStation) methodProxy.invokeSuper(obj, args);<br>       <span class="hljs-keyword">return</span> result;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>暂定：</p>
<h3 id="MethodValidationPostProcessor"><a href="#MethodValidationPostProcessor" class="headerlink" title="MethodValidationPostProcessor"></a>MethodValidationPostProcessor</h3><p>方法执行前的校验 Validate</p>
<p>AbstractBeanFactoryAwareAdvisingPostProcessor继承自ProxyConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodValidationPostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBeanFactoryAwareAdvisingPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; validatedAnnotationType = Validated.class;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Validator validator;<br>    <span class="hljs-comment">// Advice -- </span><br>    <span class="hljs-keyword">protected</span> Advice <span class="hljs-title function_">createMethodValidationAdvice</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Validator validator)</span> &#123;<br>        <span class="hljs-keyword">return</span> validator != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodValidationInterceptor</span>(validator) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodValidationInterceptor</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406200155882.png" srcset="/img/loading.gif" lazyload alt="image-20230406200155882"></p>
<h4 id="MethodValidationInterceptor"><a href="#MethodValidationInterceptor" class="headerlink" title="MethodValidationInterceptor"></a>MethodValidationInterceptor</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405161939755.png" srcset="/img/loading.gif" lazyload alt="image-20230405161939755"></p>
<h2 id="Aop和Aspect-J的应用"><a href="#Aop和Aspect-J的应用" class="headerlink" title="Aop和Aspect J的应用"></a>Aop和Aspect J的应用</h2><p>在Spring AOP中，有几个关键的组件用于实现切面编程：</p>
<p><strong>JointPoint（连接点）</strong>：连接点是在应用程序执行过程中可以插入切面的点。连接点可以是类的属性、构造方法、原始方法或代理对象。在连接点上，切面可以执行额外的逻辑。</p>
<p><strong>PointCut（切入点）</strong>：切入点是用于定义在哪些连接点上应用切面的规则。切入点可以通过使用@Pointcut注解来定义，它可以匹配类或方法的名称、参数、注解等。切入点决定了切面在哪些连接点上生效。</p>
<p><strong>Advice（增强方法）</strong>：Advice是切面在特定连接点上执行的逻辑。它定义了在连接点上要执行的操作，例如在方法执行前后执行某些代码、抛出异常时执行某些代码等。Spring AOP提供了几种类型的Advice，包括前置通知（Before）、后置通知（After）、返回通知（AfterReturning）、异常通知（AfterThrowing）和环绕通知（Around）。</p>
<p><strong>Advisor（顾问）</strong>：Advisor是将切面和切入点组合在一起的对象。它包含了切面和切入点的信息，并决定了切面在哪些连接点上生效。</p>
<p><strong>Advised（被增强对象）</strong>：Advised是被增强的目标对象。它是应用切面的对象，切面会在Advised的连接点上执行增强方法。</p>
<h3 id="包结构"><a href="#包结构" class="headerlink" title="包结构"></a>包结构</h3><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405221715635.png" srcset="/img/loading.gif" lazyload alt="image-20230405221715635"></p>
<h3 id="JoinPoint-连接点"><a href="#JoinPoint-连接点" class="headerlink" title="JoinPoint - 连接点"></a>JoinPoint - 连接点</h3><p>JointPoint（连接点）：连接点是在应用程序执行过程中可以插入切面的点。连接点可以是类的属性、构造方法、原始方法或代理对象。在连接点上，切面可以执行额外的逻辑。</p>
<p>获取切入点的 方法 &#x2F; 类 &#x2F; 属性信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Joinpoint</span> &#123;<br>   <span class="hljs-comment">// 执行织入点的方法</span><br>    Object <span class="hljs-title function_">proceed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable;<br>	<span class="hljs-comment">// 获取 织入点的 方法的this指针</span><br>    Object <span class="hljs-title function_">getThis</span><span class="hljs-params">()</span>;<br><br>    AccessibleObject <span class="hljs-title function_">getStaticPart</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>用户获取代理对象 – 即切入点-切入方法的动态代理对象Proxy，用于增强方法</p>
<h5 id="Invocation"><a href="#Invocation" class="headerlink" title="Invocation"></a>Invocation</h5><h5 id="MethodInvocation"><a href="#MethodInvocation" class="headerlink" title="MethodInvocation"></a>MethodInvocation</h5><h5 id="ConstructorInvocation"><a href="#ConstructorInvocation" class="headerlink" title="ConstructorInvocation"></a>ConstructorInvocation</h5><h5 id="ProxyMethodInvocation"><a href="#ProxyMethodInvocation" class="headerlink" title="ProxyMethodInvocation"></a>ProxyMethodInvocation</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取类信息</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Joinpoint</span> &#123;<br>    Object <span class="hljs-title function_">proceed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable;<br><br>    Object <span class="hljs-title function_">getThis</span><span class="hljs-params">()</span>;<br><br>    AccessibleObject <span class="hljs-title function_">getStaticPart</span><span class="hljs-params">()</span>;<br>&#125;<br><span class="hljs-comment">// 获取参数列表</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Invocation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Joinpoint</span> &#123;<br>    Object[] getArguments();<br>&#125;<br><span class="hljs-comment">// 获取方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MethodInvocation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Invocation</span> &#123;<br>    Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">()</span>;<br>&#125;<br><span class="hljs-comment">// 获取构造函数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConstructorInvocation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Invocation</span> &#123;<br>    Constructor&lt;?&gt; getConstructor();<br>&#125;<br><span class="hljs-comment">// 获取代理对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProxyMethodInvocation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodInvocation</span> &#123;<br>    Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// 。。。。</span><br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222028275.png" srcset="/img/loading.gif" lazyload alt="image-20230405222028275"></p>
<p>ProxyMethodInvocation -&gt; ReflectivMethodInvocation -&gt; CglibAopProxy( 内部类: CglibMethodInvocation ) 获取代理类</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222137380.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Advice-–-通知"><a href="#Advice-–-通知" class="headerlink" title="Advice – 通知"></a>Advice – 通知</h3><p>作用：通过实现 —用户方法执行的调用</p>
<p>Advice（增强方法）：Advice是切面在特定连接点上执行的逻辑。它定义了在连接点上要执行的操作，例如在方法执行前后执行某些代码、抛出异常时执行某些代码等。Spring AOP提供了几种类型的Advice，包括前置通知（Before）、后置通知（After）、返回通知（AfterReturning）、异常通知（AfterThrowing）和环绕通知（Around）。</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222505694.png" srcset="/img/loading.gif" lazyload alt="image-20230405222505694"></p>
<p>BeforeAdvice , AfterAdvice </p>
<h4 id="AspectJPrecedenceInformation"><a href="#AspectJPrecedenceInformation" class="headerlink" title="AspectJPrecedenceInformation"></a>AspectJPrecedenceInformation</h4><p>precedence ：优先级</p>
<p>作用：实现Ordered接口，实现用于设置Advice执行的优先级，并能够获取当前方法的执行时机</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AspectJPrecedenceInformation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Ordered</span> &#123;<br>    String <span class="hljs-title function_">getAspectName</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">/// </span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getDeclarationOrder</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">// </span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBeforeAdvice</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">// </span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAfterAdvice</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AbstractAspectJAdvice"><a href="#AbstractAspectJAdvice" class="headerlink" title="AbstractAspectJAdvice"></a>AbstractAspectJAdvice</h4><p>调用的方法时增强方法，<strong>aspectJAdviceMethod</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAspectJAdvice</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Advice</span>, AspectJPrecedenceInformation, Serializable &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">JOIN_POINT_KEY</span> <span class="hljs-operator">=</span> JoinPoint.class.getName();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; declaringClass;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String methodName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt;[] parameterTypes;<br>    <span class="hljs-comment">// 增强方法</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">transient</span> Method aspectJAdviceMethod;<br>    <span class="hljs-comment">// 切入点</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AspectJExpressionPointcut pointcut;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AspectInstanceFactory aspectInstanceFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">aspectName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> declarationOrder;<br>    <span class="hljs-keyword">private</span> String[] argumentNames;<br>    <span class="hljs-keyword">private</span> String throwingName;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> String returningName;<br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; discoveredReturningType = Object.class;<br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; discoveredThrowingType = Object.class;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">joinPointArgumentIndex</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">joinPointStaticPartArgumentIndex</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; argumentBindings;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">argumentsIntrospected</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Type discoveredReturningGenericType;<br><br>    <span class="hljs-comment">// 反射 执行增强方法</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">invokeAdviceMethodWithGivenArgs</span><span class="hljs-params">(Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        Object[] actualArgs = args;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.aspectJAdviceMethod.getParameterCount() == <span class="hljs-number">0</span>) &#123;<br>            actualArgs = <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ReflectionUtils.makeAccessible(<span class="hljs-built_in">this</span>.aspectJAdviceMethod);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.aspectJAdviceMethod.invoke(<span class="hljs-built_in">this</span>.aspectInstanceFactory.getAspectInstance(), actualArgs);<br>        &#125; <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222931657.png" srcset="/img/loading.gif" lazyload alt="image-20230405222931657"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222946836.png" srcset="/img/loading.gif" lazyload alt="image-20230405222946836"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 主要参数</span><br><span class="hljs-comment">// JoinPoint JoinPointMatch Obejct(returnVal) Throwable</span><br><br><span class="hljs-comment">// before</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(Method method, Object[] args, <span class="hljs-meta">@Nullable</span> Object target)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-built_in">this</span>.invokeAdviceMethod(<span class="hljs-built_in">this</span>.getJoinPointMatch(), (Object)<span class="hljs-literal">null</span>, (Throwable)<span class="hljs-literal">null</span>);<br>    &#125;<br><span class="hljs-comment">// around  -- 特殊：环绕通知需要在增强方法中， 通过JoinPoint.proceed() 调用被增强的方法</span><br> <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation mi)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-keyword">if</span> (!(mi <span class="hljs-keyword">instanceof</span> ProxyMethodInvocation)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;MethodInvocation is not a Spring ProxyMethodInvocation: &quot;</span> + mi);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">ProxyMethodInvocation</span> <span class="hljs-variable">pmi</span> <span class="hljs-operator">=</span> (ProxyMethodInvocation)mi;<br>            <span class="hljs-type">ProceedingJoinPoint</span> <span class="hljs-variable">pjp</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lazyGetProceedingJoinPoint(pmi);<br>            <span class="hljs-type">JoinPointMatch</span> <span class="hljs-variable">jpm</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getJoinPointMatch(pmi);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.invokeAdviceMethod(pjp, jpm, (Object)<span class="hljs-literal">null</span>, (Throwable)<span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br><span class="hljs-comment">// after</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation mi)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        Object var2;<br>        <span class="hljs-keyword">try</span> &#123;<br>            var2 = mi.proceed();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">this</span>.invokeAdviceMethod(<span class="hljs-built_in">this</span>.getJoinPointMatch(), (Object)<span class="hljs-literal">null</span>, (Throwable)<span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> var2;<br>    &#125;	<br></code></pre></td></tr></table></figure>





<h4 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h4><h5 id="MethodInterceptor-1"><a href="#MethodInterceptor-1" class="headerlink" title="MethodInterceptor"></a><strong>MethodInterceptor</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MethodInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Interceptor</span> &#123;<br>    Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation var1)</span> <span class="hljs-keyword">throws</span> Throwable;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="AspectJAroudAdvice"><a href="#AspectJAroudAdvice" class="headerlink" title="AspectJAroudAdvice"></a>AspectJAroudAdvice</h4><p><strong>增强方法</strong>：继承AbstractAspectJAdvice, MethodInterceptor, AspectJPrecedenceInformation  </p>
<p>通过实现MethodInterceptor的invoke()方法，然后由CGLIB生成的动态代理对象，调用invoke()方法，实现方法的增强</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation mi)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-comment">// XXXX</span><br>    <span class="hljs-comment">// 最终调用到AbstractAspectJAdvice的方法中</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.invokeAdviceMethod(pjp, jpm, (Object)<span class="hljs-literal">null</span>, (Throwable)<span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// XXXXX</span><br>&#125;<br></code></pre></td></tr></table></figure>

 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">AspectJMethodBeforeAdvice <br><br>AspectJAroudAdvice <br><br>AspectJAfterAdvice AspectJAfterReturnAdvice AspectJAfterThrowingAdvice <br></code></pre></td></tr></table></figure>



<p><strong>定义invoke()方法的调用顺序</strong> 增强方法调用和原方法调用</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405222835592.png" srcset="/img/loading.gif" lazyload alt="image-20230405222835592"></p>
<h3 id="Pointcut-–-切入点"><a href="#Pointcut-–-切入点" class="headerlink" title="Pointcut – 切入点"></a>Pointcut – 切入点</h3><p>作用：</p>
<p>PointCut（切入点）：切入点是用于定义在哪些连接点上应用切面的规则。切入点可以通过使用@Pointcut注解来定义，它可以匹配类或方法的名称、参数、注解等。切入点决定了切面在哪些连接点上生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Pointcut</span> &#123;<br>    <span class="hljs-type">Pointcut</span> <span class="hljs-variable">TRUE</span> <span class="hljs-operator">=</span> TruePointcut.INSTANCE;<br>	<span class="hljs-comment">// 获取类过滤</span><br>    ClassFilter <span class="hljs-title function_">getClassFilter</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">// 获取方法匹配器</span><br>    MethodMatcher <span class="hljs-title function_">getMethodMatcher</span><span class="hljs-params">()</span>;<br>&#125;<br>	<span class="hljs-meta">@Pointcut(&quot;execution(* concert.Performance.perform(int)) &amp;&amp; args(num)&quot;)</span>  <span class="hljs-comment">// 定义命名的切点</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performance</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> &#123;<br><br>    &#125;<br>	<span class="hljs-comment">// 切入方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Performance</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">perform</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405231025354.png" srcset="/img/loading.gif" lazyload alt="image-20230405231025354"></p>
<h4 id="ClassFilter"><a href="#ClassFilter" class="headerlink" title="ClassFilter"></a>ClassFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">[ublic <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClassFilter</span> &#123;<br>    <span class="hljs-type">ClassFilter</span> <span class="hljs-variable">TRUE</span> <span class="hljs-operator">=</span> TrueClassFilter.INSTANCE;<br>	<span class="hljs-comment">// </span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(Class&lt;?&gt; var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405231238795.png" srcset="/img/loading.gif" lazyload alt="image-20230405231238795"></p>
<h4 id="MethodMatcher"><a href="#MethodMatcher" class="headerlink" title="MethodMatcher"></a>MethodMatcher</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MethodMatcher</span> &#123;<br>    <span class="hljs-type">MethodMatcher</span> <span class="hljs-variable">TRUE</span> <span class="hljs-operator">=</span> TrueMethodMatcher.INSTANCE;<br>	<span class="hljs-comment">// </span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(Method var1, Class&lt;?&gt; var2)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRuntime</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">// </span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(Method var1, Class&lt;?&gt; var2, Object... var3)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405231331607.png" srcset="/img/loading.gif" lazyload alt="image-20230405231331607"></p>
<h4 id="DynamicMethodMatcherPoincut"><a href="#DynamicMethodMatcherPoincut" class="headerlink" title="DynamicMethodMatcherPoincut"></a>DynamicMethodMatcherPoincut</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406104600568.png" srcset="/img/loading.gif" lazyload alt="image-20230406104600568"></p>
<h4 id="AspectJExpressionPointcut"><a href="#AspectJExpressionPointcut" class="headerlink" title="AspectJExpressionPointcut"></a>AspectJExpressionPointcut</h4><p>用于解析pointcut的表达式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectJExpressionPointcut</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExpressionPointcut</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFilter</span>, IntroductionAwareMethodMatcher, BeanFactoryAware &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;PointcutPrimitive&gt; SUPPORTED_PRIMITIVES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; pointcutDeclarationScope;<br>    <span class="hljs-keyword">private</span> String[] pointcutParameterNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">private</span> Class&lt;?&gt;[] pointcutParameterTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">// 通过 BeanFactoryAware ## setBeanFactory()设置属性</span><br>    <span class="hljs-keyword">private</span> BeanFactory beanFactory;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ClassLoader pointcutClassLoader;<br>    <span class="hljs-comment">// pointcut的表达式</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> PointcutExpression pointcutExpression;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Map&lt;Method, ShadowMatch&gt; shadowMatchCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>(<span class="hljs-number">32</span>);<br></code></pre></td></tr></table></figure>



<p>MethodMatcher ：方法匹配</p>
<p>ClassFilter ： 类匹配</p>
<p>Pointcut -&gt; ExpressionPointcut ： 获取切入点的表达式</p>
<p>BeanFactoryAware: 用于获取BeanFactory参数</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230405233548524.png" srcset="/img/loading.gif" lazyload alt="image-20230405233548524"></p>
<h3 id="Advisor-–-通知者"><a href="#Advisor-–-通知者" class="headerlink" title="Advisor – 通知者"></a>Advisor – 通知者</h3><p>作用：Advisor（顾问）：Advisor是将切面和切入点组合在一起的对象。它包含了切面和切入点的信息，并决定了切面在哪些连接点上生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Advisor</span> &#123;<br>    <span class="hljs-type">Advice</span> <span class="hljs-variable">EMPTY_ADVICE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Advice</span>() &#123;<br>    &#125;;<br>	<span class="hljs-comment">// 获取通知</span><br>    Advice <span class="hljs-title function_">getAdvice</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPerInstance</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="InstantiationModelAwarePointcutAdvisorImpl"><a href="#InstantiationModelAwarePointcutAdvisorImpl" class="headerlink" title="InstantiationModelAwarePointcutAdvisorImpl"></a>InstantiationModelAwarePointcutAdvisorImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstantiationModelAwarePointcutAdvisorImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InstantiationModelAwarePointcutAdvisor</span>, AspectJPrecedenceInformation, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Advice</span> <span class="hljs-variable">EMPTY_ADVICE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Advice</span>() &#123;<br>    &#125;;<br>    <span class="hljs-comment">// Pointcut - 切入点</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AspectJExpressionPointcut declaredPointcut;<br>    <span class="hljs-comment">// 参数信息</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; declaringClass;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String methodName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt;[] parameterTypes;<br>    <span class="hljs-comment">// 增强方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Method aspectJAdviceMethod;<br>    <span class="hljs-comment">// 用于获取Advisor和Advice的工厂方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AspectJAdvisorFactory aspectJAdvisorFactory;<br>    <span class="hljs-comment">// 获取AspectMetadata 元数据信息</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MetadataAwareAspectInstanceFactory aspectInstanceFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> declarationOrder;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String aspectName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Pointcut pointcut;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> lazy;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Advice instantiatedAdvice;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Boolean isBeforeAdvice;<br>    <span class="hljs-comment">// AspectJPrecedenceInformation的方法 </span><br>    <span class="hljs-keyword">private</span> Boolean isAfterAdvice;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406092414132.png" srcset="/img/loading.gif" lazyload alt="image-20230406092414132"></p>
<h5 id="AspectJAdvisorFactory"><a href="#AspectJAdvisorFactory" class="headerlink" title="AspectJAdvisorFactory"></a>AspectJAdvisorFactory</h5><p>用于获取Advisor - 通知者和 Advice 通知的工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AspectJAdvisorFactory</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAspect</span><span class="hljs-params">(Class&lt;?&gt; var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(Class&lt;?&gt; var1)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br>	<span class="hljs-comment">// 获取 Advisor 通过MetadataAwareAspectInstanceFactory</span><br>    List&lt;Advisor&gt; <span class="hljs-title function_">getAdvisors</span><span class="hljs-params">(MetadataAwareAspectInstanceFactory var1)</span>;<br>	<br>    Advisor <span class="hljs-title function_">getAdvisor</span><span class="hljs-params">(Method var1, MetadataAwareAspectInstanceFactory var2, <span class="hljs-type">int</span> var3, String var4)</span>;<br>	<span class="hljs-comment">// 实现类  通过Anotation的类型创建 </span><br>    Advice <span class="hljs-title function_">getAdvice</span><span class="hljs-params">(Method var1, AspectJExpressionPointcut var2, MetadataAwareAspectInstanceFactory var3, <span class="hljs-type">int</span> var4, String var5)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h6 id="ReflectiveAspectJAdvisorFactory"><a href="#ReflectiveAspectJAdvisorFactory" class="headerlink" title="ReflectiveAspectJAdvisorFactory"></a>ReflectiveAspectJAdvisorFactory</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectiveAspectJAdvisorFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAspectJAdvisorFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>	<br>     <br>    <span class="hljs-comment">// 用于创建AspectJAroundAdvice AspectJMethodBeforeAdvice  AspectJAfterReturningAdvice </span><br>    <span class="hljs-comment">// advice对象</span><br>    <span class="hljs-keyword">public</span> Advice <span class="hljs-title function_">getAdvice</span><span class="hljs-params">(Method candidateAdviceMethod, AspectJExpressionPointcut expressionPointcut, MetadataAwareAspectInstanceFactory aspectInstanceFactory, <span class="hljs-type">int</span> declarationOrder, String aspectName)</span> &#123;<br>        Class&lt;?&gt; candidateAspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();<br>        <span class="hljs-built_in">this</span>.validate(candidateAspectClass);<br>        AspectJAnnotation&lt;?&gt; aspectJAnnotation = AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);<br>        <span class="hljs-keyword">if</span> (aspectJAnnotation == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <br>            Object springAdvice;<br>            <span class="hljs-keyword">switch</span>(aspectJAnnotation.getAnnotationType()) &#123;<br>            <span class="hljs-keyword">case</span> AtPointcut:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">case</span> AtAround:<br>                springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAroundAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> AtBefore:<br>                springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJMethodBeforeAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> AtAfter:<br>                springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAfterAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> AtAfterReturning:<br>                springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAfterReturningAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>                <span class="hljs-type">AfterReturning</span> <span class="hljs-variable">afterReturningAnnotation</span> <span class="hljs-operator">=</span> (AfterReturning)aspectJAnnotation.getAnnotation();<br>                <span class="hljs-keyword">if</span> (StringUtils.hasText(afterReturningAnnotation.returning())) &#123;<br>                    ((AbstractAspectJAdvice)springAdvice).setReturningName(afterReturningAnnotation.returning());<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> AtAfterThrowing:<br>                springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAfterThrowingAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>                <span class="hljs-type">AfterThrowing</span> <span class="hljs-variable">afterThrowingAnnotation</span> <span class="hljs-operator">=</span> (AfterThrowing)aspectJAnnotation.getAnnotation();<br>                <span class="hljs-keyword">if</span> (StringUtils.hasText(afterThrowingAnnotation.throwing())) &#123;<br>                    ((AbstractAspectJAdvice)springAdvice).setThrowingName(afterThrowingAnnotation.throwing());<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Unsupported advice type on method: &quot;</span> + candidateAdviceMethod);<br>            &#125;<br><br>            ((AbstractAspectJAdvice)springAdvice).setAspectName(aspectName);<br>            ((AbstractAspectJAdvice)springAdvice).setDeclarationOrder(declarationOrder);<br>            String[] argNames = <span class="hljs-built_in">this</span>.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);<br>            <span class="hljs-keyword">if</span> (argNames != <span class="hljs-literal">null</span>) &#123;<br>                ((AbstractAspectJAdvice)springAdvice).setArgumentNamesFromStringArray(argNames);<br>            &#125;<br><br>            ((AbstractAspectJAdvice)springAdvice).calculateArgumentBindings();<br>            <span class="hljs-keyword">return</span> (Advice)springAdvice;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="AspectInstanceFactory"><a href="#AspectInstanceFactory" class="headerlink" title="AspectInstanceFactory"></a>AspectInstanceFactory</h5><p>获取Aspect对象的<strong>实例对象</strong>或者<strong>元数据信息</strong>(类基本信息)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AspectInstanceFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Ordered</span> &#123;<br>    <span class="hljs-comment">// 获取 Aspect对象的实例	-- 实例对象</span><br>    Object <span class="hljs-title function_">getAspectInstance</span><span class="hljs-params">()</span>;<br>	<br>    ClassLoader <span class="hljs-title function_">getAspectClassLoader</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406112053207.png" srcset="/img/loading.gif" lazyload alt="image-20230406112053207"></p>
<h6 id="MetadataAwareAspectInstanceFactory"><a href="#MetadataAwareAspectInstanceFactory" class="headerlink" title="MetadataAwareAspectInstanceFactory"></a>MetadataAwareAspectInstanceFactory</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MetadataAwareAspectInstanceFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AspectInstanceFactory</span> &#123;<br>    <span class="hljs-comment">// 获取AspectMetadata  -- 元数据 -- 类基本信息</span><br>    AspectMetadata <span class="hljs-title function_">getAspectMetadata</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">//  </span><br>    Object <span class="hljs-title function_">getAspectCreationMutex</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectMetadata</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String aspectName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; aspectClass;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> AjType&lt;?&gt; ajType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Pointcut perClausePointcut;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406113728786.png" srcset="/img/loading.gif" lazyload alt="image-20230406113728786"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406085006730.png" srcset="/img/loading.gif" lazyload alt="image-20230406085006730"></p>
<h3 id="Advised"><a href="#Advised" class="headerlink" title="Advised"></a>Advised</h3><p>管理Advisor和Advice，还有被代理对象的Class</p>
<p>Advised（被增强对象）：Advised是被增强的目标对象。它是应用切面的对象，切面会在Advised的连接点上执行增强方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TargetClassAware</span> &#123;<br>    <span class="hljs-meta">@Nullable</span><br>    Class&lt;?&gt; getTargetClass();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Advised</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TargetClassAware</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFrozen</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProxyTargetClass</span><span class="hljs-params">()</span>;<br><br>    Class&lt;?&gt;[] getProxiedInterfaces();<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInterfaceProxied</span><span class="hljs-params">(Class&lt;?&gt; var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTargetSource</span><span class="hljs-params">(TargetSource var1)</span>;<br><br>    TargetSource <span class="hljs-title function_">getTargetSource</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExposeProxy</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExposeProxy</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPreFiltered</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPreFiltered</span><span class="hljs-params">()</span>;<br><br>    Advisor[] getAdvisors();<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAdvisor</span><span class="hljs-params">(Advisor var1)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAdvisor</span><span class="hljs-params">(<span class="hljs-type">int</span> var1, Advisor var2)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeAdvisor</span><span class="hljs-params">(Advisor var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAdvisor</span><span class="hljs-params">(<span class="hljs-type">int</span> var1)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Advisor var1)</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">replaceAdvisor</span><span class="hljs-params">(Advisor var1, Advisor var2)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAdvice</span><span class="hljs-params">(Advice var1)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAdvice</span><span class="hljs-params">(<span class="hljs-type">int</span> var1, Advice var2)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeAdvice</span><span class="hljs-params">(Advice var1)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Advice var1)</span>;<br><br>    String <span class="hljs-title function_">toProxyConfigString</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406115216050.png" srcset="/img/loading.gif" lazyload alt="image-20230406115216050"></p>
<h4 id="AdvisedSupport"><a href="#AdvisedSupport" class="headerlink" title="AdvisedSupport"></a>AdvisedSupport</h4><p>Advised的实现类，管理代理对象的所有参数 Advisor. targerclass，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvisedSupport</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ProxyConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Advised</span> &#123;<br><br>	<span class="hljs-comment">/** use serialVersionUID from Spring 2.0 for interoperability. */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2651364800145442165L</span>;<br><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Canonical TargetSource when there&#x27;s no target, and behavior is</span><br><span class="hljs-comment">	 * supplied by the advisors.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TargetSource</span> <span class="hljs-variable">EMPTY_TARGET_SOURCE</span> <span class="hljs-operator">=</span> EmptyTargetSource.INSTANCE;<br><br><br>	<span class="hljs-comment">/** Package-protected to allow direct access for efficiency. */</span><br>	<span class="hljs-type">TargetSource</span> <span class="hljs-variable">targetSource</span> <span class="hljs-operator">=</span> EMPTY_TARGET_SOURCE;<br><br>	<span class="hljs-comment">/** Whether the Advisors are already filtered for the specific target class. */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">preFiltered</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/** The AdvisorChainFactory to use. */</span><br>	<span class="hljs-type">AdvisorChainFactory</span> <span class="hljs-variable">advisorChainFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAdvisorChainFactory</span>();<br><br>	<span class="hljs-comment">/** Cache with Method as key and advisor chain List as value. */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Map&lt;MethodCacheKey, List&lt;Object&gt;&gt; methodCache;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Interfaces to be implemented by the proxy. Held in List to keep the order</span><br><span class="hljs-comment">	 * of registration, to create JDK proxy with specified order of interfaces.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; interfaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * List of Advisors. If an Advice is added, it will be wrapped</span><br><span class="hljs-comment">	 * in an Advisor before being added to this List.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">private</span> List&lt;Advisor&gt; advisors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br></code></pre></td></tr></table></figure>



<p>联系Proxy和Advisor，Advice – 即将<strong>aspectj的方法切入</strong>  和  <strong>生成动态代理对象</strong> 相联系起来</p>
<p>Advised通过 Pointcut找到切入点，获取切入点的信息，通过ProxyConfig获取代理对象，让Advisor统一调度Advice，调用Advice的增强方法</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406115306753.png" srcset="/img/loading.gif" lazyload alt="image-20230406115306753"></p>
<h5 id="AspectJProxyFactory"><a href="#AspectJProxyFactory" class="headerlink" title="AspectJProxyFactory"></a>AspectJProxyFactory</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectJProxyFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ProxyCreatorSupport</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; aspectCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>();<br>    <span class="hljs-comment">// 获取 getAdvisor getAdvice</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AspectJAdvisorFactory</span> <span class="hljs-variable">aspectFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveAspectJAdvisorFactory</span>();<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="ProxyConfig"><a href="#ProxyConfig" class="headerlink" title="ProxyConfig"></a>ProxyConfig</h3><p>配置代理对象 ：分为三类AopInfrastructureBean、Advised、Singleton</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120704728.png" srcset="/img/loading.gif" lazyload alt="image-20230406120704728"></p>
<h4 id="AopInfrastructureBean"><a href="#AopInfrastructureBean" class="headerlink" title="AopInfrastructureBean"></a>AopInfrastructureBean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Aop的基础设施Bean -&gt; 即最基本的框架</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AopInfrastructureBean</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120420212.png" srcset="/img/loading.gif" lazyload alt="image-20230406120420212"></p>
<h5 id="ProxyProcessorSupport"><a href="#ProxyProcessorSupport" class="headerlink" title="ProxyProcessorSupport"></a>ProxyProcessorSupport</h5><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404172920442.png" srcset="/img/loading.gif" lazyload alt="image-20230404172920442"></p>
<h6 id="AbstactAutoProxyCreator"><a href="#AbstactAutoProxyCreator" class="headerlink" title="AbstactAutoProxyCreator"></a>AbstactAutoProxyCreator</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAutoProxyCreator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ProxyProcessorSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmartInstantiationAwareBeanPostProcessor</span>, BeanFactoryAware &#123;<br>    <span class="hljs-comment">// 在实例化之前生成代理对象</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInstantiation</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCacheKey(beanClass, beanName);<br>        <span class="hljs-keyword">if</span> (!StringUtils.hasLength(beanName) || !<span class="hljs-built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.advisedBeans.containsKey(cacheKey)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isInfrastructureClass(beanClass) || <span class="hljs-built_in">this</span>.shouldSkip(beanClass, beanName)) &#123;<br>                <span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-type">TargetSource</span> <span class="hljs-variable">targetSource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCustomTargetSource(beanClass, beanName);<br>        <span class="hljs-keyword">if</span> (targetSource != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName)) &#123;<br>                <span class="hljs-built_in">this</span>.targetSourcedBeans.add(beanName);<br>            &#125;<br><br>            Object[] specificInterceptors = <span class="hljs-built_in">this</span>.getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);<br>            <span class="hljs-comment">// </span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.createProxy(beanClass, beanName, specificInterceptors, targetSource);<br>            <span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());<br>            <span class="hljs-keyword">return</span> proxy;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">postProcessAfterInstantiation</span><span class="hljs-params">(Object bean, String beanName)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br>        <span class="hljs-keyword">return</span> pvs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> &#123;<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object bean, String beanName)</span> &#123;<br>        <span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCacheKey(bean.getClass(), beanName);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.wrapIfNecessary(bean, beanName, cacheKey);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404173001921.png" srcset="/img/loading.gif" lazyload alt="image-20230404173001921"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230404173027368.png" srcset="/img/loading.gif" lazyload alt="image-20230404173027368"></p>
<h5 id="ScopedProxyFactoryBean"><a href="#ScopedProxyFactoryBean" class="headerlink" title="ScopedProxyFactoryBean"></a>ScopedProxyFactoryBean</h5><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120616038.png" srcset="/img/loading.gif" lazyload alt="image-20230406120616038"></p>
<h4 id="AdvisedSupport-1"><a href="#AdvisedSupport-1" class="headerlink" title="AdvisedSupport"></a>AdvisedSupport</h4><h5 id="ProxyCreatorSupport"><a href="#ProxyCreatorSupport" class="headerlink" title="ProxyCreatorSupport"></a>ProxyCreatorSupport</h5><p><strong>ProxyFactoryBean、ProxyFactory、AspectJProxyFactory</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvisedSupport</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ProxyConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Advised</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2651364800145442165L</span>;<br>   <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TargetSource EMPTY_TARGET_SOURCE;<br>   	<span class="hljs-comment">//  // 持有目标类，可以生成代理对象</span><br>    TargetSource targetSource;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> preFiltered;<br>    AdvisorChainFactory advisorChainFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Map&lt;AdvisedSupport.MethodCacheKey, List&lt;Object&gt;&gt; methodCache;<br>    <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; interfaces;<br>    <span class="hljs-keyword">private</span> List&lt;Advisor&gt; advisors;<br>    <span class="hljs-keyword">private</span> Advisor[] advisorArray;<br>&#125;<br></code></pre></td></tr></table></figure>





<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120823535.png" srcset="/img/loading.gif" lazyload alt="image-20230406120823535"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406121146203.png" srcset="/img/loading.gif" lazyload alt="image-20230406121146203"></p>
<h4 id="AbstractSingletonProxyFactoryBean"><a href="#AbstractSingletonProxyFactoryBean" class="headerlink" title="AbstractSingletonProxyFactoryBean"></a>AbstractSingletonProxyFactoryBean</h4><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406120835618.png" srcset="/img/loading.gif" lazyload alt="image-20230406120835618"></p>
<h2 id="整体代理类生成逻辑"><a href="#整体代理类生成逻辑" class="headerlink" title="整体代理类生成逻辑"></a>整体代理类生成逻辑</h2><h3 id="AopProxyFactory"><a href="#AopProxyFactory" class="headerlink" title="AopProxyFactory"></a>AopProxyFactory</h3><p>创建AopProxy代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AopProxyFactory</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create an &#123;<span class="hljs-doctag">@link</span> AopProxy&#125; for the given AOP configuration.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> config the AOP configuration in the form of an</span><br><span class="hljs-comment">	 * AdvisedSupport object</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the corresponding AOP proxy</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> AopConfigException if the configuration is invalid</span><br><span class="hljs-comment">	 */</span><br>	AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> <span class="hljs-keyword">throws</span> AopConfigException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DefaultAopProxyFactory"><a href="#DefaultAopProxyFactory" class="headerlink" title="DefaultAopProxyFactory"></a>DefaultAopProxyFactory</h4><p>具体说创建代理 AopProxy逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultAopProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxyFactory</span>, Serializable &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7930414337282325166L</span>;<br><br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> <span class="hljs-keyword">throws</span> AopConfigException &#123;<br>		<span class="hljs-keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp;<br>				(config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) &#123;<br>			Class&lt;?&gt; targetClass = config.getTargetClass();<br>			<span class="hljs-keyword">if</span> (targetClass == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopConfigException</span>(<span class="hljs-string">&quot;TargetSource cannot determine target class: &quot;</span> +<br>						<span class="hljs-string">&quot;Either an interface or a target is required for proxy creation.&quot;</span>);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjenesisCglibAopProxy</span>(config);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>





<h3 id="TargetClassAware"><a href="#TargetClassAware" class="headerlink" title="TargetClassAware"></a>TargetClassAware</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TargetClassAware</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return the target class behind the implementing object</span><br><span class="hljs-comment">	 * (typically a proxy configuration or an actual proxy).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the target Class, or &#123;<span class="hljs-doctag">@code</span> null&#125; if not known</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@Nullable</span><br>	Class&lt;?&gt; getTargetClass();<br><br>&#125;<br></code></pre></td></tr></table></figure>





<h4 id="ProxyCreatorSupport-1"><a href="#ProxyCreatorSupport-1" class="headerlink" title="ProxyCreatorSupport"></a>ProxyCreatorSupport</h4><p>通过具体 factory创建代理 AopProxy</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyCreatorSupport</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AdvisedSupport</span> &#123;<br><br>	<span class="hljs-keyword">private</span> AopProxyFactory aopProxyFactory;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.active) &#123;<br>			activate();<br>		&#125;<br>		<span class="hljs-keyword">return</span> getAopProxyFactory().createAopProxy(<span class="hljs-built_in">this</span>);<br>	&#125;	<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="Advised-AdvisedSupport-–-总领"><a href="#Advised-AdvisedSupport-–-总领" class="headerlink" title="Advised \ AdvisedSupport – 总领"></a>Advised \ AdvisedSupport – 总领</h4><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">在Spring AOP中，选择代理的类是`AdvisedSupport`。`AdvisedSupport`是Spring AOP框架中的一个核心类，用于存储AOP代理的相关配置信息。<br><br>`AdvisedSupport`类中包含了以下重要的属性：<br><br>- `TargetSource`：目标对象的信息，包括目标对象本身和目标对象的类型。<br>- `MethodInterceptor`：拦截器对象，用于执行增强逻辑。<br>- `MethodMatcher`：方法匹配器，用于匹配需要拦截的方法。<br>- `Advisor`：通知器对象，包含了拦截器和方法匹配器。<br>- `ProxyFactory`：代理工厂对象，用于创建代理对象。<br><br>通过配置`AdvisedSupport`对象的属性，可以选择使用JDK动态代理还是CGLib动态代理，并指定拦截器、方法匹配器等，从而实现对目标对象的代理。<br><br>需要注意的是，`AdvisedSupport`类是Spring AOP框架的内部类，一般不需要直接使用它。在使用Spring AOP时，你可以通过配置XML文件或使用注解来配置AOP相关的信息，Spring框架会自动创建和管理`AdvisedSupport`对象。<br></code></pre></td></tr></table></figure>



<p>管理创建代理、执行代理的 总逻辑、并提供配置信息</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230712082954049.png" srcset="/img/loading.gif" lazyload alt="image-20230712082954049"></p>
<h3 id="AopProxy-1"><a href="#AopProxy-1" class="headerlink" title="AopProxy"></a>AopProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AopProxy</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create a new proxy object.</span><br><span class="hljs-comment">	 * &lt;p&gt;Uses the AopProxy&#x27;s default class loader (if necessary for proxy creation):</span><br><span class="hljs-comment">	 * usually, the thread context class loader.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the new proxy object (never &#123;<span class="hljs-doctag">@code</span> null&#125;)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> Thread#getContextClassLoader()</span><br><span class="hljs-comment">	 */</span><br>	Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create a new proxy object.</span><br><span class="hljs-comment">	 * &lt;p&gt;Uses the given class loader (if necessary for proxy creation).</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> null&#125; will simply be passed down and thus lead to the low-level</span><br><span class="hljs-comment">	 * proxy facility&#x27;s default, which is usually different from the default chosen</span><br><span class="hljs-comment">	 * by the AopProxy implementation&#x27;s &#123;<span class="hljs-doctag">@link</span> #getProxy()&#125; method.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> classLoader the class loader to create the proxy with</span><br><span class="hljs-comment">	 * (or &#123;<span class="hljs-doctag">@code</span> null&#125; for the low-level proxy facility&#x27;s default)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the new proxy object (never &#123;<span class="hljs-doctag">@code</span> null&#125;)</span><br><span class="hljs-comment">	 */</span><br>	Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span>;<br><br>  <br>  <br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>



<h4 id="JdkDynamicAopProxy-1"><a href="#JdkDynamicAopProxy-1" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, InvocationHandler, Serializable &#123;<br>  <br>	<span class="hljs-comment">/** Config used to configure this proxy. */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AdvisedSupport advised;<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> getProxy(ClassUtils.getDefaultClassLoader());<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>			logger.trace(<span class="hljs-string">&quot;Creating JDK dynamic proxy: &quot;</span> + <span class="hljs-built_in">this</span>.advised.getTargetSource());<br>		&#125;<br>		<span class="hljs-keyword">return</span> Proxy.newProxyInstance(classLoader, <span class="hljs-built_in">this</span>.proxiedInterfaces, <span class="hljs-built_in">this</span>);<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h4 id="CglibAopProxy-1"><a href="#CglibAopProxy-1" class="headerlink" title="CglibAopProxy"></a>CglibAopProxy</h4><p>根据AdvisedSupport 提供的配置信息， 创建Cglib代理的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, Serializable &#123;<br><br>	<span class="hljs-comment">// Constants for CGLIB callback array indices</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">AOP_PROXY</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INVOKE_TARGET</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NO_OVERRIDE</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DISPATCH_TARGET</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DISPATCH_ADVISED</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INVOKE_EQUALS</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INVOKE_HASHCODE</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br><br><br>	<span class="hljs-comment">/** Logger available to subclasses; static to optimize serialization. */</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(CglibAopProxy.class);<br><br>	<span class="hljs-comment">/** Keeps track of the Classes that we have validated for final methods. */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Boolean&gt; validatedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakHashMap</span>&lt;&gt;();<br><br><br>	<span class="hljs-comment">/** The configuration used to configure this proxy. */</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> AdvisedSupport advised;<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> getProxy(<span class="hljs-literal">null</span>);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>			logger.trace(<span class="hljs-string">&quot;Creating CGLIB proxy: &quot;</span> + <span class="hljs-built_in">this</span>.advised.getTargetSource());<br>		&#125;<br><br>		<span class="hljs-keyword">try</span> &#123;<br>			Class&lt;?&gt; rootClass = <span class="hljs-built_in">this</span>.advised.getTargetClass();<br>			Assert.state(rootClass != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;Target class must be available for creating a CGLIB proxy&quot;</span>);<br><br>			Class&lt;?&gt; proxySuperClass = rootClass;<br>			<span class="hljs-keyword">if</span> (rootClass.getName().contains(ClassUtils.CGLIB_CLASS_SEPARATOR)) &#123;<br>				proxySuperClass = rootClass.getSuperclass();<br>				Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();<br>				<span class="hljs-keyword">for</span> (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;<br>					<span class="hljs-built_in">this</span>.advised.addInterface(additionalInterface);<br>				&#125;<br>			&#125;<br><br>			<span class="hljs-comment">// Validate the class, writing log messages as necessary.</span><br>			validateClassIfNecessary(proxySuperClass, classLoader);<br><br>			<span class="hljs-comment">// Configure CGLIB Enhancer...</span><br>			<span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> createEnhancer();<br>			<span class="hljs-keyword">if</span> (classLoader != <span class="hljs-literal">null</span>) &#123;<br>				enhancer.setClassLoader(classLoader);<br>				<span class="hljs-keyword">if</span> (classLoader <span class="hljs-keyword">instanceof</span> SmartClassLoader &amp;&amp;<br>						((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;<br>					enhancer.setUseCache(<span class="hljs-literal">false</span>);<br>				&#125;<br>			&#125;<br>			enhancer.setSuperclass(proxySuperClass);<br>			enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(<span class="hljs-built_in">this</span>.advised));<br>			enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);<br>			enhancer.setStrategy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoaderAwareGeneratorStrategy</span>(classLoader));<br><br>			Callback[] callbacks = getCallbacks(rootClass);<br>			Class&lt;?&gt;[] types = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[callbacks.length];<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; x &lt; types.length; x++) &#123;<br>				types[x] = callbacks[x].getClass();<br>			&#125;<br>			<span class="hljs-comment">// fixedInterceptorMap only populated at this point, after getCallbacks call above</span><br>			enhancer.setCallbackFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyCallbackFilter</span>(<br>					<span class="hljs-built_in">this</span>.advised.getConfigurationOnlyCopy(), <span class="hljs-built_in">this</span>.fixedInterceptorMap, <span class="hljs-built_in">this</span>.fixedInterceptorOffset));<br>			enhancer.setCallbackTypes(types);<br><br>			<span class="hljs-comment">// Generate the proxy class and create a proxy instance.</span><br>			<span class="hljs-keyword">return</span> createProxyClassAndInstance(enhancer, callbacks);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (CodeGenerationException | IllegalArgumentException ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopConfigException</span>(<span class="hljs-string">&quot;Could not generate CGLIB subclass of &quot;</span> + <span class="hljs-built_in">this</span>.advised.getTargetClass() +<br>					<span class="hljs-string">&quot;: Common causes of this problem include using a final class or a non-visible class&quot;</span>,<br>					ex);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>			<span class="hljs-comment">// TargetSource.getTarget() failed</span><br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopConfigException</span>(<span class="hljs-string">&quot;Unexpected AOP exception&quot;</span>, ex);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230712083639599.png" srcset="/img/loading.gif" lazyload alt="image-20230712083639599"></p>
<h1 id="PropertySource加载"><a href="#PropertySource加载" class="headerlink" title="PropertySource加载"></a>PropertySource加载</h1><p>PropertySource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertySource</span>&lt;T&gt; &#123;<br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String name;<br>	<span class="hljs-comment">// InputStreanSource子类 -- 包括各种格式Resource</span><br>    <span class="hljs-comment">// 这里是 EncodeResource</span><br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> T source;<br>&#125;<br><span class="hljs-comment">// Iterable -- 用于遍历等操作PropertySource</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PropertySources</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Iterable</span>&lt;PropertySource&lt;?&gt;&gt; &#123;<br>	<span class="hljs-comment">// 流式操作</span><br>	<span class="hljs-keyword">default</span> Stream&lt;PropertySource&lt;?&gt;&gt; stream() &#123;<br>		<span class="hljs-keyword">return</span> StreamSupport.stream(spliterator(), <span class="hljs-literal">false</span>);<br>	&#125;<br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String name)</span>;<br>	PropertySource&lt;?&gt; get(String name);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416162221630.png" srcset="/img/loading.gif" lazyload alt="image-20230416162221630"></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230416162125168.png" srcset="/img/loading.gif" lazyload alt="image-20230416162125168"></p>
<p>​	</p>
<h2 id="PropertySourceFactory"><a href="#PropertySourceFactory" class="headerlink" title="PropertySourceFactory"></a>PropertySourceFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PropertySourceFactory</span> &#123;<br><br>   PropertySource&lt;?&gt; createPropertySource(<span class="hljs-meta">@Nullable</span> String name, EncodedResource resource) <span class="hljs-keyword">throws</span> IOException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DefaultPropertySourceFactory"><a href="#DefaultPropertySourceFactory" class="headerlink" title="DefaultPropertySourceFactory"></a>DefaultPropertySourceFactory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultPropertySourceFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PropertySourceFactory</span> &#123;<br><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> PropertySource&lt;?&gt; createPropertySource(<span class="hljs-meta">@Nullable</span> String name, EncodedResource resource) <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-keyword">return</span> (name != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourcePropertySource</span>(name, resource) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourcePropertySource</span>(resource));<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="InputStreamSource"><a href="#InputStreamSource" class="headerlink" title="InputStreamSource"></a>InputStreamSource</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InputStreamSource</span> &#123;<br>	InputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="EncodedResource"><a href="#EncodedResource" class="headerlink" title="EncodedResource"></a>EncodedResource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 封装 编码</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncodedResource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InputStreamSource</span> &#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Resource resource;<br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String encoding;<br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Charset charset;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/* @see #getInputStream()</span><br><span class="hljs-comment"> * @see #getURL()</span><br><span class="hljs-comment"> * @see #getURI()</span><br><span class="hljs-comment"> * @see #getFile()</span><br><span class="hljs-comment"> * @see WritableResource</span><br><span class="hljs-comment"> * @see ContextResource</span><br><span class="hljs-comment"> * @see UrlResource</span><br><span class="hljs-comment"> * @see FileUrlResource</span><br><span class="hljs-comment"> * @see FileSystemResource</span><br><span class="hljs-comment"> * @see ClassPathResource</span><br><span class="hljs-comment"> * @see ByteArrayResource</span><br><span class="hljs-comment"> * @see InputStreamResource</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Resource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputStreamSource</span> &#123;<br> <br> &#125;<br></code></pre></td></tr></table></figure>



<h1 id="BeanDefinition加载"><a href="#BeanDefinition加载" class="headerlink" title="BeanDefinition加载"></a>BeanDefinition加载</h1><h1 id="配置类加载"><a href="#配置类加载" class="headerlink" title="配置类加载"></a>配置类加载</h1><p>配置类ConfigurationClass的BeanDefinition注册和解析</p>
<h2 id="流程：-1"><a href="#流程：-1" class="headerlink" title="流程："></a>流程：</h2><p>通过注解或者方法实现，创建配置类</p>
<p>0、ConfigurationClassPost  获取对应的 condidate(判断是否满足ConfigurationClass条件)的 BeanDefinition ，</p>
<p>1、调用 ConfigurationClassParse的parse()方法，将其解析 - 封装为ConfigurationClass对象，</p>
<p>2、调用ConfigurationClassBeanDefinitionReader的loadBeanDefinition()方法，将ConfigurationClass对象加载为BeanDefinition对象注册到BeanFactory中</p>
<p>ConfiguratonClass可以获取 BeanMethod（方法上有@Bean）注解</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>()<br>=&gt;<span class="hljs-title function_">refreshContext</span>(<span class="hljs-title class_">ConfigurableApplicationContext</span> context)<br>	=&gt; <span class="hljs-title class_">EmbeddedWebApplicationContext</span>.<span class="hljs-title function_">refresh</span>()<br>		=&gt; <span class="hljs-title class_">AbstractApplicationContext</span>.<span class="hljs-title function_">refresh</span>()<br>		=&gt;<span class="hljs-title function_">invokeBeanFactoryPostProcessors</span>()<br>			=&gt; <span class="hljs-title class_">PostProcessorRegistrationDelegate</span>.<span class="hljs-title function_">invokeBeanFactoryPostProcessors</span>()<br>				=&gt; <span class="hljs-title class_">ConfigurationClassPostProcessor</span>.<span class="hljs-title function_">processConfigBeanDefinitions</span>()<br>					=&gt; <span class="hljs-title class_">ConfigurationClassParse</span>.<span class="hljs-title function_">parse</span>()<br>					=&gt; <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span>.<span class="hljs-title function_">loadBeanDefinitions</span>()<br><br>调用<span class="hljs-title class_">ConfigurationClassPostProcessor</span>创世纪后置处理器的时候，肯定是先调用带注册功能的<span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>接口的postProcessBeanDefinitionRegistry方法对配置类的<span class="hljs-title class_">Bean</span>定义进行处理，然后再调用<span class="hljs-title class_">BeanFactoryPostProcessor</span>接口的postProcessBeanFactory方法进行注册；<br><br></code></pre></td></tr></table></figure>



<h2 id="PostProcessorRegistrationDelegate"><a href="#PostProcessorRegistrationDelegate" class="headerlink" title="PostProcessorRegistrationDelegate"></a>PostProcessorRegistrationDelegate</h2><p>invokeBeanFactoryPostProcessors () : </p>
<p>​	1、初始化 ConfigurationClasPostProcessor 类 并 调用 possProcessor()方法 - 用于解析配置类信息</p>
<p>​	2、 执行其他postProcessor()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostProcessorRegistrationDelegate</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;<br><br>		<span class="hljs-comment">// WARNING: Although it may appear that the body of this method can be easily</span><br>		<span class="hljs-comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span><br>		<span class="hljs-comment">// of multiple lists and multiple passes over the names of processors is</span><br>		<span class="hljs-comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span><br>		<span class="hljs-comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span><br>		<span class="hljs-comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span><br>		<span class="hljs-comment">// in the wrong order.</span><br>		<span class="hljs-comment">//</span><br>		<span class="hljs-comment">// Before submitting a pull request (PR) to change this method, please review the</span><br>		<span class="hljs-comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span><br>		<span class="hljs-comment">// to ensure that your proposal does not result in a breaking change:</span><br>		<span class="hljs-comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span><br><br>		<span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br>		Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><br>		<span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;<br>			List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>			List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>			<span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;<br>				<span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;<br>					registryProcessor.postProcessBeanDefinitionRegistry(registry);<br>					registryProcessors.add(registryProcessor);<br>				&#125;<br>				<span class="hljs-keyword">else</span> &#123;<br>					regularPostProcessors.add(postProcessor);<br>				&#125;<br>			&#125;<br><br>			<span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>			<span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br>			<span class="hljs-comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span><br>			<span class="hljs-comment">// PriorityOrdered, Ordered, and the rest.</span><br>			List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>			<span class="hljs-comment">// PriorityOrdered 实现该接口的  BeanDefinitionRegistryPostProcessors 优先级最高 限制性</span><br>			<span class="hljs-comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><br>			String[] postProcessorNames =<br>					beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>				<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>													<span class="hljs-comment">// getBean() 显示创建 ConfigurationClassPostProcessor实例</span><br>					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>					processedBeans.add(ppName);<br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">// 对 registerProcessor进行排序</span><br>			sortPostProcessors(currentRegistryProcessors, beanFactory);<br>			registryProcessors.addAll(currentRegistryProcessors);<br>			<span class="hljs-comment">// 优先调用postProcessBeanDefinitionRegistry</span><br>			<span class="hljs-comment">// 调用 registerProcessor的 postProcessBeanDefinitionRegistry()</span><br>			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>			currentRegistryProcessors.clear();<br><br>			<span class="hljs-comment">//</span><br>			<span class="hljs-comment">// Ordered 实现该接口的  BeanDefinitionRegistryPostProcessors 较后执行</span><br>			<span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br>			postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>				<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>												<span class="hljs-comment">// getBean() 根据AnnotatedBeanDefinitionReader注册的 BeanDefinition创建实列</span><br>					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>					processedBeans.add(ppName);<br>				&#125;<br>			&#125;<br>			sortPostProcessors(currentRegistryProcessors, beanFactory);<br>			registryProcessors.addAll(currentRegistryProcessors);<br>			<span class="hljs-comment">//</span><br>			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>			currentRegistryProcessors.clear();<br><br>			<span class="hljs-comment">// 最后执行 普通的BeanDefinitionRegistryPostProcessors</span><br>			<span class="hljs-comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><br>			<span class="hljs-type">boolean</span> <span class="hljs-variable">reiterate</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>			<span class="hljs-keyword">while</span> (reiterate) &#123;<br>				reiterate = <span class="hljs-literal">false</span>;<br>				postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>				<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>					<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;<br>						currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>						processedBeans.add(ppName);<br>						reiterate = <span class="hljs-literal">true</span>;<br>					&#125;<br>				&#125;<br>				sortPostProcessors(currentRegistryProcessors, beanFactory);<br>				registryProcessors.addAll(currentRegistryProcessors);<br>				invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>				currentRegistryProcessors.clear();<br>			&#125;<br><br>			<span class="hljs-comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><br>			invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);<br>			invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);<br>		&#125;<br><br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 执行容器的实例</span><br>			<span class="hljs-comment">// Invoke factory processors registered with the context instance.</span><br>			invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);<br>		&#125;<br><br>		<span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>		<span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br>		String[] postProcessorNames =<br>				beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><br>		<span class="hljs-comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><br>		<span class="hljs-comment">// Ordered, and the rest.</span><br>		List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>			<span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;<br>				<span class="hljs-comment">// skip - already processed in first phase above</span><br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>				priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));<br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>				orderedPostProcessorNames.add(ppName);<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				nonOrderedPostProcessorNames.add(ppName);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><br>		sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>		invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><br>		<span class="hljs-comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><br>		List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());<br>		<span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;<br>			orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>		&#125;<br>		sortPostProcessors(orderedPostProcessors, beanFactory);<br>		invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);<br><br>		<span class="hljs-comment">// Finally, invoke all other BeanFactoryPostProcessors.</span><br>		List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());<br>		<span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;<br>			nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>		&#125;<br>		invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);<br><br>		<span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span><br>		<span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span><br>		beanFactory.clearMetadataCache();<br>	&#125;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> &#123;<br><br>		<span class="hljs-comment">// WARNING: Although it may appear that the body of this method can be easily</span><br>		<span class="hljs-comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span><br>		<span class="hljs-comment">// of multiple lists and multiple passes over the names of processors is</span><br>		<span class="hljs-comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span><br>		<span class="hljs-comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span><br>		<span class="hljs-comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span><br>		<span class="hljs-comment">// in the wrong order.</span><br>		<span class="hljs-comment">//</span><br>		<span class="hljs-comment">// Before submitting a pull request (PR) to change this method, please review the</span><br>		<span class="hljs-comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span><br>		<span class="hljs-comment">// to ensure that your proposal does not result in a breaking change:</span><br>		<span class="hljs-comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span><br><br>		String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><br>		<span class="hljs-comment">// Register BeanPostProcessorChecker that logs an info message when</span><br>		<span class="hljs-comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span><br>		<span class="hljs-comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span><br>		<span class="hljs-type">int</span> <span class="hljs-variable">beanProcessorTargetCount</span> <span class="hljs-operator">=</span> beanFactory.getBeanPostProcessorCount() + <span class="hljs-number">1</span> + postProcessorNames.length;<br>		beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPostProcessorChecker</span>(beanFactory, beanProcessorTargetCount));<br><br>		<span class="hljs-comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span><br>		<span class="hljs-comment">// Ordered, and the rest.</span><br>		List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>			<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>				<span class="hljs-comment">// 实例化 BeanPostProcessor</span><br>				<span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>				priorityOrderedPostProcessors.add(pp);<br>				<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>					internalPostProcessors.add(pp);<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>				orderedPostProcessorNames.add(ppName);<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				nonOrderedPostProcessorNames.add(ppName);<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 分多个等级注册 PriorityOrdered， Ordered， regular(常规)， internal BeanPostProcessors</span><br><br>		<span class="hljs-comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span><br>		sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>		registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);<br><br>		<span class="hljs-comment">// Next, register the BeanPostProcessors that implement Ordered.</span><br>		List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());<br>		<span class="hljs-keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;<br>			<span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>			orderedPostProcessors.add(pp);<br>			<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>				internalPostProcessors.add(pp);<br>			&#125;<br>		&#125;<br>		sortPostProcessors(orderedPostProcessors, beanFactory);<br>		registerBeanPostProcessors(beanFactory, orderedPostProcessors);<br><br>		<span class="hljs-comment">// Now, register all regular BeanPostProcessors.</span><br>		List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());<br>		<span class="hljs-keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;<br>			<span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>			nonOrderedPostProcessors.add(pp);<br>			<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>				internalPostProcessors.add(pp);<br>			&#125;<br>		&#125;<br>		registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);<br><br>		<span class="hljs-comment">// Finally, re-register all internal BeanPostProcessors.</span><br>		sortPostProcessors(internalPostProcessors, beanFactory);<br>		registerBeanPostProcessors(beanFactory, internalPostProcessors);<br><br>		<span class="hljs-comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span><br>		<span class="hljs-comment">// moving it to the end of the processor chain (for picking up proxies etc).</span><br>		beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationListenerDetector</span>(applicationContext));<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="ConfigurationClassPostProcessor-1"><a href="#ConfigurationClassPostProcessor-1" class="headerlink" title="ConfigurationClassPostProcessor"></a>ConfigurationClassPostProcessor</h2><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230723172702175.png" srcset="/img/loading.gif" lazyload alt="image-20230723172702175"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 通过实现各种Aware接口获取解析所需要的属性</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>, PriorityOrdered, ResourceLoaderAware, BeanClassLoaderAware, EnvironmentAware &#123;<br>    <br>    <span class="hljs-comment">// 方法invokeBeanFactoryPostProcessors() ## postProcessBeanFactory()</span><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">factoryId</span> <span class="hljs-operator">=</span> System.identityHashCode(beanFactory);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.factoriesPostProcessed.contains(factoryId)) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>					<span class="hljs-string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> + beanFactory);<br>		&#125;<br>		<span class="hljs-built_in">this</span>.factoriesPostProcessed.add(factoryId);<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.registriesPostProcessed.contains(factoryId)) &#123;<br>			<span class="hljs-comment">// BeanDefinitionRegistryPostProcessor hook apparently not supported...</span><br>			<span class="hljs-comment">// Simply call processConfigurationClasses lazily at this point then.</span><br>			<span class="hljs-comment">// 调用创建 ConfigurationClass</span><br>			processConfigBeanDefinitions((BeanDefinitionRegistry) beanFactory);<br>		&#125;<br><br>		enhanceConfigurationClasses(beanFactory);<br>		beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ImportAwareBeanPostProcessor</span>(beanFactory));<br>	&#125;<br>    <br>    <span class="hljs-comment">// 配置类 信息（@Bean）解析为 BeanDefinition</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConfigBeanDefinitions</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>		List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>		<span class="hljs-comment">// 获取当前 上下文可能为 Configuration的beanName用于下面的解析操作</span><br>		<span class="hljs-comment">// 配置类信息 再 AnnotatedBeanDefinitionReader的 doRegister() 处进行beanDefinition注册</span><br>		<span class="hljs-comment">// 通过 ConfigurableListableBeanFactory --》 BeanDefinitionRegistry -》 获取candidateNames</span><br>        <span class="hljs-comment">// 获取已经注册的BeanName  === BeanDefinition在 obtainBeanFactory()的方法内</span><br>		<span class="hljs-comment">// 调用loadBeanDefinition() 方法进行注册</span><br>		String[] candidateNames = registry.getBeanDefinitionNames();<br><br>		<span class="hljs-keyword">for</span> (String beanName : candidateNames) &#123;<br>			<span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDef</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(beanName);<br>			<span class="hljs-keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>					logger.debug(<span class="hljs-string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);<br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">// 通过 ji</span><br>			<span class="hljs-comment">// ConfigurationClass</span><br>            <span class="hljs-comment">// Check whether the given bean definition is a candidate for a configuration class</span><br>			<span class="hljs-comment">// 检查是否满足 配置类候选者 条件</span><br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="hljs-built_in">this</span>.metadataReaderFactory)) &#123;<br>				configCandidates.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDef, beanName));<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// Return immediately if no @Configuration classes were found</span><br>		<span class="hljs-keyword">if</span> (configCandidates.isEmpty()) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-comment">// Sort by previously determined @Order value, if applicable</span><br>		configCandidates.sort((bd1, bd2) -&gt; &#123;<br>			<span class="hljs-type">int</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());<br>			<span class="hljs-type">int</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());<br>			<span class="hljs-keyword">return</span> Integer.compare(i1, i2);<br>		&#125;);<br><br>		<span class="hljs-comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span><br>		<span class="hljs-type">SingletonBeanRegistry</span> <span class="hljs-variable">sbr</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">if</span> (registry <span class="hljs-keyword">instanceof</span> SingletonBeanRegistry _sbr) &#123;<br>			sbr = _sbr;<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.localBeanNameGeneratorSet) &#123;<br>				<span class="hljs-type">BeanNameGenerator</span> <span class="hljs-variable">generator</span> <span class="hljs-operator">=</span> (BeanNameGenerator) sbr.getSingleton(<br>						AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);<br>				<span class="hljs-keyword">if</span> (generator != <span class="hljs-literal">null</span>) &#123;<br>					<span class="hljs-built_in">this</span>.componentScanBeanNameGenerator = generator;<br>					<span class="hljs-built_in">this</span>.importBeanNameGenerator = generator;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.environment == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-built_in">this</span>.environment = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEnvironment</span>();<br>		&#125;<br>		<span class="hljs-comment">// 初始化 ConfigurationClassParser</span><br>		<span class="hljs-comment">// Parse each @Configuration class -- 解析@Configuration注解的Class</span><br>		<span class="hljs-type">ConfigurationClassParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>(<br>				<span class="hljs-built_in">this</span>.metadataReaderFactory, <span class="hljs-built_in">this</span>.problemReporter, <span class="hljs-built_in">this</span>.environment,<br>				<span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.componentScanBeanNameGenerator, registry);<br><br>		Set&lt;BeanDefinitionHolder&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(configCandidates);<br>		Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(configCandidates.size());<br>		<span class="hljs-keyword">do</span> &#123;<br>			<span class="hljs-type">StartupStep</span> <span class="hljs-variable">processConfig</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.config-classes.parse&quot;</span>);<br>            <span class="hljs-comment">// 调用 parser.parse() </span><br>			parser.parse(candidates);<br>			parser.validate();<br><br>			Set&lt;ConfigurationClass&gt; configClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(parser.getConfigurationClasses());<br>			configClasses.removeAll(alreadyParsed);<br><br>			<span class="hljs-comment">// Read the model and create bean definitions based on its content</span><br>			<span class="hljs-comment">// 读取模式，并基于ConfigurationClass信息创建beanDefinition</span><br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.reader == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-comment">// 初始化 ConfigurationClassBeanDefinitionReader</span><br>				<span class="hljs-built_in">this</span>.reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span>(<br>						registry, <span class="hljs-built_in">this</span>.sourceExtractor, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.environment,<br>						<span class="hljs-built_in">this</span>.importBeanNameGenerator, parser.getImportRegistry());<br>			&#125;<br>            <span class="hljs-comment">// 调用reader.loadBeanDefinitions() </span><br>            <span class="hljs-comment">// 将configClasses注册为BeanDefinition</span><br>			<span class="hljs-comment">// 加载BeanDefinition -》</span><br>			<span class="hljs-built_in">this</span>.reader.loadBeanDefinitions(configClasses);<br>			alreadyParsed.addAll(configClasses);<br>			processConfig.tag(<span class="hljs-string">&quot;classCount&quot;</span>, () -&gt; String.valueOf(configClasses.size())).end();<br><br>			candidates.clear();<br>			<span class="hljs-keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;<br>				String[] newCandidateNames = registry.getBeanDefinitionNames();<br>				Set&lt;String&gt; oldCandidateNames = Set.of(candidateNames);<br>				Set&lt;String&gt; alreadyParsedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>				<span class="hljs-keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;<br>					alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());<br>				&#125;<br>				<span class="hljs-keyword">for</span> (String candidateName : newCandidateNames) &#123;<br>					<span class="hljs-keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;<br>						<span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(candidateName);<br>						<span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="hljs-built_in">this</span>.metadataReaderFactory) &amp;&amp;<br>								!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;<br>							candidates.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(bd, candidateName));<br>						&#125;<br>					&#125;<br>				&#125;<br>				candidateNames = newCandidateNames;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">while</span> (!candidates.isEmpty());<br><br>		<span class="hljs-comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span><br>		<span class="hljs-keyword">if</span> (sbr != <span class="hljs-literal">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;<br>			sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());<br>		&#125;<br><br>		<span class="hljs-comment">// Store the PropertySourceDescriptors to contribute them Ahead-of-time if necessary</span><br>		<span class="hljs-built_in">this</span>.propertySourceDescriptors = parser.getPropertySourceDescriptors();<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metadataReaderFactory <span class="hljs-keyword">instanceof</span> CachingMetadataReaderFactory cachingMetadataReaderFactory) &#123;<br>			<span class="hljs-comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span><br>			<span class="hljs-comment">// for a shared cache since it&#x27;ll be cleared by the ApplicationContext.</span><br>			cachingMetadataReaderFactory.clearCache();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230412112047479.png" srcset="/img/loading.gif" lazyload alt="image-20230412112047479"></p>
<h3 id="ConfigurationClassParser"><a href="#ConfigurationClassParser" class="headerlink" title="ConfigurationClassParser"></a>ConfigurationClassParser</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/niechen/p/9262452.html">深入理解Spring的ImportSelector接口 - 聂晨 - 博客园 (cnblogs.com)</a></p>
<p>解析@Configuration的Class</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> Component，ComponentScan，Import，ImportResource注解和Bean方法注解就是配置类<br><span class="hljs-regexp">//</span> 流程<br><span class="hljs-number">1</span>、component注解，会在Context初始化时，调用AnnotatedBeanDefinitionReader进行解析注册为BeanDefinition<br><span class="hljs-number">2</span>、再ConfigurationClassParser中进行 parse，即解析配置类信息，封装为 ConfigurationClass对象，<br><span class="hljs-number">3</span>、解析<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangwei19871103/article/details/104988954">(10条消息) Spring 5.x 源码之旅七ConfigurationClassParser解析配置类_王伟王胖胖的博客-CSDN博客</a></p>
<p><img src="https://img-blog.csdnimg.cn/20200320214625506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dhbmd3ZWkxOTg3MTEwMw==,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassParser</span> &#123;<br>    <span class="hljs-comment">// 解析ConfigurationBeanDefinition，即解析Configuratione的各种信息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> &#123;<br>		<span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : configCandidates) &#123;<br>			<span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> holder.getBeanDefinition();<br>			<span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">// 注解AnnotatedBeanDefinition</span><br>				<span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition annotatedBeanDef) &#123;<br>					parse(annotatedBeanDef.getMetadata(), holder.getBeanName());<br>				&#125; <span class="hljs-comment">// AbstractBeanDefinition</span><br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition abstractBeanDef &amp;&amp; abstractBeanDef.hasBeanClass()) &#123;<br>					parse(abstractBeanDef.getBeanClass(), holder.getBeanName());<br>				&#125;<br>				<span class="hljs-keyword">else</span> &#123;<br>					parse(bd.getBeanClassName(), holder.getBeanName());<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">//</span><br>		<span class="hljs-built_in">this</span>.deferredImportSelectorHandler.process();<br>	&#125;<br>    <br>    <span class="hljs-comment">// 通过 类路径获取 MetadataReader,创建ConfigurationClass</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String className, String beanName)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>		Assert.notNull(className, <span class="hljs-string">&quot;No bean class name for configuration class bean definition&quot;</span>);<br>		<span class="hljs-type">MetadataReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.metadataReaderFactory.getMetadataReader(className);<br>		processConfigurationClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClass</span>(reader, beanName), DEFAULT_EXCLUSION_FILTER);<br>	&#125;<br>	<span class="hljs-comment">// 通过Class对象直接创建 ConfigurationClass</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(Class&lt;?&gt; clazz, String beanName)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>		<span class="hljs-comment">// 创建 ConfigurationClass对象</span><br>		processConfigurationClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClass</span>(clazz, beanName), DEFAULT_EXCLUSION_FILTER);<br>	&#125;<br><br>	<span class="hljs-comment">// 通过注解信息 创建ConfigurationClass</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(AnnotationMetadata metadata, String beanName)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>		processConfigurationClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClass</span>(metadata, beanName), DEFAULT_EXCLUSION_FILTER);<br>	&#125;<br>    <br>    <span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SourceClass <span class="hljs-title function_">doProcessConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter)</span><br>			<span class="hljs-keyword">throws</span> IOException &#123;<br><br>		<span class="hljs-keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;<br>			<span class="hljs-comment">// Recursively process any member (nested) classes first</span><br>			processMemberClasses(configClass, sourceClass, filter);<br>		&#125;<br><br>		<span class="hljs-comment">// Process any @PropertySource annotations</span><br>		<span class="hljs-keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(<br>				sourceClass.getMetadata(), PropertySources.class,<br>				org.springframework.context.annotation.PropertySource.class)) &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.propertySourceRegistry != <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-built_in">this</span>.propertySourceRegistry.processPropertySource(propertySource);<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				logger.info(<span class="hljs-string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +<br>						<span class="hljs-string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// Process any @ComponentScan annotations</span><br>		Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(<br>				sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);<br>		<span class="hljs-keyword">if</span> (!componentScans.isEmpty() &amp;&amp;<br>				!<span class="hljs-built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;<br>			<span class="hljs-keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;<br>				<span class="hljs-comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span><br>				Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =<br>						<span class="hljs-built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());<br>				<span class="hljs-comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span><br>				<span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;<br>					<span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bdCand</span> <span class="hljs-operator">=</span> holder.getBeanDefinition().getOriginatingBeanDefinition();<br>					<span class="hljs-keyword">if</span> (bdCand == <span class="hljs-literal">null</span>) &#123;<br>						bdCand = holder.getBeanDefinition();<br>					&#125;<br>					<span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="hljs-built_in">this</span>.metadataReaderFactory)) &#123;<br>						parse(bdCand.getBeanClassName(), holder.getBeanName());<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 关键 -- 自动注入 -- 实现接口，方法调用</span><br>		<span class="hljs-comment">// Process any @Import annotations</span><br>		processImports(configClass, sourceClass, getImports(sourceClass), filter, <span class="hljs-literal">true</span>);<br><br>		<span class="hljs-comment">// Process any @ImportResource annotations</span><br>		<span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">importResource</span> <span class="hljs-operator">=</span><br>				AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);<br>		<span class="hljs-keyword">if</span> (importResource != <span class="hljs-literal">null</span>) &#123;<br>			String[] resources = importResource.getStringArray(<span class="hljs-string">&quot;locations&quot;</span>);<br>			Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanDefinitionReader</span>&gt; readerClass = importResource.getClass(<span class="hljs-string">&quot;reader&quot;</span>);<br>			<span class="hljs-keyword">for</span> (String resource : resources) &#123;<br>				<span class="hljs-type">String</span> <span class="hljs-variable">resolvedResource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.environment.resolveRequiredPlaceholders(resource);<br>				configClass.addImportedResource(resolvedResource, readerClass);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// Process individual @Bean methods</span><br>		Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);<br>		<span class="hljs-keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;<br>			configClass.addBeanMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanMethod</span>(methodMetadata, configClass));<br>		&#125;<br><br>		<span class="hljs-comment">// Process default methods on interfaces</span><br>		processInterfaces(configClass, sourceClass);<br><br>		<span class="hljs-comment">// Process superclass, if any</span><br>		<span class="hljs-keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">superclass</span> <span class="hljs-operator">=</span> sourceClass.getMetadata().getSuperClassName();<br>			<span class="hljs-keyword">if</span> (superclass != <span class="hljs-literal">null</span> &amp;&amp; !superclass.startsWith(<span class="hljs-string">&quot;java&quot;</span>) &amp;&amp;<br>					!<span class="hljs-built_in">this</span>.knownSuperclasses.containsKey(superclass)) &#123;<br>				<span class="hljs-built_in">this</span>.knownSuperclasses.put(superclass, configClass);<br>				<span class="hljs-comment">// Superclass found, return its annotation metadata and recurse</span><br>				<span class="hljs-keyword">return</span> sourceClass.getSuperClass();<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// No superclass -&gt; processing is complete</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br>    <br>    <span class="hljs-comment">// 递归解析 import的信息</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processImports</span><span class="hljs-params">(ConfigurationClass configClass, SourceClass currentSourceClass,</span><br><span class="hljs-params">			Collection&lt;SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter,</span><br><span class="hljs-params">			<span class="hljs-type">boolean</span> checkForCircularImports)</span> &#123;<br><br>		<span class="hljs-keyword">if</span> (importCandidates.isEmpty()) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (checkForCircularImports &amp;&amp; isChainedImportOnStack(configClass)) &#123;<br>			<span class="hljs-built_in">this</span>.problemReporter.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CircularImportProblem</span>(configClass, <span class="hljs-built_in">this</span>.importStack));<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-built_in">this</span>.importStack.push(configClass);<br>			<span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">//</span><br>				<span class="hljs-keyword">for</span> (SourceClass candidate : importCandidates) &#123;<br>					<span class="hljs-comment">// 配置类是一个 ImportSelector</span><br>					<span class="hljs-keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;<br>						<span class="hljs-comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br>						<span class="hljs-comment">// 委托 导入 Imports</span><br>						Class&lt;?&gt; candidateClass = candidate.loadClass();<br>						<span class="hljs-comment">// 实例化 当前的 ImportSelector接口实现类 ---autoConfiguraitonImportSelector就是在这实例化</span><br>						<span class="hljs-type">ImportSelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,<br>								<span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>						Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();<br>						<span class="hljs-comment">// 过滤</span><br>						<span class="hljs-keyword">if</span> (selectorFilter != <span class="hljs-literal">null</span>) &#123;<br>							exclusionFilter = exclusionFilter.or(selectorFilter);<br>						&#125; <span class="hljs-comment">/////如果为延迟导入处理则加入集合当中</span><br>						<span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> DeferredImportSelector deferredImportSelector) &#123;<br>							<span class="hljs-built_in">this</span>.deferredImportSelectorHandler.handle(configClass, deferredImportSelector);<br>						&#125;<br>						<span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// 调用selectImports方法，获取需要导入的 类的全路径信息</span><br>							String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());<br>							<span class="hljs-comment">// 封装</span><br>							Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames, exclusionFilter);<br>							<span class="hljs-comment">// 递归调用</span><br>							processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="hljs-literal">false</span>);<br>						&#125;<br>					&#125; <span class="hljs-comment">// ImportBeanDefinitionRegistrar接口 解析调用</span><br>					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;<br>						<span class="hljs-comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span><br>						<span class="hljs-comment">// delegate to it to register additional bean definitions</span><br>						Class&lt;?&gt; candidateClass = candidate.loadClass();<br>						<span class="hljs-type">ImportBeanDefinitionRegistrar</span> <span class="hljs-variable">registrar</span> <span class="hljs-operator">=</span><br>								ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class,<br>										<span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>						configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());<br>					&#125;<br>					<span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">// 如果都不是, 则认为是一个配置类，调用配置类解析方法解析</span><br>						<span class="hljs-comment">// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span><br>						<span class="hljs-comment">// process it as an @Configuration class</span><br>						<span class="hljs-comment">// 如果当前的类既不是ImportSelector也不是ImportBeanDefinitionRegistar就进行@Configuration的解析处理</span><br>						<span class="hljs-built_in">this</span>.importStack.registerImport(<br>								currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());<br>						<span class="hljs-comment">// 当作配置类进行处理</span><br>						processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter);<br>					&#125;<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br>						<span class="hljs-string">&quot;Failed to process import candidates for configuration class [&quot;</span> +<br>						configClass.getMetadata().getClassName() + <span class="hljs-string">&quot;]: &quot;</span> + ex.getMessage(), ex);<br>			&#125;<br>			<span class="hljs-keyword">finally</span> &#123;<br>				<span class="hljs-built_in">this</span>.importStack.pop();<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ImportResource"><a href="#ImportResource" class="headerlink" title="ImportResource"></a>ImportResource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*Indicates one or more resources containing bean definitions to import*/</span><br><span class="hljs-comment">// 导入 BeanDefinition资源</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ImportResource &#123;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Alias for &#123;<span class="hljs-doctag">@link</span> #locations&#125;.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@see</span> #locations</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@see</span> #reader</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@AliasFor(&quot;locations&quot;)</span><br>   String[] value() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Resource locations from which to import.</span><br><span class="hljs-comment">    * &lt;p&gt;Supports resource-loading prefixes such as &#123;<span class="hljs-doctag">@code</span> classpath:&#125;,</span><br><span class="hljs-comment">    * &#123;<span class="hljs-doctag">@code</span> file:&#125;, etc.</span><br><span class="hljs-comment">    * &lt;p&gt;Consult the Javadoc for &#123;<span class="hljs-doctag">@link</span> #reader&#125; for details on how resources</span><br><span class="hljs-comment">    * will be processed.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@since</span> 4.2</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@see</span> #value</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@see</span> #reader</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@AliasFor(&quot;value&quot;)</span><br>   String[] locations() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * &#123;<span class="hljs-doctag">@link</span> BeanDefinitionReader&#125; implementation to use when processing</span><br><span class="hljs-comment">    * resources specified via the &#123;<span class="hljs-doctag">@link</span> #value&#125; attribute.</span><br><span class="hljs-comment">    * &lt;p&gt;By default, the reader will be adapted to the resource path specified:</span><br><span class="hljs-comment">    * &#123;<span class="hljs-doctag">@code</span> &quot;.groovy&quot;&#125; files will be processed with a</span><br><span class="hljs-comment">    * &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.groovy.GroovyBeanDefinitionReader GroovyBeanDefinitionReader&#125;;</span><br><span class="hljs-comment">    * whereas, all other resources will be processed with an</span><br><span class="hljs-comment">    * &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.xml.XmlBeanDefinitionReader XmlBeanDefinitionReader&#125;.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@see</span> #value</span><br><span class="hljs-comment">    */</span><br>   Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanDefinitionReader</span>&gt; reader() <span class="hljs-keyword">default</span> BeanDefinitionReader.class;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ImportSelector"><a href="#ImportSelector" class="headerlink" title="ImportSelector"></a>ImportSelector</h4><p>获取需要导入的 BeanDefinition全路径信息，当作 ConfigurationClass来解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>	String[] selectImports(AnnotationMetadata importingClassMetadata);<br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">default</span> Predicate&lt;String&gt; <span class="hljs-title function_">getExclusionFilter</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ImportRegistry"><a href="#ImportRegistry" class="headerlink" title="ImportRegistry"></a>ImportRegistry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportRegistry</span> &#123;<br><br>   <span class="hljs-meta">@Nullable</span><br>   AnnotationMetadata <span class="hljs-title function_">getImportingClassFor</span><span class="hljs-params">(String importedClass)</span>;<br><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeImportingClass</span><span class="hljs-params">(String importingClass)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ConfigurationClass"><a href="#ConfigurationClass" class="headerlink" title="ConfigurationClass"></a>ConfigurationClass</h3><p>配置类的信息封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClass</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotationMetadata metadata;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Resource resource;<br><br>   <span class="hljs-meta">@Nullable</span><br>   <span class="hljs-keyword">private</span> String beanName;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;ConfigurationClass&gt; importedBy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-number">1</span>);<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;BeanMethod&gt; beanMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanDefinitionReader</span>&gt;&gt; importedResources =<br>         <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; importBeanDefinitionRegistrars =<br>         <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br><br>   <span class="hljs-keyword">final</span> Set&lt;String&gt; skippedBeanMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="ConfigurationClassBeanDefinitionReader-1"><a href="#ConfigurationClassBeanDefinitionReader-1" class="headerlink" title="ConfigurationClassBeanDefinitionReader"></a>ConfigurationClassBeanDefinitionReader</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">读取一组已经被完整解析的配置类ConfigurationClass，向给定bean容器BeanDefinitionRegistry注册其中所有的bean定义。<br><br>该内部工具由Spring BeanDefinitionRegistryPostProcessor ConfigurationClassParser使用。在容器启动过程中， ConfigurationClassParser会在BeanDefinitionRegistryPostProcessor 应用阶段被调用，用于发现应用中所有的配置类ConfigurationClass,然后交给ConfigurationClassBeanDefinitionReader将这些配置类中的bean定义注册到容器<br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SpringApplication</span>.</span></span>run<span class="hljs-literal">()</span><br>=&gt;refresh<span class="hljs-constructor">Context(ConfigurableApplicationContext <span class="hljs-params">context</span>)</span><br>	=&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EmbeddedWebApplicationContext</span>.</span></span>refresh<span class="hljs-literal">()</span><br>		=&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AbstractApplicationContext</span>.</span></span>refresh<span class="hljs-literal">()</span><br>		=&gt;invoke<span class="hljs-constructor">BeanFactoryPostProcessors()</span><br>			=&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PostProcessorRegistrationDelegate</span>.</span></span>invoke<span class="hljs-constructor">BeanFactoryPostProcessors()</span><br>				=&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigurationClassPostProcessor</span>.</span></span>process<span class="hljs-constructor">ConfigBeanDefinitions()</span><br>				<span class="hljs-comment">// 加载 ConfiguraitonClass 为 BeanDefinition</span><br>					=&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConfigurationClassBeanDefinitionReader</span>.</span></span>load<span class="hljs-constructor">BeanDefinitions()</span><br><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(ConfigurationClassBeanDefinitionReader.class);<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScopeMetadataResolver</span> <span class="hljs-variable">scopeMetadataResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationScopeMetadataResolver</span>();<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanDefinitionRegistry registry;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SourceExtractor sourceExtractor;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Environment environment;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanNameGenerator importBeanNameGenerator;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ImportRegistry importRegistry;<br>	<span class="hljs-comment">// 对@Conditional注解求值的工具类</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConditionEvaluator conditionEvaluator;<br>    <br>    <span class="hljs-comment">// 读取一组已经被完整解析的配置类ConfigurationClass，向给定bean容器BeanDefinitionRegistry注册其中所有的bean定义。</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Set&lt;ConfigurationClass&gt; configurationModel)</span> &#123;<br>		<span class="hljs-type">TrackedConditionEvaluator</span> <span class="hljs-variable">trackedConditionEvaluator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrackedConditionEvaluator</span>();<br>		<span class="hljs-comment">// 遍历当前 ConfigurationClass</span><br>		<span class="hljs-keyword">for</span> (ConfigurationClass configClass : configurationModel) &#123;<br>			loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Read a particular &#123;<span class="hljs-doctag">@link</span> ConfigurationClass&#125;, registering bean definitions</span><br><span class="hljs-comment">	 * for the class itself and all of its &#123;<span class="hljs-doctag">@link</span> Bean&#125; methods.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsForConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">			ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator)</span> &#123;<br><br>		<span class="hljs-comment">// 如果 条件Condition判断 应当跳过当前配置类，则从当前registry中移除 BeanDefinition信息</span><br>		<span class="hljs-keyword">if</span> (trackedConditionEvaluator.shouldSkip(configClass)) &#123;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> configClass.getBeanName();<br>			<span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-built_in">this</span>.registry.containsBeanDefinition(beanName)) &#123;<br>				<span class="hljs-built_in">this</span>.registry.removeBeanDefinition(beanName);<br>			&#125;<br>			<span class="hljs-built_in">this</span>.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (configClass.isImported()) &#123;<br>			<span class="hljs-comment">// 如果已经导入，</span><br>			registerBeanDefinitionForImportedConfigurationClass(configClass);<br>		&#125;<br>		<span class="hljs-comment">// 遍历configClass的 BeanMethod （@Bean注解信息），加载为BeanDefinition</span><br>		<span class="hljs-keyword">for</span> (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;<br>			loadBeanDefinitionsForBeanMethod(beanMethod);<br>		&#125;<br>		<span class="hljs-comment">// 参数：Map&lt;String, Class&lt;? extends BeanDefinitionReader&gt;&gt;</span><br>        <span class="hljs-comment">// ImportResource 的 ConfigClass</span><br>		loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());<br>		<span class="hljs-comment">// 参数：Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt;</span><br>        <span class="hljs-comment">// ImportBeanDefinitionRegistrars 的 ConfigClass</span><br>		loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="AdviceModeImportSelector"><a href="#AdviceModeImportSelector" class="headerlink" title="AdviceModeImportSelector"></a>AdviceModeImportSelector</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdviceModeImportSelector</span>&lt;A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * The default advice mode attribute name.</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_ADVICE_MODE_ATTRIBUTE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mode&quot;</span>;<br>    <span class="hljs-comment">// 根据 AdviceModle返回需要Import的类的全限定名</span><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String[] selectImports(AdviceMode adviceMode);<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfigurationSelector</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AdviceModeImportSelector</span>&lt;EnableAsync&gt; &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.scheduling.aspectj.AspectJAsyncConfiguration&quot;</span>;<br><br>        <span class="hljs-keyword">public</span> String[] selectImports(AdviceMode adviceMode) &#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> (adviceMode) &#123;<br>              <span class="hljs-keyword">case</span> PROXY -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;ProxyAsyncConfiguration.class.getName()&#125;;<br>              <span class="hljs-keyword">case</span> ASPECTJ -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME&#125;;<br>           &#125;;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230410152227214.png" srcset="/img/loading.gif" lazyload alt="image-20230410152227214"></p>
<h1 id="Transaction模块"><a href="#Transaction模块" class="headerlink" title="Transaction模块"></a>Transaction模块</h1><p>BeanDefinition</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.transaction;<br><br><span class="hljs-keyword">import</span> org.springframework.lang.Nullable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Interface that defines Spring-compliant transaction properties.</span><br><span class="hljs-comment"> * Based on the propagation behavior definitions analogous to EJB CMT attributes.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Note that isolation level and timeout settings will not get applied unless</span><br><span class="hljs-comment"> * an actual new transaction gets started. As only &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRES_NEW&#125;, and &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_NESTED&#125; can cause</span><br><span class="hljs-comment"> * that, it usually doesn&#x27;t make sense to specify those settings in other cases.</span><br><span class="hljs-comment"> * Furthermore, be aware that not all transaction managers will support those</span><br><span class="hljs-comment"> * advanced features and thus might throw corresponding exceptions when given</span><br><span class="hljs-comment"> * non-default values.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;The &#123;<span class="hljs-doctag">@linkplain</span> #isReadOnly() read-only flag&#125; applies to any transaction context,</span><br><span class="hljs-comment"> * whether backed by an actual resource transaction or operating non-transactionally</span><br><span class="hljs-comment"> * at the resource level. In the latter case, the flag will only apply to managed</span><br><span class="hljs-comment"> * resources within the application, such as a Hibernate &#123;<span class="hljs-doctag">@code</span> Session&#125;.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> PlatformTransactionManager#getTransaction(TransactionDefinition)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.DefaultTransactionDefinition</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TransactionDefinition</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction; create a new one if none exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;This is typically the default setting of a transaction definition</span><br><span class="hljs-comment">	 * and typically defines a transaction synchronization scope.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_REQUIRED</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction; execute non-transactionally if none exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; For transaction managers with transaction synchronization,</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> PROPAGATION_SUPPORTS&#125; is slightly different from no transaction</span><br><span class="hljs-comment">	 * at all, as it defines a transaction scope that synchronization might apply to.</span><br><span class="hljs-comment">	 * As a consequence, the same resources (a JDBC &#123;<span class="hljs-doctag">@code</span> Connection&#125;, a</span><br><span class="hljs-comment">	 * Hibernate &#123;<span class="hljs-doctag">@code</span> Session&#125;, etc) will be shared for the entire specified</span><br><span class="hljs-comment">	 * scope. Note that the exact behavior depends on the actual synchronization</span><br><span class="hljs-comment">	 * configuration of the transaction manager.</span><br><span class="hljs-comment">	 * &lt;p&gt;In general, use &#123;<span class="hljs-doctag">@code</span> PROPAGATION_SUPPORTS&#125; with care. In particular, do</span><br><span class="hljs-comment">	 * not rely on &#123;<span class="hljs-doctag">@code</span> PROPAGATION_REQUIRED&#125; or &#123;<span class="hljs-doctag">@code</span> PROPAGATION_REQUIRES_NEW&#125;</span><br><span class="hljs-comment">	 * &lt;i&gt;within&lt;/i&gt; a &#123;<span class="hljs-doctag">@code</span> PROPAGATION_SUPPORTS&#125; scope (which may lead to</span><br><span class="hljs-comment">	 * synchronization conflicts at runtime). If such nesting is unavoidable, make sure</span><br><span class="hljs-comment">	 * to configure your transaction manager appropriately (typically switching to</span><br><span class="hljs-comment">	 * &quot;synchronization on actual transaction&quot;).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#setTransactionSynchronization</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#SYNCHRONIZATION_ON_ACTUAL_TRANSACTION</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_SUPPORTS</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction; throw an exception if no current transaction</span><br><span class="hljs-comment">	 * exists. Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that transaction synchronization within a &#123;<span class="hljs-doctag">@code</span> PROPAGATION_MANDATORY&#125;</span><br><span class="hljs-comment">	 * scope will always be driven by the surrounding transaction.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_MANDATORY</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create a new transaction, suspending the current transaction if one exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual transaction suspension will not work out-of-the-box</span><br><span class="hljs-comment">	 * on all transaction managers. This in particular applies to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.jta.JtaTransactionManager&#125;,</span><br><span class="hljs-comment">	 * which requires the &#123;<span class="hljs-doctag">@code</span> jakarta.transaction.TransactionManager&#125; to be</span><br><span class="hljs-comment">	 * made available to it (which is server-specific in standard Jakarta EE).</span><br><span class="hljs-comment">	 * &lt;p&gt;A &#123;<span class="hljs-doctag">@code</span> PROPAGATION_REQUIRES_NEW&#125; scope always defines its own</span><br><span class="hljs-comment">	 * transaction synchronizations. Existing synchronizations will be suspended</span><br><span class="hljs-comment">	 * and resumed appropriately.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_REQUIRES_NEW</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Do not support a current transaction; rather always execute non-transactionally.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual transaction suspension will not work out-of-the-box</span><br><span class="hljs-comment">	 * on all transaction managers. This in particular applies to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.jta.JtaTransactionManager&#125;,</span><br><span class="hljs-comment">	 * which requires the &#123;<span class="hljs-doctag">@code</span> jakarta.transaction.TransactionManager&#125; to be</span><br><span class="hljs-comment">	 * made available to it (which is server-specific in standard Jakarta EE).</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that transaction synchronization is &lt;i&gt;not&lt;/i&gt; available within a</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> PROPAGATION_NOT_SUPPORTED&#125; scope. Existing synchronizations</span><br><span class="hljs-comment">	 * will be suspended and resumed appropriately.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_NOT_SUPPORTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Do not support a current transaction; throw an exception if a current transaction</span><br><span class="hljs-comment">	 * exists. Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that transaction synchronization is &lt;i&gt;not&lt;/i&gt; available within a</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> PROPAGATION_NEVER&#125; scope.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_NEVER</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br><br>	<span class="hljs-comment">// 嵌套</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_NESTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br><br>	<span class="hljs-comment">// 隔离级别</span><br>    <span class="hljs-comment">/* 数据库默认隔离级别 -- 根据 java.sql.Connection*/</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_DEFAULT</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_READ_UNCOMMITTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_READ_UNCOMMITTED;</span><br><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_READ_COMMITTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_READ_COMMITTED;</span><br><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_REPEATABLE_READ</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_REPEATABLE_READ;</span><br><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_SERIALIZABLE</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_SERIALIZABLE;</span><br><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Use the default timeout of the underlying transaction system,</span><br><span class="hljs-comment">	 * or none if timeouts are not supported.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">TIMEOUT_DEFAULT</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return the propagation behavior.</span><br><span class="hljs-comment">	 * &lt;p&gt;Must return one of the &#123;<span class="hljs-doctag">@code</span> PROPAGATION_XXX&#125; constants</span><br><span class="hljs-comment">	 * defined on &#123;<span class="hljs-doctag">@link</span> TransactionDefinition this interface&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;The default is &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the propagation behavior</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #PROPAGATION_REQUIRED</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.TransactionSynchronizationManager#isActualTransactionActive()</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">default</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPropagationBehavior</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> PROPAGATION_REQUIRED;<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return the isolation level.</span><br><span class="hljs-comment">	 * &lt;p&gt;Must return one of the &#123;<span class="hljs-doctag">@code</span> ISOLATION_XXX&#125; constants defined on</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> TransactionDefinition this interface&#125;. Those constants are designed</span><br><span class="hljs-comment">	 * to match the values of the same constants on &#123;<span class="hljs-doctag">@link</span> java.sql.Connection&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;Exclusively designed for use with &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRES_NEW&#125; since it only applies to newly started</span><br><span class="hljs-comment">	 * transactions. Consider switching the &quot;validateExistingTransactions&quot; flag to</span><br><span class="hljs-comment">	 * &quot;true&quot; on your transaction manager if you&#x27;d like isolation level declarations</span><br><span class="hljs-comment">	 * to get rejected when participating in an existing transaction with a different</span><br><span class="hljs-comment">	 * isolation level.</span><br><span class="hljs-comment">	 * &lt;p&gt;The default is &#123;<span class="hljs-doctag">@link</span> #ISOLATION_DEFAULT&#125;. Note that a transaction manager</span><br><span class="hljs-comment">	 * that does not support custom isolation levels will throw an exception when</span><br><span class="hljs-comment">	 * given any other level than &#123;<span class="hljs-doctag">@link</span> #ISOLATION_DEFAULT&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the isolation level</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #ISOLATION_DEFAULT</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#setValidateExistingTransaction</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">default</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIsolationLevel</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> ISOLATION_DEFAULT;<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return the transaction timeout.</span><br><span class="hljs-comment">	 * &lt;p&gt;Must return a number of seconds, or &#123;<span class="hljs-doctag">@link</span> #TIMEOUT_DEFAULT&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;Exclusively designed for use with &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRES_NEW&#125; since it only applies to newly started</span><br><span class="hljs-comment">	 * transactions.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that a transaction manager that does not support timeouts will throw</span><br><span class="hljs-comment">	 * an exception when given any other timeout than &#123;<span class="hljs-doctag">@link</span> #TIMEOUT_DEFAULT&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;The default is &#123;<span class="hljs-doctag">@link</span> #TIMEOUT_DEFAULT&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the transaction timeout</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">default</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTimeout</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> TIMEOUT_DEFAULT;<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return whether to optimize as a read-only transaction.</span><br><span class="hljs-comment">	 * &lt;p&gt;The read-only flag applies to any transaction context, whether backed</span><br><span class="hljs-comment">	 * by an actual resource transaction (&#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125;/</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRES_NEW&#125;) or operating non-transactionally at</span><br><span class="hljs-comment">	 * the resource level (&#123;<span class="hljs-doctag">@link</span> #PROPAGATION_SUPPORTS&#125;). In the latter case,</span><br><span class="hljs-comment">	 * the flag will only apply to managed resources within the application,</span><br><span class="hljs-comment">	 * such as a Hibernate &#123;<span class="hljs-doctag">@code</span> Session&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;This just serves as a hint for the actual transaction subsystem;</span><br><span class="hljs-comment">	 * it will &lt;i&gt;not necessarily&lt;/i&gt; cause failure of write access attempts.</span><br><span class="hljs-comment">	 * A transaction manager which cannot interpret the read-only hint will</span><br><span class="hljs-comment">	 * &lt;i&gt;not&lt;/i&gt; throw an exception when asked for a read-only transaction.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if the transaction is to be optimized as read-only</span><br><span class="hljs-comment">	 * (&#123;<span class="hljs-doctag">@code</span> false&#125; by default)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.TransactionSynchronization#beforeCommit(boolean)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.TransactionSynchronizationManager#isCurrentTransactionReadOnly()</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReadOnly</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return the name of this transaction. Can be &#123;<span class="hljs-doctag">@code</span> null&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;This will be used as the transaction name to be shown in a</span><br><span class="hljs-comment">	 * transaction monitor, if applicable (for example, WebLogic&#x27;s).</span><br><span class="hljs-comment">	 * &lt;p&gt;In case of Spring&#x27;s declarative transactions, the exposed name will be</span><br><span class="hljs-comment">	 * the &#123;<span class="hljs-doctag">@code</span> fully-qualified class name + &quot;.&quot; + method name&#125; (by default).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the name of this transaction (&#123;<span class="hljs-doctag">@code</span> null&#125; by default&#125;</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAspectSupport</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.TransactionSynchronizationManager#getCurrentTransactionName()</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">default</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br><br><br>	<span class="hljs-comment">// Static builder methods</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return an unmodifiable &#123;<span class="hljs-doctag">@code</span> TransactionDefinition&#125; with defaults.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">static</span> TransactionDefinition <span class="hljs-title function_">withDefaults</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> StaticTransactionDefinition.INSTANCE;<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// since spring 5.2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PlatformTransactionManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TransactionManager</span> &#123;<br>    TransactionStatus <span class="hljs-title function_">getTransaction</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> TransactionDefinition var1)</span> <span class="hljs-keyword">throws</span> TransactionException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(TransactionStatus var1)</span> <span class="hljs-keyword">throws</span> TransactionException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(TransactionStatus var1)</span> <span class="hljs-keyword">throws</span> TransactionException;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230410171445188.png" srcset="/img/loading.gif" lazyload alt="image-20230410171445188"></p>
<h1 id="Aware"><a href="#Aware" class="headerlink" title="Aware"></a>Aware</h1><p>通过实现Aware接口，可以在对应的资源创建后，获取到对应的资源</p>
<p>例如：</p>
<h3 id="BeanFactoryAware"><a href="#BeanFactoryAware" class="headerlink" title="BeanFactoryAware"></a>BeanFactoryAware</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactoryAware</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Aware</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanFactory</span><span class="hljs-params">(BeanFactory var1)</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406233747409.png" srcset="/img/loading.gif" lazyload alt="image-20230406233747409"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">Aware (org.springframework.beans.factory)<br>    <span class="hljs-comment">// </span><br>ApplicationEventPublisherAware (org.springframework.context)<br>    <span class="hljs-comment">// </span><br>ServletContextAware (org.springframework.web.context)<br>    <span class="hljs-comment">// </span><br>MessageSourceAware (org.springframework.context)<br>ResourceLoaderAware (org.springframework.context)<br>NotificationPublisherAware (org.springframework.jmx.export.notification)<br>EnvironmentAware (org.springframework.context)<br>BeanFactoryAware (org.springframework.beans.factory)<br>EmbeddedValueResolverAware (org.springframework.context)<br>ImportAware (org.springframework.context.annotation)<br>ServletConfigAware (org.springframework.web.context)<br>LoadTimeWeaverAware (org.springframework.context.weaving)<br>BeanNameAware (org.springframework.beans.factory)<br>BeanClassLoaderAware (org.springframework.beans.factory)<br>ApplicationContextAware (org.springframework.context)<br></code></pre></td></tr></table></figure>

<h1 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h1><p>AbstractApplicationContext的使用s</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br>	<span class="hljs-comment">// 广播器</span><br>    <span class="hljs-keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;<br>    <span class="hljs-comment">// 监听者</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;ApplicationListener&lt;?&gt;&gt; applicationListeners;<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">private</span> Set&lt;ApplicationListener&lt;?&gt;&gt; earlyApplicationListeners;<br>    <span class="hljs-comment">// 监听事件</span><br>    <span class="hljs-keyword">private</span> Set&lt;ApplicationEvent&gt; earlyApplicationEvents;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="ApplicationEventMulticaster"><a href="#ApplicationEventMulticaster" class="headerlink" title="ApplicationEventMulticaster"></a>ApplicationEventMulticaster</h2><p>管理EventListener和Event，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationEventMulticaster</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addApplicationListener</span><span class="hljs-params">(ApplicationListener&lt;?&gt; var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addApplicationListenerBean</span><span class="hljs-params">(String var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeApplicationListener</span><span class="hljs-params">(ApplicationListener&lt;?&gt; var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeApplicationListenerBean</span><span class="hljs-params">(String var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAllListeners</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">multicastEvent</span><span class="hljs-params">(ApplicationEvent var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">multicastEvent</span><span class="hljs-params">(ApplicationEvent var1, <span class="hljs-meta">@Nullable</span> ResolvableType var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="EventListener"><a href="#EventListener" class="headerlink" title="EventListener"></a>EventListener</h2><p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406234800354.png" srcset="/img/loading.gif" lazyload alt="image-20230406234800354"></p>
<p>ApplicationListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationListener</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EventListener</span> &#123;<br>    <span class="hljs-comment">// 绑定监听事件</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(E var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="SpringApplicationRunListener"><a href="#SpringApplicationRunListener" class="headerlink" title="SpringApplicationRunListener"></a>SpringApplicationRunListener</h3><p>事件发布，通过事件接口，能够收到消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SpringApplicationRunListener</span> &#123;<br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">starting</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">environmentPrepared</span><span class="hljs-params">(ConfigurableEnvironment environment)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextPrepared</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoaded</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">started</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">running</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">failed</span><span class="hljs-params">(ConfigurableApplicationContext context, Throwable exception)</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="EventObject"><a href="#EventObject" class="headerlink" title="EventObject"></a>EventObject</h2><p>定义事件</p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406235010626.png" srcset="/img/loading.gif" lazyload alt="image-20230406235010626"></p>
<h3 id="SpringApplicationEvent"><a href="#SpringApplicationEvent" class="headerlink" title="SpringApplicationEvent"></a>SpringApplicationEvent</h3><p>事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringApplicationEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] args;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SpringApplicationEvent</span><span class="hljs-params">(SpringApplication application, String[] args)</span> &#123;<br>        <span class="hljs-built_in">super</span>(application);<br>        <span class="hljs-built_in">this</span>.args = args;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> SpringApplication <span class="hljs-title function_">getSpringApplication</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (SpringApplication)<span class="hljs-built_in">this</span>.getSource();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String[] getArgs() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.args;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230406234346965.png" srcset="/img/loading.gif" lazyload alt="image-20230406234346965"></p>
<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><p>元注解</p>
<p>@Target</p>
<p>@Retention</p>
<p>Spring注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Lookup;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-meta">@Qualifier</span><br><span class="hljs-meta">@Value(&quot;&quot;)</span><br><br><span class="hljs-comment">// CommonAnnotationBeanPostProssor</span><br><span class="hljs-comment">// Method  用于 一个单例bean需要和一个非单例bean组合使用或者一个非单例bean和另一个非单例bean组合使用时创建原型对象 -- 而不是单例对象</span><br><span class="hljs-meta">@Lookup</span><br>对于<span class="hljs-meta">@Lookup</span>修饰的方法，有相对应的标准<br>&lt;<span class="hljs-keyword">public</span>|<span class="hljs-keyword">protected</span>&gt; [<span class="hljs-keyword">abstract</span>] &lt;<span class="hljs-keyword">return</span>-type&gt; theMethodName(no-arguments);<br><br><span class="hljs-meta">@Resource</span><br></code></pre></td></tr></table></figure>







<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.cache.annotation.Cacheable;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.Caching;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-meta">@Caching</span><br><span class="hljs-meta">@Cacheable</span><br></code></pre></td></tr></table></figure>



<h2 id="Scheduling-调度注解"><a href="#Scheduling-调度注解" class="headerlink" title="Scheduling - 调度注解"></a>Scheduling - 调度注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.*<br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-meta">@Scheduled</span><br><span class="hljs-meta">@Schedules()</span><br><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-meta">@Async</span><br></code></pre></td></tr></table></figure>



<h2 id="stereotype-定型注解"><a href="#stereotype-定型注解" class="headerlink" title="stereotype - 定型注解"></a>stereotype - 定型注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.stereotype.*;<br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@Indexed</span><br><span class="hljs-meta">@Repository</span><br><span class="hljs-meta">@Service</span><br></code></pre></td></tr></table></figure>



<h2 id="Context-上下文注解"><a href="#Context-上下文注解" class="headerlink" title="Context - 上下文注解"></a>Context - 上下文注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.context.annotation<br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ComponentScan</span><br><span class="hljs-meta">@ComponentScans(value = &#123;&#125;)</span><br><span class="hljs-meta">@Conditional(value = Condition.class)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@DependsOn</span><br><span class="hljs-meta">@EnableAspectJAutoProxy</span><br><span class="hljs-meta">@EnableLoadTimeWeaving</span><br><span class="hljs-meta">@EnableMBeanExport</span><br><span class="hljs-meta">@Import(value = Test1.class)</span><br><span class="hljs-meta">@Lazy</span><br><span class="hljs-meta">@Primary</span><br><span class="hljs-meta">@PropertySource(value = &quot;&quot;)</span><br><span class="hljs-meta">@PropertySources(value = &#123;&#125;)</span><br><span class="hljs-meta">@Profile(value = &#123;&#125;)</span><br><span class="hljs-meta">@Role(value = 1)</span><br><span class="hljs-meta">@Scope</span><br></code></pre></td></tr></table></figure>



<h2 id="Autowired-自动注入注解"><a href="#Autowired-自动注入注解" class="headerlink" title="Autowired - 自动注入注解"></a>Autowired - 自动注入注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.*;<br><span class="hljs-meta">@AutoConfigurationPackage</span><br><span class="hljs-meta">@AutoConfigureAfter</span><br><span class="hljs-meta">@AutoConfigureBefore</span><br><span class="hljs-meta">@AutoConfigureOrder</span><br><span class="hljs-meta">@EnableAutoConfiguration</span><br><span class="hljs-meta">@ImportAutoConfiguration</span><br><span class="hljs-meta">@SpringBootApplication</span><br></code></pre></td></tr></table></figure>



<h2 id="Properties-配置注解"><a href="#Properties-配置注解" class="headerlink" title="Properties 配置注解"></a>Properties 配置注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.*;<br><span class="hljs-meta">@ConfigurationProperties</span><br><span class="hljs-meta">@ConfigurationPropertiesBinding</span><br><span class="hljs-meta">@ConfigurationPropertiesScan</span><br><span class="hljs-meta">@ConstructorBinding</span><br><span class="hljs-meta">@DeprecatedConfigurationProperty</span><br><span class="hljs-meta">@EnableConfigurationProperties</span><br><span class="hljs-meta">@NestedConfigurationProperty</span><br></code></pre></td></tr></table></figure>





<h1 id="SPI-接口Service-Provider-Interface"><a href="#SPI-接口Service-Provider-Interface" class="headerlink" title="SPI 接口	Service Provider Interface"></a>SPI 接口	Service Provider Interface</h1><h2 id="ApplicationContextInitializer-1"><a href="#ApplicationContextInitializer-1" class="headerlink" title="ApplicationContextInitializer"></a>ApplicationContextInitializer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationContextInitializer</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConfigurableApplicationContext</span>&gt; &#123;<br>    <span class="hljs-comment">// 实现接口进行初始化，再SpringApplication中设置属性</span><br>    <span class="hljs-comment">// 在SpringApplication##run() ### prepareContext()方法中调用</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(C var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="拓展点"><a href="#拓展点" class="headerlink" title="拓展点"></a>拓展点</h2><p>1、 AbstractApplicationContext ##  prepareRefresh() ## initPropertySources()</p>
<p>2、</p>
<h2 id="SPI-文件"><a href="#SPI-文件" class="headerlink" title="SPI 文件"></a>SPI 文件</h2><p>spring.factory：可以通过SpringFactoryLoader通过类的全路径进行加载注入</p>
<p>spring.provides： 能够引入填写依赖</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs txt">provides: spring-security-web,spring-security-config<br></code></pre></td></tr></table></figure>



<p>META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-string">``</span><span class="hljs-string">`</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"># 初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">启动时实例化类 - SingletonObjects</span><br><span class="hljs-string"></span><br><span class="hljs-string">`</span><span class="hljs-string">``</span>json<br> <span class="hljs-comment">// Initializer接口</span><br><span class="hljs-string">&quot;org.springframework.boot.context.ContextIdApplicationContextInitializer$ContextId&quot;</span> -&gt; &#123;ContextIdApplicationContextInitializer$ContextId@1992&#125; <br><span class="hljs-string">&quot;autoConfigurationReport&quot;</span> -&gt; &#123;ConditionEvaluationReport@2549&#125; <br><span class="hljs-comment">// 封装Argument</span><br><span class="hljs-string">&quot;springApplicationArguments&quot;</span> -&gt; &#123;DefaultApplicationArguments@2399&#125;<br><span class="hljs-string">&quot;springBootLoggingSystem&quot;</span> -&gt; &#123;LogbackLoggingSystem@2652&#125; <br><span class="hljs-comment">// Banner打印</span><br><span class="hljs-string">&quot;springBootBanner&quot;</span> -&gt; &#123;SpringApplicationBannerPrinter$PrintedBanner@2400&#125; <br><span class="hljs-string">&quot;springBootLoggerGroups&quot;</span> -&gt; &#123;LoggerGroups@2658&#125; <br><span class="hljs-comment">// 系统参数 this.prepareBeanFactory(beanFactory);</span><br><span class="hljs-string">&quot;systemProperties&quot;</span> -&gt; &#123;Properties@2749&#125;  <span class="hljs-keyword">size</span> = <span class="hljs-number">59</span><br><span class="hljs-comment">// 环境变量初始化</span><br>environment -&gt; &#123;StandardEnvironment@2376&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs json">singletonObject = <span class="hljs-punctuation">&#123;</span>Properties@<span class="hljs-number">2749</span><span class="hljs-punctuation">&#125;</span>  size = <span class="hljs-number">59</span><br> <span class="hljs-string">&quot;java.runtime.name&quot;</span> -&gt; <span class="hljs-string">&quot;Java(TM) SE Runtime Environment&quot;</span><br> <span class="hljs-string">&quot;sun.boot.library.path&quot;</span> -&gt; <span class="hljs-string">&quot;D:\Java\jdk1.8\jre\bin&quot;</span><br> <span class="hljs-string">&quot;java.vm.version&quot;</span> -&gt; <span class="hljs-string">&quot;25.152-b16&quot;</span><br> <span class="hljs-string">&quot;java.vm.vendor&quot;</span> -&gt; <span class="hljs-string">&quot;Oracle Corporation&quot;</span><br> <span class="hljs-string">&quot;java.vendor.url&quot;</span> -&gt; <span class="hljs-string">&quot;http://java.oracle.com/&quot;</span><br> <span class="hljs-string">&quot;path.separator&quot;</span> -&gt; <span class="hljs-string">&quot;;&quot;</span><br> <span class="hljs-string">&quot;java.vm.name&quot;</span> -&gt; <span class="hljs-string">&quot;Java HotSpot(TM) 64-Bit Server VM&quot;</span><br> <span class="hljs-string">&quot;file.encoding.pkg&quot;</span> -&gt; <span class="hljs-string">&quot;sun.io&quot;</span><br> <span class="hljs-string">&quot;user.country&quot;</span> -&gt; <span class="hljs-string">&quot;CN&quot;</span><br> <span class="hljs-string">&quot;user.script&quot;</span> -&gt; <span class="hljs-string">&quot;&quot;</span><br> <span class="hljs-string">&quot;sun.java.launcher&quot;</span> -&gt; <span class="hljs-string">&quot;SUN_STANDARD&quot;</span><br> <span class="hljs-string">&quot;sun.os.patch.level&quot;</span> -&gt; <span class="hljs-string">&quot;&quot;</span><br> <span class="hljs-string">&quot;PID&quot;</span> -&gt; <span class="hljs-string">&quot;7840&quot;</span><br> <span class="hljs-string">&quot;java.vm.specification.name&quot;</span> -&gt; <span class="hljs-string">&quot;Java Virtual Machine Specification&quot;</span><br> <span class="hljs-string">&quot;user.dir&quot;</span> -&gt; <span class="hljs-string">&quot;D:\learncode\right-try&quot;</span><br> <span class="hljs-string">&quot;intellij.debug.agent&quot;</span> -&gt; <span class="hljs-string">&quot;true&quot;</span><br> <span class="hljs-string">&quot;java.runtime.version&quot;</span> -&gt; <span class="hljs-string">&quot;1.8.0_152-b16&quot;</span><br> <span class="hljs-string">&quot;java.awt.graphicsenv&quot;</span> -&gt; <span class="hljs-string">&quot;sun.awt.Win32GraphicsEnvironment&quot;</span><br> <span class="hljs-string">&quot;java.endorsed.dirs&quot;</span> -&gt; <span class="hljs-string">&quot;D:\Java\jdk1.8\jre\lib\endorsed&quot;</span><br> <span class="hljs-string">&quot;os.arch&quot;</span> -&gt; <span class="hljs-string">&quot;amd64&quot;</span><br> <span class="hljs-string">&quot;java.io.tmpdir&quot;</span> -&gt; <span class="hljs-string">&quot;C:\Users\LENOVO\AppData\Local\Temp\&quot;</span><br><span class="hljs-string"> &quot;</span>line.separator<span class="hljs-string">&quot; -&gt; &quot;</span>\r\n<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.vm.specification.vendor<span class="hljs-string">&quot; -&gt; &quot;</span>Oracle Corporation<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>user.variant<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>os.name<span class="hljs-string">&quot; -&gt; &quot;</span>Windows <span class="hljs-number">10</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>sun.jnu.encoding<span class="hljs-string">&quot; -&gt; &quot;</span>GBK<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>spring.beaninfo.ignore<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.library.path<span class="hljs-string">&quot; -&gt; &quot;</span>D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\bin;C<span class="hljs-punctuation">:</span>\WINDOWS\Sun\Java\bin;C<span class="hljs-punctuation">:</span>\WINDOWS\system32;C<span class="hljs-punctuation">:</span>\WINDOWS;D<span class="hljs-punctuation">:</span>\application\VM Ware\bin\;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\bin;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre;C<span class="hljs-punctuation">:</span>\Program Files\Common Files\Oracle\Java\javapath;C<span class="hljs-punctuation">:</span>\WINDOWS\system32;C<span class="hljs-punctuation">:</span>\WINDOWS;C<span class="hljs-punctuation">:</span>\WINDOWS\System32\Wbem;C<span class="hljs-punctuation">:</span>\WINDOWS\System32\WindowsPowerShell\v1<span class="hljs-number">.0</span>\;C<span class="hljs-punctuation">:</span>\WINDOWS\System32\OpenSSH\;D<span class="hljs-punctuation">:</span>\c++\mingw_7<span class="hljs-number">.3</span><span class="hljs-number">.0</span>\bin;D<span class="hljs-punctuation">:</span>\java\apache-tomcat<span class="hljs-number">-9.0</span><span class="hljs-number">.62</span>\bin;D<span class="hljs-punctuation">:</span>\java\apache-tomcat<span class="hljs-number">-9.0</span><span class="hljs-number">.62</span>\lib;D<span class="hljs-punctuation">:</span>\java\apache-tomcat<span class="hljs-number">-9.0</span><span class="hljs-number">.62</span>\bin;D<span class="hljs-punctuation">:</span>\java\apache-maven<span class="hljs-number">-3.6</span><span class="hljs-number">.3</span>\bin;D<span class="hljs-punctuation">:</span>\Python\python<span class="hljs-number">-3.10</span><span class="hljs-number">.4</span>;D<span class="hljs-punctuation">:</span>\MySQL\mysql<span class="hljs-number">-8.0</span><span class="hljs-number">.29</span>-winx64\bin;D<span class="hljs-punctuation">:</span>\MySQL\mysql<span class="hljs-number">-5.7</span><span class="hljs-number">.20</span>-winx64\bin;D<span class="hljs-punctuation">:</span>\java\nacos\bin;D<span class="hljs-punctuation">:</span>\application\Git\cmd;C<span class="hljs-punctuation">:</span>\ProgramData\chocolatey\bin;D<span class="hljs-punctuation">:</span>\Web\nvm;D<span class="hljs-punctuation">:</span>\Web\nodejs;D<span class="hljs-punctuation">:</span>\Web\nodejs\node-global;D<span class="hljs-punctuation">:</span>\java\apache-jmeter<span class="hljs-number">-5.5</span>\bin;C<span class="hljs-punctuation">:</span>\Program Files\Azure Data Studio\bin;D<span class="hljs-punctuation">:</span>\java\Redis-x64<span class="hljs-number">-3.0</span><span class="hljs-number">.504</span>;D<span class="hljs-punctuation">:</span>\java\Redis-x64<span class="hljs-number">-3.0</span><span class="hljs-number">.504</span>;D<span class="hljs-punctuation">:</span>\java\mongodb-win32-x86_64-windows<span class="hljs-number">-5.0</span><span class="hljs-number">.9</span>\bin;C<span class="hljs-punctuation">:</span>\Users\LENOVO\AppData\Local\Microsoft\WindowsApps;D<span class="hljs-punctuation">:</span>\java\IntelliJ IDEA <span class="hljs-number">2021.3</span><span class="hljs-number">.3</span>\bin;;D<span class="hljs-punctuation">:</span>\application\Microsoft VS Code\bin;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>jboss.modules.system.pkgs<span class="hljs-string">&quot; -&gt; &quot;</span>com.intellij.rt<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.specification.name<span class="hljs-string">&quot; -&gt; &quot;</span>Java Platform API Specification<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.class.version<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-number">52.0</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>sun.management.compiler<span class="hljs-string">&quot; -&gt; &quot;</span>HotSpot <span class="hljs-number">64</span>-Bit Tiered Compilers<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>os.version<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-number">10.0</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>user.home<span class="hljs-string">&quot; -&gt; &quot;</span>C<span class="hljs-punctuation">:</span>\Users\LENOVO<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>user.timezone<span class="hljs-string">&quot; -&gt; &quot;</span>Asia/Shanghai<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.awt.printerjob<span class="hljs-string">&quot; -&gt; &quot;</span>sun.awt.windows.WPrinterJob<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>file.encoding<span class="hljs-string">&quot; -&gt; &quot;</span>UTF<span class="hljs-number">-8</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.specification.version<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-number">1.8</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.class.path<span class="hljs-string">&quot; -&gt; &quot;</span>D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\charsets.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\deploy.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\access-bridge<span class="hljs-number">-64.</span>jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\cldrdata.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\dnsns.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\jaccess.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\jfxrt.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\localedata.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\nashorn.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\sunec.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\sunjce_provider.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\sunmscapi.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\sunpkcs11.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext\zipfs.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\javaws.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\jce.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\jfr.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\jfxswt.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\jsse.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\management-agent.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\plugin.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\resources.jar;D<span class="hljs-punctuation">:</span>\java\jdk1<span class="hljs-number">.8</span>\jre\lib\rt.jar;D<span class="hljs-punctuation">:</span>\learncode\right-try\target\classes;D<span class="hljs-punctuation">:</span>\java\apache-maven<span class="hljs-number">-3.6</span><span class="hljs-number">.3</span>\repo\org\springframework\boot\spring-boot-starter\<span class="hljs-number">2.3</span><span class="hljs-number">.12</span>.RELEASE\spring-b<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>user.name<span class="hljs-string">&quot; -&gt; &quot;</span>where<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.vm.specification.version<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-number">1.8</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>sun.java.command<span class="hljs-string">&quot; -&gt; &quot;</span>com.where.right.RightApplication<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.home<span class="hljs-string">&quot; -&gt; &quot;</span>D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>sun.arch.data.model<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-number">64</span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>user.language<span class="hljs-string">&quot; -&gt; &quot;</span>zh<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.specification.vendor<span class="hljs-string">&quot; -&gt; &quot;</span>Oracle Corporation<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>awt.toolkit<span class="hljs-string">&quot; -&gt; &quot;</span>sun.awt.windows.WToolkit<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.vm.info<span class="hljs-string">&quot; -&gt; &quot;</span>mixed mode<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.version<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-number">1.8</span><span class="hljs-number">.0</span>_152<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.ext.dirs<span class="hljs-string">&quot; -&gt; &quot;</span>D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\ext;C<span class="hljs-punctuation">:</span>\WINDOWS\Sun\Java\lib\ext<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>sun.boot.class.path<span class="hljs-string">&quot; -&gt; &quot;</span>D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\resources.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\rt.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\sunrsasign.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\jsse.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\jce.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\charsets.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\lib\jfr.jar;D<span class="hljs-punctuation">:</span>\Java\jdk1<span class="hljs-number">.8</span>\jre\classes;C<span class="hljs-punctuation">:</span>\Users\LENOVO\AppData\Local\JetBrains\IntelliJIdea2021<span class="hljs-number">.3</span>\captureAgent\debugger-agent.jar<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.awt.headless<span class="hljs-string">&quot; -&gt; &quot;</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.vendor<span class="hljs-string">&quot; -&gt; &quot;</span>Oracle Corporation<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>file.separator<span class="hljs-string">&quot; -&gt; &quot;</span>\<span class="hljs-string">&quot;</span><br><span class="hljs-string"> &quot;</span>java.vendor.url.bug<span class="hljs-string">&quot; -&gt; &quot;</span>http<span class="hljs-punctuation">:</span><span class="hljs-comment">//bugreport.sun.com/bugreport/&quot;</span><br> <span class="hljs-string">&quot;sun.io.unicode.encoding&quot;</span> -&gt; <span class="hljs-string">&quot;UnicodeLittle&quot;</span><br> <span class="hljs-string">&quot;sun.cpu.endian&quot;</span> -&gt; <span class="hljs-string">&quot;little&quot;</span><br> <span class="hljs-string">&quot;sun.desktop&quot;</span> -&gt; <span class="hljs-string">&quot;windows&quot;</span><br> <span class="hljs-string">&quot;sun.cpu.isalist&quot;</span> -&gt; <span class="hljs-string">&quot;amd64&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">environment -&gt; <span class="hljs-punctuation">&#123;</span>StandardEnvironment@<span class="hljs-number">2376</span><span class="hljs-punctuation">&#125;</span> <span class="hljs-string">&quot;StandardEnvironment &#123;activeProfiles=[], defaultProfiles=[default], propertySources=[ConfigurationPropertySourcesPropertySource &#123;name=&#x27;configurationProperties&#x27;&#125;, PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;, OriginAwareSystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;, RandomValuePropertySource &#123;name=&#x27;random&#x27;&#125;]&#125;2&quot;</span><br></code></pre></td></tr></table></figure>





<h1 id="spring-boot-autoconfiguration模块"><a href="#spring-boot-autoconfiguration模块" class="headerlink" title="spring-boot-autoconfiguration模块"></a>spring-boot-autoconfiguration模块</h1><h2 id="AutoConfigurationImportSelector"><a href="#AutoConfigurationImportSelector" class="headerlink" title="AutoConfigurationImportSelector"></a>AutoConfigurationImportSelector</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfigurationImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeferredImportSelector</span>, BeanClassLoaderAware, ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AutoConfigurationImportSelector.<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">EMPTY_ENTRY</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationImportSelector</span>.AutoConfigurationEntry();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] NO_IMPORTS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(AutoConfigurationImportSelector.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PROPERTY_NAME_AUTOCONFIGURE_EXCLUDE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.autoconfigure.exclude&quot;</span>;<br>    <span class="hljs-keyword">private</span> ConfigurableListableBeanFactory beanFactory;<br>    <span class="hljs-keyword">private</span> Environment environment;<br>    <span class="hljs-keyword">private</span> ClassLoader beanClassLoader;<br>    <span class="hljs-keyword">private</span> ResourceLoader resourceLoader;<br>    <span class="hljs-keyword">private</span> AutoConfigurationImportSelector.ConfigurationClassFilter configurationClassFilter;<br>	<br>    <span class="hljs-comment">// 自动注入的配置信息 实体</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfigurationEntry</span> &#123;<br>        <span class="hljs-comment">// 全路径名</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; configurations;<br>        <span class="hljs-comment">// 需要排除的 类</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; exclusions;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 通过 @EnableAutoConfiguration</span><br>    <br>	<span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isEnabled(annotationMetadata)) &#123;<br>            <span class="hljs-keyword">return</span> NO_IMPORTS;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 封装为 实体信息 = 注入配置类 + 排除配置类</span><br>            AutoConfigurationImportSelector.<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getAutoConfigurationEntry(annotationMetadata);<br>            <span class="hljs-keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> AutoConfigurationImportSelector.AutoConfigurationEntry <span class="hljs-title function_">getAutoConfigurationEntry</span><span class="hljs-params">(AnnotationMetadata annotationMetadata)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isEnabled(annotationMetadata)) &#123;<br>            <span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getAttributes(annotationMetadata);<br>            <span class="hljs-comment">// 获取 configurations的全路径名</span><br>            List&lt;String&gt; configurations = <span class="hljs-built_in">this</span>.getCandidateConfigurations(annotationMetadata, attributes);<br>            configurations = <span class="hljs-built_in">this</span>.removeDuplicates(configurations);<br>            <span class="hljs-comment">// 通过注解获取需要排除的 类信息</span><br>            Set&lt;String&gt; exclusions = <span class="hljs-built_in">this</span>.getExclusions(annotationMetadata, attributes);<br>            <span class="hljs-built_in">this</span>.checkExcludedClasses(configurations, exclusions);<br>            configurations.removeAll(exclusions);<br>            configurations = <span class="hljs-built_in">this</span>.getConfigurationClassFilter().filter(configurations);<br>            <span class="hljs-built_in">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationImportSelector</span>.AutoConfigurationEntry(configurations, exclusions);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 获取需要进行自动注入的候选对象的 全路径名 数组</span><br>    <span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getCandidateConfigurations</span><span class="hljs-params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;<br>        <span class="hljs-comment">// 通过 @EnableAutoConfiguration注解的Class，获取spring.factory中以 其为key的value数组</span><br>    	<span class="hljs-comment">// 数组为，需要进行自动注入的对象信息</span><br>        List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="hljs-built_in">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="hljs-built_in">this</span>.getBeanClassLoader());<br>        <span class="hljs-keyword">return</span> configurations;<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; getSpringFactoriesLoaderFactoryClass() &#123;<br>        <span class="hljs-keyword">return</span> EnableAutoConfiguration.class;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/image-20230407235054392.png" srcset="/img/loading.gif" lazyload alt="image-20230407235054392"></p>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/69874744">了解 Spring Boot AutoConfiguration - 知乎 (zhihu.com)</a></p>
<h1 id="SpringFrameWork"><a href="#SpringFrameWork" class="headerlink" title="SpringFrameWork"></a>SpringFrameWork</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ThinkWon/article/details/102810819">(3条消息) Spring模块组成(框架组成、整体架构、体系架构、体系结构)_spring由那些模块组成_ThinkWon的博客-CSDN博客</a></p>
<p><img src="https://raw.githubusercontent.com/wherezy1/PicGOImageShack/main/images/aaaa.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="七大模块"><a href="#七大模块" class="headerlink" title="七大模块"></a>七大模块</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>. Spring Core<br>框架的最基础部分，提供 IoC 容器，对 bean 进行管理。<br><br><span class="hljs-number">2</span><span class="hljs-selector-class">.Spring</span> Context<br>基于 bean，提供上下文信息，扩展出JNDI、EJB、电子邮件、国际化、校验和调度等功能。<br><br><span class="hljs-number">3</span>．Spring DAO<br>提供了JDBC的抽象层，它可消除冗长的JDBC编码和解析数据库厂商特有的错误代码，还提供了声明性事务管理方法。<br><br><span class="hljs-number">4</span><span class="hljs-selector-class">.Spring</span> ORM<br>提供了常用的“对象/关系”映射APIs的集成层。 其中包括JPA、JDO、Hibernate、MyBatis 等。<br><br><span class="hljs-number">5</span><span class="hljs-selector-class">.Spring</span> AOP<br>提供了符合AOP Alliance规范的面向方面的编程实现。<br><br><span class="hljs-number">6</span><span class="hljs-selector-class">.Spring</span> Web<br>提供了基础的 Web 开发的上下文信息，可与其他 web 进行集成。<br><br><span class="hljs-number">7</span><span class="hljs-selector-class">.Spring</span> Web MVC<br>提供了 Web 应用的 Model-View-Controller 全功能实现。<br></code></pre></td></tr></table></figure>







<h3 id="核心容器"><a href="#核心容器" class="headerlink" title="核心容器"></a>核心容器</h3><p>Spring的核心容器是其他模块建立的基础，有spring-core、spring-beans、spring-context、spring-context-support和spring-expression（Spring表达式语言）等模块组成。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">spring-core 模块：提供了框架的基本组成部分，包括控制反转（Inversion of Control，IOC）和依赖注入（Dependency Injection，<span class="hljs-keyword">DI）功能。</span><br><span class="hljs-keyword"></span><br>spring-<span class="hljs-keyword">beans </span>模块：提供了<span class="hljs-keyword">BeanFactory，是工厂模式的一个经典实现，Spring将管理对象称为Bean。</span><br><span class="hljs-keyword"></span><br>spring-<span class="hljs-built_in">context</span> 模块：建立在Core和<span class="hljs-keyword">Beans模块的基础之上，提供一个框架式的对象访问方式，是访问定义和配置的任何对象的媒介。ApplicationContext接口是Context模块的焦点。</span><br><span class="hljs-keyword"></span><br>spring-<span class="hljs-built_in">context</span>-support 模块：支持整合第三方库到Spring应用程序上下文，特别是用于高速缓存（EhCache、<span class="hljs-keyword">JCache）和任务调度（CommonJ、Quartz）的支持。</span><br><span class="hljs-keyword"></span><br>Spring-expression 模块：提供了强大的表达式语言去支持运行时查询和操作对象图。这是对<span class="hljs-keyword">JSP2.1规范中规定的统一表达式语言（Unified </span>EL）的扩展。该语言支持设置和获取属性值、属性分配、方法调用、访问数组、集合和索引器的内容、逻辑和算术运算、变量命名以及从Spring的IOC容器中以名称检索对象。它还支持列表投影、选择以及常用的列表聚合。<br></code></pre></td></tr></table></figure>



<h3 id="AOP-和设备支持"><a href="#AOP-和设备支持" class="headerlink" title="AOP 和设备支持"></a>AOP 和设备支持</h3><p>由spring-aop、 spring-aspects 和 spring-instrument等 3 个模块组成。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">spring</span>-aop 模块：是 Spring 的另一个核心模块，提供了一个符合 AOP 要求的面向切面的编程实现。 作为继 OOP（面向对象编程） 后， 对程序员影响最大的编程思想之一， AOP 极大地开拓了人们对于编程的思路。 在 Spring 中， 以动态代理技术为基础，允许定义方法拦截器和切入点，将代码按照功能进行分离，以便干净地解耦。<br><br><span class="hljs-keyword">spring</span>-aspects 模块：提供了与AspectJ的集成功能，AspectJ是一个功能强大且成熟的AOP框架。<br><br><span class="hljs-keyword">spring</span>-instrument 模块：是 AOP 的一个支援模块， 提供了类植入（Instrumentation）支持和类加载器的实现，可以在特定的应用服务器中使用。主要作用是在 JVM 启用时， 生成一个代理类， 程序员通过代理类在运行时修改类的字节， 从而改变一个类的功能， 实现 AOP 的功能。<br></code></pre></td></tr></table></figure>



<h3 id="数据访问与集成"><a href="#数据访问与集成" class="headerlink" title="数据访问与集成"></a>数据访问与集成</h3><p>由 <strong>spring-jdbc、spring-orm、spring-oxm、spring-jms 和 spring-tx</strong> 等 5 个模块组成。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">spring</span>-jdbc 模块：提供了一个JDBC的抽象层，消除了烦琐的JDBC编码和数据库厂商特有的错误代码解析， 用于简化JDBC。主要是提供 JDBC 模板方式、 关系数据库对象化方式、 SimpleJdbc 方式、 事务管理来简化 JDBC 编程， 主要实现类是 JdbcTemplate、 SimpleJdbcTemplate 以及 NamedParameterJdbcTemplate。<br><br><span class="hljs-keyword">spring</span>-orm 模块：是 ORM 框架支持模块， 主要集成 Hibernate， Java Persistence API (JPA) 和Java Data Objects (JDO) 用于资源管理、 数据访问对象(DAO)的实现和事务策略。<br><br><span class="hljs-keyword">spring</span>-oxm 模块：主要提供一个抽象层以支撑 OXM（OXM 是 Object-to-XML-Mapping 的缩写， 它是一个 O/M-mapper， 将 java 对象映射成 XML 数据， 或者将 XML 数据映射成 java 对象） ， 例如： JAXB，Castor，XMLBeans，JiBX 和 XStream 等。<br><br><span class="hljs-keyword">spring</span>-jms模块（Java Messaging Service）：指Java消息传递服务，包含用于生产和使用消息的功能。自Spring4<span class="hljs-number">.1</span>以后，提供了与<span class="hljs-keyword">spring</span>-messaging模块的集成。<br><br><span class="hljs-keyword">spring</span>-tx 模块：事务模块，支持用于实现特殊接口和所有POJO（普通Java对象）类的编程和声明式事务管理。<br></code></pre></td></tr></table></figure>



<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><p>由<strong>spring-websocket、spring-webmvc、spring-web、portlet</strong>和<strong>spring-webflux</strong>模块等 5 个模块组成。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">spring</span>-websocket 模块：Spring4<span class="hljs-number">.0</span>以后新增的模块，实现双工异步通讯协议，实现了WebSocket和SocketJS，提供Socket通信和web端的推送功能。<br><br><span class="hljs-keyword">spring</span>-webmvc 模块：也称为Web-Servlet模块，包含用于web应用程序的Spring MVC和REST Web Services实现。Spring MVC框架提供了领域模型代码和Web表单之间的清晰分离，并与Spring Framework的所有其他功能集成。<br><br><span class="hljs-keyword">spring</span>-web 模块：提供了基本的Web开发集成功能，包括使用Servlet监听器初始化一个IOC容器以及Web应用上下文，自动载入WebApplicationContext特性的类，Struts集成类、文件上传的支持类、Filter类和大量辅助工具类。<br><br>portlet 模块：实现web模块功能的聚合，类似于Servlet模块的功能，提供了Portlet环境下的MVC实现。<br><br><span class="hljs-keyword">spring</span>-webflux 模块：是一个新的非堵塞函数式 Reactive Web 框架， 可以用来建立异步的， 非阻塞，事件驱动的服务， 并且扩展性非常好。<br></code></pre></td></tr></table></figure>



<h3 id="消息-Messaging"><a href="#消息-Messaging" class="headerlink" title="消息(Messaging)"></a>消息(Messaging)</h3><p>即 spring-messaging 模块。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">spring</span>-messaging 是从 Spring4 开始新加入的一个模块， 该模块提供了对消息传递体系结构和协议的支持。<br></code></pre></td></tr></table></figure>



<h3 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h3><p>即 spring-test 模块。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">spring-<span class="hljs-keyword">test</span> 模块主要为测试提供支持的，支持使用JUnit或TestNG对Spring组件进行单元测试和集成测试。<br></code></pre></td></tr></table></figure>



<h2 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h2><p>所有模块的依赖引入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">org.springframework.version</span>&gt;</span>5.0.8.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">org.springframework.version</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-comment">&lt;!-- spring start --&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring core start--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-expression<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-support<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-indexer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring core end--&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring aop start--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spirng aop end--&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring aspects start--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aspects<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring aspects end--&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring instrumentation start --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-instrument<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring instrumentation end--&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring messaging start --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-messaging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring messaging end--&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring data access start --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-orm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-oxm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jms<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-tx<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring data access end--&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring web start --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc-portlet<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring web end --&gt;</span><br><br>       <span class="hljs-comment">&lt;!--spring test start --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.springframework.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring test end --&gt;</span><br>       <span class="hljs-comment">&lt;!-- spring end --&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br></code></pre></td></tr></table></figure>





<h2 id="packaget-info-java"><a href="#packaget-info-java" class="headerlink" title="packaget-info.java"></a>packaget-info.java</h2><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">1</span>、为标注在包上<span class="hljs-built_in">Annotation</span>提供便利；<br><br><span class="hljs-number">2</span>、声明友好类和包常量；<br><br><span class="hljs-number">3</span>、提供包的整体注释说明。<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Classes supporting the org.springframework.context package,</span><br><span class="hljs-comment"> * such as abstract base classes for ApplicationContext</span><br><span class="hljs-comment"> * implementations and a MessageSource implementation.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@NonNullApi</span>  用于声明参数和返回值在默认情况下对于给定的包被视为不可为空。<br><span class="hljs-meta">@NonNullFields</span> 用于声明对于给定的包，默认情况下字段将被视为不可为空<br><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">import</span> org.springframework.lang.NonNullApi;<br><span class="hljs-keyword">import</span> org.springframework.lang.NonNullFields;<br></code></pre></td></tr></table></figure>



<h1 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h1><h2 id="AnnotationConfigUtils"><a href="#AnnotationConfigUtils" class="headerlink" title="AnnotationConfigUtils"></a>AnnotationConfigUtils</h2><p>AnnotationBeanDefinitionReader调用用于注册PostProcessor</p>
<h2 id="PostProcessorRegistrationDelegate-1"><a href="#PostProcessorRegistrationDelegate-1" class="headerlink" title="PostProcessorRegistrationDelegate"></a>PostProcessorRegistrationDelegate</h2><p>执行refresh()的 <strong>invokePostProcessor()</strong> 和 registerPostProcessor()方法</p>
<h2 id="ResolvableType"><a href="#ResolvableType" class="headerlink" title="ResolvableType"></a>ResolvableType</h2><p>不知道</p>
<h2 id="BeanUtils"><a href="#BeanUtils" class="headerlink" title="BeanUtils"></a>BeanUtils</h2><h2 id="SpringFactoriesLoader"><a href="#SpringFactoriesLoader" class="headerlink" title="SpringFactoriesLoader"></a>SpringFactoriesLoader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringFactoriesLoader</span> &#123;<br>    <span class="hljs-comment">// 路径</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FACTORIES_RESOURCE_LOCATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;META-INF/spring.factories&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(SpringFactoriesLoader.class);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;ClassLoader, MultiValueMap&lt;String, String&gt;&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentReferenceHashMap</span>();<br>	<br>    <span class="hljs-comment">// 通过 @EnableAutoConfiguration注解的Class，获取spring.factory中以 其为key的value数组</span><br>    <span class="hljs-comment">// 数组为，需要进行自动注入的对象信息</span><br>    <span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getCandidateConfigurations</span><span class="hljs-params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;<br>        List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="hljs-built_in">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="hljs-built_in">this</span>.getBeanClassLoader());<br>        <span class="hljs-keyword">return</span> configurations;<br>    &#125;<br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; getSpringFactoriesLoaderFactoryClass() &#123;<br>        <span class="hljs-keyword">return</span> EnableAutoConfiguration.class;<br>    &#125;<br>    <br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">loadFactories</span><span class="hljs-params">(Class&lt;T&gt; factoryType, <span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>        Assert.notNull(factoryType, <span class="hljs-string">&quot;&#x27;factoryType&#x27; must not be null&quot;</span>);<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoaderToUse</span> <span class="hljs-operator">=</span> classLoader;<br>        <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-literal">null</span>) &#123;<br>            classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();<br>        &#125;<br>		<span class="hljs-comment">// 获取对应key的 values</span><br>        List&lt;String&gt; factoryImplementationNames = loadFactoryNames(factoryType, classLoaderToUse);<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            logger.trace(<span class="hljs-string">&quot;Loaded [&quot;</span> + factoryType.getName() + <span class="hljs-string">&quot;] names: &quot;</span> + factoryImplementationNames);<br>        &#125;<br><br>        List&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(factoryImplementationNames.size());<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> factoryImplementationNames.iterator();<br><br>        <span class="hljs-keyword">while</span>(var5.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">factoryImplementationName</span> <span class="hljs-operator">=</span> (String)var5.next();<br>            <span class="hljs-comment">// 实例化 并 加入到 result</span><br>            result.add(instantiateFactory(factoryImplementationName, factoryType, classLoaderToUse));<br>        &#125;<br><br>        AnnotationAwareOrderComparator.sort(result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>	<span class="hljs-comment">// 获取对应key的 values</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">loadFactoryNames</span><span class="hljs-params">(Class&lt;?&gt; factoryType, <span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">factoryTypeName</span> <span class="hljs-operator">=</span> factoryType.getName();<br>        <span class="hljs-keyword">return</span> (List)loadSpringFactories(classLoader).getOrDefault(factoryTypeName, Collections.emptyList());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="———-《再看Spring》———–"><a href="#———-《再看Spring》———–" class="headerlink" title="———-《再看Spring》———–"></a>———-《再看Spring》———–</h1><h1 id="重要的-PostProccesor"><a href="#重要的-PostProccesor" class="headerlink" title="重要的 PostProccesor"></a>重要的 PostProccesor</h1><h1 id="重要的-Context"><a href="#重要的-Context" class="headerlink" title="重要的 Context"></a>重要的 Context</h1><h2 id="注解相关的-Context-自动注入"><a href="#注解相关的-Context-自动注入" class="headerlink" title="注解相关的 Context - 自动注入"></a>注解相关的 Context - 自动注入</h2><h3 id="AnnotationConfigApplicationContext-1"><a href="#AnnotationConfigApplicationContext-1" class="headerlink" title="AnnotationConfigApplicationContext"></a>AnnotationConfigApplicationContext</h3><p>两个 Reader、Scanner 用于 BeanDefinition的注册扫描</p>
<p>在 上下文初始化的手创建和初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AnnotationConfigRegistry</span> &#123;<br>	<span class="hljs-comment">// register - 注解扫描</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotatedBeanDefinitionReader reader;<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">  @Configuration 、 @Conponent</span><br><span class="hljs-comment">  */</span><br>	<br>  <br> <br>  <span class="hljs-comment">// scan  - 包扫描</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassPathBeanDefinitionScanner scanner;<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment"> @ConfigurationScan</span><br><span class="hljs-comment">  */</span><br>  <br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationConfigApplicationContext</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-type">StartupStep</span> <span class="hljs-variable">createAnnotatedBeanDefReader</span> <span class="hljs-operator">=</span> getApplicationStartup().start(<span class="hljs-string">&quot;spring.context.annotated-bean-reader.create&quot;</span>);<br>    <span class="hljs-comment">// 这个方法很重要 --- 这里是一些注解处理的 PostPrcessor 注册的地方</span><br>		<span class="hljs-built_in">this</span>.reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedBeanDefinitionReader</span>(<span class="hljs-built_in">this</span>);<br>		createAnnotatedBeanDefReader.end();<br>		<span class="hljs-built_in">this</span>.scanner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span>(<span class="hljs-built_in">this</span>);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="AnnotatedBeanDefinitionReader的初始化（非常重要-Autowired）"><a href="#AnnotatedBeanDefinitionReader的初始化（非常重要-Autowired）" class="headerlink" title="AnnotatedBeanDefinitionReader的初始化（非常重要-@Autowired）"></a>AnnotatedBeanDefinitionReader的初始化（非常重要-@Autowired）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry, Environment environment)</span> &#123;<br>		Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);<br>		Assert.notNull(environment, <span class="hljs-string">&quot;Environment must not be null&quot;</span>);<br>		<span class="hljs-built_in">this</span>.registry = registry;<br>		<span class="hljs-built_in">this</span>.conditionEvaluator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionEvaluator</span>(registry, environment, <span class="hljs-literal">null</span>);<br>  <span class="hljs-comment">// </span><br>		AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="hljs-built_in">this</span>.registry);<br>	&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="AnnotationConfigUtils-1"><a href="#AnnotationConfigUtils-1" class="headerlink" title="AnnotationConfigUtils"></a>AnnotationConfigUtils</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">registerAnnotationConfigProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">			BeanDefinitionRegistry registry, <span class="hljs-meta">@Nullable</span> Object source)</span> &#123;<br>		<span class="hljs-comment">// 用 register 包装创建 DefaultListableBeanFactory</span><br>		<span class="hljs-type">DefaultListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> unwrapDefaultListableBeanFactory(registry);<br>		<span class="hljs-keyword">if</span> (beanFactory != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">if</span> (!(beanFactory.getDependencyComparator() <span class="hljs-keyword">instanceof</span> AnnotationAwareOrderComparator)) &#123;<br>				beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (!(beanFactory.getAutowireCandidateResolver() <span class="hljs-keyword">instanceof</span> ContextAnnotationAutowireCandidateResolver)) &#123;<br>				beanFactory.setAutowireCandidateResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextAnnotationAutowireCandidateResolver</span>());<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 注册一些重要的 BeanDefinition（PostProcessor），</span><br>		<span class="hljs-comment">//  ---- 在后面实例化的（PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()）</span><br>		<span class="hljs-comment">// -----			(PostProcessorRegistrationDelegate.registerBeanPostProcessors())</span><br>		Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-number">8</span>);<br><br>		<span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;<br>			<span class="hljs-comment">// ConfigurationClassPostProcessor, 究极重要--配置类@Configuraion 解析</span><br>			<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(ConfigurationClassPostProcessor.class);<br>			def.setSource(source);<br>			beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;<br>			<span class="hljs-comment">// AutowiredAnnotationBeanPostProcessor -- @Autowired 注解解析 --自动注入</span><br>			<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(AutowiredAnnotationBeanPostProcessor.class);<br>			def.setSource(source);<br>			beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));<br>		&#125;<br><br>		<span class="hljs-comment">// Check for Jakarta Annotations support, and if present add the CommonAnnotationBeanPostProcessor.</span><br>		<span class="hljs-keyword">if</span> ((jakartaAnnotationsPresent || jsr250Present) &amp;&amp;<br>				!registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;<br>			<span class="hljs-comment">// </span><br>			<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(CommonAnnotationBeanPostProcessor.class);<br>			def.setSource(source);<br>			beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));<br>		&#125;<br><br>		<span class="hljs-comment">// JPA 相关的支持</span><br>		<span class="hljs-comment">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span><br>		<span class="hljs-keyword">if</span> (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;<br>			<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>();<br>			<span class="hljs-keyword">try</span> &#123;<br>				def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,<br>						AnnotationConfigUtils.class.getClassLoader()));<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>						<span class="hljs-string">&quot;Cannot load optional framework class: &quot;</span> + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);<br>			&#125;<br>			def.setSource(source);<br>			beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));<br>		&#125;<br><br>		<span class="hljs-comment">// EventListenerMethodProcessor -- @EventListener 注解的支持</span><br>		<span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;<br>			<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(EventListenerMethodProcessor.class);<br>			def.setSource(source);<br>			beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));<br>		&#125;<br><br>		<span class="hljs-comment">// EventListenerMethodProcessor -- @EventListener 注解的支持</span><br>		<span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;<br>			<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(DefaultEventListenerFactory.class);<br>			def.setSource(source);<br>			beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> beanDefs;<br>	&#125;<br></code></pre></td></tr></table></figure>





<h1 id="重要的工具类"><a href="#重要的工具类" class="headerlink" title="重要的工具类"></a>重要的工具类</h1><p>主要用于重要方法的执行，重要类的 BeanDefinition 的注册，BeanDefinition的实例化</p>
<h2 id="AnnotationConfigUtils-2"><a href="#AnnotationConfigUtils-2" class="headerlink" title="AnnotationConfigUtils"></a>AnnotationConfigUtils</h2><p>Spring 注解、JPA 注解（Java 注解规范）</p>
<p>@Configuration @Autowired @EnventListerner @Inject</p>
<p>注册相关的 支持类为 BeanDefinition，后面 在 PostProcessorRegistrationDelegate 的时候注册为 Bean，实现相关功能</p>
<p>registerAnnotationConfigProcessors –</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"> * <span class="hljs-meta">@see</span> ContextAnnotationAutowireCandidateResolver<br> * <span class="hljs-meta">@see</span> ConfigurationClassPostProcessor<br> * <span class="hljs-meta">@see</span> CommonAnnotationBeanPostProcessor<br> * <span class="hljs-meta">@see</span> org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor<br> * <span class="hljs-meta">@see</span> org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor<br> */<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationConfigUtils</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed Configuration annotation processor.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed BeanNameGenerator for use when processing</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> Configuration&#125; classes. Set by &#123;<span class="hljs-doctag">@link</span> AnnotationConfigApplicationContext&#125;</span><br><span class="hljs-comment">	 * and &#123;<span class="hljs-doctag">@code</span> AnnotationConfigWebApplicationContext&#125; during bootstrap in order to make</span><br><span class="hljs-comment">	 * any custom name generation strategy available to the underlying</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> ConfigurationClassPostProcessor&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 3.1.1</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIGURATION_BEAN_NAME_GENERATOR</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.annotation.internalConfigurationBeanNameGenerator&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed Autowired annotation processor.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.annotation.internalAutowiredAnnotationProcessor&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed common annotation processor.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.annotation.internalCommonAnnotationProcessor&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed JPA annotation processor.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.annotation.internalPersistenceAnnotationProcessor&quot;</span>;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed <span class="hljs-doctag">@EventListener</span> annotation processor.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.event.internalEventListenerProcessor&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The bean name of the internally managed EventListenerFactory.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EVENT_LISTENER_FACTORY_BEAN_NAME</span> <span class="hljs-operator">=</span><br>			<span class="hljs-string">&quot;org.springframework.context.event.internalEventListenerFactory&quot;</span>;<br><br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> AnnotationConfigUtils.class.getClassLoader();<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">jakartaAnnotationsPresent</span> <span class="hljs-operator">=</span><br>			ClassUtils.isPresent(<span class="hljs-string">&quot;jakarta.annotation.PostConstruct&quot;</span>, classLoader);<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">jsr250Present</span> <span class="hljs-operator">=</span><br>			ClassUtils.isPresent(<span class="hljs-string">&quot;javax.annotation.PostConstruct&quot;</span>, classLoader);<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">jpaPresent</span> <span class="hljs-operator">=</span><br>			ClassUtils.isPresent(<span class="hljs-string">&quot;jakarta.persistence.EntityManagerFactory&quot;</span>, classLoader) &amp;&amp;<br>					ClassUtils.isPresent(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, classLoader);<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="PostProcessorRegistrationDelegate-2"><a href="#PostProcessorRegistrationDelegate-2" class="headerlink" title="PostProcessorRegistrationDelegate"></a>PostProcessorRegistrationDelegate</h2><p>一些重要方法的执行</p>
<ul>
<li><p>invokeBeanFactoryPostProcessors — refresh() 方法调用，执行 BeanFactoryPostPRcessor</p>
</li>
<li><p>registerBeanPostProcessors. – refresh() 方法调用 注册 BeanPostProcessor</p>
</li>
</ul>
<p>loadBeanPostProcessors – 加载 和 排序 BeanPostProcessor</p>
<p>invokeMergedBeanDefinitionPostProcessors — 执行 MergedBeanDefinitionPostProcessors</p>
<p>sortPostProcessors – 按照Order、PrioryOrder 排序</p>
<p>invokeBeanDefinitionRegistryPostProcessors – 执行 BeanDefinitionRegistryPostProcessors</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostProcessorRegistrationDelegate</span> &#123;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="自动注入相关"><a href="#自动注入相关" class="headerlink" title="自动注入相关"></a>自动注入相关</h1><h2 id="AutowireCapableBeanFactory"><a href="#AutowireCapableBeanFactory" class="headerlink" title="AutowireCapableBeanFactory"></a>AutowireCapableBeanFactory</h2><p>用于自动注入的工厂</p>
<h2 id="AutowiredAnnotationBeanPostProcessor-框架"><a href="#AutowiredAnnotationBeanPostProcessor-框架" class="headerlink" title="AutowiredAnnotationBeanPostProcessor - 框架"></a>AutowiredAnnotationBeanPostProcessor - 框架</h2><p>实现了</p>
<p>InstantiationAwareBeanPostProcessor 的 postProcessProperties 方法，</p>
<h3 id="InstantiationAwareBeanPostProcessor-明细"><a href="#InstantiationAwareBeanPostProcessor-明细" class="headerlink" title="InstantiationAwareBeanPostProcessor 明细"></a>InstantiationAwareBeanPostProcessor 明细</h3><p>三个方法，主要是实例化（反射实例化）的前后步骤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><br>	<span class="hljs-comment">// Initialization - 2 = 初始化- 2</span><br>	<span class="hljs-comment">// Instantiation - 1 = 实例化- 1</span><br>	<span class="hljs-comment">// 1</span><br><span class="hljs-comment">// 1</span><br>	<span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">default</span> Object <span class="hljs-title function_">postProcessBeforeInstantiation</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br><span class="hljs-comment">// 2</span><br><span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">postProcessAfterInstantiation</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>	&#125;<br><span class="hljs-comment">// 3</span><br><span class="hljs-meta">@Nullable</span><br>	<span class="hljs-keyword">default</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span><br>			<span class="hljs-keyword">throws</span> BeansException &#123;<br><br>		<span class="hljs-keyword">return</span> pvs;<br>	&#125;<br></code></pre></td></tr></table></figure>





<h3 id="AutowiredAnnotationBeanPostProcessor-步骤"><a href="#AutowiredAnnotationBeanPostProcessor-步骤" class="headerlink" title="AutowiredAnnotationBeanPostProcessor 步骤"></a>AutowiredAnnotationBeanPostProcessor 步骤</h3><p>postProcessProperties() - </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br>		<span class="hljs-comment">// 找到需要注入的位置 InjectionMetadata （注入点-属性、方法）</span><br>		<span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findAutowiringMetadata(beanName, bean.getClass(), pvs);<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// 属性注入</span><br>			metadata.inject(bean, beanName, pvs);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);<br>		&#125;<br>		<span class="hljs-keyword">return</span> pvs;<br>	&#125;<br></code></pre></td></tr></table></figure>



<p>支持三种注入的自动注入（这个类实现的支持）</p>
<p>Autowired、Value、Inject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AutowiredAnnotationBeanPostProcessor</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-comment">// Autowired</span><br>		<span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(Autowired.class);<br>		<span class="hljs-comment">// Value</span><br>		<span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(Value.class);<br><br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// Inject</span><br>			<span class="hljs-comment">// jakarta.inject.Inject </span><br>			<span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add((Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;)<br>					ClassUtils.forName(<span class="hljs-string">&quot;jakarta.inject.Inject&quot;</span>, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));<br>			logger.trace(<span class="hljs-string">&quot;&#x27;jakarta.inject.Inject&#x27; annotation found and supported for autowiring&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>			<span class="hljs-comment">// jakarta.inject API not available - simply skip.</span><br>		&#125;<br><br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add((Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;)<br>					ClassUtils.forName(<span class="hljs-string">&quot;javax.inject.Inject&quot;</span>, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));<br>			logger.trace(<span class="hljs-string">&quot;&#x27;javax.inject.Inject&#x27; annotation found and supported for autowiring&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>			<span class="hljs-comment">// javax.inject API not available - simply skip.</span><br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>


















                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Spring/" class="category-chain-item">Spring</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spring/">#Spring</a>
      
        <a href="/tags/Java/">#Java</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring Boot</div>
      <div>http://example.com/2023/06/01/Spring家族/Spring Boot/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>where</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/06/01/Spring%E5%AE%B6%E6%97%8F/Spring%20Profile/" title="Spring Profile">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring Profile</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/01/Spring%E5%AE%B6%E6%97%8F/Spring%20framework/" title="Spring Framework">
                        <span class="hidden-mobile">Spring Framework</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
